<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>c++11ç®€æ˜“çº¿ç¨‹æ± </title>
    <link href="/2024/12/25/c++11%E7%AE%80%E6%98%93%E7%BA%BF%E7%A8%8B%E6%B1%A0/"/>
    <url>/2024/12/25/c++11%E7%AE%80%E6%98%93%E7%BA%BF%E7%A8%8B%E6%B1%A0/</url>
    
    <content type="html"><![CDATA[<div class="note note-success">            <p>å‚è€ƒï¼š</p><p><a href="https://www.bilibili.com/video/BV1364y1i7uo/?spm_id_from=333.1007.top_right_bar_window_default_collection.content.click&amp;vd_source=7e145ef25e753e6fd72277167b7c92f0">https://www.bilibili.com/video/BV1364y1i7uo/?spm_id_from=333.1007.top_right_bar_window_default_collection.content.click&amp;vd_source=7e145ef25e753e6fd72277167b7c92f0</a></p><p><a href="https://gitee.com/zwhddup/make-wheels">https://gitee.com/zwhddup/make-wheels</a></p><p><a href="https://subingwen.cn/cpp/threadpool/#3-%E7%BA%BF%E7%A8%8B%E5%BC%82%E6%AD%A5">https://subingwen.cn/cpp/threadpool/#3-çº¿ç¨‹å¼‚æ­¥</a></p>          </div><p><strong>motivation</strong>ï¼šç”¨ç©ºé—´æ¢æ—¶é—´ï¼Œç‰ºç‰²æœåŠ¡å™¨çš„ç¡¬ä»¶èµ„æºä»è€Œæ¢å–è¿è¡Œæ•ˆç‡ã€‚åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶å°±åˆå§‹åŒ–æ•´ä¸ªæ± ï¼Œè¿è¡Œæ—¶è‹¥éœ€è¦çº¿ç¨‹åˆ™ç›´æ¥ä»æ± ä¸­è·å–ï¼Œæ— éœ€å†åŠ¨æ€åˆ†é…ï¼›çº¿ç¨‹å®Œæˆä»»åŠ¡åä¹Ÿä¼šç›´æ¥å›åˆ°æ± ä¸­ï¼Œæ— éœ€æ‰§è¡Œç³»ç»Ÿè°ƒç”¨é‡Šæ”¾èµ„æº</p><p>çº¿ç¨‹æ± ä¸»è¦åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p><ul><li><strong>ä»»åŠ¡é˜Ÿåˆ—</strong>ï¼šä¸€ä¸ªclassï¼Œç”¨äºå­˜å‚¨éœ€è¦å¤„ç†çš„ä»»åŠ¡ï¼Œå·¥ä½œçº¿ç¨‹ä»ä¸­å–ç”¨ä»»åŠ¡ï¼Œå¤„ç†å®Œçš„ä»»åŠ¡ä¼šè¢«åˆ é™¤</li><li><strong>å·¥ä½œçº¿ç¨‹ï¼ˆä»»åŠ¡é˜Ÿåˆ—çš„æ¶ˆè´¹è€…ï¼‰</strong>ï¼šæœ‰Nä¸ªï¼Œä¸åœåœ°ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡å¹¶å¤„ç†ï¼Œä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºæ—¶å·¥ä½œçº¿ç¨‹ä¼šè¢«é˜»å¡</li><li><strong>ç®¡ç†è€…çº¿ç¨‹ï¼ˆä¸å¤„ç†ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼‰</strong>ï¼šåªæœ‰1ä¸ªï¼Œä½œç”¨æ˜¯å‘¨æœŸæ€§åœ°æ£€æµ‹ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ•°é‡å’Œå·¥ä½œçº¿ç¨‹çš„ä¸ªæ•°ï¼Œå¯æ ¹æ®ä»»åŠ¡å¤šå°‘é€‚å½“åˆ›å»ºæˆ–é‡Šæ”¾å·¥ä½œçº¿ç¨‹</li></ul><hr><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;thread&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;mutex&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;queue&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;atomic&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;chrono&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;condition_variable&gt;</span></span><br><br><br><span class="hljs-comment">/************************* ä»»åŠ¡é˜Ÿåˆ— ****************************/</span><br><br><span class="hljs-keyword">using</span> callback = <span class="hljs-built_in">void</span>(*)(<span class="hljs-type">void</span>*);<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">task</span> &#123;<br><span class="hljs-built_in">task</span>() &#123;<br>fun = <span class="hljs-literal">nullptr</span>;<br>args = <span class="hljs-literal">nullptr</span>;<br>&#125;<br><br><span class="hljs-built_in">task</span>(callback f, <span class="hljs-type">void</span>* args) &#123;<br><span class="hljs-keyword">this</span>-&gt;fun = f;<br><span class="hljs-keyword">this</span>-&gt;args = args;<br>&#125;<br><br>callback fun;<br><span class="hljs-type">void</span>* args;<br>&#125;;<br><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">taskQueue</span> &#123;<br><span class="hljs-keyword">private</span>:<br>std::queue&lt;task&gt; m_Qtask;<br>std::mutex m_mutexQueue;<br><br><span class="hljs-keyword">public</span>:<br><span class="hljs-built_in">taskQueue</span>() &#123;&#125;;<br>~<span class="hljs-built_in">taskQueue</span>() &#123;&#125;;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">addTask</span><span class="hljs-params">(task newTask)</span></span>;<br><span class="hljs-function">task <span class="hljs-title">takeTask</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">getTaskNum</span><span class="hljs-params">()</span></span>;<br><br>&#125;;<br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">taskQueue::addTask</span><span class="hljs-params">(task newTask)</span> </span>&#123;<br><span class="hljs-comment">// lock_guardæ¨¡æ¿ç±»ä½¿ç”¨raiiï¼Œææ„æ—¶è‡ªåŠ¨é‡Šæ”¾é”</span><br><span class="hljs-function">std::lock_guard&lt;std::mutex&gt;<span class="hljs-title">lock</span><span class="hljs-params">(m_mutexQueue)</span></span>;<br>m_Qtask.<span class="hljs-built_in">push</span>(newTask);<br>&#125;<br><br><br><span class="hljs-function">task <span class="hljs-title">taskQueue::takeTask</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-function">std::lock_guard&lt;std::mutex&gt;<span class="hljs-title">lock</span><span class="hljs-params">(m_mutexQueue)</span></span>;<br>task tmp;<br><span class="hljs-keyword">if</span> (!m_Qtask.<span class="hljs-built_in">empty</span>()) &#123;<br>tmp = m_Qtask.<span class="hljs-built_in">front</span>();<br>m_Qtask.<span class="hljs-built_in">pop</span>();<br>&#125;<br><span class="hljs-keyword">return</span> tmp;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">taskQueue::getTaskNum</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">return</span> m_Qtask.<span class="hljs-built_in">size</span>();<br>&#125;<br><br><span class="hljs-comment">/************************* çº¿ç¨‹æ±  ****************************/</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">threadPool</span> &#123;<br><span class="hljs-keyword">private</span>:<br>taskQueue* m_taskQueue;<br>std::thread* m_managerThread;<br>std::vector&lt;std::thread&gt; m_workThreads;<br><br><span class="hljs-type">int</span> m_minNum;<br><span class="hljs-type">int</span> m_maxNum;<br>std::atomic&lt;<span class="hljs-type">int</span>&gt; m_busyNum;  <span class="hljs-comment">// å·¥ä½œä¸­çš„çº¿ç¨‹æ•°</span><br>std::atomic&lt;<span class="hljs-type">int</span>&gt; m_aliveNum;  <span class="hljs-comment">// å­˜æ´»çš„çš„çº¿ç¨‹æ•°</span><br>std::atomic&lt;<span class="hljs-type">int</span>&gt; m_exitNum;  <span class="hljs-comment">// è¦é”€æ¯çš„çº¿ç¨‹æ•°</span><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">int</span> m_addThreadNum = <span class="hljs-number">2</span>;  <span class="hljs-comment">// ä¸€æ¬¡åŠ å…¥çš„çº¿ç¨‹æ•°</span><br><br>std::mutex m_mutexPool;<br>std::condition_variable m_notEmpty;<br><br><span class="hljs-comment">// ä¸ºtrueæ—¶é”€æ¯çº¿ç¨‹æ± </span><br><span class="hljs-type">bool</span> m_isShutdown;<br><br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-title">worker</span><span class="hljs-params">(<span class="hljs-type">void</span>* arg)</span></span>;<br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span>* <span class="hljs-title">manager</span><span class="hljs-params">(<span class="hljs-type">void</span>* arg)</span></span>;<br><br><br><span class="hljs-keyword">public</span>:<br><span class="hljs-built_in">threadPool</span>(<span class="hljs-type">int</span> min, <span class="hljs-type">int</span> max);<br>~<span class="hljs-built_in">threadPool</span>();<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">addTask</span><span class="hljs-params">(task newTask)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">threadExit</span><span class="hljs-params">()</span></span>;<br>&#125;;<br><br><br>threadPool::<span class="hljs-built_in">threadPool</span>(<span class="hljs-type">int</span> min, <span class="hljs-type">int</span> max) &#123;<br>m_taskQueue = <span class="hljs-keyword">new</span> taskQueue;<br><br>m_minNum = min;<br>m_maxNum = max;<br>m_busyNum = <span class="hljs-number">0</span>;<br>m_aliveNum = min;<br>m_exitNum = <span class="hljs-number">0</span>;<br><br>m_isShutdown = <span class="hljs-literal">false</span>;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; min; i++) &#123;<br>m_workThreads.<span class="hljs-built_in">push_back</span>(std::<span class="hljs-built_in">thread</span>(worker, <span class="hljs-keyword">this</span>));<br>&#125;<br>m_managerThread = <span class="hljs-keyword">new</span> std::<span class="hljs-built_in">thread</span>(manager, <span class="hljs-keyword">this</span>);<br>&#125;<br><br><br>threadPool::~<span class="hljs-built_in">threadPool</span>() &#123;<br>m_isShutdown = <span class="hljs-literal">true</span>;<br><br><span class="hljs-keyword">if</span> (m_aliveNum) &#123;<br>m_exitNum.<span class="hljs-built_in">store</span>(m_aliveNum);<br>m_notEmpty.<span class="hljs-built_in">notify_all</span>();<br>&#125;<br><br><span class="hljs-keyword">if</span> (m_taskQueue)<br><span class="hljs-keyword">delete</span> m_taskQueue;<br><br><span class="hljs-keyword">if</span> (m_managerThread != <span class="hljs-literal">nullptr</span>) &#123;<br><span class="hljs-keyword">if</span> (m_managerThread-&gt;<span class="hljs-built_in">joinable</span>())<br>m_managerThread-&gt;<span class="hljs-built_in">join</span>();<br><span class="hljs-keyword">delete</span> m_managerThread;<br>&#125;<br><br><span class="hljs-keyword">if</span> (!m_workThreads.<span class="hljs-built_in">empty</span>())<br><span class="hljs-built_in">threadExit</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-title">threadPool::worker</span><span class="hljs-params">(<span class="hljs-type">void</span>* arg)</span> </span>&#123;<br>std::cout &lt;&lt; std::this_thread::<span class="hljs-built_in">get_id</span>() &lt;&lt; <span class="hljs-string">&quot; worker thread strating&quot;</span> &lt;&lt; std::endl;<br><br><span class="hljs-comment">// poolæŒ‡å‘ä¸»çº¿ç¨‹(mainå‡½æ•°)ä¸­å®ä¾‹åŒ–çš„é‚£ä¸ªthreadPool</span><br>threadPool* pool = <span class="hljs-built_in">static_cast</span>&lt;threadPool*&gt; (arg);<br><br><span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br><span class="hljs-comment">// æ„é€ æ—¶è‡ªåŠ¨ä¸Šé”</span><br><span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">poolLock</span><span class="hljs-params">(pool-&gt;m_mutexPool)</span></span>;<br><br><span class="hljs-comment">// è¿˜æ²¡æœ‰ä»»åŠ¡æ—¶</span><br><span class="hljs-keyword">while</span> (pool-&gt;m_taskQueue-&gt;<span class="hljs-built_in">getTaskNum</span>() == <span class="hljs-number">0</span> &amp;&amp; pool-&gt;m_isShutdown == <span class="hljs-literal">false</span>) &#123;<br>std::cout &lt;&lt; std::this_thread::<span class="hljs-built_in">get_id</span>() &lt;&lt; <span class="hljs-string">&quot; waiting task&quot;</span> &lt;&lt; std::endl;<br><br><span class="hljs-comment">// é‡Šæ”¾é”å¹¶é˜»å¡ç­‰å¾…ä»»åŠ¡ï¼Œè¢«å”¤é†’åè‡ªåŠ¨ä¸Šé”</span><br>pool-&gt;m_notEmpty.<span class="hljs-built_in">wait</span>(poolLock);<br><br><span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦é”€æ¯çº¿ç¨‹</span><br><span class="hljs-keyword">if</span> (pool-&gt;m_exitNum &gt; <span class="hljs-number">0</span> &amp;&amp; pool-&gt;m_aliveNum &gt; pool-&gt;m_minNum) &#123;<br>pool-&gt;m_exitNum--;<br>pool-&gt;m_aliveNum--;<br>std::cout &lt;&lt; std::this_thread::<span class="hljs-built_in">get_id</span>() &lt;&lt; <span class="hljs-string">&quot; thread end working&quot;</span> &lt;&lt; std::endl;<br>poolLock.<span class="hljs-built_in">unlock</span>();<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (pool-&gt;m_isShutdown) &#123;<br>poolLock.<span class="hljs-built_in">unlock</span>();<br>std::cout &lt;&lt; std::this_thread::<span class="hljs-built_in">get_id</span>() &lt;&lt; <span class="hljs-string">&quot; thread end working&quot;</span> &lt;&lt; std::endl;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>&#125;<br><br>task oneTask = pool-&gt;m_taskQueue-&gt;<span class="hljs-built_in">takeTask</span>();<br><br><span class="hljs-comment">// å–å‡ºä»»åŠ¡åå°±ä¸Šé”ï¼Œä¸éœ€è¦æŠŠä»»åŠ¡æ‰§è¡Œæ”¾åœ¨é”èŒƒå›´å†…</span><br>poolLock.<span class="hljs-built_in">unlock</span>();<br><br>pool-&gt;m_busyNum++;<br>oneTask.<span class="hljs-built_in">fun</span>(oneTask.args);<br><span class="hljs-keyword">delete</span> oneTask.args;  <span class="hljs-comment">// è¿™ä¸ªdeleteå¤ªå®¹æ˜“å¿˜è®°äº†</span><br>pool-&gt;m_busyNum--;<br>&#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-type">void</span>* <span class="hljs-title">threadPool::manager</span><span class="hljs-params">(<span class="hljs-type">void</span>* arg)</span> </span>&#123;<br>std::cout &lt;&lt; std::this_thread::<span class="hljs-built_in">get_id</span>() &lt;&lt; <span class="hljs-string">&quot; manager thread strating&quot;</span> &lt;&lt; std::endl;<br>threadPool* pool = <span class="hljs-built_in">static_cast</span>&lt;threadPool*&gt; (arg);<br><br><span class="hljs-keyword">while</span> (pool-&gt;m_isShutdown == <span class="hljs-literal">false</span>) &#123;<br>std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">2</span>));<br><span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">poolLock</span><span class="hljs-params">(pool-&gt;m_mutexPool)</span></span>;<br><span class="hljs-type">int</span> queueSize = pool-&gt;m_taskQueue-&gt;<span class="hljs-built_in">getTaskNum</span>();<br><br><span class="hljs-comment">// å”¤é†’ç­‰å¾…ä»»åŠ¡çš„çº¿ç¨‹</span><br><span class="hljs-type">int</span> sleepThreadNum = pool-&gt;m_aliveNum - pool-&gt;m_busyNum;<br><span class="hljs-keyword">if</span> (pool-&gt;m_busyNum &lt; queueSize) &#123;<br><span class="hljs-keyword">while</span> (sleepThreadNum &gt; <span class="hljs-number">0</span>) &#123;<br><span class="hljs-comment">// éšæœºå”¤é†’ä¸€ä¸ªwaitingä¸­çš„workerçº¿ç¨‹</span><br>pool-&gt;m_notEmpty.<span class="hljs-built_in">notify_one</span>();<br>sleepThreadNum--;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// ä»»åŠ¡æ•°&gt;çº¿ç¨‹æ•°æ—¶ï¼Œæ·»åŠ çº¿ç¨‹</span><br><span class="hljs-keyword">if</span> (queueSize &gt; pool-&gt;m_aliveNum &amp;&amp; pool-&gt;m_aliveNum &lt; pool-&gt;m_maxNum) &#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> count = <span class="hljs-number">0</span>; count &lt; m_addThreadNum &amp;&amp; pool-&gt;m_aliveNum &lt; pool-&gt;m_maxNum; count++) &#123;<br>pool-&gt;m_workThreads.<span class="hljs-built_in">push_back</span>(std::<span class="hljs-built_in">thread</span>(worker, pool));<br>pool-&gt;m_aliveNum++;<br>&#125;<br>&#125;<br>poolLock.<span class="hljs-built_in">unlock</span>();<br><br><span class="hljs-comment">// ä¼‘æ¯çº¿ç¨‹æ•°&gt;å·¥ä½œçº¿ç¨‹æ•°æ—¶ï¼Œé”€æ¯å¤šä½™çº¿ç¨‹</span><br>sleepThreadNum = pool-&gt;m_aliveNum - pool-&gt;m_busyNum;<br><span class="hljs-keyword">if</span> (sleepThreadNum &gt; pool-&gt;m_busyNum &amp;&amp; pool-&gt;m_aliveNum &gt; pool-&gt;m_minNum) &#123;<br>pool-&gt;m_exitNum = m_addThreadNum;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; m_addThreadNum; i++)<br>pool-&gt;m_notEmpty.<span class="hljs-built_in">notify_one</span>();<br>&#125;<br><br><span class="hljs-keyword">if</span> (pool-&gt;m_workThreads.<span class="hljs-built_in">size</span>() &gt; pool-&gt;m_aliveNum)<br>pool-&gt;<span class="hljs-built_in">threadExit</span>();<br>&#125;<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">threadPool::addTask</span><span class="hljs-params">(task newTask)</span> </span>&#123;<br>m_taskQueue-&gt;<span class="hljs-built_in">addTask</span>(newTask);<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">threadPool::threadExit</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">auto</span> iter = m_workThreads.<span class="hljs-built_in">begin</span>();<br><span class="hljs-keyword">while</span> (iter != m_workThreads.<span class="hljs-built_in">end</span>()) &#123;<br><span class="hljs-keyword">auto</span> currentThreadID = (*iter).<span class="hljs-built_in">native_handle</span>();<br><br><span class="hljs-comment">// å‘é€ä¿¡å·0ï¼Œæ¢æµ‹ä¿¡å·æ˜¯å¦å­˜æ´»</span><br><span class="hljs-type">int</span> kill = <span class="hljs-built_in">pthread_kill</span>(currentThreadID, <span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (kill == ESRCH) &#123;<br><span class="hljs-keyword">if</span> ((*iter).<span class="hljs-built_in">joinable</span>())<br>(*iter).<span class="hljs-built_in">join</span>();<br>iter = m_workThreads.<span class="hljs-built_in">erase</span>(iter);<br>std::cout &lt;&lt; <span class="hljs-string">&quot;thread&quot;</span> &lt;&lt; currentThreadID &lt;&lt; <span class="hljs-string">&quot; has exited&quot;</span> &lt;&lt; std::endl;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>iter++;<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-comment">/************************* test ****************************/</span><br>std::mutex mtxTask;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">testFun</span><span class="hljs-params">(<span class="hljs-type">void</span>* arg)</span> </span>&#123;<br><span class="hljs-type">int</span> num = *(<span class="hljs-type">int</span>*)arg;<br><br><span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mtxTask)</span></span>;<br>std::cout &lt;&lt; <span class="hljs-string">&quot;current thread id is&quot;</span> &lt;&lt; std::this_thread::<span class="hljs-built_in">get_id</span>() &lt;&lt; num &lt;&lt; std::endl;<br>std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">1</span>));<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-function">threadPool <span class="hljs-title">pool</span><span class="hljs-params">(<span class="hljs-number">2</span>, <span class="hljs-number">10</span>)</span></span>;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123;<br><span class="hljs-type">int</span>* num = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>(i);<br>pool.<span class="hljs-built_in">addTask</span>(<span class="hljs-built_in">task</span>(testFun, (<span class="hljs-type">void</span>*)num));<br>&#125;<br><br>std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">2</span>));<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä¸€äº›é—®é¢˜</strong>ï¼š</p><p><strong>Q</strong>ï¼šworker()å‡½æ•°ä¸­ï¼Œåº”è¯¥æŠŠoneTask.fun(oneTask.args);æ”¾åˆ°poolLock.unlock();ä¹‹å‰å—ï¼Ÿ</p><p><strong>A</strong>ï¼šä¸åº”è¯¥ï¼ŒpoolLockåªä¿è¯å„workerä»taskQueueä¸­å–ä»»åŠ¡æ—¶ä¸å†²çªã€ä¸ä¼šåŒä¸€ä¸ªä»»åŠ¡å–ä¸¤æ¬¡å°±è¡Œäº†ï¼Œè‡³äº<strong>ä»»åŠ¡å‡½æ•°ä¸­çš„çº¿ç¨‹å®‰å…¨ä¸åº”è¯¥ç”±threadPoolæ¥ä¿è¯ï¼Œé‚£æ˜¯ä»»åŠ¡å‡½æ•°è‡ªå·±çš„äº‹</strong>ï¼Œè¦çº¿ç¨‹å®‰å…¨å°±è‡ªå·±åœ¨å‡½æ•°å†…éƒ¨ä¸Šé”æˆ–atomicï¼ˆæœ¬æ¥çœŸå®åœºæ™¯ä¸­çš„ä»»åŠ¡å‡½æ•°å°±è‚¯å®šä¸ä¸€æ ·ï¼Œä¸ä¼šåƒè¿™ä¸ªdemoä¸­å…¨ç”¨ä¸€æ ·çš„å‡½æ•°ï¼Œä¹Ÿæ²¡åŠæ³•ç”±threadPoolæ¥ç»Ÿä¸€ä¸Šé”ï¼ŒæŒ‡ä¸å®šå„ä»»åŠ¡ä¹‹é—´æ ¹æœ¬æ²¡æœ‰å…±äº«èµ„æºï¼Œæœ¬èº«å°±ä¸éœ€è¦ä¸Šé”ï¼‰ï¼Œç”±threadPoolç»Ÿä¸€ä¸Šé”çš„è¯å¾ˆå®¹æ˜“é€ æˆçº¿ç¨‹å µå¡ï¼Œå…¶å®ƒçº¿ç¨‹åªæƒ³é¢†ä¸ªä»»åŠ¡åšè‡ªå·±çš„äº‹ï¼Œç»“æœè¿˜å¾—ç­‰å…¶å®ƒçº¿ç¨‹å…ˆå®Œæˆä»»åŠ¡åæ‰èƒ½é¢†å–ï¼Œè¿™å°±å¾ˆæµªè´¹ï¼Œå…¸å‹çš„é”ç²’åº¦å¤ªå¤§çš„åé¢æ•™æ</p><p><strong>Q</strong>ï¼šä¸ºä»€ä¹ˆworker()å’Œmanager()éƒ½è¦è®¾ä¸ºstaticï¼Ÿ</p><p><strong>A</strong>ï¼šstd::thread(worker, this)çš„å‡½æ•°åŸå‹ä¸ºï¼šthread(void *(&amp; f)(void *arg), threadPool *&amp;&amp; args)</p><p>å³ä¼ å…¥çš„å›è°ƒå‡½æ•°callbackä¸åº”è¯¥å¸¦æœ‰å‚æ•°ï¼Œè€Œç±»æˆå‘˜å‡½æ•°è‡ªå¸¦éšè—thisæŒ‡é’ˆå‚æ•°ï¼Œç›´æ¥threadæ„é€ ä¼šæŠ¥é”™ï¼Œè€Œstaticçš„ç±»æˆå‘˜å‡½æ•°ä¼šæ¶ˆé™¤éšè—thisæŒ‡é’ˆå‚æ•°</p><p><strong>Q</strong>ï¼šmanager()ä¸­å”¤é†’ç­‰å¾…çº¿ç¨‹æ—¶åº”è¯¥ç”¨notify_one()è¿˜æ˜¯notify_all()ï¼Ÿ</p><p><strong>A</strong>ï¼šnotify_one()ï¼Œå› ä¸ºoneæ˜¯å”¤é†’ä¸€ä¸ªcondition_variable.wait()ä¸­çš„çº¿ç¨‹ï¼Œå…·ä½“å“ªä¸ªç”±osçš„è°ƒåº¦å™¨æ¥å†³å®šï¼›allåˆ™æ˜¯å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œä½†æ­¤å¤„æœ¬æ¥ä¹Ÿåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å»é¢†ä»»åŠ¡ï¼Œå”¤é†’äº†å¤šä¸ªworkerå®ƒä»¬ä¹Ÿè¿˜æ˜¯ä¼šå»ç«äº‰poolLockï¼Œé€ æˆä¸å¿…è¦çš„å¼€é”€ã€‚notify_all()åº”è¯¥åœ¨å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶å¤„ç†ä»»åŠ¡çš„åœºæ™¯ä¸‹æ‰ä½¿ç”¨</p><p><strong>Q</strong>ï¼šthreadExit()ä¸­çš„if (kill == ESRCH)æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</p><p><strong>A</strong>ï¼šint kill = pthread_kill(currentThreadID, 0);ç”¨äºç»™çº¿ç¨‹å‘é€è¯•æ¢ä¿¡å·ï¼Œè¿”å›å€¼killå¦‚æœä¸º0ï¼Œè¡¨ç¤ºæ‰¾åˆ°äº†è¿™ä¸ªçº¿ç¨‹ï¼Œå³çº¿ç¨‹è¿˜åœ¨ç”Ÿå‘½å‘¨æœŸå†…ã€è¿˜åœ¨å·¥ä½œï¼Œå°±ä¸å›æ”¶ï¼›å¦‚æœkillä¸ºESRCHï¼Œè¡¨ç¤ºæ²¡æ‰¾åˆ°è¯¥çº¿ç¨‹ï¼Œè¯´æ˜å…¶ç”Ÿå‘½å‘¨æœŸå·²ç»ç»“æŸï¼Œå¯ä»¥å›æ”¶èµ„æºäº†ï¼ˆå°½ç®¡çº¿ç¨‹è‡ªå·±ä¼šææ„ï¼Œä½†è¿˜æœ‰äº›ç›¸å…³èµ„æºå¯èƒ½éœ€è¦äººä¸ºå¤„ç†ï¼Œå¦‚m_workThreads.erase()ï¼‰</p><p><strong>Q</strong>ï¼šmanager()ä¸­é”€æ¯å¤šä½™çº¿ç¨‹çš„æ€è·¯æ˜¯ä»€ä¹ˆï¼Ÿ</p><p><strong>A</strong>ï¼šæŠŠm_exitNumè®¾ä¸ºä¸€ä¸ªæ­£æ•°ï¼Œç„¶åå”¤é†’é‚£äº›ä¼‘æ¯ä¸­çš„çº¿ç¨‹ï¼ˆå³è¢«condition_variable.wait()é˜»å¡çš„çº¿ç¨‹ï¼‰ï¼Œworkerçº¿ç¨‹è¢«å”¤é†’ååˆ¤æ–­if (pool-&gt;m_exitNum &gt; 0)ã€returnã€ç»“æŸç”Ÿå‘½å‘¨æœŸã€ç­‰å¾…è¢«å›æ”¶èµ„æº</p>]]></content>
    
    
    <categories>
      
      <category>è‡ªå·±äº‹æƒ…é è‡ªå·±</category>
      
    </categories>
    
    
    <tags>
      
      <tag>c++</tag>
      
      <tag>å¤šçº¿ç¨‹</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ŠMIT-6S081ç¬”è®°ã€‹</title>
    <link href="/2024/09/03/%E3%80%8AMIT6.S081%E7%AC%94%E8%AE%B0%E3%80%8B/"/>
    <url>/2024/09/03/%E3%80%8AMIT6.S081%E7%AC%94%E8%AE%B0%E3%80%8B/</url>
    
    <content type="html"><![CDATA[<div class="note note-success">            <p>è¯¾ç¨‹æ¥æºï¼šMIT-6S081(20 summer)</p><p>è¯¾ç¨‹labï¼š<a href="https://github.com/qlhhahaha/MIT6.S081-20fall">https://github.com/qlhhahaha/MIT6.S081-20fall</a></p>          </div><h1>ã€ŠMIT6.S081ç¬”è®°ã€‹@qlhhahaha</h1><h1>Lecture1ã€Introduction and Examples</h1><ol><li><p>XV6é‡‡ç”¨ä¼ ç»Ÿçš„å†…æ ¸å½¢å¼ï¼Œåˆ†ä¸ºç”¨æˆ·æ€å’Œå†…æ ¸æ€</p><p><img src="https://s2.loli.net/2024/09/03/GYLkQ2BMjsuzXZI.png" alt=""></p><p>å½“ä¸€ä¸ªè¿›ç¨‹éœ€è¦è°ƒç”¨ä¸€ä¸ªå†…æ ¸æœåŠ¡æ—¶ï¼Œå®ƒä¼šè°ƒç”¨ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ˜¯æ“ä½œç³»ç»Ÿæ¥å£ä¸­çš„ä¸€ä¸ªè°ƒç”¨ã€‚ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸ï¼Œå†…æ ¸æ‰§è¡ŒæœåŠ¡å¹¶è¿”å›ã€‚å› æ­¤ï¼Œä¸€ä¸ªè¿›ç¨‹åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´äº¤æ›¿æ‰§è¡Œ</p><p>â€‹<div class="note note-warning">            <p>â€‹ğŸ’¡ PS.</p><p>â€‹æ³¨æ„ï¼Œxv6å’ŒPOSIXæ ‡å‡†æ˜¯ä¸å…¼å®¹çš„ï¼Œå®ƒç¼ºå°‘è®¸å¤šsyscallï¼Œä¸”å·²æœ‰çš„syscallæ ‡å‡†ä¹Ÿå’ŒPOSIXæœ‰å·®å¼‚ï¼›å¦å¤–xv6æ²¡æœ‰ç”¨æˆ·æ¦‚å¿µæˆ–è€…æä¾›ä¸€ä¸ªæœºåˆ¶æ¥ä¿æŠ¤ä¸€ä¸ªç”¨æˆ·ä¸å—å¦ä¸€ä¸ªç”¨æˆ·çš„å½±å“ï¼Œç”¨Unixçš„æœ¯è¯­æ¥è¯´ï¼Œæ‰€æœ‰çš„xv6è¿›ç¨‹éƒ½ä½œä¸ºrootè¿è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬è¯´xv6åªæ˜¯ä¸€ä¸ªâ€ç±»unixç³»ç»Ÿâ€</p><p>â€‹</p>          </div></p><p>Qï¼šç³»ç»Ÿè°ƒç”¨è·³åˆ°å†…æ ¸ä¸æ ‡å‡†çš„å‡½æ•°è°ƒç”¨è·³åˆ°å¦ä¸€ä¸ªå‡½æ•°ç›¸æ¯”ï¼ŒåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>Aï¼š<strong>Kernel</strong>çš„ä»£ç æ€»æ˜¯æœ‰<strong>ç‰¹æ®Šçš„æƒé™</strong>ã€‚å½“æœºå™¨å¯åŠ¨Kernelæ—¶ï¼ŒKernelä¼šæœ‰ç‰¹æ®Šçš„æƒé™èƒ½ç›´æ¥è®¿é—®å„ç§å„æ ·çš„ç¡¬ä»¶ï¼Œä¾‹å¦‚ç£ç›˜ã€‚è€Œæ™®é€šçš„ç”¨æˆ·ç¨‹åºæ˜¯æ²¡æœ‰åŠæ³•ç›´æ¥è®¿é—®è¿™äº›ç¡¬ä»¶çš„ã€‚æ‰€ä»¥ï¼Œæ‰§è¡Œä¸€ä¸ªæ™®é€šçš„å‡½æ•°è°ƒç”¨æ—¶ï¼Œæ‰€è°ƒç”¨çš„å‡½æ•°å¹¶æ²¡æœ‰å¯¹äºç¡¬ä»¶çš„ç‰¹æ®Šæƒé™ã€‚ç„¶è€Œï¼Œå¦‚æœè§¦å‘ç³»ç»Ÿè°ƒç”¨åˆ°å†…æ ¸ä¸­ï¼Œå†…æ ¸ä¸­çš„å…·ä½“å®ç°ä¼šå…·æœ‰è¿™äº›ç‰¹æ®Šçš„æƒé™ï¼Œè¿™æ ·å°±èƒ½<strong>ä¿®æ”¹æ•æ„Ÿçš„å’Œè¢«ä¿æŠ¤çš„ç¡¬ä»¶èµ„æº</strong>ï¼Œæ¯”å¦‚è®¿é—®ç¡¬ä»¶ç£ç›˜ã€‚</p></li><li><p>argv[0]é»˜è®¤æ˜¯ç¨‹åºåç§°ï¼Œæ‰€ä»¥æ‰§è¡Œecho hello worldæ—¶ï¼Œargc=strlen(argv)ä¸º3ï¼Œargv[1]=â€œhelloâ€ï¼Œargv[2]=â€œworldâ€</p></li><li><p><strong>å…³äºreturnå’Œexit()</strong></p><p>é¦–å…ˆåœ¨å®šä¹‰å±‚é¢ï¼Œreturnå’Œexit()çš„åŒºåˆ«æ˜¯ï¼š</p><ul><li><p>returnæ˜¯å…³é”®å­—ï¼Œè¡¨ç¤ºè°ƒç”¨å †æ ˆçš„è¿”å›ï¼Œåªç»“æŸä¸€ä¸ªå‡½æ•°ï¼Œä¸ä¸€å®šç»“æŸæ•´ä¸ªç¨‹åº</p></li><li><p>exit()æ˜¯syscallï¼Œè¡¨ç¤ºä¸€ä¸ªè¿›ç¨‹çš„ç»“æŸï¼Œå®ƒä¼šç»ˆæ­¢å½“å‰è¿›ç¨‹ï¼Œå¹¶å°†çŠ¶æ€æŠ¥å‘Šç»™wait()å‡½æ•°ï¼Œä¸€èˆ¬æ˜¯ 0 ä¸ºæ­£å¸¸é€€å‡ºï¼Œ é0 ä¸ºéæ­£å¸¸é€€å‡º</p></li></ul><p><strong>Q</strong>ï¼šåœ¨main()ä¸­return 0å’Œexit(0)æœ‰å•¥åŒºåˆ«ï¼Ÿ</p><p><strong>A</strong>ï¼šä»æ•ˆæœä¸Šæ¥è®²ï¼Œæ²¡åŒºåˆ«</p><p><strong>Q</strong>ï¼šémain()çš„æ™®é€šå‡½æ•°ä¸­å‘¢ï¼Ÿ</p><p><strong>A</strong>ï¼šexit(0)å¯ä»¥æ”¾åœ¨ä»»ä½•ä½ç½®æ¥é€€å‡ºç¨‹åºï¼Œç±»ä¼¼äºcppçš„throw</p><p><strong>Q</strong>ï¼šä¸ºä»€ä¹ˆmain()ä¸­æ˜¯return 0è€Œä¸æ˜¯return 1ï¼Ÿ</p><p><strong>A</strong>ï¼šmainä¸­returnå°±ç›¸å½“äºexit()ï¼Œè€Œexit()çš„å‚æ•°è¯´æ˜ï¼š</p><ul><li>å¦‚æœå‚æ•°ä¸º 0 æˆ–è€… EXIT_SUCCESSï¼Œå‘å¤–éƒ¨ç¯å¢ƒæŠ¥å‘Šç¨‹åºè¿è¡Œåœ†æ»¡ç»“æŸ</li><li>å¦‚æœå‚æ•°ä¸º EXIT_FAILUREï¼Œå‘å¤–éƒ¨ç¯å¢ƒæŠ¥å‘Šç¨‹åºè¿è¡Œä»¥å¤±è´¥å‘Šç»ˆ</li><li>å¦‚æœå‚æ•°ä¸ºå…¶å®ƒå€¼ï¼Œæ•ˆæœç”±å®ç°å®šä¹‰</li></ul><p>æ‰€ä»¥è¯´return 0æ˜¯æœ‰æ˜ç¡®è¯­ä¹‰çš„ï¼Œè€Œreturn 1åˆ™<strong>ä¸å…·å¤‡å¯ç§»æ¤æ€§</strong></p><p><strong>Q</strong>ï¼šå¦‚æœmain()ä¸­ä¸ä½¿ç”¨returnå‘¢ï¼ˆä»æ±‡ç¼–è§’åº¦ç†è§£ï¼‰ï¼Ÿ</p><p><strong>A</strong>ï¼š</p><ul><li>å¦‚æœä¸å†™returnï¼Œæ±‡ç¼–ä¼šè‡ªåŠ¨ç”Ÿæˆreturn</li><li>å¦‚æœå†™äº†returnï¼Œæ±‡ç¼–ä¼šç”Ÿæˆç›¸å½“äºexit(main())çš„è¯­å¥</li><li>å¦‚æœç›´æ¥å†™exit()ï¼Œå°±ä¸ä¼šç”Ÿæˆexit(main())ï¼Œç¨‹åºç›´æ¥é€€å‡ºäº†</li></ul></li></ol><p>æ€»ç»“è¯´ï¼Œä¸€ä¸ªç¨‹åºçœŸæ­£çš„é€€å‡ºï¼Œåœ¨Cè¯­è¨€å±‚é¢ä¸Šï¼Œå®é™…æ˜¯exit()å‡½æ•°ï¼Œè€Œmainå‡½æ•°çš„ä½œç”¨ï¼Œåˆ™æ˜¯ç»™exit()æä¾›è¿”å›å€¼</p><ol start="4"><li><p><strong>atoi()</strong></p> <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">atoi</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *s)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> n;<br><br>    n = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-string">&#x27;0&#x27;</span> &lt;= *s &amp;&amp; *s &lt;= <span class="hljs-string">&#x27;9&#x27;</span>)<br>        n = n * <span class="hljs-number">10</span> + *s++ - <span class="hljs-string">&#x27;0&#x27;</span>;<br>    <span class="hljs-keyword">return</span> n;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»†èŠ‚ï¼šä¸ºä»€ä¹ˆè¦å‡å»â€˜0â€™ï¼Ÿ</p><p>å› ä¸ºn = n * 10 + *s++ - â€˜0â€™è¿™ä¸€è¡Œä¸­å…¶å®åŒ…å«äº†charåˆ°intçš„éšå¼ç±»å‹è½¬æ¢ï¼Œå­—ç¬¦â€˜0â€™å¯¹åº”intå€¼æ˜¯48ã€‚æ¯”å¦‚è¾“å…¥â€œ123â€ï¼Œç¬¬ä¸€æ¬¡n = â€™1â€˜ - â€™0â€˜ = 1ï¼Œæ²¡è¿™ä¸ªâ€™0â€˜çš„è¯nå°±ä¸º49äº†</p></li></ol><h1>LECTURE2ã€OS organization and syscall</h1><ol><li><p><strong>æ“ä½œç³»ç»Ÿçš„éš”ç¦»æ€§ï¼ˆisolationï¼‰</strong></p><p><strong>motivation</strong>ï¼šç”¨æˆ·ç©ºé—´ä¸­æœ‰å¤šä¸ªåº”ç”¨ç¨‹åºï¼ˆshellã€echoã€findï¼‰ï¼Œä¸€ä¸ªåº”ç”¨ç¨‹åºå‡ºé”™æ—¶ä¸åº”è¯¥å½±å“å…¶å®ƒåº”ç”¨ï¼Œæ‰€ä»¥<strong>ä¸åŒçš„åº”ç”¨ç¨‹åºä¹‹é—´</strong>åº”è¯¥è¦æœ‰éš”ç¦»æ€§ï¼›ç±»ä¼¼çš„ï¼Œæˆ‘ä»¬ä¹Ÿä¸å¸Œæœ›åº”ç”¨ç¨‹åºçš„å‡ºé”™ä¼šå¯¼è‡´æ•´ä¸ªOSçš„crashï¼Œæ‰€ä»¥<strong>åº”ç”¨ç¨‹åºå’ŒOSä¹‹é—´</strong>ä¹Ÿåº”è¯¥å…·æœ‰éš”ç¦»æ€§</p><p>æƒ³æƒ³å¦‚æœæ²¡æœ‰éš”ç¦»æ€§ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p><p>å„ä¸ªåº”ç”¨ç¨‹åºç›´æ¥ä¸ç¡¬ä»¶äº¤äº’ï¼Œå‡å¦‚shellä¸­æŸä¸ªå‡½æ•°æœ‰æ­»å¾ªç¯ï¼Œåˆ™shellæ°¸è¿œä¸ä¼šé‡Šæ”¾cpuï¼Œç”šè‡³æ²¡åŠæ³•é€šè¿‡ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„ç¨‹åºå»killï¼›è€Œæœ‰äº†æ“ä½œç³»ç»Ÿï¼Œä¸è®ºåº”ç”¨ç¨‹åºåœ¨æ‰§è¡Œä»€ä¹ˆæ“ä½œï¼Œmultiplexingéƒ½ä¼šè¿«ä½¿åº”ç”¨ç¨‹åºæ—¶ä¸æ—¶çš„é‡Šæ”¾CPUï¼Œè¿™æ ·å…¶ä»–çš„åº”ç”¨ç¨‹åºæ‰èƒ½è¿è¡Œ</p><p>å¦å¤–ä»å†…å­˜çš„è§’åº¦æ¥è¯´ï¼Œå¦‚æœåº”ç”¨ç¨‹åºç›´æ¥è¿è¡Œåœ¨ç¡¬ä»¶èµ„æºä¹‹ä¸Šï¼Œé‚£ä¹ˆæ¯ä¸ªåº”ç”¨ç¨‹åºçš„æ–‡æœ¬ï¼Œä»£ç å’Œæ•°æ®éƒ½ç›´æ¥ä¿å­˜åœ¨ç‰©ç†å†…å­˜ä¸­ã€‚ç‰©ç†å†…å­˜ä¸­çš„ä¸€éƒ¨åˆ†è¢«Shellä½¿ç”¨ï¼Œå¦ä¸€éƒ¨åˆ†è¢«echoä½¿ç”¨</p> <img src="https://s2.loli.net/2024/09/03/VodEmgYiAFIPNSC.png" style="zoom:80%;" /><p>é‚£ä¹ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸ºä¸¤ä¸ªåº”ç”¨ç¨‹åºçš„å†…å­˜ä¹‹é—´æ²¡æœ‰è¾¹ç•Œï¼Œå¦‚æœechoç¨‹åºå°†æ•°æ®å­˜å‚¨åœ¨å±äºShellçš„ä¸€ä¸ªå†…å­˜åœ°å€ä¸­ï¼ˆä¸Šå›¾ä¸­çš„1000ï¼‰ï¼Œé‚£ä¹ˆå°±echoå°±ä¼šè¦†ç›–Shellç¨‹åºå†…å­˜ä¸­çš„å†…å®¹</p><p>â€‹<div class="note note-warning">            <p>â€‹ğŸ’¡ PS.</p><p>â€‹OSä¸æ˜¯ç›´æ¥å°†CPUæä¾›ç»™åº”ç”¨ç¨‹åºï¼Œè€Œæ˜¯å‘åº”ç”¨ç¨‹åºæä¾›â€œè¿›ç¨‹â€ï¼Œi.e. è¿›ç¨‹æŠ½è±¡äº†CPUï¼Œåº”ç”¨ç¨‹åºä¸èƒ½ç›´æ¥ä¸CPUäº¤äº’ï¼Œåªèƒ½ä¸è¿›ç¨‹äº¤äº’</p><p>â€‹</p>          </div></p></li><li><p><strong>æ“ä½œç³»ç»Ÿçš„é˜²å¾¡æ€§ï¼ˆDefensiveï¼‰</strong></p><p><strong>motivation</strong>ï¼šOSåº”è¯¥èƒ½æŠµå¾¡å¤–æ¥åº”ç”¨ç¨‹åºçš„æ”»å‡»ï¼Œé¿å…åº”ç”¨ç¨‹åºæ§åˆ¶å†…æ ¸ï¼ˆä¸€æ—¦æ‹¥æœ‰å†…æ ¸å°±å¯ä»¥æ§åˆ¶æ‰€æœ‰ç¡¬ä»¶èµ„æºï¼‰</p></li><li><p><strong>ç¡¬ä»¶å¯¹äºéš”ç¦»/é˜²å¾¡çš„æ”¯æŒ</strong></p><ul><li><p><strong>user/kernel mode</strong></p><p>useræ¨¡å¼ä¸‹åªèƒ½æ‰§è¡Œæ™®é€šæƒé™çš„æŒ‡ä»¤ï¼Œå¦‚addã€subã€branch</p><p>kernelæ¨¡å¼ä¸‹èƒ½æ‰§è¡Œç‰¹æƒæŒ‡ä»¤ï¼Œä¸»è¦æ˜¯<strong>ç›´æ¥æ“çºµç¡¬ä»¶</strong>çš„æŒ‡ä»¤å’Œ<strong>è®¾ç½®ä¿æŠ¤</strong>çš„æŒ‡ä»¤ï¼Œå¦‚è®¾ç½®page tableå¯„å­˜å™¨ã€å…³é—­æ—¶é’Ÿä¸­æ–­</p><p>å½“ä¸€ä¸ªåº”ç”¨ç¨‹åºå°è¯•æ‰§è¡Œä¸€æ¡ç‰¹æ®Šæƒé™æŒ‡ä»¤æ—¶ï¼Œå› ä¸ºä¸å…è®¸åœ¨user modeæ‰§è¡Œç‰¹æ®Šæƒé™æŒ‡ä»¤ï¼Œå¤„ç†å™¨ä¼šæ‹’ç»æ‰§è¡Œè¿™æ¡æŒ‡ä»¤ã€‚é€šå¸¸æ¥è¯´ï¼Œè¿™æ—¶æ§åˆ¶æƒé™ä¼šä»user modeåˆ‡æ¢åˆ°kernel modeï¼Œå½“æ“ä½œç³»ç»Ÿæ‹¿åˆ°æ§åˆ¶æƒä¹‹åï¼Œæˆ–è®¸ä¼šæ€æ‰è¿›ç¨‹ï¼Œå› ä¸ºåº”ç”¨ç¨‹åºæ‰§è¡Œäº†ä¸è¯¥æ‰§è¡Œçš„æŒ‡ä»¤</p><p>â€‹<div class="note note-warning">            <p>â€‹ğŸ’¡ PS.</p><p>â€‹å…·ä½“æ¥è®²ï¼Œæ˜¯CPUä¸­æœ‰ä¸€ä¸ªbitï¼Œä¸º1æ—¶è¡¨ç¤ºuser modeï¼Œ0è¡¨ç¤ºkernel modeï¼Œå½“CPUåœ¨è§£ææŒ‡ä»¤æ—¶ï¼Œè‹¥æŒ‡ä»¤æ˜¯ç‰¹æ®Šæƒé™æŒ‡ä»¤ï¼Œä¸”è¯¥bitè¢«è®¾ç½®ä¸º1ï¼Œåˆ™å¤„ç†å™¨ä¼šæ‹’ç»æ‰§è¡Œè¿™æ¡æŒ‡ä»¤ â€”â€” å½“ç„¶ï¼ŒåŒæ ·éœ€è¦ç‰¹æƒæŒ‡ä»¤æ‰èƒ½æ›´æ–°è¿™ä¸ªbit</p><p>â€‹</p>          </div></p></li><li><p><strong>è™šæ‹Ÿå†…å­˜</strong></p><p>æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„page tableï¼Œåªèƒ½è®¿é—®å‡ºç°åœ¨è‡ªå·±page tableä¸­çš„ç‰©ç†å†…å­˜ã€‚è€ŒOSä¼šè®¾ç½®page tableï¼Œä½¿å¾—æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸é‡åˆçš„ç‰©ç†å†…å­˜ï¼Œä»è€Œå®ç°å†…å­˜çš„éš”ç¦»</p></li></ul></li><li><p><strong>userè¿›å…¥kernelçš„æ–¹å¼</strong>ï¼š<strong>ecallæŒ‡ä»¤</strong></p><p>å½“ä¸€ä¸ªç”¨æˆ·ç¨‹åºæƒ³è¦å°†ç¨‹åºæ‰§è¡Œçš„æ§åˆ¶æƒè½¬ç§»åˆ°å†…æ ¸ï¼Œå®ƒåªéœ€è¦æ‰§è¡ŒECALLæŒ‡ä»¤ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ªæ•°å­—ï¼Œæ•°å­—å‚æ•°ä»£è¡¨äº†åº”ç”¨ç¨‹åºæƒ³è¦è°ƒç”¨çš„System Callã€‚ å¦‚ï¼Œä¸è®ºæ˜¯Shellè¿˜æ˜¯å…¶ä»–çš„åº”ç”¨ç¨‹åºï¼Œå½“å®ƒåœ¨ç”¨æˆ·ç©ºé—´æ‰§è¡Œforkæ—¶ï¼Œå®ƒå¹¶ä¸æ˜¯ç›´æ¥è°ƒç”¨æ“ä½œç³»ç»Ÿä¸­å¯¹åº”çš„å‡½æ•°ï¼Œè€Œæ˜¯è°ƒç”¨ECALLæŒ‡ä»¤ï¼Œå¹¶å°†forkå¯¹åº”çš„æ•°å­—ä½œä¸ºå‚æ•°ä¼ ç»™ECALLã€‚ä¹‹åå†é€šè¿‡ECALLè·³è½¬åˆ°å†…æ ¸</p></li><li><p><strong>what is QEMUï¼Ÿ</strong></p><p>ä»åŠŸèƒ½ä¸Šæ¥è¯´ï¼ŒQEMUå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªçœŸæ­£çš„è®¡ç®—æœºã€ä¸€å—RISC-Vä¸»æ¿ï¼Œå®ƒæ¨¡æ‹Ÿå®ç°äº†ä¸»æ¿å¼€å…³ã€æ’æ§½ã€å†…å­˜èŠ¯ç‰‡åŠŸèƒ½ï¼Œè¿è¡ŒQEMUç­‰æ•ˆäºè¿è¡Œç¡¬ä»¶ï¼›ä»ä»£ç è§’åº¦è¯´ï¼ŒQEMUæ˜¯ä¸€ä¸ªå¤§å‹çš„å¼€æºCç¨‹åºï¼Œåœ¨QEMUçš„ä¸»å¾ªç¯ä¸­ï¼Œåªåœ¨åšä¸€ä»¶äº‹æƒ…ï¼š</p><ul><li>è¯»å–4å­—èŠ‚æˆ–è€…8å­—èŠ‚çš„RISC-VæŒ‡ä»¤</li><li>è§£æRISC-VæŒ‡ä»¤ï¼Œå¹¶æ‰¾å‡ºå¯¹åº”çš„æ“ä½œç ï¼ˆop codeï¼‰ã€‚æˆ‘ä»¬ä¹‹å‰åœ¨çœ‹kernel.asmçš„æ—¶å€™ï¼Œçœ‹è¿‡ä¸€äº›æ“ä½œç çš„äºŒè¿›åˆ¶ç‰ˆæœ¬ã€‚é€šè¿‡è§£æå¯ä»¥çŸ¥é“è¿™æ˜¯ä¸€ä¸ªADDæŒ‡ä»¤ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªSUBæŒ‡ä»¤</li><li>ä¹‹åï¼Œåœ¨è½¯ä»¶ä¸­æ‰§è¡Œç›¸åº”çš„æŒ‡ä»¤</li></ul></li><li><p><strong>XV6ä»£ç ç»„ç»‡ç»“æ„</strong></p> <img src="https://s2.loli.net/2024/09/03/6jaoXbuNvBzxYZi.png" style="zoom:67%;" /> <img src="https://s2.loli.net/2024/09/03/HLzU6FRlStZOWb2.png" style="zoom:67%;" /></li><li><p><strong>XV6ä¸­çš„21ä¸ªsyscall</strong></p> <img src="https://s2.loli.net/2024/09/03/nC95tEoTLUpbghZ.png" style="zoom:80%;" /> <img src="https://s2.loli.net/2024/09/03/AdISovODLnx6YXh.png" style="zoom:80%;" /></li><li><p><strong>XV6å¯„å­˜å™¨</strong></p> <img src="https://s2.loli.net/2024/09/03/Oh76RSXWuQesJBa.png" style="zoom:80%;" /><ul><li><strong>0å¯„å­˜å™¨</strong>ï¼šrisc-vä¸“é—¨ä¸º0è®¾ç½®äº†ä¸€ä¸ªå¯„å­˜å™¨ï¼Œè¿™ä¸ªå¯„å­˜å™¨åªå¯è¯»è€Œä¸å¯å†™ï¼Œæ°¸è¿œä¿æŒ0çš„çŠ¶æ€ã€‚<strong>x0</strong>å¯„å­˜å™¨ä¸“é—¨å®Œæˆè¿™ä¸€é¡¹å·¥ä½œã€‚é‰´äº0çš„ä½¿ç”¨é¢‘ç‡å¹¶ä¸ç®—å°‘ï¼Œè¿™ä¸ªç®€å•çš„æ€è·¯å¯ä»¥å¸¦æ¥æ•ˆç‡ä¸ŠæƒŠäººçš„æå‡ã€‚</li><li><strong>è¿”å›åœ°å€å¯„å­˜å™¨ï¼ˆraï¼‰åŠæ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼ˆspï¼‰</strong>ï¼š<strong>x1</strong>å¯„å­˜å™¨ä¿å­˜äº†æ ˆæ•°æ®ä¸­è¿”å›çš„åœ°å€ï¼Œè€Œ<strong>x2</strong>ä¿å­˜äº†æ ˆé¡¶çš„ä½ç½®</li><li><strong>å…¨å±€æŒ‡é’ˆå¯„å­˜å™¨ï¼ˆgpï¼‰</strong>ï¼š<strong>x3</strong>çš„ä½œç”¨ä¸ºå®ç°4KBå¤§å°èŒƒå›´å†…çš„è®¿é—®åŠ é€Ÿã€‚è¿™å¯¹é¡µå†…å¯»å€æœ‰ç€éå¸¸ä¸é”™çš„æ•ˆæœï¼Œä¸è¿‡å¯¹ä¸»ä½“è¿è¡ŒåŸç†æ²¡æœ‰ä»€ä¹ˆå¤ªå¤§å½±å“</li><li><strong>çº¿ç¨‹æŒ‡é’ˆå¯„å­˜å™¨ï¼ˆtpï¼‰</strong>ï¼šå½“å‰ç¡¬ä»¶çº¿ç¨‹ç¼–å·ï¼Œä¸»è¦æ˜¯æ–¹ä¾¿å®ç°å„ä¸ªç¡¬ä»¶çº¿ç¨‹çš„åŒºåˆ†</li><li><strong>æš‚å­˜å¯„å­˜å™¨ï¼ˆt0~t6ï¼‰</strong>ï¼šç”¨äºä¿å­˜ä¸´æ—¶æ•°</li><li><strong>å­˜å‚¨å¯„å­˜å™¨ï¼ˆs0~s10ï¼‰</strong>ï¼šä¿å­˜å¿…è¦çš„æ•°æ®ã€‚è¿™éƒ¨åˆ†æ•°æ®åœ¨<strong>åˆ‡æ¢ä¸Šä¸‹æ–‡</strong>çš„æ—¶å€™ä¼šå¾—åˆ°ä¿å­˜ï¼Œè€Œä¸æ˜¯è¦†ç›–</li><li><strong>å‚æ•°å¯„å­˜å™¨ï¼ˆa0~a7ï¼‰</strong>ï¼šä¿å­˜å‡½æ•°å‚æ•°ã€‚è°ƒç”¨å‡½æ•°æ—¶ï¼Œå‚æ•°å°†æŒ‰é¡ºåºå­˜æ”¾åœ¨è¿™äº›å¯„å­˜å™¨ä¸­ï¼Œç›¸åº”åœ°ï¼Œä½¿ç”¨å‚æ•°çš„æ­¥éª¤ä¼šåœ¨æ±‡ç¼–ä¸­è½¬åŒ–ä¸ºè¯»å–å‚æ•°å¯„å­˜å™¨çš„å†…å®¹ ä½†æ˜¯æ³¨æ„ï¼š**a0å’Œa1æ¯”è¾ƒç‰¹æ®Šã€‚**å®ƒä»¬ä¸ä»…æ‹…ä»»å‡½æ•°è°ƒç”¨æ—¶çš„ä¼ å‚è¿‡ç¨‹ï¼Œè¿˜åœ¨è¿”å›æ—¶æ‹…ä»»å­˜æ”¾è¿”å›å€¼ï¼› <strong>a7ä¸ä»…æ˜¯å‚æ•°å¯„å­˜å™¨ï¼Œè¿˜æ˜¯ç”¨æ¥è¡¨ç¤ºç³»ç»Ÿè°ƒç”¨å·</strong>ã€‚å½“é‡‡å–riscvçš„ç³»ç»Ÿè°ƒç”¨æŒ‡ä»¤<code>ecall</code>åï¼Œç¡¬ä»¶å°†æ ¹æ®a7å†…çš„æ•°æ®ï¼Œäºä¸­æ–­å‘é‡è¡¨ä¸­å¯åŠ¨å¯¹åº”ç¼–å·çš„ä¸­æ–­è¿›ç¨‹ ï¼ˆusys.plä¸­çš„â€li a7, SYS_${name}â€ï¼‰</li></ul></li><li><p><strong>vscodeä¸­è°ƒè¯•XV6</strong></p><ul><li><p>æ¯æ¬¡åœ¨vscodeä¸­æ‰“å¼€æ–‡ä»¶å¤¹æ—¶ä¸è¦æ‰“å¼€MIT_6S081_20fallè¿™ä¸ªä¸Šçº§ç›®å½•ï¼Œè¦æ‰“å¼€MIT6.S081-20fallè¿™ä¸ªå­ç›®å½•</p></li><li><p>åœ¨MIT6.S081-20fallå­ç›®å½•ä¸‹åˆ›å»º.vscodeæ–‡ä»¶ï¼ŒæŠŠdebug_jsonä¸­çš„5ä¸ªjsonæ–‡ä»¶å…¨å¤åˆ¶è¿‡å»</p><p><img src="https://s2.loli.net/2024/09/03/YV1iLzlt3SZWbMf.png" alt=""></p></li><li><p>æ³¨é‡Šé…ç½®æ–‡ä»¶ä¸­çš„ç«¯å£å·</p></li></ul><p><img src="https://s2.loli.net/2024/09/03/57lazcmAKbp4nTL.png" alt=""></p><ul><li><p>åœ¨main.cçš„ç¬¬ä¸€è¡Œæ‰“æ–­ç‚¹ï¼Œç›´æ¥æŒ‰F5 debug</p>  <img src="https://s2.loli.net/2024/09/03/gkcj68arZ2t5Gpb.png" style="zoom:80%;" /></li></ul></li><li><p><strong>XV6ä¸­syscallçš„è°ƒç”¨å’Œå®ç°è¿‡ç¨‹</strong></p><p><strong>user</strong>ï¼š</p><ul><li><strong><a href="http://usys.pl">usys.pl</a></strong>ï¼šè‡ªåŠ¨ç”Ÿæˆusys.Sæ±‡ç¼–æ–‡ä»¶ï¼Œé‡Œé¢å®šä¹‰äº†æŸä¸ªsyscallçš„ç”¨æˆ·æ€è·³æ¿å‡½æ•°</li></ul><img src="https://s2.loli.net/2024/09/03/BjZMG42OJSaHm7g.png" style="zoom:80%;" /><ul><li><strong>user.h</strong>ï¼šsyscallå‡½æ•°å£°æ˜</li></ul><img src="https://s2.loli.net/2024/09/03/ndacSW5EkKuBCM9.png" style="zoom:80%;" /><p><strong>kernel</strong>ï¼š</p><ul><li><p><strong>syscall.h</strong>ï¼šdefine syscall numbers</p>  <img src="https://s2.loli.net/2024/09/03/pTstS4LPWh7ndz9.png" style="zoom:80%;" /></li><li><p><strong>syscall.c</strong>ï¼šé€šè¿‡ä¸€ä¸ªé€šç”¨æ¨¡æ¿æ¥æ‰§è¡Œsyscall</p>  <img src="https://s2.loli.net/2024/09/03/mlaxRTS8pftojJz.png" style="zoom:67%;" /></li><li><p><strong>sysproc.c</strong>ï¼šsyscallçš„å…·ä½“å®ç°</p>  <img src="https://s2.loli.net/2024/09/03/TrBLkzOGf5Ntq2u.png" style="zoom:80%;" /></li><li><p><strong>proc.h</strong>ï¼šå®šä¹‰procã€trapframeã€contextç­‰é‡è¦ç»“æ„ä½“</p>  <img src="https://s2.loli.net/2024/09/03/yQdLTz8cfYMiZax.png" style="zoom:67%;" /></li><li><p><strong>proc.c</strong>ï¼šprocç›¸å…³å‡½æ•°çš„å…·ä½“å®ç°</p>  <img src="https://s2.loli.net/2024/09/03/sDgnXJVfhvimRLx.png" style="zoom:80%;" /><p>ç³»ç»Ÿè°ƒç”¨å…¨æµç¨‹ï¼š</p>  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp">user/user.h:ç”¨æˆ·æ€ç¨‹åºè°ƒç”¨è·³æ¿å‡½æ•° <span class="hljs-built_in">trace</span>()<br>user/usys.S:è·³æ¿å‡½æ•° <span class="hljs-built_in">trace</span>() ä½¿ç”¨ CPU æä¾›çš„ ecall æŒ‡ä»¤ï¼Œè°ƒç”¨åˆ°å†…æ ¸æ€<br>kernel/syscall.cåˆ°è¾¾å†…æ ¸æ€ç»Ÿä¸€ç³»ç»Ÿè°ƒç”¨å¤„ç†å‡½æ•° <span class="hljs-built_in">syscall</span>()ï¼Œæ‰€æœ‰ç³»ç»Ÿè°ƒç”¨éƒ½ä¼šè·³åˆ°è¿™é‡Œæ¥å¤„ç†ã€‚<br>kernel/syscall.<span class="hljs-function">c<span class="hljs-title">syscall</span><span class="hljs-params">()</span> æ ¹æ®è·³æ¿ä¼ è¿›æ¥çš„ç³»ç»Ÿè°ƒç”¨ç¼–å·ï¼ŒæŸ¥è¯¢ syscalls[] è¡¨ï¼Œæ‰¾åˆ°å¯¹åº”çš„å†…æ ¸å‡½æ•°å¹¶è°ƒç”¨ã€‚</span><br><span class="hljs-function">kernel/sysproc.cåˆ°è¾¾ <span class="hljs-title">sys_trace</span><span class="hljs-params">()</span> å‡½æ•°ï¼Œæ‰§è¡Œå…·ä½“å†…æ ¸æ“ä½œ</span><br></code></pre></td></tr></table></figure><p>è¿™ä¹ˆç¹ççš„è°ƒç”¨æµç¨‹çš„ä¸»è¦ç›®çš„æ˜¯å®ç°<strong>ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„è‰¯å¥½éš”ç¦»</strong>ã€‚</p><p>å¹¶ä¸”ç”±äºå†…æ ¸ä¸ç”¨æˆ·è¿›ç¨‹çš„é¡µè¡¨ä¸åŒï¼Œå¯„å­˜å™¨ä¹Ÿä¸äº’é€šï¼Œæ‰€ä»¥å‚æ•°æ— æ³•ç›´æ¥é€šè¿‡ C è¯­è¨€å‚æ•°çš„å½¢å¼ä¼ è¿‡æ¥ï¼Œè€Œæ˜¯éœ€è¦ä½¿ç”¨ argaddrã€argintã€argstr ç­‰ç³»åˆ—å‡½æ•°ï¼Œä»è¿›ç¨‹çš„ trapframe ä¸­è¯»å–ç”¨æˆ·è¿›ç¨‹å¯„å­˜å™¨ä¸­çš„å‚æ•°ã€‚</p><p>åŒæ—¶ç”±äºé¡µè¡¨ä¸åŒï¼ŒæŒ‡é’ˆä¹Ÿä¸èƒ½ç›´æ¥äº’é€šè®¿é—®ï¼ˆä¹Ÿå°±æ˜¯å†…æ ¸ä¸èƒ½ç›´æ¥å¯¹ç”¨æˆ·æ€ä¼ è¿›æ¥çš„æŒ‡é’ˆè¿›è¡Œè§£å¼•ç”¨ï¼‰ï¼Œè€Œæ˜¯éœ€è¦ä½¿ç”¨ copyinã€copyout æ–¹æ³•ç»“åˆè¿›ç¨‹çš„é¡µè¡¨ï¼Œæ‰èƒ½é¡ºåˆ©æ‰¾åˆ°ç”¨æˆ·æ€æŒ‡é’ˆï¼ˆé€»è¾‘åœ°å€ï¼‰å¯¹åº”çš„ç‰©ç†å†…å­˜åœ°å€ã€‚</p></li></ul></li></ol><h1>LECTURE3ã€Page tables</h1><ol><li><p><strong>æ¦‚å¿µ</strong>ï¼š</p><p>é¡µè¡¨æ˜¯æ“ä½œç³»ç»Ÿä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›ç§æœ‰åœ°å€ç©ºé—´å’Œå†…å­˜çš„æœºåˆ¶ã€‚ RISC-VæŒ‡ä»¤ï¼ˆåŒ…æ‹¬ç”¨æˆ·æŒ‡ä»¤å’Œå†…æ ¸æŒ‡ä»¤ï¼‰ä½¿ç”¨çš„æ˜¯è™šæ‹Ÿåœ°å€ï¼Œè€Œæœºå™¨çš„RAMæˆ–ç‰©ç†å†…å­˜æ˜¯ç”±ç‰©ç†åœ°å€ç´¢å¼•çš„ã€‚è€Œé¡µè¡¨å°±æ˜¯å°†æ¯ä¸ªè™šæ‹Ÿåœ°å€æ˜ å°„åˆ°ç‰©ç†åœ°å€ï¼Œä»è€Œåœ¨ä¸¤ç§åœ°å€é—´å»ºç«‹è”ç³»ã€‚</p></li><li><p><strong>é¡µé¢å·¥ä½œè¿‡ç¨‹</strong></p> <img src="https://s2.loli.net/2024/09/03/jUZDJG2kborxQHX.png" style="zoom:80%;" /><ul><li><p>XV6åªæ˜¯ç”¨64ä½è™šæ‹Ÿåœ°å€ä¸­çš„ä½39ä½ï¼Œé«˜25ä½ä¸ç”¨</p></li><li><p>39ä½ä¸­ï¼Œæœ‰27ä½ç”¨æ¥åš**é¡µè¡¨æ¡ç›®ï¼ˆPage Table Entries/PTEï¼‰**çš„ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯æœ‰$2^{27}$ä¸ªentry</p></li><li><p>æ¯ä¸ªPTEåŒ…å«ä¸€ä¸ª44ä½çš„**ç‰©ç†é¡µç ï¼ˆPhysical Page Number/PPNï¼‰**å’Œä¸€äº›æ ‡å¿—ä½</p></li><li><p>ç”Ÿæˆçš„ç‰©ç†åœ°å€æœ‰56ä½ï¼Œå…¶ä¸­44ä½æ˜¯PPNï¼Œè¿˜æœ‰12ä½æ˜¯åŸå§‹è™šæ‹Ÿåœ°å€çš„Offset</p></li></ul><p>åœ¨å®é™…çš„è½¬æ¢ä¸­è¿˜æŠŠé¡µè¡¨åˆ†æˆäº†ä¸‰çº§æ ‘ç»“æ„</p> <img src="https://s2.loli.net/2024/09/03/qIcbfYEou3saHUQ.png" style="zoom:80%;" /><p>æ¯çº§æœ‰512ä¸ªPTEï¼Œæ¯ä¸ªPTEä¸­åŒ…å«è¯¥æ ‘çš„ä¸‹ä¸€çº§é¡µè¡¨é¡µçš„ç‰©ç†åœ°å€ å¦‚æœè½¬æ¢åœ°å€æ‰€éœ€çš„ä¸‰ä¸ªPTEä¸­çš„ä»»ä½•ä¸€ä¸ªä¸å­˜åœ¨ï¼Œé¡µå¼ç¡¬ä»¶å°±ä¼šå¼•å‘é¡µé¢æ•…éšœå¼‚å¸¸ï¼ˆpage-fault exceptionï¼‰ï¼Œå¹¶è®©å†…æ ¸æ¥å¤„ç†è¯¥å¼‚å¸¸</p><p>PTEä¸­Flagsçš„å«ä¹‰ï¼š</p><p><img src="https://s2.loli.net/2024/09/03/OUCQJzkTqpabZP1.png" alt=""></p></li><li><p><strong>è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€å’Œå†…æ ¸è™šæ‹Ÿåœ°å€</strong></p><p>OSçš„è™šæ‹Ÿåœ°å€ç©ºé—´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸¤ä¸ªï¼š</p><ul><li><p><strong>è¿›ç¨‹è™šæ‹Ÿåœ°å€ï¼ˆUser Virtual Memory, UVMï¼‰</strong>ï¼šå³ç”¨æˆ·çº§è™šæ‹Ÿåœ°å€ï¼ŒæŒ‡è¿›ç¨‹åœ¨ç”¨æˆ·ç©ºé—´ä¸‹å¯è®¿é—®çš„è™šæ‹Ÿå†…å­˜åœ°å€ã€‚è¿›ç¨‹è™šæ‹Ÿåœ°å€ç”±å†…å­˜ç®¡ç†å•å…ƒï¼ˆMMUï¼‰é€šè¿‡ä¸‰çº§é¡µè¡¨æ˜ å°„åˆ°ç‰©ç†å†…å­˜åœ°å€ï¼ˆxv6ä¸­ï¼Œ<strong>UVMåˆ°çœŸå®PAçš„è½¬æ¢æ˜¯éçº¿æ€§æ˜ å°„</strong>ï¼Œå…·ä½“æ–¹å¼æ˜¯ä¸‰çº§é¡µè¡¨æŸ¥è¯¢+ä½å·¦ç§»å³ç§»ï¼‰</p></li><li><p><strong>å†…æ ¸è™šæ‹Ÿåœ°å€ï¼ˆKernel Virtual Memory, KVMï¼‰</strong>ï¼šå…è®¸æ“ä½œç³»ç»Ÿå†…æ ¸ç›´æ¥è®¿é—®å’Œç®¡ç†æ‰€æœ‰çš„ç¡¬ä»¶èµ„æºå’Œå†…å­˜ï¼ˆxv6ä¸­ï¼Œ<strong>KVMåˆ°çœŸå®PAçš„è½¬æ¢æ˜¯çº¿æ€§æ˜ å°„</strong>ï¼Œå¦‚UARTçš„VAå’ŒPAéƒ½æ˜¯0x10000000Lï¼Œè¿™ç§çº¿æ€§æ˜ å°„ä¸€ç›´æŒç»­åˆ°0x80000000Lï¼‰</p>  <img src="https://s2.loli.net/2024/09/03/eQZajwFqt3yvug9.png" style="zoom:80%;" /></li></ul></li></ol><p>â€‹æ¯ä¸ªè¿›ç¨‹éƒ½ç‹¬äº«ä¸€ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œä½†å†…æ ¸è™šæ‹Ÿç©ºé—´åªæœ‰ä¸€ä¸ªï¼Œæ•´ä¸ªOSå…±ç”¨</p><p>â€‹<div class="note note-warning">            <p>â€‹ğŸ’¡ PS.</p><p>ä»CPUè§’åº¦çœ‹ï¼Œæ‰€è°“å†…æ ¸ç©ºé—´åœ°å€/ç”¨æˆ·ç©ºé—´åœ°å€åªæ˜¯æƒé™ä¸ä¸€æ ·è€Œå·²ï¼Œè¦è·å–å®ƒä»¬çš„ç‰©ç†åœ°å€ï¼Œä»ç¡¬ä»¶å±‚é¢ä¸Šéƒ½è¦èµ°MMUè¿™å¥—ç¡¬ä»¶æœºåˆ¶ã€‚ä½†æ˜¯è½¯ä»¶å±‚é¢ä¸ä¸€æ ·ï¼Œå½“éœ€è¦çŸ¥é“ä¸€ä¸ªç”¨æˆ·ç©ºé—´è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†åœ°å€æ—¶ï¼Œå°±æ˜¯ç”¨ä¸Šè¿°ä¸‰çº§é¡µè¡¨æ¥ç¿»è¯‘å¾—åˆ°å®ƒçš„ç‰©ç†åœ°å€ï¼›ä½†æ˜¯å†…æ ¸ç©ºé—´è™šæ‹Ÿåœ°å€æ˜¯æ‰€æœ‰è¿›ç¨‹å…±äº«çš„ï¼Œè€Œä¸”æ•ˆç‡å¾ˆé‡è¦ï¼Œè¿™å°±æœ‰å–å·§ä¼˜åŒ–çš„ç©ºé—´äº†ï¼š å†…æ ¸åœ¨åˆå§‹åŒ–æ—¶å°±åˆ›å»ºå†…æ ¸ç©ºé—´çš„æ˜ å°„ï¼ˆå› ä¸ºæ‰€æœ‰è¿›ç¨‹å…±äº«ä¸€ä»½å°±å¤Ÿäº†)ï¼Œå¹¶ä¸”é‡‡ç”¨çš„æ˜¯çº¿æ€§æ˜ å°„ï¼ˆå³å†…æ ¸ä¸€æ•´å—å†…æ ¸ç©ºé—´é¡µï¼Œä¸€å¯¹ä¸€åœ°æ˜ å°„åˆ°ä¸€å—ç‰©ç†å†…å­˜ä¸Šï¼‰ã€‚è¿™æ„å‘³ç€ï¼Œåœ¨è½¯ä»¶å±‚é¢(å†…æ ¸)ï¼Œå½“å†…æ ¸éœ€è¦çŸ¥é“å®ƒè®¿é—®çš„ä¸€ä¸ªå†…æ ¸ç©ºé—´é¡µé¢Pxçš„ç‰©ç†åœ°å€æ—¶ï¼Œå®ƒåªè¦çŸ¥é“ç¬¬ä¸€é¡µP0çš„ç‰©ç†åœ°å€å³å¯ï¼Œç„¶ååŠ ä¸ŠPxç›¸è·P0çš„åç§»ï¼Œå³å¯å¿«é€ŸçŸ¥é“Pxçš„ç‰©ç†åœ°å€ï¼ˆçº¿æ€§æ˜ å°„çš„ä¼˜åŠ¿ï¼‰ï¼Œè€Œä¸éœ€è¦èµ°é¡µè¡¨ç¿»è¯‘è¿™ç§ç±»ä¼¼å“ˆå¸Œè¡¨çš„æ–¹å¼å»è®¡ç®—ã€‚</p><p>â€‹</p>          </div></p><ol start="4"><li><p><strong>è¿›ç¨‹çš„åœ°å€ç©ºé—´</strong></p> <img src="https://s2.loli.net/2024/09/03/tl4WnXrqRJ6afAN.png" style="zoom:80%;" /><p>ä¸ºäº†æ£€æµ‹ç”¨æˆ·æ ˆæ˜¯å¦æº¢å‡ºäº†æ‰€åˆ†é…æ ˆå†…å­˜ï¼Œxv6åœ¨æ ˆæ­£ä¸‹æ–¹æ”¾ç½®äº†ä¸€ä¸ªæ— æ•ˆçš„ä¿æŠ¤é¡µï¼ˆguard pageï¼‰ã€‚å¦‚æœç”¨æˆ·æ ˆæº¢å‡ºå¹¶ä¸”è¿›ç¨‹è¯•å›¾ä½¿ç”¨æ ˆä¸‹æ–¹çš„åœ°å€ï¼Œé‚£ä¹ˆç”±äºæ˜ å°„æ— æ•ˆï¼ˆPTE_Vä¸º0ï¼‰ç¡¬ä»¶å°†ç”Ÿæˆä¸€ä¸ªé¡µé¢æ•…éšœå¼‚å¸¸ã€‚å½“ç”¨æˆ·æ ˆæº¢å‡ºæ—¶ï¼Œå®é™…çš„æ“ä½œç³»ç»Ÿå¯èƒ½ä¼šè‡ªåŠ¨ä¸ºå…¶åˆ†é…æ›´å¤šå†…å­˜</p></li><li><p><strong>some QA</strong></p><p><strong>Q</strong>ï¼šå› ä¸ºå­˜åœ¨å¾ˆå¤šä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œæ‰€ä»¥è®¾è®¡æ—¶éœ€è¦è®²æœ€å¤§è™šæ‹Ÿåœ°å€è®¾ç½®å¾—è¶³å¤Ÿå°å—ï¼Ÿ</p><p><strong>A</strong>ï¼šä¸éœ€è¦ï¼Œè™šæ‹Ÿå†…å­˜å¯ä»¥æ¯”ç‰©ç†å†…å­˜æ›´å¤§ï¼Œpage tableçš„å®ç°éå¸¸çµæ´»</p><p><strong>Q</strong>ï¼šå¦‚æœæœ‰å¤ªå¤šçš„è¿›ç¨‹ä½¿ç”¨äº†è™šæ‹Ÿå†…å­˜ï¼Œæœ‰æ²¡æœ‰å¯èƒ½ç‰©ç†å†…å­˜è€—å°½äº†ï¼Ÿ</p><p><strong>A</strong>ï¼šæœ‰å¯èƒ½ï¼Œè¿™é€šè¿‡kallcoå¯ä»¥çœ‹åˆ°ï¼Œå®ƒä¿å­˜äº†ç©ºä½™pageçš„åˆ—è¡¨ï¼Œå½“è¿™ä¸ªåˆ—è¡¨è€—å°½äº†çš„æ—¶å€™kallocä¼šè¿”å›ä¸€ä¸ªç©ºæŒ‡é’ˆï¼›è€Œå†…æ ¸çš„ä¸€éƒ¨åˆ†å·¥ä½œå°±æ˜¯å¤„ç†è¿™æ ·çš„æƒ…å†µ â€”â€” åº”è¯¥ç»™ç”¨æˆ·è¿”å›ä¸€ä¸ªé”™è¯¯æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯ç›´æ¥crash</p><p><strong>Q</strong>ï¼šä»£ç /æ±‡ç¼–æŒ‡ä»¤ä¸­çš„åœ°å€æ˜¯è™šæ‹Ÿåœ°å€è¿˜æ˜¯ç‰©ç†åœ°å€ï¼Ÿ</p><p><strong>A</strong>ï¼šä»»ä½•ä¸€æ¡å¸¦æœ‰åœ°å€çš„æŒ‡ä»¤ï¼Œå…¶ä¸­çš„åœ°å€éƒ½æ˜¯è™šæ‹Ÿå†…å­˜åœ°å€</p><p><strong>Q</strong>ï¼špage tableç”±MMUä¿å­˜å—ï¼Ÿ</p><p><strong>A</strong>ï¼šä¸æ˜¯ï¼Œpage tableä¹Ÿä¿å­˜åœ¨å†…å­˜ä¸­ï¼ŒMMUæ˜¯ä»å†…å­˜ä¸­è¯»å–page tableå¹¶å®Œæˆç¿»è¯‘</p><p><strong>Q</strong>ï¼šä»¥XV6çš„ä¸‰çº§page tableä¸ºä¾‹ï¼Œè§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆç»™ä¸€ä¸ªè¿›ç¨‹åˆ†é…çš„æœ€å¤§è™šæ‹Ÿå†…å­˜æ˜¯512GBï¼Ÿ</p><p><strong>A</strong>ï¼šæ³¨æ„ï¼Œä¸€ä¸ªentryå¯¹åº”çš„æ˜¯ä¸€ä¸ª4KBçš„pageï¼Œä¸‰çº§åˆ—è¡¨ï¼Œæ¯ä¸ªæœ‰512ä¸ªentryï¼Œæ€»å…±å°±æœ‰$512Ã—512Ã—512=2^{27}$ä¸ªentryï¼Œæ¯ä¸ª4KBï¼Œæ€»å…±å°±æ˜¯$2^{27}Ã—2^2KB=512GB$</p><p>â€‹<div class="note note-warning">            <p>â€‹ğŸ’¡ PS.</p><p>PS. æ³¨æ„ï¼Œindexä¸º27ä¸ªbitï¼Œåˆšå¥½å¯¹åº”2^{27}ä¸ªentryï¼›offsetä¸º12bitï¼Œåˆšå¥½å¯¹åº”4KBã€‚å³indexç”¨æ¥æŸ¥æ‰¾pageï¼Œoffsetå¯¹åº”çš„æ˜¯ä¸€ä¸ªpageä¸­çš„å“ªä¸ªå­—èŠ‚</p><p>â€‹</p>          </div></p><p><strong>Q</strong>ï¼š4096Bytesä½œä¸ºä¸€ä¸ªpageï¼Œè¿™åœ¨ç‰©ç†å†…å­˜ä¸­æ˜¯è¿ç»­çš„å—ï¼Ÿ</p><p><strong>A</strong>ï¼šæ˜¯çš„ï¼Œåœ¨ç‰©ç†å†…å­˜ä¸­ï¼Œè¿™æ˜¯è¿ç»­çš„4096ä¸ªå­—èŠ‚ã€‚æ‰€ä»¥ç‰©ç†å†…å­˜æ˜¯ä»¥4096ä¸ºç²’åº¦ä½¿ç”¨çš„</p><p><strong>Q</strong>ï¼šä¸ºä»€ä¹ˆè¦æŠŠpage tableåˆ†æˆ3çº§ï¼Ÿ</p><p><strong>A</strong>ï¼šå‡è®¾æŸä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´åªä½¿ç”¨äº†1ä¸ªpageï¼Œä¹Ÿå°±æ˜¯4094Bytesï¼Œåœ¨ä¸‰çº§ç»“æ„ä¸­è¦å¤šå°‘ä¸ªentryå‘¢ï¼Ÿ åœ¨æœ€é«˜çº§ï¼Œä½ éœ€è¦ä¸€ä¸ªpage directoryã€‚åœ¨è¿™ä¸ªpage directoryä¸­ï¼Œä½ éœ€è¦ä¸€ä¸ªæ•°å­—æ˜¯0çš„PTEï¼ŒæŒ‡å‘ä¸­é—´çº§page directoryã€‚æ‰€ä»¥åœ¨ä¸­é—´çº§ï¼Œä½ ä¹Ÿéœ€è¦ä¸€ä¸ªpage directoryï¼Œé‡Œé¢ä¹Ÿæ˜¯ä¸€ä¸ªæ•°å­—0çš„PTEï¼ŒæŒ‡å‘æœ€ä½çº§page directoryã€‚æ‰€ä»¥è¿™é‡Œæ€»å…±éœ€è¦3ä¸ªpage directoryï¼ˆä¹Ÿå°±æ˜¯3 * 512ä¸ªentryï¼Œ12KB å†…å­˜ï¼‰ è€Œåœ¨ä¸åˆ†çº§çš„ç»“æ„ä¸­å‘¢ï¼Ÿ åªä½¿ç”¨äº†ä¸€ä¸ªpageï¼Œä½†è¿˜æ˜¯éœ€è¦2^27ä¸ªPTEï¼ˆæ³¨ï¼Œçº¦ 1GB å†…å­˜ï¼‰</p><p>â€‹<div class="note note-warning">            <p>â€‹ğŸ’¡ PS.</p><p>è¿™ä¸ª3ä¸ªpage directoryçš„ä¾‹å­å…·ä½“ç”±entryä¸­çš„valid æ ‡å¿—ä½æ¥å®ç°ï¼Œæˆ‘ä»¬åªä½¿ç”¨äº†3ä¸ªpage directoryï¼Œæ¯ä¸ªpage directoryä¸­åªæœ‰ç¬¬0ä¸ªPTEè¢«ä½¿ç”¨äº†ï¼Œæ‰€ä»¥åªæœ‰ç¬¬0ä¸ªPTEçš„Valid bitä½ä¼šè¢«è®¾ç½®æˆ1ï¼Œå…¶ä»–çš„511ä¸ªPTEçš„Valid bitä¸º0ã€‚è¿™ä¸ªæ ‡å¿—ä½å‘Šè¯‰MMUï¼Œä½ ä¸èƒ½ä½¿ç”¨è¿™æ¡PTEï¼Œå› ä¸ºè¿™æ¡PTEå¹¶ä¸åŒ…å«æœ‰ç”¨çš„ä¿¡æ¯</p><p>â€‹</p>          </div></p><p><strong>Q</strong>ï¼šSATPå¯„å­˜å™¨ä¸­å­˜çš„æ˜¯ä»€ä¹ˆï¼Ÿ</p><p><strong>A</strong>ï¼š<strong>æœ€é«˜çº§çš„page directoryçš„ç‰©ç†å†…å­˜åœ°å€</strong>ã€‚å½“ä¸€ä¸ªè¿›ç¨‹è¯·æ±‚ä¸€ä¸ªè™šæ‹Ÿå†…å­˜åœ°å€æ—¶ï¼ŒCPUä¸­çš„MMUä¼šæŸ¥çœ‹SATPå¯„å­˜å™¨å¾—åˆ°å¯¹åº”çš„æœ€é«˜ä¸€çº§page tableçš„åœ°å€ï¼Œè¿™çº§page tableä¼šä½¿ç”¨è™šæ‹Ÿå†…å­˜åœ°å€ä¸­27bit indexçš„æœ€é«˜9bitæ¥å®Œæˆç¬¬ä¸€æ¬¡ç´¢å¼•</p></li><li><p><strong>ç”¨lab3ä¸­çš„ä¾‹å­è§£é‡Šä¸€ä¸‹é¡µè¡¨ä¸­çš„å‡ ä¸ªç‚¹</strong></p> <img src="https://s2.loli.net/2024/09/03/TWQnqizDEmvXpCO.png" style="zoom:80%;" /><ul><li>æ•´ä¸ªé¡µè¡¨çš„åœ°å€=æœ€é«˜çº§çš„é¡µè¡¨çš„entry0çš„åœ°å€</li><li>ç”¨é¡µè¡¨è¿›è¡Œåœ°å€è½¬æ¢çš„è¿‡ç¨‹æ˜¯ï¼šå…ˆç”¨æ•´ä¸ªé¡µè¡¨çš„åœ°å€ï¼ˆä¹Ÿå°±æ˜¯myproc()â†’pagetableè¿™ä¸ªå˜é‡ï¼‰æ‰¾åˆ°æœ€é«˜çº§é¡µè¡¨ï¼Œå†ç”¨virtual addressçš„é«˜9ä½æ‰¾åˆ°å¯¹åº”çš„é‚£ä¸ªentryï¼Œè¿™ä¸ªentryä¸­çš„PTEé€šè¿‡æŸç§è½¬æ¢ç®—æ³•å˜æˆçœŸå®çš„PAï¼ˆXV6ä¸­æ˜¯ç®€å•çš„bitå·¦ç§»å³ç§»æ“ä½œï¼‰ï¼Œè¿™ä¸ªPAå°±æ˜¯ä¸‹ä¸€çº§é¡µè¡¨çš„åœ°å€ï¼›å¥½ï¼Œæ‰¾åˆ°ä¸‹ä¸€çº§é¡µè¡¨ååˆé€šè¿‡virtual addressçš„ä¸­9ä½æ‰¾å¯¹åº”entryï¼Œé‡å¤æ“ä½œç›´è‡³æ‰¾åˆ°æœ€ä½ä¸€çº§é¡µè¡¨ä¸­çš„å¯¹åº”entryï¼Œå…¶è½¬æ¢åçš„PAå°±æ˜¯åˆ†é…çš„é‚£ä¸ª4KB pageçš„ç‰©ç†åœ°å€</li></ul></li><li><p><strong>è¿›ç¨‹çš„å†…æ ¸æ ˆï¼ˆprocessâ€˜s kernel stackï¼‰</strong></p><p>è¿›ç¨‹çš„å†…æ ¸æ ˆæ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸ä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…çš„ä¸€å—ç‰¹æ®Šå†…å­˜åŒºåŸŸï¼Œç”¨äºåœ¨å†…æ ¸æ¨¡å¼ä¸‹æ‰§è¡Œæ—¶å­˜å‚¨ä¸´æ—¶æ•°æ®å’Œæ§åˆ¶ä¿¡æ¯ã€‚å½“è¿›ç¨‹åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹è¿è¡Œæ—¶ï¼Œå®ƒä½¿ç”¨çš„æ˜¯ç”¨æˆ·æ ˆï¼›ä½†å½“è¿›ç¨‹è¿›è¡Œç³»ç»Ÿè°ƒç”¨æˆ–é‡åˆ°ä¸­æ–­ã€å¼‚å¸¸æ—¶ï¼ŒCPUä¼šåˆ‡æ¢åˆ°å†…æ ¸æ¨¡å¼ï¼Œæ­¤æ—¶å°±ä¼šä½¿ç”¨å†…æ ¸æ ˆã€‚</p><p>å¦‚<strong>ä¸Šä¸‹æ–‡ä¿å­˜ä¸æ¢å¤</strong>ï¼šå½“è¿›ç¨‹ä»ç”¨æˆ·æ¨¡å¼åˆ‡æ¢åˆ°å†…æ ¸æ¨¡å¼æ—¶ï¼Œå†…æ ¸æ ˆç”¨äºä¿å­˜å½“å‰çš„CPUå¯„å­˜å™¨çŠ¶æ€ã€ç¨‹åºè®¡æ•°å™¨å’Œå…¶ä»–å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯åœ¨è¿›ç¨‹å†æ¬¡å›åˆ°ç”¨æˆ·æ¨¡å¼æ—¶éœ€è¦è¢«æ¢å¤ã€‚</p><p>â€‹<div class="note note-warning">            <p>â€‹ğŸ’¡ PS.</p><ol><li><p>æ¯ä¸ªè¿›ç¨‹éƒ½ç‹¬æœ‰ä¸€ä¸ªç”¨æˆ·æ ˆå’Œä¸€ä¸ªå†…æ ¸æ ˆ</p></li><li><p>å†…æ ¸æ ˆçš„å¤§å°é€šå¸¸åœ¨è¿›ç¨‹åˆ›å»ºæ—¶ç¡®å®šï¼Œå¹¶åœ¨è¿›ç¨‹çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­ä¿æŒä¸å˜</p></li></ol><p>â€‹</p>          </div></p></li></ol><h1>LECTURE4ã€Trap</h1><ol><li><p><strong>æ¦‚å¿µ</strong></p><p>ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„åˆ‡æ¢é€šå¸¸è¢«ç§°ä¸ºtrapï¼Œå®ƒé€šå¸¸å‘ç”Ÿåœ¨</p><ul><li>æ‰§è¡Œsyscall</li><li>ç¨‹åºå‡ºç°ç±»ä¼¼page faultã€è¿ç®—æ—¶é™¤ä»¥0çš„é”™è¯¯</li><li>è®¾å¤‡è§¦å‘ä¸­æ–­</li></ul></li><li><p><strong>trapä»£ç æ‰§è¡Œæµç¨‹</strong></p><p>ä»¥ä¸‹æ˜¯shellä¸­è°ƒç”¨write() syscallæ—¶trapçš„å…¨è¿‡ç¨‹</p> <img src="https://s2.loli.net/2024/09/03/4F5opKEP73JUNWM.png" style="zoom:67%;" /><p>a. writeæ‰§è¡Œ<strong>ECALL</strong>æŒ‡ä»¤ï¼Œåˆ‡æ¢åˆ°supervisor modeå†…æ ¸</p><p>b. æ‰§è¡Œå†…æ ¸ä»£ç trampoline.sä¸­çš„å‡½æ•°<strong>uservec</strong>ï¼Œä»£ç æ‰§è¡Œè·³è½¬åˆ°trap.cä¸­çš„å‡½æ•°usertrap()</p><p>c. åœ¨usertrap()ä¸­ï¼Œæ‰§è¡Œ<strong>syscall()<strong>å‡½æ•°ï¼›syscall()æ ¹æ®ä¼ å…¥çš„ä»£è¡¨ç³»ç»Ÿè°ƒç”¨çš„æ•°å­—è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¹¶åœ¨å†…æ ¸ä¸­æ‰§è¡Œå…·ä½“åŠŸèƒ½å‡½æ•°ï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯</strong>sys_write</strong>ï¼‰</p><p>d. syscall()æ‰§è¡Œç»“æŸåç»§ç»­è°ƒç”¨trap.cä¸­çš„<strong>usertrapret()</strong>ï¼Œè¯¥å‡½æ•°å®Œæˆäº†éƒ¨åˆ†æ–¹ä¾¿åœ¨Cä»£ç ä¸­å®ç°çš„è¿”å›åˆ°ç”¨æˆ·ç©ºé—´çš„å·¥ä½œ</p><p>e. å‰©ä¸‹çš„ä¸€äº›å·¥ä½œå­˜åœ¨äºtrampoline.sä¸­çš„userretä¸­</p></li></ol><h1>LECTURE5ã€Page Fault</h1><ol><li><p><strong>æ¦‚å¿µ</strong></p><p>åº”ç”¨ç¨‹åºé€šè¿‡ malloc å‡½æ•°ç”³è¯·å†…å­˜çš„æ—¶å€™ï¼Œå®é™…ä¸Šç”³è¯·çš„æ˜¯è™šæ‹Ÿå†…å­˜ï¼Œæ­¤æ—¶å¹¶ä¸ä¼šåˆ†é…ç‰©ç†å†…å­˜ã€‚å½“åº”ç”¨ç¨‹åºè¯»å†™äº†è¿™å—è™šæ‹Ÿå†…å­˜ï¼ŒCPUå°±ä¼šå»è®¿é—®è¿™ä¸ªè™šæ‹Ÿå†…å­˜ï¼Œ è¿™æ—¶ä¼šå‘ç°è¿™ä¸ªè™šæ‹Ÿå†…å­˜æ²¡æœ‰æ˜ å°„åˆ°ç‰©ç†å†…å­˜ï¼Œ CPUå°±ä¼šäº§ç”Ÿ<strong>ç¼ºé¡µä¸­æ–­</strong>ï¼Œè¿›ç¨‹ä¼šä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œå¹¶å°†ç¼ºé¡µä¸­æ–­äº¤ç»™å†…æ ¸çš„ Page Fault Handler ï¼ˆç¼ºé¡µä¸­æ–­å‡½æ•°ï¼‰å¤„ç†</p><p>XV6ä¸­å¤„ç†page faultçš„æ–¹å¼å¾ˆä¿å®ˆï¼Œé‡åˆ°å°±ç›´æ¥killæ‰è¿›ç¨‹ï¼›ä½†æ­£è§„çš„æ“ä½œç³»ç»Ÿæœ‰ä¸€ç³»åˆ—å¤„ç†æ–¹å¼ï¼š</p><ul><li>lazy allocation</li><li>copy-on-write fork</li><li>demand paging</li><li>memory mapped files</li></ul></li><li><p><strong>XV6ä¸­çš„page fault</strong></p><p>å½“å‡ºç°page faultçš„æ—¶å€™ï¼ŒXV6å†…æ ¸ä¼šæ‰“å°å‡ºé”™çš„è™šæ‹Ÿåœ°å€ï¼Œå¹¶ä¸”è¿™ä¸ªåœ°å€ä¼šè¢«ä¿å­˜åœ¨STVALå¯„å­˜å™¨ä¸­ï¼Œä¸”page faultå’Œå…¶ä»–çš„å¼‚å¸¸ä½¿ç”¨ä¸ç³»ç»Ÿè°ƒç”¨ç›¸åŒçš„trapæœºåˆ¶æ¥ä»ç”¨æˆ·ç©ºé—´åˆ‡æ¢åˆ°å†…æ ¸ç©ºé—´</p><p>å‡ºç°page faultæ—¶ï¼Œæœ‰ä¸‰ä¸ªæœ‰ä»·å€¼çš„ä¿¡æ¯ï¼š</p><ul><li>å¼•èµ·page faultçš„å†…å­˜åœ°å€ï¼ˆä¿å­˜åœ¨STVALå¯„å­˜å™¨ä¸­ï¼‰</li><li>å¼•èµ·page faultçš„åŸå› ç±»å‹ï¼ˆä¿å­˜åœ¨SCAUSEå¯„å­˜å™¨ä¸­ï¼‰</li><li>å¼•èµ·page faultæ—¶çš„ç¨‹åºè®¡æ•°å™¨å€¼ï¼Œè¿™è¡¨æ˜äº†page faultåœ¨ç”¨æˆ·ç©ºé—´å‘ç”Ÿçš„ä½ç½®</li></ul><p>â€‹<div class="note note-warning">            <p>â€‹ğŸ’¡ PS.</p><p>æˆ‘ä»¬ä¹‹æ‰€ä»¥å…³å¿ƒè§¦å‘page faultæ—¶çš„ç¨‹åºè®¡æ•°å™¨å€¼ï¼Œæ˜¯å› ä¸ºåœ¨page fault handlerä¸­æˆ‘ä»¬æˆ–è®¸æƒ³è¦ä¿®å¤page tableï¼Œå¹¶é‡æ–°æ‰§è¡Œå¯¹åº”çš„æŒ‡ä»¤ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œä¿®å¤å®Œpage tableä¹‹åï¼ŒæŒ‡ä»¤å°±å¯ä»¥æ— é”™è¯¯çš„è¿è¡Œäº†ã€‚æ‰€ä»¥ï¼Œèƒ½å¤Ÿæ¢å¤å› ä¸ºpage faultä¸­æ–­çš„æŒ‡ä»¤è¿è¡Œæ˜¯å¾ˆé‡è¦çš„ã€‚</p><p>â€‹</p>          </div></p><p><img src="https://s2.loli.net/2024/09/03/ApJK8mDI3RyaP4b.png" alt=""></p></li><li><p><strong>sbrk()</strong></p><p>sbrkæ˜¯XV6æä¾›çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒä½¿å¾—ç”¨æˆ·åº”ç”¨ç¨‹åºèƒ½æ‰©å¤§è‡ªå·±çš„heapã€‚å½“ä¸€ä¸ªåº”ç”¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™ï¼ŒsbrkæŒ‡å‘çš„æ˜¯heapçš„æœ€åº•ç«¯ï¼ŒåŒæ—¶ä¹Ÿæ˜¯stackçš„æœ€é¡¶ç«¯ã€‚è¿™ä¸ªä½ç½®é€šè¿‡ä»£è¡¨è¿›ç¨‹çš„æ•°æ®ç»“æ„ä¸­çš„szå­—æ®µè¡¨ç¤ºï¼Œè¿™é‡Œä»¥<em>p-&gt;szè¡¨ç¤º</em>ã€‚</p><p><img src="https://s2.loli.net/2024/09/03/7FdHt5guphVCzLG.png" alt=""></p><p>å½“è°ƒç”¨sbrkæ—¶ï¼Œå®ƒçš„å‚æ•°æ˜¯æ•´æ•°ï¼Œä»£è¡¨äº†ä½ æƒ³è¦ç”³è¯·çš„pageæ•°é‡ï¼Œå³å†…å­˜ä¼šåˆ†é…ä¸€äº›ç‰©ç†å†…å­˜å¹¶å°†å…¶æ˜ å°„åˆ°ç”¨æˆ·åœ°å€ç©ºé—´ï¼Œå¹¶å°†å†…å­˜å†…å®¹åˆå§‹åŒ–ä¸º0ï¼ˆè¿™ç§æ–¹å¼ç§°ä¹‹ä¸ºeager allocationï¼‰ ä½†è¿™å½“ä¸­æœ‰ä¸ªæ½œåœ¨é—®é¢˜ï¼šå®é™…ä¸­çš„è¿›ç¨‹å¾ˆéš¾é¢„æµ‹è‡ªå·±éœ€è¦å¤šå°‘å†…å­˜ï¼Œè‹¥æå‰è¦å¤ªå¤šå†…å­˜ï¼Œå¯èƒ½ä¼šå‡ºç°æœ‰äº›åˆ†é…çš„å†…å­˜æ°¸è¿œä¸ä¼šè¢«ä½¿ç”¨åˆ°çš„æµªè´¹æƒ…å†µã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬æå‡ºlazy allocation</p></li><li><p><strong>lazy allocation</strong></p><p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šsbrk()åŸºæœ¬ä¸Šä¸åšä»»ä½•äº‹æƒ…ï¼Œå”¯ä¸€éœ€è¦åšçš„äº‹æƒ…å°±æ˜¯æå‡<em>p-&gt;sz</em>ï¼Œå°†<em>p-&gt;sz</em>å¢åŠ nï¼Œå…¶ä¸­næ˜¯éœ€è¦æ–°åˆ†é…çš„å†…å­˜pageæ•°é‡ã€‚ä½†æ˜¯å†…æ ¸åœ¨è¿™ä¸ªæ—¶é—´ç‚¹å¹¶ä¸ä¼šåˆ†é…ä»»ä½•ç‰©ç†å†…å­˜ã€‚ ä¹‹ååœ¨æŸä¸ªæ—¶é—´ç‚¹ï¼Œåº”ç”¨ç¨‹åºä½¿ç”¨åˆ°äº†æ–°ç”³è¯·çš„é‚£éƒ¨åˆ†å†…å­˜ï¼Œè¿™æ—¶ä¼šè§¦å‘page faultï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰å°†æ–°çš„å†…å­˜æ˜ å°„åˆ°page tableã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬è§£æä¸€ä¸ªå¤§äºæ—§çš„<em>p-&gt;sz</em>ï¼Œä½†æ˜¯åˆå°äºæ–°çš„<em>p-&gt;sz</em>ï¼ˆä¹Ÿå°±æ˜¯æ—§çš„p-&gt;sz + nï¼‰çš„è™šæ‹Ÿåœ°å€ï¼Œæˆ‘ä»¬å¸Œæœ›å†…æ ¸èƒ½å¤Ÿåˆ†é…ä¸€ä¸ªå†…å­˜pageï¼ˆä½¿ç”¨kallocï¼‰ï¼Œå¹¶ä¸”é‡æ–°æ‰§è¡ŒæŒ‡ä»¤</p><p><strong>ä»£ç éƒ¨åˆ†</strong>ï¼š</p><p>é¦–å…ˆä¿®æ”¹sys_sbrk()ï¼Œè®©å®ƒå¯¹pâ†’szå¢åŠ nï¼Œä½†å¹¶ä¸æ‰§è¡Œå¢åŠ å†…å­˜çš„æ“ä½œ</p><p><img src="https://s2.loli.net/2024/09/03/a9HURjX417ytcLx.png" alt=""></p><p>ä½†è¿™ä¸ªæ—¶å€™è¿˜æ˜¯ä¼špage faultï¼Œå› ä¸ºsys_sbrk()å¹¶æ²¡æœ‰å®é™…åˆ†é…æ‰€éœ€è¦çš„å†…å­˜</p><p><img src="https://s2.loli.net/2024/09/03/i9oQZd7BjpfJznM.png" alt=""></p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨usertrap()ä¸­æ ¹æ®ä¸åŒçš„SCAUSEè¿›è¡Œæ”¹è¿›</p> <img src="https://s2.loli.net/2024/09/03/9XJWPLNxBAYbiHv.png" style="zoom:80%;" /><p>å¦‚æœSCAUSE ==8ï¼Œåˆ™è¡¨ç¤ºæ˜¯å¤„ç†æ™®é€šsyscallæ—¶è¿›å…¥çš„trapï¼›è‹¥SCAUSE==15ï¼Œåˆ™è¡¨ç¤ºæ˜¯å› ä¸ºpage faultè¿›å…¥çš„trapï¼Œä¹‹ååˆ†é…ä¸€ä¸ªç‰©ç†å†…å­˜pageï¼Œå¦‚æœkaç­‰äº0ï¼Œè¡¨æ˜æ²¡æœ‰ç‰©ç†å†…å­˜æˆ‘ä»¬ç°åœ¨OOMäº†ï¼Œæˆ‘ä»¬ä¼šæ€æ‰è¿›ç¨‹ã€‚å¦‚æœæœ‰ç‰©ç†å†…å­˜ï¼Œé¦–å…ˆä¼šå°†å†…å­˜å†…å®¹è®¾ç½®ä¸º0ï¼Œä¹‹åå°†ç‰©ç†å†…å­˜pageæŒ‡å‘ç”¨æˆ·åœ°å€ç©ºé—´ä¸­åˆé€‚çš„è™šæ‹Ÿå†…å­˜åœ°å€</p><p>ä½†æ˜¯è¿™æ ·ä¿®æ”¹ä¹‹åè¿˜æ˜¯ä¼šå‡ºé”™</p><p><img src="https://s2.loli.net/2024/09/03/mSGiLP3DrXBCQKZ.png" alt=""></p><p>Whyï¼ŸæŠ¥é”™ä¿¡æ¯æ˜¾ç¤ºæ˜¯å› ä¸ºuvmunmapå°è¯•å¯¹æŸäº›pageè¿›è¡Œunmapæ—¶å‘ç°è¿™äº›pageå¹¶ä¸å­˜åœ¨ï¼Œè¿™äº›pageæ˜¯å“ªå„¿æ¥çš„ï¼Ÿå…¶å®å°±æ˜¯ä¹‹å‰lazy allocationä½†æ˜¯åˆæ²¡å®é™…åˆ†é…çš„å†…å­˜ï¼Œæˆ‘ä»¬åªéœ€è¦å°†uvmunmapä¸­åŸå…ˆçš„panicæ”¹æˆcontinueå°±è¡Œ</p> <img src="https://s2.loli.net/2024/09/03/4gFswiaeOTujMIY.png" style="zoom:67%;" /><p>â€‹<div class="note note-warning">            <p>â€‹ğŸ’¡ PS.</p><p>è§£é‡Šï¼šä¹‹å‰çš„panicè¡¨æ˜ï¼Œæˆ‘ä»¬å°è¯•åœ¨é‡Šæ”¾ä¸€ä¸ªå¹¶æ²¡æœ‰mapçš„pageã€‚æ€ä¹ˆä¼šå‘ç”Ÿè¿™ç§æƒ…å†µå‘¢ï¼Ÿå”¯ä¸€çš„åŸå› æ˜¯sbrkå¢åŠ äº†p-&gt;szï¼Œä½†æ˜¯åº”ç”¨ç¨‹åºè¿˜æ²¡æœ‰ä½¿ç”¨é‚£éƒ¨åˆ†å†…å­˜ã€‚å› ä¸ºå¯¹åº”çš„ç‰©ç†å†…å­˜è¿˜æ²¡æœ‰åˆ†é…ï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†æ–°å¢åŠ çš„å†…å­˜çš„ç¡®æ²¡æœ‰æ˜ å°„å…³ç³»ã€‚æˆ‘ä»¬ç°åœ¨æ˜¯lazy allocationï¼Œæˆ‘ä»¬åªä¼šä¸ºéœ€è¦çš„å†…å­˜åˆ†é…ç‰©ç†å†…å­˜pageã€‚å¦‚æœæˆ‘ä»¬ä¸éœ€è¦è¿™éƒ¨åˆ†å†…å­˜ï¼Œé‚£ä¹ˆå°±ä¸ä¼šå­˜åœ¨mapå…³ç³»ï¼Œè¿™éå¸¸çš„åˆç†ã€‚ç›¸åº”çš„ï¼Œæˆ‘ä»¬å¯¹äºè¿™éƒ¨åˆ†å†…å­˜ä¹Ÿä¸èƒ½é‡Šæ”¾ï¼Œå› ä¸ºæ²¡æœ‰å®é™…çš„ç‰©ç†å†…å­˜å¯ä»¥é‡Šæ”¾ï¼Œæ‰€ä»¥è¿™é‡Œæœ€å¥½çš„å¤„ç†æ–¹å¼å°±æ˜¯continueï¼Œè·³è¿‡å¹¶å¤„ç†ä¸‹ä¸€ä¸ªpage ä¸ºä»€ä¹ˆä¹‹å‰çš„panicä¼šå­˜åœ¨ï¼Ÿå¯¹äºæœªä¿®æ”¹çš„XV6ï¼Œæ°¸è¿œä¹Ÿä¸ä¼šå‡ºç°ç”¨æˆ·å†…å­˜æœªmapçš„æƒ…å†µï¼Œæ‰€ä»¥ä¸€æ—¦å‡ºç°è¿™ç§æƒ…å†µéœ€è¦panicã€‚ä½†æ˜¯ç°åœ¨æˆ‘ä»¬æ›´æ”¹äº†XV6ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»æ‰è¿™é‡Œçš„panicï¼Œå› ä¸ºä¹‹å‰çš„ä¸å¯èƒ½å˜æˆäº†å¯èƒ½</p><p>â€‹</p>          </div></p></li><li><p><strong>Copy On Writeï¼ˆCOWï¼‰</strong></p><p><strong>motivation</strong>ï¼šXV6ä¸­çš„shellé€šå¸¸æœ‰4ä¸ªç‰©ç†pageï¼Œåœ¨shellä¸­æ‰§è¡Œecho helloæ—¶ï¼Œshellä¼šé€šè¿‡forkåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œè¿™ä¸ªå­è¿›ç¨‹åˆ›å»º4ä¸ªæ–°pageå¹¶å°†çˆ¶è¿›ç¨‹pageä¸­çš„å†…å®¹æ‹·è´åˆ°æ–°pageï¼Œç„¶åè°ƒç”¨execæ¥æ‰§è¡Œecho é‚£ä¹ˆå°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œexecä¼šä¸¢å¼ƒä»çˆ¶è¿›ç¨‹æ‹·è´è¿‡æ¥çš„shellåœ°å€ç©ºé—´ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ä¸€ä¸ªåŒ…å«äº†echoçš„åœ°å€ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯<strong>åˆšæŠŠçˆ¶è¿›ç¨‹åœ°å€ç©ºé—´æ‹·è´è¿‡æ¥å°±ä¸¢æ‰äº†</strong>ï¼Œè¿™çœ‹èµ·æ¥æœ‰äº›æµªè´¹ ä¸€ä¸ªç±»ä¼¼äºæ‡’åˆ†é…çš„ä¼˜åŒ–æ–¹æ¡ˆæ˜¯ï¼š<strong>æ‡’æ‹·è´</strong>ï¼Œå³åˆ›å»ºå­è¿›ç¨‹æ—¶ä¸ç«‹åˆ»åˆ†é…æ–°çš„ç‰©ç†pageï¼Œè€Œæ˜¯æš‚æ—¶å’Œçˆ¶è¿›ç¨‹å…±äº«ï¼Œç­‰åˆ°<strong>çœŸçš„è¦å¯¹å­è¿›ç¨‹å†™å†…å­˜çš„æ—¶å€™å†çœŸæ­£åˆ†é…ç‰©ç†page</strong></p><p><strong>å…·ä½“åšæ³•</strong>ï¼š</p><p>è®¾ç½®å­è¿›ç¨‹çš„PTEæŒ‡å‘çˆ¶è¿›ç¨‹å¯¹åº”çš„ç‰©ç†å†…å­˜pageï¼ˆæ³¨æ„ï¼Œä¸ºäº†ä¿è¯çˆ¶å­è¿›ç¨‹ä¹‹é—´çš„éš”ç¦»æ€§ï¼Œè¿™é‡Œå¯ä»¥å°†çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹çš„PTEçš„flagséƒ½è®¾ç½®æˆåªè¯»çš„ï¼‰</p> <img src="https://s2.loli.net/2024/09/03/PlQ4bqpBN3tmVWe.png" style="zoom:67%;" /><p>å†™å†…å­˜æ—¶ä¼šå¾—åˆ°page faultï¼ˆå› ä¸ºéƒ½æ˜¯åªè¯»çš„ï¼‰ï¼Œç„¶åå»çœŸæ­£åˆ†é…ä¸€ä¸ªæ–°çš„ç‰©ç†pageï¼ˆåªå¯¹å­è¿›ç¨‹å¯è§äº†ï¼ŒPTEå¯ä»¥è®¾ä¸ºè¯»+å†™äº†ï¼‰ï¼Œä¸”åˆšåˆšå‡ºé”™çš„é‚£ä¸ªpageä¹Ÿå¯ä»¥æ”¹ä¸ºè¯»+å†™äº†ï¼ˆå› ä¸ºå®ƒç°åœ¨åªå¯¹çˆ¶è¿›ç¨‹å¯è§äº†ï¼‰</p> <img src="https://s2.loli.net/2024/09/03/Eoqv8DMKXjSGYNt.png" style="zoom:80%;" /><p>ç„¶åè°ƒç”¨userret()é‡æ–°æ‰§è¡Œç”¨æˆ·æŒ‡ä»¤ï¼ˆuserret()ä¼šå›åˆ°ç”¨æˆ·ç©ºé—´ï¼‰</p><p>â€‹<div class="note note-warning">            <p>â€‹ğŸ’¡ PS.</p><p>å¦‚ä½•åŒºåˆ†æ˜¯copy-on-writeè¿˜æ˜¯æ™®é€šçš„åœ¨å‘ä¸€ä¸ªæ­£å¸¸çš„åªè¯»åœ°å€å†™æ•°æ®å‘¢ï¼Ÿï¼ˆCOWçš„è¯éœ€è¦åœ¨page fault handlerä¸­å»æ–°åˆ†é…å†…å­˜ï¼Œæ™®é€šçš„å°±ä¸ç”¨ï¼‰ ç­”ï¼šä½¿ç”¨PTEä¸­çš„RSWæ ‡å¿—ä½ï¼Œå®ƒæœ‰2bitï¼Œæˆ‘ä»¬å¯ä»¥å°†copy-on-writeè®¾æˆç‰¹å®šflag</p><p>â€‹</p>          </div></p><p>å¦å¤–ï¼Œcopy-on-writeä¸­éœ€è¦æ³¨æ„çš„ä¸€ä¸ªç»†èŠ‚æ˜¯ï¼Œé‡‡ç”¨è¿™ç§æ–¹æ¡ˆå¯èƒ½ä¼šå¯¼è‡´å¤šä¸ªè¿›ç¨‹æŒ‡å‘åŒä¸€ç‰‡ç‰©ç†pageï¼Œé‚£ä¹ˆçˆ¶è¿›ç¨‹é€€å‡ºæ—¶ä¸èƒ½é©¬ä¸Šé‡Šæ”¾è¿™äº›pageï¼Œå¯èƒ½è¿˜æœ‰å…¶å®ƒå­è¿›ç¨‹æŒ‡ç€çš„ã€‚ æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹æ¯ä¸ªç‰©ç†pageçš„å¼•ç”¨è¿›è¡Œè®¡æ•°ï¼ˆå¼•å…¥é¢å¤–çš„æ•°æ®ç»“æ„ï¼Œshared_ptrï¼Ÿï¼‰ï¼Œå¼•ç”¨æ•°ä¸º0æ—¶æ‰èƒ½å»é‡Šæ”¾ç‰©ç†page</p></li></ol><h1>LECTURE6ã€Multiprocessors and locking</h1><ol><li><p><strong>è‡ªæ—‹é”ï¼ˆspinlocksï¼‰</strong></p><p>è¯¦è§ã€Šå—å¤§OSç¬”è®°ã€‹</p><p><strong>XV6ä¸­è‡ªæ—‹é”å®ç°åŸç†</strong>ï¼š</p><p>æ ¸å¿ƒè¿˜æ˜¯ä½¿ç”¨åŸå­æ±‡ç¼–æŒ‡ä»¤amoswap</p> <img src="https://s2.loli.net/2024/09/03/rgUN2Y6ynDORH5J.png" style="zoom:67%;" /> <img src="https://s2.loli.net/2024/09/03/G7DuMpfnCFe6NAb.png" style="zoom:67%;" /><p><strong>XV6ä¸­æ‰€æœ‰è‡ªæ—‹é”</strong></p> <img src="https://s2.loli.net/2024/09/03/pr4DlONdPWKzcRx.png" style="zoom:67%;" /><p><strong>__sync_synchronize()çš„ä½œç”¨ï¼š</strong></p><p>å‘Šè¯‰ç¼–è¯‘å™¨å’ŒCPUä¸è¦è·¨éšœç¢é‡æ–°æ’åºloadæˆ–è€…storeæŒ‡ä»¤ï¼Œå› ä¸ºxv6åœ¨è®¿é—®å…±äº«æ•°æ®æ—¶ä½¿ç”¨äº†é”ï¼Œxv6çš„<code>acquire</code>å’Œ<code>release</code>ä¸­çš„éšœç¢åœ¨å‡ ä¹æ‰€æœ‰é‡è¦çš„æƒ…å†µä¸‹éƒ½ä¼šå¼ºåˆ¶é¡ºåºæ‰§è¡Œ</p></li><li><p><strong>xv6ä¸­UARTæ¨¡å—å¯¹äºé”çš„ä½¿ç”¨</strong></p> <img src="https://s2.loli.net/2024/09/03/G9PzfSMDa2p6sxQ.png" style="zoom:80%;" /><p>å‡½æ•°é¦–å…ˆè·å¾—äº†é”ï¼Œç„¶åæŸ¥çœ‹å½“å‰ç¼“å­˜æ˜¯å¦è¿˜æœ‰ç©ºæ§½ä½ï¼Œå¦‚æœæœ‰çš„è¯å°†æ•°æ®æ”¾ç½®äºç©ºæ§½ä½ä¸­ï¼›å†™æŒ‡é’ˆåŠ 1ï¼›è°ƒç”¨uartstartï¼›æœ€åé‡Šæ”¾é”ã€‚ å¦‚æœä¸¤ä¸ªè¿›ç¨‹åœ¨åŒä¸€ä¸ªæ—¶é—´è°ƒç”¨uartputcï¼Œé‚£ä¹ˆè¿™é‡Œçš„é”ä¼šç¡®ä¿æ¥è‡ªäºç¬¬ä¸€ä¸ªè¿›ç¨‹çš„ä¸€ä¸ªå­—ç¬¦è¿›å…¥åˆ°ç¼“å­˜çš„ç¬¬ä¸€ä¸ªæ§½ä½ï¼Œæ¥ä¸‹æ¥ç¬¬äºŒä¸ªè¿›ç¨‹çš„ä¸€ä¸ªå­—ç¬¦è¿›å…¥åˆ°ç¼“å­˜çš„ç¬¬äºŒä¸ªæ§½ä½ã€‚è¿™å°±æ˜¯é”å¸®åŠ©æˆ‘ä»¬é¿å…race conditionçš„ä¸€ä¸ªç®€å•ä¾‹å­ã€‚å¦‚æœæ²¡æœ‰é”çš„è¯ï¼Œç¬¬äºŒä¸ªè¿›ç¨‹å¯èƒ½ä¼šè¦†ç›–ç¬¬ä¸€ä¸ªè¿›ç¨‹çš„å­—ç¬¦ã€‚</p><p>â€‹<div class="note note-warning">            <p>â€‹ğŸ’¡ PS.</p><p>å½“ç¬¬ä¸€ä¸ªè¿›ç¨‹é€šè¿‡acquire()æ‹¿åˆ°é”ä¹‹åï¼Œç¬¬äºŒä¸ªè¿›ç¨‹å°±ä¼šå¡åœ¨acquire()ä¸­çš„whileå¾ªç¯é‡Œ</p><p>â€‹</p>          </div></p></li><li><p><strong>acquireå‡½æ•°çš„æœ€å¼€å§‹ï¼Œä¼šå…ˆå…³é—­ä¸­æ–­ï¼šwhyï¼Ÿ</strong></p><p>æˆ‘ä»¬å›åˆ°uart.cä¸­ï¼Œå‡è®¾uartputc()ä¸­çš„acquireåœ¨ä¸€å¼€å§‹å¹¶æ²¡æœ‰å…³é—­ä¸­æ–­ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ</p><ul><li>UARTå®Œæˆå­—ç¬¦ä¼ è¾“åäº§ç”Ÿä¸€ä¸ªä¸­æ–­ï¼Œè¿è¡Œuartintrå‡½æ•°</li><li>åœ¨uartintrå‡½æ•°ä¸­ï¼Œä¼šè·å–åŒä¸€æŠŠé”ï¼Œä½†æ˜¯è¿™æŠŠé”æ­£åœ¨è¢«uartputcæŒæœ‰</li><li>ä¸­æ–­å¤„ç†ç¨‹åºuartinträ¸€ç›´ç­‰å¾…é”é‡Šæ”¾ï¼Œä½†æ˜¯CPUä¸å‡ºè®©ç»™uartputcæ‰§è¡Œçš„è¯é”åˆä¸ä¼šé‡Šæ”¾</li><li>é€ æˆæ­»é”ï¼Œå¼•å‘panic</li></ul><p>è¿™å°±è§£é‡Šä¸ºä¸ºå•¥acquire()é¦–å…ˆè¦å…³æ‰ä¸­æ–­ï¼Œrelease()å®Œåå†å¼€å¯ä¸­æ–­ æ‰€ä»¥è¯´ï¼Œspinlockå…¶å®éœ€è¦å¤„ç†ä¸¤ç±»å¹¶å‘ï¼Œä¸€ç±»æ˜¯ä¸åŒCPUä¹‹é—´çš„å¹¶å‘ï¼Œä¸€ç±»æ˜¯ç›¸åŒCPUä¸Šä¸­æ–­å’Œæ™®é€šç¨‹åºä¹‹é—´çš„å¹¶å‘ã€‚</p></li></ol><h1>LECTURE7ã€Thread switching</h1><ol><li><p><strong>çº¿ç¨‹åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†</strong>ï¼š</p><ul><li>ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰</li><li>ä¿å­˜å˜é‡çš„å¯„å­˜å™¨</li><li>ç¨‹åºçš„stackï¼ˆè®°å½•å‡½æ•°è°ƒç”¨ï¼‰</li></ul></li><li><p><strong>xv6ä¸­çš„çº¿ç¨‹åˆ‡æ¢</strong></p><p>åœ¨XV6ä¸­ï¼Œä»»ä½•æ—¶å€™åˆ‡æ¢ä¸Šä¸‹æ–‡éƒ½éœ€è¦ç»å†ï¼š</p><ul><li><p>ä»ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹åˆ‡æ¢åˆ°å¦ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹ï¼Œéƒ½éœ€è¦ä»ç¬¬ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹æ¥å…¥åˆ°å†…æ ¸ä¸­ï¼Œä¿å­˜ç”¨æˆ·è¿›ç¨‹çš„çŠ¶æ€å¹¶è¿è¡Œç¬¬ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹çš„å†…æ ¸çº¿ç¨‹</p></li><li><p>å†ä»ç¬¬ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹çš„å†…æ ¸çº¿ç¨‹åˆ‡æ¢åˆ°ç¬¬äºŒä¸ªç”¨æˆ·è¿›ç¨‹çš„å†…æ ¸çº¿ç¨‹</p></li><li><p>ç¬¬äºŒä¸ªç”¨æˆ·è¿›ç¨‹çš„å†…æ ¸çº¿ç¨‹æš‚åœè‡ªå·±ï¼Œå¹¶æ¢å¤ç¬¬äºŒä¸ªç”¨æˆ·è¿›ç¨‹çš„ç”¨æˆ·å¯„å­˜å™¨</p></li><li><p>æœ€åè¿”å›åˆ°ç¬¬äºŒä¸ªç”¨æˆ·è¿›ç¨‹ç»§ç»­æ‰§è¡Œ</p><p>â€‹<div class="note note-warning">            <p>â€‹ğŸ’¡ PS.</p><p>ç”¨æˆ·å¯„å­˜å™¨å­˜åœ¨trapframeä¸­ï¼Œå†…æ ¸çº¿ç¨‹çš„å¯„å­˜å™¨å­˜åœ¨contextä¸­</p><p>â€‹</p>          </div></p></li></ul><p><img src="https://s2.loli.net/2024/09/03/suQWUmeK6LblBcO.png" alt=""></p><p>procç»“æ„ä½“ä¸­å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ç›¸å…³çš„å†…å®¹ï¼š</p><ul><li>ä¿å­˜äº†ç”¨æˆ·ç©ºé—´çº¿ç¨‹å¯„å­˜å™¨çš„trapframeå­—æ®µ</li><li>ä¿å­˜äº†å†…æ ¸çº¿ç¨‹å¯„å­˜å™¨çš„contextå­—æ®µ</li><li>ä¿å­˜äº†å½“å‰è¿›ç¨‹çš„å†…æ ¸æ ˆçš„kstackå­—æ®µï¼Œç”¨äºè¿›ç¨‹åœ¨å†…æ ¸ä¸­æ‰§è¡Œæ—¶ä¿å­˜å‡½æ•°è°ƒç”¨</li><li>stateå­—æ®µä¿å­˜äº†å½“å‰è¿›ç¨‹çŠ¶æ€ï¼šRUNNINGï¼ŒRUNABLEï¼ŒSLEEPING</li><li>è‡ªæ—‹é”lockï¼Œå¾ˆå¤šåœ°æ–¹éƒ½ä¼šç”¨ï¼ˆå¦‚stateå­—æ®µçš„æ›´æ–°ï¼‰</li></ul><p><strong>demoç¨‹åº</strong>ï¼š</p><p><img src="https://s2.loli.net/2024/09/03/9QJ1sz8c7pmGWFg.png" alt=""></p><p><strong>è¾“å‡ºç»“æœ</strong>ï¼š</p><p><img src="https://s2.loli.net/2024/09/03/vuKiYLCI3kjT6hn.png" alt=""></p><p><strong>yieldå‡½æ•°</strong>ï¼š</p><p><img src="https://s2.loli.net/2024/09/03/ywhJ6FrXEucfKpO.png" alt=""></p><p>yield()å°†è¿›ç¨‹çš„çŠ¶æ€æ”¹ä¸ºRUNNABLEï¼Œè¿™æ„å‘³ç€å½“å‰è¿›ç¨‹è¦è®©å‡ºcpuï¼Œå¹¶åˆ‡æ¢åˆ°è°ƒåº¦å™¨çº¿ç¨‹ åŠ é”çš„ç›®çš„ï¼šå¦‚æœä¸åŠ é”çš„è¯ï¼Œå…¶å®ƒcpuçš„è°ƒåº¦å™¨çº¿ç¨‹å¯èƒ½çœ‹åˆ°è¿›ç¨‹çš„çŠ¶æ€ä¸ºRUNNABLEå¹¶å°è¯•è¿è¡Œå®ƒï¼Œè¿™å°±ä¼šå¯¼è‡´è¿›ç¨‹å°±ä¼šåœ¨ä¸¤ä¸ªCPUæ ¸ä¸Šè¿è¡Œäº†ï¼Œè€Œä¸€ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä¸ªæ ˆï¼Œè¿™æ„å‘³ç€ä¸¤ä¸ªCPUæ ¸åœ¨åŒä¸€ä¸ªæ ˆä¸Šè¿è¡Œä»£ç ï¼ˆæ³¨ï¼Œå› ä¸ºXV6ä¸­ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹åªæœ‰ä¸€ä¸ªç”¨æˆ·çº¿ç¨‹ï¼‰</p><p><strong>schedå‡½æ•°</strong>ï¼š</p><p><img src="https://s2.loli.net/2024/09/03/Lthql27geY1AWTz.png" alt=""></p><p>ä¸»è¦æ˜¯ä¸€äº›é˜²å¾¡æ€§æ£€æŸ¥ï¼Œç„¶åè°ƒç”¨swtch()</p><p><strong>swtch()</strong>ï¼š</p> <img src="https://s2.loli.net/2024/09/03/vUQdCNFSG92gMwp.png" style="zoom:67%;" /><p>swtchå‡½æ•°ä¼šå°†å½“å‰çš„å†…æ ¸çº¿ç¨‹çš„å¯„å­˜å™¨ä¿å­˜åˆ°p-&gt;contextä¸­ã€‚swtchå‡½æ•°çš„å¦ä¸€ä¸ªå‚æ•°c-&gt;contextï¼Œcè¡¨ç¤ºå½“å‰CPUçš„ç»“æ„ä½“</p><p>â€‹<div class="note note-warning">            <p>â€‹ğŸ’¡ PS.</p><p>ä¸ºå•¥swtchå‡½æ•°è¦ç”¨æ±‡ç¼–æ¥å®ç°ï¼Œè€Œä¸æ˜¯Cè¯­è¨€ï¼Ÿ å› ä¸ºCè¯­è¨€ä¸­å¾ˆéš¾ä¸å¯„å­˜å™¨äº¤äº’ï¼Œé™¤éåœ¨Cä¸­åµŒå¥—æ±‡ç¼–ï¼Œé‚£å°±å’Œå®šä¹‰ä¸€ä¸ªæ±‡ç¼–å‡½æ•°æ˜¯ç­‰ä»·çš„äº†</p><p>â€‹</p>          </div></p><p><strong>scheduler()</strong>ï¼š</p><p><img src="https://s2.loli.net/2024/09/03/2Jj57miLpWIoBqd.png" alt=""></p><p>æ‰€æœ‰xv6ä»£ç ä¸­ï¼Œä»…æœ‰æ¯ä¸ªcpuåˆå§‹åŒ–çš„æ—¶å€™è°ƒç”¨scheduler()ï¼Œå…¶ä¸»ä½“æ˜¯ä¸ªæ­»å¾ªç¯ï¼Œä»…å½“æŸä¸ªè¿›ç¨‹çŠ¶æ€ä¸ºRUNNABLEæ—¶æ‰èƒ½swtchåˆ°è¯¥è¿›ç¨‹</p></li><li><p><strong>sleep &amp; wakeup</strong></p><p>è§ã€Šå—å¤§OSç¬”è®°ã€‹æ¡ä»¶å˜é‡</p></li><li><p><strong>å±éšœæœºåˆ¶</strong></p> <img src="https://s2.loli.net/2024/09/03/vYgtTnDGcylmfZj.png" style="zoom:67%;" /> <img src="https://s2.loli.net/2024/09/03/sDGUobcZIFWahTM.png" style="zoom:80%;" /><p>å‡è®¾åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£thread()ä¸­çš„barrier()åªéœ€è¦ç®€å•åœ°å†™æˆbstate.round++å°±è¡Œï¼Œå°±å¯ä»¥ä¿è¯iå’Œtå§‹ç»ˆä¸€æ ·ï¼›</p><p>ä½†å¦‚æœæœ‰ä¸¤ä¸ªçº¿ç¨‹å°±ä¸è¡Œäº†ï¼šç¬¬ä¸€ä¸ªçº¿ç¨‹æŠŠbstate.roundåŠ ä¸€ä¸‹ï¼Œç¬¬äºŒä¸ªåˆåŠ ä¸€ä¸‹ï¼Œå°±è§¦å‘assertäº†ã€‚è¿™æ—¶å€™å°±éœ€è¦æ‰€è°“çš„å±éšœæœºåˆ¶ï¼Œæ¥ä¿è¯<strong>å¤šä¸ªçº¿ç¨‹åœ¨barrier()å¤„èƒ½â€œç­‰ä¸€ç­‰å¤§å®¶â€ï¼Œæ²¡åˆ°é½å°±ä¸èƒ½æ‰§è¡Œcritical sectionï¼Œåˆ°é½äº†å°±å…¶å®ƒçº¿ç¨‹ç¡çœ ï¼Œç•™å‡ºä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¸€æ¬¡bstate.round++å°±è¡Œ</strong>ï¼Œå°†è¿™ç§æ€æƒ³å†™æˆä»£ç å°±æ˜¯ï¼š</p> <img src="https://s2.loli.net/2024/09/03/iQ9PFR1EG8uTBcz.png" style="zoom:80%;" /> <img src="https://s2.loli.net/2024/09/03/yJ2I84pejgDfmRC.png" style="zoom:67%;" /><p>ä»»ä½•ä¸€ä¸ªçº¿ç¨‹è¿›å…¥barrier()ä¹‹åéƒ½è¦æŠŠbstate.nthreadï¼ˆè¡¨ç¤ºå½“å‰åœ¨barrier()ä¸­çš„çº¿ç¨‹æ•°ï¼‰åŠ ä¸€å¹¶åˆ¤æ–­æ˜¯å¦æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°é½ï¼Œå‡è®¾åªæœ‰ä¸€ä¸ªçº¿ç¨‹é‚£ç›´æ¥æ‰§è¡Œelseï¼Œæ²¡å•¥é—®é¢˜ï¼› å‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆå…ˆè¿›å»çš„é‚£ä¸ªä¼špthread_cond_wait()é™·å…¥ç¡çœ ï¼Œåè¿›å»çš„é‚£ä¸ªæ‰§è¡Œelseï¼ŒæŠŠbstate.round++åå†ç”¨pthread_cond_broadcast()å”¤é†’ç¡çœ ä¸­çš„çº¿ç¨‹ï¼Œè¢«å”¤é†’åæ‰§è¡Œç¬¬18è¡Œï¼Œä¸ä¼šæ”¹å˜bstate.roundï¼Œè¿™æ ·ä¸€æ¥å°±ä¿è¯äº†<strong>æ‰€æœ‰çº¿ç¨‹éƒ½ä¼šåœ¨barrierå¤„ç­‰å¾…ä¸”critical sectionåªæ‰§è¡Œä¸€æ¬¡</strong>ï¼Œnä¸ªçº¿ç¨‹æ—¶åŒç†ï¼Œç•¥</p><p>è‡³äºä¸ºå•¥barrierä¸­è¦å¯¹pthread_mutex lockå’Œunlockå‘¢ï¼Ÿ å‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸ä½¿ç”¨äº’æ–¥é”ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªçº¿ç¨‹++bstate.nthreadåã€é™·å…¥ç¡çœ å‰ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹å¯èƒ½å°±å·²ç»æ‰§è¡Œäº†å”¤é†’å‡½æ•°pthread_cond_broadcast()ï¼Œé‚£å°±ç›¸å½“äºç™½å”¤é†’äº†ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹å°±ä¼šæ°¸è¿œé™·å…¥ç¡çœ ï¼Œç¨‹åºä¸ä¼šç»ˆæ­¢ï¼ˆå¦‚ä¸‹ï¼‰ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„<strong>lost wakeup</strong></p><p><img src="https://s2.loli.net/2024/09/03/WAXGJY1LoCIRaps.png" alt=""></p><p>è€ŒåŠ ä¸Šäº’æ–¥é”åï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹é¦–å…ˆä¸Šé”ã€è¿›è¡Œifåˆ¤æ–­ã€å‡†å¤‡é™·å…¥ç¡çœ ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ç¬¬äºŒä¸ªçº¿ç¨‹å› ä¸ºæ‹¿ä¸åˆ°é”ï¼Œä¸€ç›´è¿˜åœ¨ç¬¬9è¡Œç­‰å¾…ï¼Œç­‰ç¬¬ä¸€ä¸ªçº¿ç¨‹é™·å…¥ç¡çœ åæ‰ä¼šé‡Šæ”¾é”ï¼ˆpthread_cond_wait()ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯è¦é‡Šæ”¾çš„é‚£æŠŠäº’æ–¥é”ï¼‰ï¼Œç„¶åç¬¬äºŒä¸ªçº¿ç¨‹æ‰èƒ½æ‹¿åˆ°é”ã€æ‰§è¡Œelse</p><p>æœ€ç»ˆæµ‹è¯•æ‰§è¡Œï¼š</p><p><img src="https://s2.loli.net/2024/09/03/qvmjWHsLSQJnZN3.png" alt=""></p></li><li><p><strong>å†…å­˜åˆ†é…å™¨ä¸­çš„é”ä¼˜åŒ–</strong></p><p><strong>motivation</strong>ï¼š</p><p>kallocåŸæœ¬çš„å®ç°ä¸­ç”¨freelisté“¾è¡¨æ¥ç®¡ç†ç©ºé—²ç‰©ç†é¡µï¼Œå³æŠŠ<strong>ç©ºé—²ç‰©ç†é¡µæœ¬èº«</strong>ç›´æ¥å½“ä½œé“¾è¡¨é¡¹ï¼ˆè¿™æ ·å¯ä»¥ä¸ä½¿ç”¨é¢å¤–ç©ºé—´ï¼‰ï¼Œåœ¨åˆ†é…çš„æ—¶å€™å°†ç‰©ç†é¡µä»é“¾è¡¨ä¸­ç§»é™¤ï¼Œå›æ”¶æ—¶å°†ç‰©ç†é¡µæ”¾å›é“¾è¡¨ä¸­</p> <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// kernel/kalloc.cstruct &#123;</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">spinlock</span> lock;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">run</span>*freelist;<br>&#125; kmem;<br></code></pre></td></tr></table></figure><p>åˆ†é…ç‰©ç†é¡µçš„å®ç°ï¼ˆåŸç‰ˆï¼‰ï¼š</p> <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// kernel/kalloc.c</span><br><span class="hljs-function"><span class="hljs-type">void</span>*<span class="hljs-title">kalloc</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">run</span>*r;<br><br>  <span class="hljs-built_in">acquire</span>(&amp;kmem.lock);<br>  r= kmem.freelist;<span class="hljs-comment">// å–å‡ºä¸€ä¸ªç‰©ç†é¡µã€‚é¡µè¡¨é¡¹æœ¬èº«å°±æ˜¯ç‰©ç†é¡µã€‚if(r)</span><br>  kmem.freelist= r-&gt;next;<br>  <span class="hljs-built_in">release</span>(&amp;kmem.lock);<br><br><span class="hljs-keyword">if</span>(r)<br>    <span class="hljs-built_in">memset</span>((<span class="hljs-type">char</span>*)r, <span class="hljs-number">5</span>, PGSIZE);<span class="hljs-comment">// fill with junkreturn (void*)r;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>é‡Šæ”¾ç‰©ç†é¡µï¼ˆåŸç‰ˆï¼‰ï¼š</p> <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">kfree</span><span class="hljs-params">(<span class="hljs-type">void</span>* pa)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">run</span>* r;<br><br>    <span class="hljs-keyword">if</span> (((uint64)pa % PGSIZE) != <span class="hljs-number">0</span> || (<span class="hljs-type">char</span>*)pa &lt; end || (uint64)pa &gt;= PHYSTOP)<br>        <span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;kfree&quot;</span>);<br><br>    <span class="hljs-comment">// Fill with junk to catch dangling refs.</span><br>    <span class="hljs-built_in">memset</span>(pa, <span class="hljs-number">1</span>, PGSIZE);<br><br>    r = (<span class="hljs-keyword">struct</span> run*)pa;<br><br>    <span class="hljs-built_in">acquire</span>(&amp;kmem.lock);<br>    r-&gt;next = kmem.freelist;<br>    kmem.freelist = r;<br>    <span class="hljs-built_in">release</span>(&amp;kmem.lock);<br>&#125;<br></code></pre></td></tr></table></figure><p>å›¾ç¤ºï¼š</p> <img src="https://s2.loli.net/2024/09/03/Rgi4s2xq89wBEoG.png" style="zoom:80%;" /><p>ä¸è®ºæ˜¯åˆ†é…ç‰©ç†é¡µè¿˜æ˜¯é‡Šæ”¾ï¼Œéƒ½éœ€è¦ä¿®æ”¹freelistï¼ŒåŠ é”æ˜¯ä¸ºäº†ä¿è¯å¤šçº¿ç¨‹ä¸€è‡´æ€§ï¼Œå¦åˆ™å¯èƒ½ä¼šå‡ºç°å¤šä¸ªçº¿ç¨‹åŒæ—¶æ“çºµä¸€ä¸ªç‰©ç†é¡µçš„æƒ…å†µï¼Œå¯¼è‡´å‡ºé”™ï¼›ä½†è¿™æ ·çš„é”è®¾è®¡åœ¨ä¿è¯æ­£ç¡®æ€§çš„åŒæ—¶ä¹Ÿå¯¼è‡´äº†å¤šçº¿ç¨‹æ— æ³•å¹¶å‘ç”³è¯·å†…å­˜ï¼ˆå› ä¸ºåªæœ‰ä¸€ä¸ªfreelisté“¾è¡¨ï¼Œæ‰€æœ‰å¯ç”¨çš„ç‰©ç†ç©ºé—´éƒ½ç”±è¿™ä¸ªfreelistç®¡ç†ï¼Œæ‰€ä»¥åŠ é”æ—¢é˜²æ­¢äº†â€œåŒæ—¶æ“çºµåŒä¸€ä¸ªç‰©ç†ç©ºé—´â€ï¼Œä¹Ÿé˜»æ­¢äº†â€œåŒæ—¶æ“çºµä¸åŒçš„ç‰©ç†ç©ºé—´â€ï¼‰ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„â€œé”ç«äº‰é¢‘ç¹â€</p><p><strong>è§£å†³æ€è·¯</strong>ï¼š</p><p>é”ç«äº‰ä¼˜åŒ–çš„å¸¸ç”¨æ€è·¯ï¼š</p><ul><li>åªåœ¨å¿…é¡»å…±äº«çš„æ—¶å€™å…±äº«ï¼ˆå¯¹åº”ä¸ºå°†èµ„æºä» CPU å…±äº«æ‹†åˆ†ä¸ºæ¯ä¸ª CPU ç‹¬ç«‹ï¼‰</li><li>å¿…é¡»å…±äº«æ—¶ï¼Œå°½é‡å‡å°‘åœ¨å…³é”®åŒºä¸­åœç•™çš„æ—¶é—´ï¼ˆå¯¹åº”â€œå¤§é”åŒ–å°é”â€ï¼Œé™ä½é”çš„ç²’åº¦ï¼‰</li></ul><p>è¯¥ lab çš„å®éªŒç›®æ ‡ï¼Œå³æ˜¯ä¸ºæ¯ä¸ª CPU åˆ†é…ç‹¬ç«‹çš„ freelistï¼Œè¿™æ ·å¤šä¸ª CPU å¹¶å‘åˆ†é…ç‰©ç†é¡µå°±ä¸å†ä¼šäº’ç›¸æ’æ–¥äº†ï¼Œæé«˜äº†å¹¶è¡Œæ€§ã€‚</p><p>ä½†ç”±äºåœ¨ä¸€ä¸ª CPU freelist ä¸­ç©ºé—²é¡µä¸è¶³çš„æƒ…å†µä¸‹ï¼Œä»éœ€è¦ä»å…¶ä»– CPU çš„ freelist ä¸­â€œå·â€å†…å­˜é¡µï¼Œæ‰€ä»¥ä¸€ä¸ª CPU çš„ freelist å¹¶ä¸æ˜¯åªä¼šè¢«å…¶å¯¹åº” CPU è®¿é—®ï¼Œè¿˜å¯èƒ½åœ¨â€œå·â€å†…å­˜é¡µçš„æ—¶å€™è¢«å…¶ä»– CPU è®¿é—®ï¼Œæ•…ä»ç„¶éœ€è¦ä½¿ç”¨å•ç‹¬çš„é”æ¥ä¿æŠ¤æ¯ä¸ª CPU çš„ freelistã€‚ä½†ä¸€ä¸ª CPU freelist ä¸­ç©ºé—²é¡µä¸è¶³çš„æƒ…å†µç›¸å¯¹æ¥è¯´æ˜¯æ¯”è¾ƒç¨€æœ‰çš„ï¼Œæ‰€ä»¥æ€»ä½“æ€§èƒ½ä¾ç„¶æ¯”å•ç‹¬ kmem å¤§é”è¦å¿«ã€‚åœ¨æœ€ä½³æƒ…å†µä¸‹ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰å‘ç”Ÿè·¨ CPU â€œå·â€é¡µçš„æƒ…å†µä¸‹ï¼Œè¿™äº›å°é”ä¸ä¼šå‘ç”Ÿä»»ä½•é”ç«äº‰ã€‚</p><p><strong>ä»£ç å®ç°</strong>ï¼š</p> <img src="https://s2.loli.net/2024/09/03/tS2Mdsz7wDQrW6F.png" style="zoom:67%;" /> <img src="https://s2.loli.net/2024/09/03/viLm1haYE3Us2QX.png" style="zoom:80%;" /><p>æ³¨æ„ï¼Œkinit()é˜¶æ®µä¸ºæ¯ä¸ªcpuéƒ½å»ºç«‹äº†ä¸€ä¸ªfreelisté“¾è¡¨ï¼Œåœ¨freerange()ä¸­è°ƒç”¨kfree()ï¼ŒæŠŠæ‰€æœ‰å¯ç”¨çš„ç‰©ç†ç©ºé—´å‡åˆ†ç»™äº†æ¯ä¸€ä¸ªcpuï¼ˆç†è®ºä¸Šå‡ ä¹å‡åˆ†ï¼‰</p> <img src="https://s2.loli.net/2024/09/03/p1mY4QM5IJwAC7c.png" style="zoom:67%;" /><p>åœ¨åˆ†é…å†…å­˜çš„æ—¶å€™ï¼Œè‹¥CPU freelist ä¸­ç©ºé—²é¡µæ˜¯å……è¶³çš„é‚£å°±ç›´æ¥åˆ†é…ï¼Œå„ä¸ªcpuå„å¿™å„çš„ï¼› è‹¥ç©ºé—²é¡µä¸å¤Ÿäº†åˆ™è¿è¡Œ12-30è¡Œï¼Œå»â€œå·â€åˆ«çš„cpuçš„freelistçš„ç‰©ç†é¡µ</p><p>å›¾ç¤ºï¼š</p> <img src="https://s2.loli.net/2024/09/03/rWGxDjEyMaV3vhO.png" style="zoom:80%;" /><p>æ¯æˆåŠŸå¾ªç¯è¿è¡Œä¸€æ¬¡å·ä¸€ä¸ªç‰©ç†é¡µï¼Œæœ€å¤šå·64ä¸ªï¼ˆæ•°å€¼æ˜¯éšæ„å–çš„ï¼Œåœ¨ç°å®åœºæ™¯ä¸­ï¼Œæœ€å¥½è¿›è¡Œæµ‹é‡åé€‰å–åˆé€‚çš„æ•°å€¼ï¼Œå°½é‡ä½¿å¾—â€œå·â€é¡µé¢‘ç‡ä½ï¼Œå› ä¸ºå·é¡µæ—¶ä¹Ÿè¦è°ƒç”¨é”ï¼Œå½±å“æ•ˆç‡ï¼‰</p><p>æœ€ç»ˆé”ç«äº‰é™åˆ°äº†0</p><p><img src="https://s2.loli.net/2024/09/03/d4WeTRGtQCgDbiz.png" alt=""></p></li></ol><h1>LECTURE8ã€File System</h1><ol><li><p><strong>æ–‡ä»¶ç³»ç»Ÿä¸»è¦åšçš„äº‹</strong></p><ul><li>åŸºæœ¬åŠŸèƒ½ï¼šç”¨æ•°æ®ç»“æ„æ¥è¡¨ç¤ºç›®å½•å’Œæ–‡ä»¶åç§°æ ‘ï¼Œè®°å½•æ¯ä¸ªæ–‡ä»¶å†…å®¹å—ã€ä»¥åŠç£ç›˜çš„å“ªäº›åŒºåŸŸæ˜¯ç©ºé—²çš„</li><li>å´©æºƒæ¢å¤ï¼ˆcrash recoveryï¼‰ï¼šè‹¥å‘ç”Ÿå´©æºƒï¼ˆå¦‚ç”µæºæ•…éšœï¼‰ï¼Œæ–‡ä»¶ç³»ç»Ÿå¿…é¡»é‡å¯åä»èƒ½æ­£å¸¸å·¥ä½œã€‚å…¶éš¾ç‚¹åœ¨äºå´©æºƒå¯èƒ½ä¼šä¸­æ–­ä¸€ç³»åˆ—æ›´æ–°ï¼Œå¹¶ä½¿ç£ç›˜ä¸Šçš„æ•°æ®ç»“æ„ä¸ä¸€è‡´ï¼ˆå¦‚ä¸€ä¸ªå—åœ¨æŸä¸ªæ–‡ä»¶ä¸­ä½¿ç”¨ä½†åŒæ—¶ä»è¢«æ ‡è®°ä¸ºç©ºé—²ï¼‰</li><li>åŸå­æ€§ï¼šä¸åŒçš„è¿›ç¨‹å¯èƒ½åŒæ—¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šè¿è¡Œï¼Œå› æ­¤æ–‡ä»¶ç³»ç»Ÿå¿…é¡»åè°ƒä»¥ä¿æŒä¸å˜é‡</li><li>é€Ÿåº¦ä¸ä¸€è‡´ï¼šè®¿é—®ç£ç›˜çš„é€Ÿåº¦æ¯”è®¿é—®å†…å­˜æ…¢å‡ ä¸ªæ•°é‡çº§ï¼Œå› æ­¤æ–‡ä»¶ç³»ç»Ÿå¿…é¡»ä¿æŒå¸¸ç”¨å—çš„å†…å­˜ç¼“å­˜</li></ul></li><li><p><strong>XV6ä¸­çš„æ–‡ä»¶ç³»ç»Ÿ</strong></p><p>XV6æ–‡ä»¶ç³»ç»Ÿåˆ†ä¸º7å±‚</p><table><thead><tr><th>å±‚çº§</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>ç£ç›˜ï¼ˆDiskï¼‰</td><td>å®é™…ä¿å­˜æ•°æ®ï¼Œç¡¬ä»¶å±‚é¢æä¾›æŒä¹…åŒ–</td></tr><tr><td>ç¼“å†²åŒºé«˜é€Ÿç¼“å­˜ï¼ˆBuffer cacheï¼‰</td><td>é¿å…é¢‘ç¹çš„è¯»å†™ç£ç›˜</td></tr><tr><td>æ—¥å¿—ï¼ˆLoggingï¼‰</td><td>å®ç°å´©æºƒæ¢å¤ï¼Œè½¯ä»¶å±‚é¢æä¾›æŒä¹…åŒ–</td></tr><tr><td>ç´¢å¼•èŠ‚ç‚¹ï¼ˆInodeï¼‰</td><td>å°†æ¯ä¸ªæ–‡ä»¶è¡¨ç¤ºä¸ºä¸€ä¸ªç´¢å¼•èŠ‚ç‚¹ï¼Œå…¶ä¸­åŒ…å«å”¯ä¸€çš„ç´¢å¼•å·å’Œä¸€äº›ä¿å­˜æ–‡ä»¶æ•°æ®çš„å—</td></tr><tr><td>ç›®å½•ï¼ˆDirectoryï¼‰</td><td>å°†æ¯ä¸ªç›®å½•å®ç°ä¸ºä¸€ç§ç‰¹æ®Šçš„ç´¢å¼•èŠ‚ç‚¹</td></tr><tr><td>è·¯å¾„åï¼ˆPathnameï¼‰</td><td>å¦‚***/usr/rtm/xv6/fs.c***</td></tr><tr><td>æ–‡ä»¶æè¿°ç¬¦ï¼ˆFile descriptorï¼‰</td><td>æŠ½è±¡Unixèµ„æºï¼ˆå¦‚ç®¡é“ã€è®¾å¤‡ã€æ–‡ä»¶ï¼‰</td></tr></tbody></table><p><strong>æ€ä¹ˆç†è§£æŒä¹…åŒ–</strong>ï¼š</p><p>å…³é—­è®¡ç®—æœºï¼Œè¿‡å‡ å¤©å†å¼€æœºè€Œæ–‡ä»¶ä»ç„¶åœ¨é‚£ï¼Œæˆ‘å¯ä»¥ç»§ç»­åŸºäºæ–‡ä»¶å·¥ä½œã€‚è¿™ä¸€ç‚¹ä¸è¿›ç¨‹å’Œå…¶ä»–èµ„æºä¸ä¸€æ ·ï¼Œè¿™äº›èµ„æºåœ¨è®¡ç®—æœºé‡å¯æ—¶å°±ä¼šæ¶ˆå¤±ï¼Œä¹‹åéœ€è¦é‡æ–°å¯åŠ¨å®ƒä»¬ã€‚è¿™å°±æ˜¯æ–‡ä»¶ç³»ç»Ÿæ‰€è°“çš„æŒä¹…åŒ–</p><p><strong>ç´¢å¼•èŠ‚ç‚¹ï¼ˆInodeï¼‰</strong>ï¼š</p><p>æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ ¸å¿ƒæ•°æ®ç»“æ„å°±æ˜¯<strong>inode</strong>å’Œ<strong>file descriptor</strong>ã€‚ inodeä»£è¡¨ä¸€ä¸ªæ–‡ä»¶çš„å¯¹è±¡ï¼Œä½†å®ƒä¸ä¾èµ–äºæ–‡ä»¶åï¼Œè€Œæ˜¯é€šè¿‡è‡ªèº«çš„ç¼–å·æ¥è¿›è¡ŒåŒºåˆ†ã€‚æ‰€ä»¥è¯´æ–‡ä»¶ç³»ç»Ÿå†…éƒ¨é€šè¿‡ä¸€ä¸ªæ•°å­—ï¼ˆè€Œéæ–‡ä»¶è·¯å¾„åï¼‰æ¥å¼•ç”¨inode XV6å’ŒUNIXä¸­éƒ½æœ‰ä¸€ä¸ªsyscallï¼Œå«åšlinkï¼Œç”¨æ¥ç»™åŒä¸€æ–‡ä»¶æŒ‡å®šå¤šä¸ªåå­—ï¼Œå¦‚</p> <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">link</span>(<span class="hljs-string">&quot;X/Y&quot;</span>, <span class="hljs-string">&quot;X/Z&quot;</span>)   <span class="hljs-comment">// ä¸ºæ–‡ä»¶&quot;X/Y&quot;åˆ›å»ºå¦ä¸€ä¸ªåå­—&quot;X/Z&quot;</span><br></code></pre></td></tr></table></figure><p>è€Œinodeå¿…é¡»æœ‰ä¸€ä¸ªlink countæ¥è·Ÿè¸ªæŒ‡å‘è¿™ä¸ªinodeçš„æ–‡ä»¶åçš„æ•°é‡ã€‚ä¸€ä¸ªæ–‡ä»¶ï¼ˆinodeï¼‰åªèƒ½åœ¨link countä¸º0çš„æ—¶å€™è¢«åˆ é™¤</p><p>XV6ä¸­ä¸€ä¸ªinodeçš„å¤§å°æ˜¯64å­—èŠ‚</p><ul><li>typeå­—æ®µï¼šè¡¨æ˜inodeæ˜¯æ–‡ä»¶è¿˜æ˜¯ç›®å½•</li><li>nlinkå­—æ®µï¼šä¹Ÿå°±æ˜¯linkè®¡æ•°å™¨ï¼Œç”¨æ¥è·Ÿè¸ªç©¶ç«Ÿæœ‰å¤šå°‘æ–‡ä»¶åæŒ‡å‘äº†å½“å‰çš„inode</li><li>sizeå­—æ®µï¼šè¡¨æ˜äº†æ–‡ä»¶æ•°æ®æœ‰å¤šå°‘ä¸ªå­—èŠ‚ã€‚</li><li>direct block numberï¼šè¿™12ä¸ªblockç¼–å·æŒ‡å‘äº†æ„æˆæ–‡ä»¶çš„å‰12ä¸ªblockã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæ–‡ä»¶åªæœ‰2ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆåªä¼šæœ‰ä¸€ä¸ªblockç¼–å·0ï¼Œå®ƒåŒ…å«çš„æ•°å­—æ˜¯ç£ç›˜ä¸Šæ–‡ä»¶å‰2ä¸ªå­—èŠ‚çš„blockçš„ä½ç½®ã€‚</li><li>indirect block numberï¼šæŒ‡å‘å…¶å®ƒçš„blockï¼ˆæœ‰ç‚¹ç±»ä¼¼äºpage tableçš„æ€æƒ³ï¼‰</li></ul> <img src="https://s2.loli.net/2024/09/03/L5R17KnvCWgypoU.png" style="zoom:80%;" /> <img src="https://s2.loli.net/2024/09/03/wWrBuO6ES4zQmiL.png" style="zoom:67%;" /><p><strong>æ–‡ä»¶ç³»ç»Ÿå¦‚ä½•ä½¿ç”¨ç£ç›˜</strong>ï¼š</p><p>ä¸¤ä¸ªæœ¯è¯­ï¼š</p><ul><li>sectoré€šå¸¸æ˜¯ç£ç›˜é©±åŠ¨å¯ä»¥è¯»å†™çš„æœ€å°å•å…ƒï¼Œå®ƒè¿‡å»é€šå¸¸æ˜¯512å­—èŠ‚ã€‚</li><li>blocké€šå¸¸æ˜¯æ“ä½œç³»ç»Ÿæˆ–è€…æ–‡ä»¶ç³»ç»Ÿè§†è§’çš„æ•°æ®ã€‚å®ƒç”±æ–‡ä»¶ç³»ç»Ÿå®šä¹‰ï¼Œåœ¨XV6ä¸­å®ƒæ˜¯1024å­—èŠ‚ã€‚æ‰€ä»¥XV6ä¸­ä¸€ä¸ªblockå¯¹åº”ä¸¤ä¸ªsectorã€‚é€šå¸¸æ¥è¯´ä¸€ä¸ªblockå¯¹åº”äº†ä¸€ä¸ªæˆ–è€…å¤šä¸ªsectorã€‚</li></ul><p>ï¼ˆä½†äºŒè€…æœ‰æ—¶ä¹Ÿä¼šæ··ç”¨ï¼‰</p><p><img src="https://s2.loli.net/2024/09/03/O6ikfRq2BMEbacv.png" alt=""></p><p>å¤§è‡´ç»“æ„å°±æ˜¯ï¼Œç£ç›˜ã€cpuã€å†…å­˜éƒ½è¿åˆ°æ€»çº¿ä¸Šï¼Œæ–‡ä»¶ç³»ç»Ÿè¿è¡Œåœ¨cpuä¸Šï¼Œå°†å†…éƒ¨çš„æ•°æ®å­˜å‚¨åœ¨memoryä¸­ï¼ŒåŒæ—¶ä¹Ÿä¼šä»¥è¯»å†™blockï¼ˆread/writeçš„ç³»ç»Ÿè°ƒç”¨ï¼‰çš„å½¢å¼å­˜å‚¨åœ¨ç£ç›˜ä¸­</p><p>ä»æ–‡ä»¶ç³»ç»Ÿçš„è§’åº¦æ¥çœ‹ç£ç›˜ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå·¨å¤§çš„blockçš„æ•°ç»„ï¼Œå…¶ä¸­ï¼š</p><ul><li>block0è¦ä¹ˆæ²¡æœ‰ç”¨ï¼Œè¦ä¹ˆè¢«ç”¨ä½œboot sectoræ¥å¯åŠ¨æ“ä½œç³»ç»Ÿ</li><li>block1é€šå¸¸è¢«ç§°ä¸ºsuper blockï¼Œå®ƒæè¿°äº†æ–‡ä»¶ç³»ç»Ÿã€‚å®ƒå¯èƒ½åŒ…å«ç£ç›˜ä¸Šæœ‰å¤šå°‘ä¸ªblockå…±åŒæ„æˆäº†æ–‡ä»¶ç³»ç»Ÿè¿™æ ·çš„ä¿¡æ¯</li><li>åœ¨XV6ä¸­ï¼Œloggingä»block2å¼€å§‹ï¼Œåˆ°block32ç»“æŸ</li><li>æ¥ä¸‹æ¥åœ¨block32åˆ°block45ä¹‹é—´ï¼ŒXV6å­˜å‚¨äº†inodeï¼Œä¸€ä¸ªinodeæ˜¯64å­—èŠ‚</li><li>ä¹‹åæ˜¯bitmap blockï¼Œç”¨äºè®°å½•æ•°æ®blockæ˜¯å¦ç©ºé—²ï¼Œå®ƒåªå æ®ä¸€ä¸ªblock</li><li>ä¹‹åå°±å…¨æ˜¯æ•°æ®blockäº†ï¼Œæ•°æ®blockå­˜å‚¨äº†æ–‡ä»¶çš„å†…å®¹å’Œç›®å½•çš„å†…å®¹</li></ul><p><img src="https://s2.loli.net/2024/09/03/A1VGuwecW3gQXld.png" alt="39.png"></p><p><strong>block cacheçš„é”ç­–ç•¥</strong></p><p>block cacheç”¨çš„æ˜¯sleep lockï¼ŒåŒºåˆ«äºä¸€ä¸ªå¸¸è§„çš„spinlock</p><p><img src="https://s2.loli.net/2024/09/03/OVyUpcdhMxtJREN.png" alt=""></p><p>é¦–å…ˆç”¨acquire()è·å–ä¸€ä¸ªæ™®é€šçš„è‡ªæ—‹é”ï¼Œç„¶åå¦‚æœè¿™ä¸ªé”è¢«æŒæœ‰äº†ï¼Œå°±è¿›å…¥sleepçŠ¶æ€ï¼Œå¹¶å°†è‡ªå·±ä»å½“å‰cpuè°ƒåº¦å¼€</p><p>â€‹<div class="note note-warning">            <p>â€‹ğŸ’¡ PS.</p><p>Qã€æ—¢ç„¶sleep lockæ˜¯åŸºäºspinlockå®ç°çš„ï¼Œä¸ºä»€ä¹ˆå¯¹äºblock cacheï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯sleep lockè€Œä¸æ˜¯spinlockï¼Ÿ Aã€å› ä¸ºç£ç›˜æ“ä½œéœ€è¦å¾ˆé•¿çš„æ—¶é—´ã€‚spinlockåœ¨åŠ é”æ—¶ä¸­æ–­å¿…é¡»è¦å…³é—­ï¼Œæ‰€ä»¥æŒæœ‰spinlockæ—¶æ°¸è¿œä¸èƒ½ä»ç£ç›˜æ”¶åˆ°æ•°æ®ï¼ˆå‡è®¾åªæœ‰ä¸€ä¸ªcpuï¼‰ï¼›è€Œsleep lockçš„ä¼˜åŠ¿æ˜¯ï¼ŒæŒæœ‰é”æ—¶ä¸å…³é—­ä¸­æ–­ï¼Œåœ¨ç­‰å¾…sleep lockçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰è®©CPUä¸€ç›´ç©ºè½¬ï¼Œè€Œæ˜¯é€šè¿‡sleepå°†CPUå‡ºè®©å‡ºå»äº†</p><p>â€‹</p>          </div></p></li><li><p><strong>XV6ä¸­çš„å´©æºƒæ¢å¤</strong></p><p><strong>æ¦‚è¿°</strong>ï¼šloggingæ˜¯æ•…éšœæ¢å¤çš„æœ€å…³é”®æœºåˆ¶ï¼Œåœ¨æ•°æ®åº“ã€æ–‡ä»¶ç³»ç»Ÿã€åˆ†å¸ƒå¼ç³»ç»Ÿä¸­éƒ½æœ‰å¤§é‡åº”ç”¨ï¼ˆæœ‰äº›åœ°æ–¹ä¼šæŠŠlogå«åšjournalï¼‰</p><p><strong>åˆ›å»ºæ–‡ä»¶æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¸ç£ç›˜blockçš„äº¤äº’è¿‡ç¨‹</strong>ï¼š</p><p><img src="https://s2.loli.net/2024/09/03/WBXohmfSkxdI6OC.png" alt=""></p><ul><li>é¦–å…ˆæ˜¯åˆ†é…inodeï¼Œå› ä¸ºé¦–å…ˆå†™çš„æ˜¯block 33</li><li>ä¹‹åinodeè¢«åˆå§‹åŒ–ï¼Œç„¶ååˆå†™äº†ä¸€æ¬¡block 33</li><li>ä¹‹åæ˜¯å†™block 46ï¼Œæ˜¯å°†æ–‡ä»¶xçš„inodeç¼–å·å†™å…¥åˆ°xæ‰€åœ¨ç›®å½•çš„inodeçš„data blockä¸­</li><li>ä¹‹åæ˜¯æ›´æ–°root inodeï¼Œå› ä¸ºæ–‡ä»¶xåˆ›å»ºåœ¨æ ¹ç›®å½•ï¼Œæ‰€ä»¥éœ€è¦æ›´æ–°æ ¹ç›®å½•çš„inodeçš„sizeå­—æ®µï¼Œä»¥åŒ…å«è¿™é‡Œæ–°åˆ›å»ºçš„æ–‡ä»¶x</li><li>æœ€åå†æ¬¡æ›´æ–°äº†æ–‡ä»¶xçš„inode</li></ul><p><strong>loggingçš„å·¥ä½œæµç¨‹</strong>ï¼š</p><p>é¦–å…ˆï¼Œå°†ç£ç›˜åˆ†å‰²ä¸ºlogå’Œæ–‡ä»¶ç³»ç»Ÿä¸¤ä¸ªéƒ¨åˆ†ï¼Œæ–‡ä»¶ç³»ç»Ÿå¯èƒ½æ¯”logå¤§å¾—å¤š</p><p>ï¼ˆlog writeï¼‰å°†å†™æ“ä½œ<strong>è®°å½•åˆ°logä¸­</strong>ï¼Œè€Œéç›´æ¥å†™å…¥åˆ°blockæ‰€åœ¨çš„ä½ç½® ï¼ˆcommit opï¼‰å½“æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œç»“æŸåï¼Œè®°å½•åŒä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œçš„ä¸ªæ•°ï¼Œå³commit ï¼ˆinstall logï¼‰çœŸæ­£æ‰§è¡Œlogä¸­è®°å½•çš„æ“ä½œ ï¼ˆclean logï¼‰å®Œæˆåæ¸…é™¤logï¼Œå³å°†åŒä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œä¸ªæ•°è®¾ç½®ä¸º0</p><p>ä¸ºä»€ä¹ˆè¿™æ ·èƒ½å®ç°å´©æºƒæ¢å¤å‘¢ï¼Ÿ</p><p>å‡è®¾crashå¹¶é‡å¯äº†ã€‚åœ¨é‡å¯çš„æ—¶å€™ï¼Œæ–‡ä»¶ç³»ç»Ÿä¼šæŸ¥çœ‹logçš„commitè®°å½•å€¼ï¼Œå¦‚æœæ˜¯0çš„è¯ï¼Œé‚£ä¹ˆä»€ä¹ˆä¹Ÿä¸åšã€‚å¦‚æœå¤§äº0çš„è¯ï¼Œæˆ‘ä»¬å°±çŸ¥é“logä¸­å­˜å‚¨çš„blockéœ€è¦è¢«å†™å…¥åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œå¾ˆæ˜æ˜¾æˆ‘ä»¬åœ¨crashçš„æ—¶å€™å¹¶ä¸ä¸€å®šå®Œæˆäº†install logï¼Œæˆ‘ä»¬å¯èƒ½æ˜¯åœ¨commitä¹‹åï¼Œclean logä¹‹å‰crashçš„ã€‚æ‰€ä»¥è¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯reinstallï¼ˆæ³¨ï¼Œä¹Ÿå°±æ˜¯å°†logä¸­çš„blockå†æ¬¡å†™å…¥åˆ°æ–‡ä»¶ç³»ç»Ÿï¼‰ï¼Œå†clean log</p><p><strong>XV6ä¸­çš„logç»“æ„</strong>ï¼š</p><p><img src="https://s2.loli.net/2024/09/03/lx9jDQLREK3yJBd.png" alt=""></p><p>å¼€å§‹æœ‰ä¸€ä¸ªheader blockï¼Œé‡Œé¢åŒ…å«äº†logè®°å½•æ¡æ•° å’Œ æ¯ä¸ªlog blockçš„å®é™…å¯¹åº”çš„blockç¼–å·ï¼› ä¹‹åå°±æ˜¯logçš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯blockçš„æ•°æ®</p><p><strong>log_write()å‡½æ•°</strong>ï¼š</p><p>å‰é¢æåˆ°ä»…åº”è¯¥åœ¨æ‰€æœ‰çš„å†™æ“ä½œå®Œæˆä¹‹åå†™å…¥commit recordï¼Œé‚£ä¹ˆåº”æœ‰æ‰‹æ®µæ¥è¡¨æ˜äº‹åŠ¡ï¼ˆtransactionï¼‰çš„å¼€å§‹å’Œç»“æŸï¼Œä»¥åˆ›å»ºæ–‡ä»¶çš„sys_open()ä¸ºä¾‹ï¼Œæ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿæ“ä½œéƒ½æœ‰begin_opå’Œend_opæ¥è¡¨ç¤ºäº‹åŠ¡çš„å¼€å§‹å’Œç»“æŸï¼ˆend_opä¸­å®ç°commitæ“ä½œï¼‰</p><p><img src="https://s2.loli.net/2024/09/03/8VaMRKQI3AULWtY.png" alt=""></p><p>log_writeæ˜¯æ–‡ä»¶ç³»ç»Ÿçš„loggingå®ç°çš„æ–¹æ³•ï¼Œä»»ä½•ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿè°ƒç”¨çš„begin_opå’Œend_opä¹‹é—´çš„å†™æ“ä½œæ€»æ˜¯ä¼šèµ°åˆ°log_write</p> <img src="https://s2.loli.net/2024/09/03/FAz58u2jk1JObGR.png" style="zoom:80%;" /><p>åŸºæœ¬æ€è·¯ï¼šå…ˆè·å–log headerçš„é”ï¼Œå†æ›´æ–°log headerã€‚é¦–å…ˆä»£ç ä¼šæŸ¥çœ‹block 45æ˜¯å¦å·²ç»è¢«logè®°å½•äº†ã€‚å¦‚æœæ˜¯çš„è¯ï¼Œå…¶å®ä¸ç”¨åšä»»ä½•äº‹æƒ…ï¼Œå› ä¸ºblock 45å·²ç»ä¼šè¢«å†™å…¥äº†ã€‚å¦‚æœblock 45ä¸åœ¨éœ€è¦å†™å…¥åˆ°ç£ç›˜ä¸­çš„blockåˆ—è¡¨ä¸­ï¼Œæ¥ä¸‹æ¥ä¼šå¯¹nåŠ 1ï¼Œå¹¶å°†block 45è®°å½•åœ¨åˆ—è¡¨çš„æœ€å</p><p><strong>end_op()å‡½æ•°</strong>ï¼š</p><p>end_op()ä¸­æœ€å…³é”®çš„æ˜¯commit()</p><p><img src="https://s2.loli.net/2024/09/03/B54bpCWyioKlQ1A.png" alt=""></p><p>å…¶ä¸­ä¸»è¦æœ‰ä¸¤ä¸ªæ“ä½œï¼Œwrite_logå°†ä½äºcacheä¸­çš„log headerä¸­çš„blockç¼–å·å¯¹åº”çš„blockï¼Œç§»åˆ°ç£ç›˜çš„logåŒºåŸŸä¸­ï¼›write_headå®ç°çœŸæ­£çš„commit</p><p><strong>æ–‡ä»¶ç³»ç»Ÿæ¢å¤</strong>ï¼š</p><p>å½“ç³»ç»Ÿcrashå¹¶é‡å¯æ—¶ï¼Œé¦–å…ˆè°ƒç”¨initlogå‡½æ•°</p><p><img src="https://s2.loli.net/2024/09/03/LaYjHkAuSZWv17x.png" alt=""></p><p><img src="https://s2.loli.net/2024/09/03/roztc2CKGXUuV6q.png" alt=""></p><p>å…¶ä¸­è°ƒç”¨install_transå‡½æ•°ï¼Œè¯»å–log headerä¸­çš„nï¼Œç„¶åæ ¹æ®nå°†æ‰€æœ‰çš„log blockæ‹·è´åˆ°æ–‡ä»¶ç³»ç»Ÿçš„blockä¸­ã€‚recover_from_logåœ¨æœ€åä¹Ÿä¼šè·Ÿä¹‹å‰ä¸€æ ·æ¸…é™¤log</p></li><li><p><strong>çœŸå®ä¸–ç•Œä¸­çš„å´©æºƒæ¢å¤</strong></p><p>åŒ…æ‹¬XV6åœ¨å†…çš„å¤§éƒ¨åˆ†loggingç³»ç»Ÿéœ€è¦éµå¾ªçš„ï¼š</p><ul><li><strong>write ahead rule</strong>ï¼šå…ˆå°†æ‰€æœ‰çš„å†™æ“ä½œè®°å½•åœ¨logä¸­ï¼Œç„¶åæ‰èƒ½å°†è¿™äº›å†™æ“ä½œåº”ç”¨åˆ°æ–‡ä»¶ç³»ç»Ÿçš„å®é™…ä½ç½®ï¼Œè€Œä¸æ˜¯å†™ä¸€æ¡æ›´æ–°ä¸€æ¡ï¼ˆä»è€Œä¿è¯åŸå­æ€§ï¼‰</li><li><strong>freeing rule</strong>ï¼šç›´åˆ°logä¸­æ‰€æœ‰çš„å†™æ“ä½œè¢«æ›´æ–°åˆ°æ–‡ä»¶ç³»ç»Ÿä¹‹å‰ï¼Œæˆ‘ä»¬éƒ½ä¸èƒ½é‡Šæ”¾æˆ–è€…é‡ç”¨log</li></ul><p><strong>linuxä¸­çš„ext3æ–‡ä»¶ç³»ç»Ÿ</strong>ï¼š</p><p>ext3 = ext2 + logging ext3é€šè¿‡3ç§æ–¹å¼æå‡æ€§èƒ½ï¼š</p><ul><li><strong>æä¾›å¼‚æ­¥çš„ç³»ç»Ÿè°ƒç”¨</strong>ï¼šå³ç³»ç»Ÿè°ƒç”¨åœ¨å†™å…¥åˆ°ç£ç›˜ä¹‹å‰å°±è¿”å›äº†ï¼Œç³»ç»Ÿè°ƒç”¨åªä¼šæ›´æ–°ç¼“å­˜åœ¨å†…å­˜ä¸­çš„blockï¼Œå¹¶ä¸ç”¨ç­‰å¾…å†™ç£ç›˜æ“ä½œã€‚ å³åº”ç”¨ç¨‹åºå¯ä»¥è°ƒç”¨ä¸€äº›æ–‡ä»¶ç³»ç»Ÿçš„ç³»ç»Ÿè°ƒç”¨ï¼Œä½†æ˜¯åº”ç”¨ç¨‹åºå¯ä»¥å¾ˆå¿«ä»ç³»ç»Ÿè°ƒç”¨ä¸­è¿”å›å¹¶ç»§ç»­è¿ç®—ï¼Œä¸æ­¤åŒæ—¶<strong>æ–‡ä»¶ç³»ç»Ÿåœ¨åå°ä¼šå¹¶è¡Œå®Œæˆä¹‹å‰çš„ç³»ç»Ÿè°ƒç”¨æ‰€è¦æ±‚çš„å†™ç£ç›˜æ“ä½œ</strong>ã€‚è¿™è¢«ç§°ä¸ºI/O concurrency</li><li>æä¾›æ‰¹é‡æ‰§è¡Œï¼ˆbatchingï¼‰çš„èƒ½åŠ›ï¼šå¯ä»¥å°†å¤šä¸ªç³»ç»Ÿè°ƒç”¨æ‰“åŒ…ä¸ºä¸€ä¸ªtransactionï¼Œä»è€Œåˆ†æ‘Šäº†transactionå¸¦æ¥çš„å›ºæœ‰çš„æŸè€—</li><li>æä¾›å¹¶å‘ï¼ˆconcurrencyï¼‰ï¼šå¯ä»¥æœ‰å¤šä¸ªä¸åŒçŠ¶æ€çš„transactionåŒæ—¶å­˜åœ¨ï¼Œè€ŒXV6ä¸­æ–°çš„ç³»ç»Ÿè°ƒç”¨å°±éœ€è¦ç­‰å¾…å‰ä¸€ä¸ªtransactionå®Œå…¨å®Œæˆ</li></ul></li></ol><h1>LECTURE9ã€Mmap</h1><ol><li><p><strong>motivation</strong></p><p>ä½¿ç”¨å¸¸è§„çš„readå’Œwriteæ¥è¯»å–æ–‡ä»¶æ•°æ®æ—¶ï¼Œè¦æ¶‰åŠä¸¤æ¬¡æ•°æ®å¤åˆ¶ï¼ˆç£ç›˜åˆ°å†…æ ¸ç©ºé—´ä¸€æ¬¡ï¼Œå†…æ ¸ç©ºé—´å†åˆ°ç”¨æˆ·ç©ºé—´ä¸€æ¬¡ï¼‰ï¼Œè€Œmmapåˆ™æ˜¯å°†æ–‡ä»¶ç›´æ¥æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼ˆå³ç”¨æˆ·ç©ºé—´ï¼‰ï¼Œä»è€Œå‡å°‘æ•°æ®å¤åˆ¶ï¼›æ­¤å¤–mmapå¯ä»¥åˆ©ç”¨æ“ä½œç³»ç»Ÿçš„å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œå¦‚é¡µé¢ç¼“å­˜å’ŒMMUç®¡ç†æ¥ä¼˜åŒ–æ€§èƒ½ï¼Œæ‰€ä»¥æ¯”read writeæ›´é«˜æ•ˆã€‚ç®€è€Œè¨€ä¹‹ï¼Œmmapæ›´å¤æ‚ï¼Œä½†ä¹Ÿæ›´é«˜æ•ˆ</p></li><li><p><strong>å¾®å†…æ ¸ï¼ˆmicro kernelï¼‰</strong></p><p>unixã€XV6è¿™ç§å«åšmonolithic kernelï¼Œå…¨é¢è€Œåºå¤§ï¼Œä½†é’ˆå¯¹ç‰¹å®šçš„ä»»åŠ¡å¯èƒ½åªéœ€è¦å…¶ä¸­ä¸€éƒ¨åˆ†åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯éœ€è¦æ‰€è°“çš„ç®€åŒ–çš„å¾®å†…æ ¸</p><p><strong>æ¶æ„</strong></p><p>ä¸€ä¸ªå…¸å‹çš„å¾®å†…æ ¸çš„æ ¸å¿ƒæ˜¯**IPCï¼ˆInter-Process Communicationï¼‰*<em>ä»¥åŠ*<em>çº¿ç¨‹å’Œä»»åŠ¡çš„tiny kernel</em></em>ã€‚æ‰€ä»¥å¾®å†…æ ¸åªæä¾›äº†è¿›ç¨‹æŠ½è±¡å’Œé€šè¿‡IPCè¿›ç¨‹é—´é€šä¿¡çš„æ–¹å¼ï¼Œé™¤æ­¤ä¹‹å¤–åˆ«æ— ä»–ç‰©ã€‚</p><p>å¦‚ä¸‹å›¾ï¼Œè¿˜æ˜¯ç”¨æˆ·ç©ºé—´å’Œkernelä¸¤å±‚ï¼Œç”¨æˆ·ç©ºé—´ä¸­ä¼šæœ‰å„ç§å„æ ·å¸¸è§çš„ç¨‹åºï¼Œä»¥åŠæ–‡ä»¶ç³»ç»Ÿã€ç£ç›˜é©±åŠ¨ã€ç½‘ç»œåè®®æ ˆã€è™šæ‹Ÿå†…å­˜ç³»ç»Ÿç­‰</p><p><img src="https://s2.loli.net/2024/09/03/eBk4XGarf3SQHjn.png" alt=""></p><p>å½“æ–‡æœ¬ç¼–è¾‘å™¨VIè¯»å–æ–‡ä»¶æ—¶ï¼Œå®ƒé€šè¿‡IPCä¼šå‘é€ä¸€æ¡æ¶ˆæ¯åˆ°æ–‡ä»¶ç³»ç»Ÿè¿›ç¨‹ã€‚æ–‡ä»¶ç³»ç»Ÿè¿›ç¨‹ä¸­åŒ…å«äº†æ‰€æœ‰çš„æ–‡ä»¶ç³»ç»Ÿä»£ç ï¼Œå®ƒçŸ¥é“æ–‡ä»¶ï¼Œç›®å½•çš„ä¿¡æ¯ã€‚æ–‡ä»¶ç³»ç»Ÿè¿›ç¨‹ä¼šå‘é€å¦ä¸€ä¸ªIPCåˆ°ç£ç›˜é©±åŠ¨ç¨‹åº</p><p>è€Œå†…å­˜å”¯ä¸€è¦åšçš„äº‹æ˜¯æ”¯æŒè¿›ç¨‹/ä»»åŠ¡/çº¿ç¨‹ï¼Œä»¥åŠæ”¯æŒIPCï¼›ä½†æ²¡æœ‰æ–‡ä»¶ç³»ç»Ÿã€æ²¡æœ‰è®¾å¤‡é©±åŠ¨ã€æ²¡æœ‰ç½‘ç»œåè®®æ ˆï¼Œè¿™äº›ä¸œè¥¿éƒ½æ”¾åœ¨äº†ç”¨æˆ·ç©ºé—´</p><p>è¿™ç§ç®€å•çš„OSæ¶æ„åœ¨å¾ˆå¤šåµŒå…¥å¼ç³»ç»Ÿä¸­éƒ½å¤§æœ‰åº”ç”¨</p></li></ol><h1>LECTURE10ã€Network</h1><p><strong>Ring Buffer</strong></p><p>ä¸€ä¸ªåŸºæœ¬çš„ç½‘å¡ã€ç½‘ç»œé©±åŠ¨çš„ç»“æ„æ˜¯ï¼šç½‘å¡æ”¶åˆ°ä¸€ä¸ªpacketåå°½å¿«å°†å…¶æ‹·è´è‡³è®¡ç®—æœºå†…å­˜ï¼ˆå› ä¸ºç½‘å¡è‡ªèº«å†…å­˜å°ï¼‰ï¼Œä¹‹åç”±æ“ä½œç³»ç»Ÿä¸­ä¸€ä¸ªå«IP processing threadçš„ç‹¬ç«‹çº¿ç¨‹æ¥è¯»å–å†…å­˜ä¸­çš„packeté˜Ÿåˆ—ï¼Œç„¶åå†æ¥å†³å®šå¦‚ä½•å¤„ç†è¿™äº›packetï¼Œå¯èƒ½æ˜¯ä¸Šä¼ ç»™UDPï¼›ä¹Ÿå¯èƒ½è¿™æ˜¯ä¸ªè·¯ç”±å™¨ï¼Œè¦è½¬å‘ç»™å¦ä¸€ä¸ªè·¯ç”±å™¨ï¼ˆ<strong>RXæ˜¯æ¥æ”¶é˜Ÿåˆ—ï¼ŒTXæ˜¯å‘é€é˜Ÿåˆ—</strong>ï¼‰</p><img src="https://s2.loli.net/2024/09/03/ZEbDqyCPBtONGg2.png" style="zoom:80%;" /><p>å…¶ä¸­é˜Ÿåˆ—çš„ä½œç”¨æ˜¯ï¼š</p><ul><li>åº”å¯¹çŸ­æš‚å¤§æµé‡ï¼šå¦‚IP processing threadåªèƒ½ä»¥ç‰¹å®šçš„é€Ÿåº¦å¤„ç†packetï¼Œä½†æ˜¯ç½‘å¡å¯èƒ½ä¼šä»¥å¿«å¾—å¤šçš„é€Ÿåº¦å¤„ç†packetï¼Œæ‰€ä»¥éœ€è¦é˜Ÿåˆ—ç¼“å­˜</li><li>è®©ç½‘å¡åœ¨ç©ºé—²æ—¶æŒç»­å‘é€packetï¼Œä½¿å…¶åˆ©ç”¨ç‡è¾¾åˆ°100%</li><li>å¸®åŠ©ç»„ä»¶è§£è€¦ï¼šå³IP processing threadä¸éœ€è¦çŸ¥é“ä¸­æ–­çš„å…·ä½“å®ç°ï¼ˆç½‘å¡æ”¶åˆ°ä¸€ä¸ªpacketåç”Ÿæˆä¸­æ–­ï¼Œç³»ç»Ÿè§¦å‘ä¸­æ–­å¤„ç†ç¨‹åºæ¥è·å–packetï¼‰ï¼Œç”¨é˜Ÿåˆ—æ¥ç»Ÿä¸€æ¥å£</li></ul><p>â€‹<div class="note note-warning">            <p>â€‹ğŸ’¡ PS.</p><p>åŒä¸€ä¸ªç½‘å¡å¯ä»¥æ—¢æ˜¯å‘é€æ–¹åˆæ˜¯æ¥æ”¶æ–¹ï¼Œä½†ä¸ç”¨çš„ç½‘ç»œè¦ç”¨ä¸åŒçš„ç½‘å¡æ¥è¿æ¥</p><p>â€‹</p>          </div></p><p>å½“ç½‘å¡ç›‘å¬åˆ°ç½‘çº¿ä¸Šçš„ç”µä¿¡å·æ—¶ï¼Œä¼šç›´æ¥å°†packetæ‹·è´åˆ°ä¸»æœºçš„å†…å­˜ä¸­ï¼Œå†…å­˜ä¸­çš„packetå°±ä¼šç­‰å¾…é©±åŠ¨æ¥è¯»å–è‡ªå·±ï¼Œæ‰€ä»¥ç½‘å¡éœ€è¦äº‹å…ˆçŸ¥é“åº”è¯¥å°†packetæ‹·è´åˆ°å“ªä¸ªä½ç½®ã€‚ å…·ä½“æ–¹å¼ä¸ºï¼Œä¸»æœºæ ¼å¼åŒ–å¥½ä¸€ä¸ªDMA ringæ•°ç»„ï¼Œå…¶ä¸­å­˜çš„æ˜¯packetæŒ‡é’ˆï¼ˆä¹‹æ‰€ä»¥å«ringæ˜¯å› ä¸ºè‹¥ç”¨åˆ°æ•°ç»„çš„æœ€åä¸€ä¸ªbufferï¼Œåˆ™ä¸‹ä¸€æ¬¡åˆä¼šä½¿ç”¨ç¬¬ä¸€ä¸ªbufferï¼‰ï¼Œä¸»æœºä¸Šçš„é©±åŠ¨ç¨‹åºä¼šå‘Šè¯‰ç½‘å¡DMA ringåœ¨å†…å­˜ä¸­çš„ä½ç½®ï¼Œè¿™æ ·ç½‘å¡å°±å¯ä»¥å°†packetæ‹·è´åˆ°å†…å­˜ä¸­çš„å¯¹åº”ä½ç½®</p><img src="https://s2.loli.net/2024/09/03/lt73eFwcNpu2DGB.png" style="zoom:80%;" /><p>æ­¤å¤–ï¼Œä¹Ÿä¼šæœ‰ä¸€ä¸ªTX ringï¼Œé©±åŠ¨ä¼šå°†éœ€è¦ç½‘å¡ä¼ è¾“çš„packetå­˜å‚¨åœ¨ TX ringä¸­ï¼Œç½‘å¡ä¹Ÿéœ€è¦çŸ¥é“TX ringçš„åœ°å€</p>]]></content>
    
    
    <categories>
      
      <category>æ ¸å¿ƒç§‘æŠ€çœ‹ç¾å¸</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
      <tag>XV6</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€Šå—äº¬å¤§å­¦æ“ä½œç³»ç»Ÿç¬”è®°ã€‹</title>
    <link href="/2023/11/06/%E3%80%8A%E5%8D%97%E5%A4%A7OS%E7%AC%94%E8%AE%B0%E3%80%8B/"/>
    <url>/2023/11/06/%E3%80%8A%E5%8D%97%E5%A4%A7OS%E7%AC%94%E8%AE%B0%E3%80%8B/</url>
    
    <content type="html"><![CDATA[<div class="note note-success">            <p>è¯¾ç¨‹æ¥æºï¼šNJU-OS(22 spring)</p><p>è¯¾ç¨‹ä¸»é¡µï¼š<a href="https://github.com/qlhhahaha/CS61C-SU20">æ“ä½œç³»ç»Ÿï¼šè®¾è®¡ä¸å®ç° (2022 æ˜¥å­£å­¦æœŸ)</a></p><p>è¯¾ç¨‹è§†é¢‘ï¼š<a href="https://space.bilibili.com/202224425/channel/collectiondetail?sid=192498">https://space.bilibili.com/202224425/channel/collectiondetail?sid=192498</a></p>          </div><h1>ã€Šå—å¤§OSç¬”è®°ã€‹@qlhhahaha</h1><h2 id="Lecture0ã€åŸºç¡€çŸ¥è¯†è¡¥å……">Lecture0ã€åŸºç¡€çŸ¥è¯†è¡¥å……</h2><ol><li><p><strong>ECFï¼ˆExceptional Control Flowï¼Œå¼‚å¸¸æ§åˆ¶æµï¼‰</strong></p> <img src="https://s2.loli.net/2023/11/05/HoTh3f4UIMEAOV8.jpg" style="zoom: 50%;" /></li></ol><p>â€‹<img src="https://s2.loli.net/2023/11/05/U2RelQGcsMA4EVh.png" style="zoom: 67%;" /></p><div class="note note-warning">            <p>ğŸ’¡ PS. ä¸­æ–­æ˜¯å¼‚å¸¸çš„ä¸€ç§ï¼Œé™¤å®ƒå¤–è¿˜æœ‰æ•…éšœä¸­æ­¢ã€ç³»ç»Ÿè°ƒç”¨ç­‰å¼‚å¸¸ç±»å‹</p>          </div><ol start="2"><li><strong>bootloader</strong></li></ol><p>ä¹Ÿæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åºï¼Œä½“é‡å°ï¼Œæ˜¯ç³»ç»Ÿä¸Šç”µåæ‰§è¡Œçš„ç¬¬ä¸€æ®µä»£ç ï¼Œåœ¨å®ŒæˆCPUå’Œç›¸å…³ç¡¬ä»¶çš„åˆå§‹åŒ–ä¹‹åï¼Œå†å°†æ“ä½œç³»ç»Ÿæ˜ åƒè£…è½½åˆ°å†…å­˜ä¸­ï¼Œç„¶åè·³è½¬åˆ°æ“ä½œç³»ç»Ÿæ‰€åœ¨çš„ç©ºé—´ï¼Œå¯åŠ¨æ“ä½œç³»ç»Ÿæ‰§è¡Œ</p><ol start="3"><li><p><strong>æ“ä½œç³»ç»Ÿå†…æ ¸å¯åŠ¨è¿‡ç¨‹</strong></p><ul><li><strong>CPU Reset</strong>ï¼šCPUæ‰§è¡Œå¤ä½å‘é‡çš„æŒ‡ä»¤ï¼Œé€šå¸¸æŒ‡å‘0xFFFF0ï¼ˆ32ä½ï¼‰æˆ–è€…0xFFFFFFF0ï¼ˆ64ä½ï¼‰ï¼Œè¿™ä¸ªåœ°å€æ˜¯ä¸»æ¿ROMä¸Šçš„BIOS/UEFIå…¥å£</li><li><strong>firmwareï¼ˆä¸»æ¿ROMè£…çš„BIOS/UEFIï¼‰</strong>ï¼šbiosæŸ¥è¯¢å¯ä»¥ç”¨æ¥å¯åŠ¨æ“ä½œç³»ç»Ÿçš„å­˜å‚¨è®¾å¤‡</li><li>**bootloaderï¼š**åŠ è½½å¹¶å¼•å¯¼æ“ä½œç³»ç»Ÿå†…æ ¸</li><li>**Kernel_start()ï¼š**æ‰§è¡Œæ“ä½œç³»ç»Ÿå†…æ ¸ä»¥åŠå¯åŠ¨å„ç§æœåŠ¡</li></ul></li></ol><h2 id="Lecture1ã€æ¦‚è¿°">Lecture1ã€æ¦‚è¿°</h2><ol><li><p><strong>æ“ä½œç³»ç»Ÿæ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><ul><li><p>è®¾è®¡\åº”ç”¨è§†è§’ï¼šæ“ä½œç³»ç»Ÿ=å¯¹è±¡+APIï¼ˆå¯¹åº”è¯¾ç¨‹çš„Mini Labï¼Œä½¿ç”¨OS APIå®ç°é»‘ç§‘æŠ€ä»£ç ï¼‰</p></li><li><p>å®ç°\ç¡¬ä»¶è§†è§’ï¼šæ“ä½œç³»ç»Ÿ=Cç¨‹åºï¼ˆå¯¹åº”OS Labï¼Œè‡ªå·±åŠ¨æ‰‹å®ç°ä¸€ä¸ªçœŸæ­£çš„æ“ä½œç³»ç»Ÿï¼‰</p></li></ul></li><li><p><strong>ç¨‹åº=çŠ¶æ€æœº</strong></p><p>Cç¨‹åºä¹Ÿæ˜¯ä¸€ä¸ªçŠ¶æ€æœºæ¨¡å‹ï¼Œå…¶ä¸­çŠ¶æ€å³å †+æ ˆï¼Œæ‰§è¡Œä¸€æ¡è¯­å¥å³å®ç°çŠ¶æ€çš„è¿ç§»</p></li></ol><p>â€‹<img src="https://s2.loli.net/2023/11/05/x7apfZhNHC9ques.png" style="zoom:50%;" /></p><ol start="3"><li><p><strong>å¦‚ä½•åœ¨ç¨‹åºçš„ä¸¤ä¸ªè§†è§’ä¹‹é—´åˆ‡æ¢ï¼Ÿ</strong></p><p>é€šè¿‡ç¼–è¯‘å™¨å®Œæˆ</p></li></ol><p>â€‹<img src="https://s2.loli.net/2023/11/05/C67UHzRwhpOea5c.png" style="zoom:50%;" /></p><p>â€‹ç¼–è¯‘ï¼ˆä¼˜åŒ–ï¼‰çš„æ­£ç¡®æ€§ï¼ˆsoundnessï¼‰ï¼š</p><p>â€‹<strong>Sä¸Cçš„å¯è§‚æµ‹è¡Œä¸ºä¸¥æ ¼ä¸€è‡´ï¼Œå³Cä»£ç çŠ¶æ€æœºä¸Šæ‰€æœ‰ä¸å¯ä¼˜åŒ–çš„barrieréƒ½è¢«æ­£ç¡®åœ°ç¿»è¯‘åˆ°æ±‡ç¼–ä¸Š</strong></p><p>â€‹<img src="https://s2.loli.net/2023/11/05/5G9tMFhkjnwBOpE.png" style="zoom:67%;" /></p><p>â€‹</p><h2 id="Lecture2ã€å¤šå¤„ç†å™¨ç¼–ç¨‹-å¹¶å‘ç¨‹åºæ‰§è¡Œ">Lecture2ã€å¤šå¤„ç†å™¨ç¼–ç¨‹ &amp;&amp; å¹¶å‘ç¨‹åºæ‰§è¡Œ</h2><ol><li><strong>å¹¶å‘ï¼ˆconcurrencyï¼‰å’Œå¹¶è¡Œï¼ˆparallelï¼‰</strong><ul><li>å¹¶å‘ï¼šä¸€ä¸ªå¤„ç†å™¨å¤„ç†å¤šä¸ªä»»åŠ¡ï¼Œå®é™…ä¸Šå…ˆåæ‰§è¡Œï¼Œçœ‹èµ·æ¥åŒæ—¶å‘ç”Ÿ</li><li>å¹¶è¡Œï¼šå¤šä¸ªå¤„ç†å™¨ï¼ˆæˆ–å•å¤„ç†å™¨çš„å¤šæ ¸ï¼‰åŒæ—¶å¤„ç†å¤šä¸ªä¸åŒä»»åŠ¡ï¼Œç‰©ç†ä¸ŠçœŸæ­£åŒæ—¶</li></ul></li></ol><p>â€‹</p><ol start="2"><li><strong>å¹¶å‘çš„åŸºæœ¬å•ä½ï¼šçº¿ç¨‹</strong></li></ol><p>å„ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„PCã€å¯„å­˜å™¨ã€æ ˆç©ºé—´ï¼Œä½†å…¨å±€çš„é™æ€ç©ºé—´æ˜¯å…±äº«çš„</p><p><img src="https://s2.loli.net/2023/11/05/eOM5gRbPGw1WSup.png" alt=""></p><ol start="3"><li><p><strong>å¹¶å‘ç‰ºç‰²äº†ä»€ä¹ˆï¼Ÿ</strong></p><ul><li><p><strong>åŸå­æ€§</strong></p><p>æ¡ˆä¾‹ï¼šå±±å¯¨å¤šçº¿ç¨‹æ”¯ä»˜å®</p>  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread.h&quot;</span></span><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> balance = <span class="hljs-number">100</span>;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Alipay_withdraw</span><span class="hljs-params">(<span class="hljs-type">int</span> amt)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (balance &gt;= amt) &#123;<br>    <span class="hljs-built_in">usleep</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// unexpected delays</span><br>    balance -= amt;<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Talipay</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> </span>&#123;<br>  <span class="hljs-built_in">Alipay_withdraw</span>(<span class="hljs-number">100</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-built_in">create</span>(Talipay);<br>  <span class="hljs-built_in">create</span>(Talipay);<br>  <span class="hljs-built_in">join</span>();<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;balance = %lu\n&quot;</span>, balance);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><p><img src="https://s2.loli.net/2023/11/05/Tq8DOc1tKJRNdgr.png" alt=""></p><p>è§£é‡Šï¼š</p><p>â€œç¨‹åºç”±ç‹¬å å¤„ç†å™¨æ‰§è¡Œâ€çš„åŸºæœ¬å‡è®¾åœ¨ç°ä»£å¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šä¸å†æˆç«‹ã€‚å¯¹äºå•å¤„ç†å™¨å¤šçº¿ç¨‹æ¥è¯´ï¼Œçº¿ç¨‹åœ¨è¿è¡Œæ—¶å¯èƒ½è¢«ä¸­æ–­ï¼Œåˆ‡æ¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼›å¯¹äºå¤šå¤„ç†å™¨å¤šçº¿ç¨‹æ¥è¯´ï¼Œçº¿ç¨‹æ ¹æœ¬å°±æ˜¯å¹¶è¡Œæ‰§è¡Œçš„</p><p>è§£å†³æ–¹æ³•ï¼š</p><p>çº¿ç¨‹æ± </p></li><li><p><strong>é¡ºåº</strong></p>  <img src="https://s2.loli.net/2023/11/05/IKrbYvFkix4OlGJ.png" style="zoom:50%;" /></li><li><p><strong>å¯è§æ€§</strong></p><p>ç®€å•åœ°è¯´ï¼Œç°ä»£å¤„ç†å™¨ä¹Ÿæ˜¯ä¸€ä¸ªåŠ¨æ€çš„ç¼–è¯‘å™¨ï¼Œå•ä¸ªå¤„ç†å™¨ä¼šæŠŠæ±‡ç¼–ä»£ç â€œç¼–è¯‘â€æ›´å°çš„å¾®opï¼Œæ¯ä¸ªå¾®opéƒ½æœ‰Fetchã€Issueã€Executeã€Commitå››ä¸ªé˜¶æ®µ</p>  <img src="https://s2.loli.net/2023/11/05/xGykX2wqzlApn75.png" style="zoom:67%;" /></li></ul></li></ol><p>â€‹è¿™æ ·çš„â€œä¹±åºâ€å¯¼è‡´äº†å¯è§æ€§çš„ä¸§å¤±</p><p>â€‹è§£å†³æ–¹æ³•ï¼š</p><p>â€‹<img src="https://s2.loli.net/2023/11/05/mLeaRVvpNj7ikJ4.png" style="zoom:67%;" /></p><ol start="4"><li><p><strong>å…³äºäº’æ–¥ç®—æ³•çš„ä¸€ä¸ªå¤±è´¥å°è¯•</strong></p><p>èƒ½å¦é€šè¿‡ä¸‹é¢è¿™ç§æ–¹å¼æ¥å®ç°äº’æ–¥ç®—æ³•æï¼Ÿ</p><p>å…·ä½“æ¥è¯´ï¼Œæ¯”å¦‚é€šè¿‡åŠ é”æ¥å®ç°äº’æ–¥</p> <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">int</span> locked = UNLOCK;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">critical_section</span><span class="hljs-params">()</span> </span>&#123;<br>retry:<br>  <span class="hljs-keyword">if</span> (locked != UNLOCK) &#123;<br>    <span class="hljs-keyword">goto</span> retry;<br>  &#125;<br>  locked = LOCK;<br><br>  <span class="hljs-comment">// critical section</span><br><br>  locked = UNLOCK;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç­”æ¡ˆæ˜¯ä¸è¡Œï¼Œæ¯”å¦‚ï¼Œå¯èƒ½ä¸¤ä¸ªçº¿ç¨‹å‡ ä¹åŒæ—¶ç»•è¿‡ if æ£€æµ‹ï¼Œç„¶åä¸Šä¸¤æ¬¡é”ï¼Œå¹¶éƒ½æ‰§è¡Œcritical section</p></li><li><p><strong>å¦ä¸€ä¸ªæˆåŠŸçš„å°è¯•ï¼šPetersonç®—æ³•</strong></p> <img src="https://s2.loli.net/2023/11/05/yn4P9Vzvehp6WS1.png" style="zoom: 67%;" /></li></ol><p>â€‹ä¸ºä»€ä¹ˆå¯ä»¥å®ç°äº’æ–¥å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ†ç±»è®¨è®ºæ¥å®šæ€§ç†è§£ä¸€ä¸‹ï¼š</p><ul><li>å‡å¦‚Aæƒ³ä¸Šå•æ‰€ä½†Bä¸æƒ³ï¼šæ­¤æ—¶Aä¸¾æ——ï¼Œå‘ç°Bæ²¡ä¸¾ï¼ŒOKï¼Œé‚£ä»–ç›´æ¥å»ä¸Šå°±è¡Œ</li><li>å‡å¦‚Aã€BåŒæ—¶æƒ³ä¸Šå•æ‰€ï¼šåŒæ—¶ä¸¾æ——ï¼Œç„¶ååŒæ—¶å¾€å•æ‰€é—¨ä¸Šè´´æ ‡ç­¾ï¼Œ<strong>è°æ‰‹é€Ÿå¿«æœ€åé—¨ä¸Šå°±æ˜¯è°çš„åå­—</strong>ï¼ˆå› ä¸ºè´´çš„æ˜¯å¯¹æ–¹çš„åå­—ï¼Œæ‰€ä»¥å…ˆè´´çš„é‚£ä¸ªä¼šè¢«åè´´çš„é‚£ä¸ªè¦†ç›–æ‰â€”â€”çœ‹èµ·æ¥äº’ç›¸è°¦è®©ï¼Œå…¶å®æœ€åè¿˜æ˜¯è‡ªç§æ‹¼æ‰‹é€Ÿï¼‰ã€‚å‡è®¾Aæ‰‹é€Ÿæ›´å¿«ï¼Œé‚£ä¹ˆæœ€åæ ‡ç­¾å°±æ˜¯â€œAæ­£åœ¨ä½¿ç”¨â€ï¼Œåˆ™Aè¿›ã€Bç­‰å¾…</li></ul><div class="note note-warning">            <p>ğŸ’¡ PS.  â€œäº’ç›¸è´´å¯¹æ–¹åå­—â€ï¼ˆè°¦è®©turnï¼‰è¿™ä¸ªè®¾å®šå…¶å®å¾ˆæœ‰è¶£ï¼Œå› ä¸ºå¦‚æœåªä¸¾æ——è€Œä¸è´´æ ‡ç­¾çš„è¯ï¼Œé‚£ä¹ˆåŒæ—¶ä¸¾æ——åæ²¡åŠæ³•ä¿è¯è°è¿›è°ä¸è¿›â€”â€”è¿™æ­£æ˜¯ä¸Šé¢ç¬¬4ç‚¹ç®—æ³•çš„å¤±è´¥ä¹‹å¤„</p>          </div><h2 id="Lecture3ã€äº’æ–¥ä¸åŒæ­¥">Lecture3ã€äº’æ–¥ä¸åŒæ­¥</h2><ol><li><p><strong>æå‡ºé”æœºåˆ¶çš„motivation</strong></p><p>åœ¨å…±äº«å†…å­˜ä¸Šå®ç°äº’æ–¥çš„æ ¹æœ¬å›°éš¾ï¼š<strong>ä¸èƒ½åŒæ—¶è¯»/å†™å†…å­˜ã€‚</strong></p><p>æ€ä¹ˆè¯´ï¼Ÿæƒ³è±¡ç‰©ç†ä¸–ç•Œä¸­ï¼Œå¤§å®¶éƒ½æƒ³ä¸Šå•æ‰€ï¼Œæ‰€ä»¥åŒæ—¶å»æ‹¿å•æ‰€é’¥åŒ™ã€‚è°æ‹¿åˆ°é’¥åŒ™ï¼Œå°±åŒæ—¶è§¦å‘äº†â€œæˆ‘getäº†é’¥åŒ™â€å’Œâ€œå¯¹å…¶ä»–äººæ¥è¯´ï¼Œé’¥åŒ™æ— æ³•è¢«getâ€ä¸¤ä»¶äº‹ â€”â€” è¨€ä¸‹ä¹‹æ„ï¼Œç‰©ç†ä¸–ç•Œä¸­çš„è¯»å†™æ“ä½œæ˜¯åŸå­æ€§çš„ï¼è¯»å’Œå†™å¯ä»¥åœ¨ä¸€ç¬é—´è¢«åŒæ—¶å®Œæˆï¼</p><p>é‚£åœ¨è®¡ç®—æœºä¸–ç•Œä¸­æ˜¯è¿™æ ·å—ï¼Ÿæ˜¾ç„¶ä¸æ˜¯ï¼Œçº¿ç¨‹Aè¯»å‡ºè¿™æŠŠé’¥åŒ™åï¼Œè¿˜è¦èŠ±æ—¶é—´å†å»æ”¹å†™é’¥åŒ™çŠ¶æ€ï¼ˆå“ªæ€•è€—æ—¶å¾ˆå°‘ï¼‰ï¼›é‚£ä¹ˆåœ¨è¿™æ®µæ—¶é—´é‡Œï¼Œçº¿ç¨‹Bå¯èƒ½ä¹Ÿä¼šè¯»å‡ºè¿™æŠŠé’¥åŒ™ï¼Œæœ€ç»ˆå¯¼è‡´äº’æ–¥å¤±è´¥ã€‚</p><p>é¡ºç€ä¸Šé¢çš„æ€è·¯ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°ï¼šæ¬¸ï¼Œé‚£å¦‚æœæˆ‘ä»¬æ‰¾åˆ°ä¸€ç§<strong>åŸå­æ€§çš„è¯»å†™æ–¹å¼</strong>ï¼Œæ˜¯ä¸æ˜¯å°±å¯ä»¥å’Œç‰©ç†ä¸–ç•Œä¸€æ ·ï¼Œè§£å†³è¿™ä¸ªé—®é¢˜äº†æï¼Ÿ</p></li><li><p><strong>è‡ªæ—‹é”ï¼ˆSpin Lockï¼‰</strong></p> <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//å®ç°äº’æ–¥ï¼šè‡ªæ—‹é”</span><br><br><span class="hljs-type">int</span> key = YES; <span class="hljs-comment">//å€¼ä¸ºYESè¡¨ç¤ºé’¥åŒ™å¯ç”¨</span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">lock</span><span class="hljs-params">()</span> </span>&#123;<br>retry:<br>  <span class="hljs-type">int</span> got = <span class="hljs-built_in">xchg</span>(&amp;key, NOPE);<br>  <span class="hljs-keyword">if</span> (got == NOPE)<br>    <span class="hljs-keyword">goto</span> retry;<br>  <span class="hljs-built_in">assert</span>(got == YES);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-built_in">xchg</span>(&amp;key, YES)<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ got = xchg(&amp;table, NOPE) å³æ˜¯ä¸€æ¡åŸå­æ€§çš„äº¤æ¢æŒ‡ä»¤ï¼Œå®ƒè¡¨ç¤º<strong>åŒæ—¶</strong>å®Œæˆâ€å–å‡ºtableçš„å€¼ç»™åˆ°gotâ€œå’Œâ€æŠŠNOPEå†™å…¥tableâ€œä¸¤ä¸ªæ“ä½œ</p><p>æƒ³æƒ³ï¼Œä¸ºå•¥æœ‰äº†è¿™ä¸ªæ“ä½œï¼Œå°±èƒ½å®ç°äº’æ–¥ï¼Ÿ</p><p>å‡è®¾çº¿ç¨‹Aç¬¬ä¸€ä¸ªæ‹¿åˆ°é’¥åŒ™ï¼Œä¹Ÿå°±æ˜¯ç”¨ xchg å–å‡ºé’¥åŒ™å¹¶å†™å…¥NOPEï¼ˆè¿™ä¸ªæ“ä½œè¿‡ç¨‹æ˜¯åŸå­çš„ï¼Œæ‰€ä»¥å…¶å®ƒçº¿ç¨‹å¹²æ‰°ä¸äº†ï¼‰ï¼Œé‚£ä¹ˆå®ƒä¼šè·³è¿‡ä¸‹é¢é‚£ä¸ª if ï¼Œç›´æ¥è¿›å…¥critical sectionï¼ˆä¸´ç•ŒåŒºï¼‰ï¼›è€Œå¯¹äºå…¶å®ƒåæ¥çš„çº¿ç¨‹ï¼Œå†è¯•å›¾ç”¨ xchg(&amp;table, NOPE)å–é’¥åŒ™æ—¶ï¼Œä¼šå‘ç°é‡Œé¢çš„å€¼å·²ç»æ˜¯NOPEäº†ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨ä¸‹é¢çš„ if åˆ¤æ–­é‡Œç©ºè½¬ï¼ˆæ‰€è°“**â€è‡ªæ—‹â€œ**å°±æ˜¯è¿™ä¸ªæ„æ€ï¼‰ã€‚ç›´åˆ°çº¿ç¨‹Aæ‰§è¡Œunlock()ï¼Œé’¥åŒ™é‡Œçš„å€¼é‡æ–°å˜ä¸ºYESï¼Œå…¶å®ƒçº¿ç¨‹æ‰æœ‰æœºä¼šè¿›å…¥ä¸´ç•ŒåŒºã€‚</p><p>ä¸Šè¿°ä»£ç ä¹Ÿå¯ä»¥ç®€å†™ä¸ºä¸‹åˆ—å½¢å¼ï¼ˆæ›´å¸¸è§ï¼‰ï¼š</p> <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">int</span> locked = <span class="hljs-number">0</span>; <span class="hljs-comment">//0è¡¨ç¤ºé’¥åŒ™å¯ç”¨</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">lock</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">while</span> (<span class="hljs-built_in">xchg</span>(&amp;locked, <span class="hljs-number">1</span>)) ; &#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-built_in">xchg</span>(&amp;locked, <span class="hljs-number">0</span>); &#125;<br></code></pre></td></tr></table></figure> <div class="note note-warning">            <p>ğŸ’¡ PS. ç”¨pythonå®ç°è‡ªæ—‹é”æ—¶ï¼Œä¼šå‘ç°åªéœ€è¦ç”¨ä¸€è¡Œ x, y = y, x å°±å¯ä»¥å®ç°åŸå­æ€§çš„äº¤æ¢ â€”â€” å†æ¬¡æ˜ è¯äººç”Ÿè‹¦çŸ­æˆ‘ç”¨pyçš„çœŸç†ã€‚ã€‚</p>          </div></li><li><p><strong>è‡ªæ—‹é”çš„ç¼ºé™·å’Œåº”ç”¨åœºæ™¯</strong></p></li></ol><p>ç”±è‡ªæ—‹é”çš„å®ç°æœºåˆ¶ï¼Œå¯ä»¥è‡ªç„¶è€Œç„¶åœ°æƒ³åˆ°å®ƒæœ‰ä»¥ä¸‹ç¼ºé™·ï¼š</p><ul><li><p>è‡ªæ—‹ï¼ˆå…±äº«å˜é‡ï¼‰ä¼šè§¦å‘å¤„ç†å™¨é—´çš„<strong>ç¼“å­˜åŒæ­¥</strong>ï¼Œå»¶è¿Ÿå¢åŠ ï¼šä¸€æ—¦ä¸€ä¸ªçº¿ç¨‹æ”¹å˜äº†å…±äº«å˜é‡ï¼Œå°±è¦åœ¨å„ä¸ªcpuçš„ç¼“å­˜ä¹‹é—´åŒæ­¥ï¼Œè€Œç¼“å­˜ä¸€è‡´æ€§æœ¬èº«ä¼šå¢åŠ å¼€é”€</p></li><li><p>é™¤äº†è¿›å…¥ä¸´ç•ŒåŒºçš„çº¿ç¨‹ï¼Œå…¶å®ƒå¤„ç†å™¨ä¸Šçš„çº¿ç¨‹éƒ½åœ¨**ç©ºè½¬ï¼Œ**ä¸”äº‰æŠ¢é”çš„å¤„ç†å™¨è¶Šå¤šï¼Œåˆ©ç”¨ç‡è¶Šä½</p></li><li><p>è·å¾—è‡ªæ—‹é”çš„çº¿ç¨‹å¯èƒ½<strong>è¢«æ“ä½œç³»ç»Ÿåˆ‡æ¢å‡ºå»</strong>ï¼Œä»è€Œé€ æˆ100%çš„èµ„æºæµªè´¹</p><p>æˆ‘ä»¬å¯ç”¨ä¸‹åˆ—ä»£ç è¿›è¡Œæ€§èƒ½æµ‹è¯•ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;thread-sync.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> N 10000000</span><br><span class="hljs-type">spinlock_t</span> lock = <span class="hljs-built_in">SPIN_INIT</span>();<br><br><span class="hljs-type">long</span> n, sum = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">//è‡ªæ—‹é”</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Tsum</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) &#123;<br>    <span class="hljs-built_in">spin_lock</span>(&amp;lock);<br>    sum++;<br>    <span class="hljs-built_in">spin_unlock</span>(&amp;lock);<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> </span>&#123;<br>  <span class="hljs-built_in">assert</span>(argc == <span class="hljs-number">2</span>);<br>  <span class="hljs-type">int</span> nthread = <span class="hljs-built_in">atoi</span>(argv[<span class="hljs-number">1</span>]);<br><br>  <span class="hljs-comment">//æŠŠä¸€ä¸ªæ±‚å’Œä»»åŠ¡åˆ†ç»™nthreadä¸ªçº¿ç¨‹åš</span><br>  n = N / nthread;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; nthread; i++) &#123;<br>    <span class="hljs-built_in">create</span>(Tsum);<br>  &#125;<br>  <span class="hljs-built_in">join</span>();<br>  <span class="hljs-built_in">assert</span>(sum == n * nthread);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p>â€‹å½“çº¿ç¨‹æ•°åˆ†åˆ«ä¸º1ã€2ã€4ã€32æ—¶ï¼š</p><p>â€‹<img src="https://s2.loli.net/2023/11/05/8fJLWCQcyqnUzFV.png" alt=""></p><p>â€‹å¥‡æ€ªçš„äº‹æƒ…å‘ç”Ÿäº†ï¼éšç€çº¿ç¨‹æ•°å¢åŠ ï¼Œè€—æ—¶ä¸å¢åå‡ï¼Œè¿™æ˜ è¯äº†ä¸Šé¢åˆ†æçš„è‡ªæ—‹é”çš„ç¼ºé™·</p><p>â€‹<img src="https://s2.loli.net/2023/11/05/S1rluGZy9jEvkHV.png" alt=""></p><p>â€‹é‚£ä¹ˆè‡ªæ—‹é”åº”è¯¥åº”ç”¨åœ¨å“ªäº›åœºæ™¯å‘¢ï¼šä¸´ç•ŒåŒºçŸ­ã€å‡ ä¹ä¸æ‹¥å µï¼›æŒæœ‰è‡ªæ—‹é”æ—¶ç¦æ­¢æ‰§è¡Œæµåˆ‡æ¢</p><p>â€‹å…·ä½“åœºæ™¯å¦‚ï¼š<strong>æ“ä½œç³»ç»Ÿå†…æ ¸çš„å¹¶å‘æ•°æ®ç»“æ„ï¼ˆçŸ­ä¸´ç•ŒåŒºï¼‰</strong></p><p>â€‹åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥å…³é—­ä¸­æ–­å’ŒæŠ¢å ï¼Œä¿è¯é”çš„æŒæœ‰è€…åœ¨å¾ˆçŸ­çš„æ—¶é—´å†…å¯ä»¥é‡Šæ”¾é”</p><ol start="4"><li><p><strong>äº’æ–¥é”ï¼ˆMutex Lockï¼‰</strong></p><p>åˆ†æå®Œä¸Šé¢è‡ªæ—‹é”çš„ç¼ºé™·åï¼Œä¸€ä¸ªè‡ªç„¶è€Œç„¶çš„æ€è·¯å°±æ˜¯ï¼šå…¶å®ƒçº¿ç¨‹æ— æ³•è¿›å…¥ä¸´ç•ŒåŒºæ—¶ï¼Œèƒ½ä¸èƒ½è®©å®ƒä»¬å»åšå…¶å®ƒäº‹ï¼Œè€Œä¸æ˜¯æé‚£å„¿è‡ªæ—‹å¹²ç­‰å‘¢ï¼Ÿ</p><p>è¿™å°±æ˜¯äº’æ–¥é”çš„æ€æƒ³ï¼š<strong>ç”¨ç³»ç»Ÿè°ƒç”¨å®ç°é”æ“ä½œ</strong></p> <img src="https://s2.loli.net/2023/11/05/QsaT1UKbN2Zwh9d.png" style="zoom:67%;" /></li></ol><p>â€‹äº’æ–¥é”å’Œè‡ªæ—‹é”æ¯”è¾ƒï¼š</p><p>â€‹<img src="https://s2.loli.net/2023/11/05/zWYVJtZi5n1GACS.png" style="zoom:67%;" /></p><p>â€‹</p><ol start="5"><li><p><strong>Take-away message</strong></p><ul><li>è‡ªæ—‹é” â€”â€” è½¯ä»¶ä¸å¤Ÿï¼Œç¡¬ä»¶æ¥å‡‘</li><li>äº’æ–¥é” â€”â€” ç”¨æˆ·ä¸å¤Ÿï¼Œå†…æ ¸æ¥å‡‘</li></ul><p>å¯è§ï¼Œè§£å†³é—®é¢˜çš„ä¸€ä¸ªå¸¸ç”¨æ€è·¯æ˜¯<strong>æ‰¾åˆ°ä½ æ‰€ä¾èµ–çš„å‡è®¾ï¼Œå¹¶å¤§èƒ†åœ°æ‰“ç ´å®ƒ</strong>ï¼ˆè§£å†³æå‡ºé—®é¢˜çš„äººï¼‰</p></li><li><p><strong>ç”Ÿäº§è€…-æ¶ˆè´¹è€…çš„åŒæ­¥</strong></p><p><strong>motivation</strong>ï¼šå•çº¯å®ç°äº’æ–¥æ˜¯ä¸å¤Ÿçš„ï¼Œæ¯”å¦‚è¦ä¸¤ä¸ªçº¿ç¨‹æŒ‰åºæ‰“å°å·¦æ‹¬å·å’Œå³æ‹¬å·ï¼Œé‚£å¿…é¡»è¿˜è¦åœ¨æŸç§ç¨‹åº¦ä¸Šå®ç°<strong>åŒæ­¥</strong></p></li></ol><p>â€‹<img src="https://s2.loli.net/2023/11/05/8l6eP43abOmS7KI.png" style="zoom:67%;" /></p><p>â€‹ä¸€ä¸ªè‡ªç„¶è€Œç„¶çš„æ€è·¯å¯¹ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«è®¾ç½®æ¡ä»¶ï¼Œä¸æ»¡è¶³çš„æ—¶å€™è‡ªæ—‹ç­‰å¾…ï¼Œæ»¡è¶³åˆ™æ‰§è¡Œ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs CPP"><span class="hljs-meta">#<span class="hljs-keyword">define</span> CAN_PRODUCE (count &lt; n)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CAN_CONSUME (count &gt; 0)</span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Tproduce</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>retry:<br>    <span class="hljs-built_in">mutex_lock</span>(&amp;lk);<br>    <span class="hljs-keyword">if</span> (!CAN_PRODUCE) &#123;<br>      <span class="hljs-built_in">mutex_unlock</span>(&amp;lk);<br>      <span class="hljs-keyword">goto</span> retry;<br>    &#125;<br>    count++;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;(&quot;</span>);  <span class="hljs-comment">// Push an element into buffer</span><br>    <span class="hljs-built_in">mutex_unlock</span>(&amp;lk);<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Tconsume</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>retry:<br>    <span class="hljs-built_in">mutex_lock</span>(&amp;lk);<br>    <span class="hljs-keyword">if</span> (!CAN_CONSUME) &#123;<br>      <span class="hljs-built_in">mutex_unlock</span>(&amp;lk);<br>      <span class="hljs-keyword">goto</span> retry;<br>    &#125;<br>    count--;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;)&quot;</span>);  <span class="hljs-comment">// Pop an element from buffer</span><br>    <span class="hljs-built_in">mutex_unlock</span>(&amp;lk);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><div class="note note-warning">            <p>ğŸ’¡ PS. ä¸Šè¿°ä»£ç çš„ä¸€ä¸ªç»†èŠ‚æ˜¯ï¼Œæ¡ä»¶ä¸æ»¡è¶³æ—¶æˆ‘ä»¬å¿…é¡»é‡Šæ”¾é” â€”â€” å¦‚æœä¸é‡Šæ”¾é”ï¼Œå…¶å®ƒç”Ÿäº§è€…/æ¶ˆè´¹è€…å°±æ— æ³•ç»§ç»­å·¥ä½œï¼Œé€ æˆæ­»é”</p>          </div><p>â€‹</p><p>â€‹è¿™æ ·ç¡®å®èƒ½å¾—åˆ°æ­£ç¡®ç»“æœï¼Œä½†æœ€å¤§çš„é—®é¢˜å°±æ˜¯ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œæ—¶å…¶å®ƒçº¿ç¨‹<strong>ä¸æ–­gotoã€retryï¼Œç©ºè€—cpuèµ„æº</strong></p><ol start="7"><li><p><strong>æ¡ä»¶å˜é‡</strong></p><p>ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬ç†æƒ³ä¸­çš„åŒæ­¥APIåº”è¯¥é•¿è¿™æ ·ï¼šä¸€ä¸ªçº¿ç¨‹æ»¡è¶³æ¡ä»¶æ—¶æ‰§è¡Œï¼Œ<strong>ä¸æ»¡è¶³åˆ™ç­‰å¾…ï¼ˆçº¿ç¨‹waitä¸æ¶ˆè€—cpuèµ„æºï¼‰</strong></p></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">wait_until</span>(CAN_PRODUCE) &#123;<br>  count++;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;(&quot;</span>);<br>&#125;<br><br><span class="hljs-built_in">wait_until</span>(CAN_CONSUME) &#123;<br>  count--;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;)&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹å…·ä½“å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">int</span> n, count = <span class="hljs-number">0</span>;<br><span class="hljs-type">mutex_t</span> lk = <span class="hljs-built_in">MUTEX_INIT</span>();<br><span class="hljs-type">cond_t</span> cv = <span class="hljs-built_in">COND_INIT</span>();<br> <br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CAN_PRODUCE (count &lt; n)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CAN_CONSUME (count &gt; 0)</span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Tproduce</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-built_in">mutex_lock</span>(&amp;lk);<br>    <span class="hljs-keyword">while</span> (!CAN_PRODUCE) &#123;<br>      <span class="hljs-built_in">cond_wait</span>(&amp;cv, &amp;lk);<br>    &#125;<br>    <span class="hljs-built_in">assert</span>(CAN_PRODUCE);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;(&quot;</span>); count++;<br>    <span class="hljs-built_in">cond_broadcast</span>(&amp;cv);<br>    <span class="hljs-built_in">mutex_unlock</span>(&amp;lk);<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Tconsume</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-built_in">mutex_lock</span>(&amp;lk);<br>    <span class="hljs-keyword">while</span> (!CAN_CONSUME) &#123;<br>      <span class="hljs-built_in">cond_wait</span>(&amp;cv, &amp;lk);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;)&quot;</span>); count--;<br>    <span class="hljs-built_in">cond_broadcast</span>(&amp;cv);<br>    <span class="hljs-built_in">mutex_unlock</span>(&amp;lk);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹åˆ†æï¼š</p><ul><li>æ‰§è¡ŒTproduce()æ—¶é¦–å…ˆä¸Šé”ï¼Œç„¶åæ£€éªŒæ¡ä»¶å‘ç°æˆç«‹ï¼Œäºæ˜¯æ‰§è¡Œä¸´ç•ŒåŒºï¼Œç»“æŸåç”¨broadcastå”¤é†’æ‰€æœ‰ç¡çœ ä¸­çš„çº¿ç¨‹ï¼Œå¹¶é‡Šæ”¾é”ï¼›ä¸æ­¤åŒæ—¶å¯¹äºTconsumer()æ¥è¯´ï¼Œè‹¥ä¸æ»¡è¶³æ¡ä»¶åˆ™è¿›å…¥ç¡çœ ç­‰å¾…çŠ¶æ€ï¼Œç›´è‡³è¢«å…¶å®ƒçº¿ç¨‹å”¤é†’</li><li>æ¡ä»¶åˆ¤æ–­ä¸­ä½¿ç”¨ <strong>while(!CAN_PRODUCE)</strong> è€Œä¸æ˜¯ if(!CAN_PRODUCE)ï¼Œå› ä¸ºå¦‚æœç”¨ if çš„è¯ï¼Œè¢«ä»ç¡çœ ä¸­å”¤é†’åç›´æ¥è¿›å…¥åé¢çš„ä¸´ç•ŒåŒºï¼Œä½†äº‹å®ä¸Šæ­¤æ—¶å¹¶ä¸ä¸€å®šæ»¡è¶³æ¡ä»¶ï¼ä»è€Œé€ æˆâ€å‡å”¤é†’â€œï¼Œæ‹¬å·æ‰“å°é”™è¯¯</li><li>åœ¨è°ƒç”¨ wait(cv, mutex) ä¹‹å‰å¿…é¡»ä¿è¯å·²ç»è·å¾—mutexã€‚waitä¼šé‡Šæ”¾mutexå¹¶ç¡çœ ï¼Œè¢«å”¤é†’æ—¶waitåˆä¼šé‡æ–°è¯•å›¾è·å¾—äº’æ–¥ï¼Œç›´åˆ°è·å¾—äº’æ–¥é”åæ‰èƒ½è¿”å›</li></ul><p>â€‹æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸Šè¿°ä»£ç æ€»ç»“å‡ºç”¨æ¡ä»¶å˜é‡è¿›è¡ŒåŒæ­¥çš„é€šç”¨æ¨¡æ¿ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">mutex_lock</span>(&amp;mutex);<br><span class="hljs-keyword">while</span> (!COND) &#123;<br>  <span class="hljs-built_in">wait</span>(&amp;cv, &amp;mutex);<br>&#125;<br><span class="hljs-built_in">assert</span>(cond);  <span class="hljs-comment">// äº’æ–¥é”ä¿è¯æ¡ä»¶æˆç«‹</span><br><span class="hljs-comment">// critical_section</span><br><span class="hljs-built_in">broadcast</span>(&amp;cv);<br><span class="hljs-built_in">mutex_unlock</span>(&amp;mutex);<br></code></pre></td></tr></table></figure><ol start="8"><li><p><strong>ä¿¡å·é‡ï¼ˆsemaphoreï¼‰</strong></p><p>P â€”â€” ä»è¢‹å­é‡Œå–å‡ºä¸€ä¸ªçƒ</p><p>V â€”â€” æ”¾å…¥ä¸€ä¸ªçƒ</p><p>çƒ â€”â€” ä¸€ä¸ªå•ä½çš„èµ„æº</p></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">sem_t</span> fill, empty;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Tproduce</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-built_in">P</span>(&amp;empty);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;(&quot;</span>);<br>    <span class="hljs-built_in">V</span>(&amp;fill);<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Tconsume</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-built_in">P</span>(&amp;fill);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;)&quot;</span>);<br>    <span class="hljs-built_in">V</span>(&amp;empty);<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> </span>&#123;<br>  <span class="hljs-built_in">assert</span>(argc == <span class="hljs-number">2</span>);<br>  <span class="hljs-built_in">SEM_INIT</span>(&amp;fill, <span class="hljs-number">0</span>);<br>  <span class="hljs-built_in">SEM_INIT</span>(&amp;empty, <span class="hljs-built_in">atoi</span>(argv[<span class="hljs-number">1</span>]));<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) &#123;<br>    <span class="hljs-built_in">create</span>(Tproduce);<br>    <span class="hljs-built_in">create</span>(Tconsume);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="9"><li><p><strong>é˜²å¾¡æ€§ç¼–ç¨‹</strong></p><p>ç‹‚åŠ assertï¼Œä¸æ–­æ£€æŸ¥ã€æ£€æŸ¥ã€æ£€æŸ¥</p></li></ol><h2 id="Lecture4ã€æ“ä½œç³»ç»Ÿä¸Šçš„è¿›ç¨‹">Lecture4ã€æ“ä½œç³»ç»Ÿä¸Šçš„è¿›ç¨‹</h2><ol><li><p><strong>fork()ï¼šåšä¸€ä»½çŠ¶æ€æœºå®Œæ•´çš„å¤åˆ¶ï¼ˆå†…å­˜ã€å¯„å­˜å™¨ç°åœºï¼‰</strong></p> <img src="https://s2.loli.net/2023/11/05/udMojUgswG3ZCX1.png" style="zoom:67%;" /></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-type">pid_t</span> pid1 = fork();<br>  <span class="hljs-type">pid_t</span> pid2 = fork();<br>  <span class="hljs-type">pid_t</span> pid3 = fork();<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello World from (%d, %d, %d)\n&quot;</span>, pid1, pid2, pid3);<br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹è¾“å‡ºç»“æœï¼š</p><p>â€‹<img src="https://s2.loli.net/2023/11/05/IhiZvNnyeSAgOks.png" alt=""></p><p>â€‹ç†è§£ï¼šä¸€ç”ŸäºŒï¼ŒäºŒç”Ÿå››ï¼Œå››ç”Ÿå…«</p><ol start="2"><li><strong>ä¸€æ®µé­”æ³•ä»£ç </strong>ï¼š</li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>;i++)&#123;<br>fork();<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;hello\n&quot;</span>);<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹ç›´æ¥å°†ç»“æœè¾“å‡ºåˆ°ç»ˆç«¯çš„æ—¶å€™ï¼Œæœ‰6ä¸ªhello</p><p>â€‹<img src="https://s2.loli.net/2023/11/05/h34kPjpTFN72una.png" alt=""></p><p>â€‹</p><p>â€‹ä½†è¾“å‡ºåˆ°ç®¡é“æˆ–è€…æ–‡ä»¶æ—¶ï¼Œç¥å¥‡çš„äº‹æƒ…å‘ç”Ÿäº†ï¼Œæœ‰8ä¸ªhello</p><p>â€‹<img src="https://s2.loli.net/2023/11/05/XcorbaZmEflyDwe.png" alt=""></p><p>â€‹<strong>è§£é‡Š</strong>ï¼š</p><p>â€‹â€œç›´æ¥å†™åˆ°ç»ˆç«¯â€ä¸â€œå†™åˆ°ç®¡é“æˆ–æ–‡ä»¶â€ä¸¤ç§æƒ…å†µä¸‹çš„<strong>ç¼“å†²ç­–ç•¥æ˜¯ä¸ä¸€æ ·çš„</strong>ï¼Œå‰è€…é‡è§æ¢è¡Œç¬¦å°±åˆ·æ–°ï¼Œåè€…åˆ™ä¼šç­‰ç¼“å†²åŒºæ»¡æ‰ä¼šåˆ·æ–°ã€‚ å¯¹äºç›´æ¥å†™åˆ°ç»ˆç«¯ï¼Œforkä¹‹åæœ‰ä¸¤ä¸ªè¿›ç¨‹ï¼Œprintfè¾“å‡ºä¸¤ä¸ªhelloåˆ°ç»ˆç«¯ï¼Œå†forkä¸€æ¬¡å¾—4ä¸ªè¿›ç¨‹ï¼Œè¾“å‡º4ä¸ªhelloåˆ°ç»ˆç«¯ï¼› è€Œå¯¹äºå†™åˆ°ç®¡é“ï¼Œforkä¹‹åæœ‰ä¸¤ä¸ªè¿›ç¨‹ï¼Œprintfåœ¨è¿›ç¨‹çš„bufferä¸­å„å†™å…¥ä¸€ä¸ªhelloï¼Œå†forkä¸€æ¬¡å¾—4ä¸ªè¿›ç¨‹ï¼ˆæ³¨æ„ï¼Œè¿™4ä¸ªè¿›ç¨‹çš„bufferä¸­éƒ½å­˜äº†ä¸€ä¸ªhelloï¼ï¼‰ï¼Œå„è¿›ç¨‹å†printfä¸€æ¬¡ï¼Œåˆ™å››ä¸ªè¿›ç¨‹çš„bufferä¸­éƒ½æœ‰ä¸¤ä¸ªhelloï¼Œäºæ˜¯æœ€åè¾“å‡º8</p><ol start="3"><li><p><strong>execve()ï¼šå°†å½“å‰è¿è¡Œçš„çŠ¶æ€æœºé‡ç½®ä¸ºå¦ä¸€ä¸ªç¨‹åºçš„åˆå§‹çŠ¶æ€</strong></p> <img src="https://s2.loli.net/2023/11/05/2cUAxvhHIzCe3fE.png" style="zoom:67%;" /></li></ol><p>â€‹</p><ol start="4"><li><p><strong>_exit()ï¼šç«‹åˆ»æ‘§æ¯çŠ¶æ€æœº</strong></p> <img src="https://s2.loli.net/2023/11/05/PCnf5Sjl7xATdRz.png" style="zoom:67%;" /></li></ol><h2 id="Lecture5ã€è¿›ç¨‹çš„åœ°å€ç©ºé—´">Lecture5ã€è¿›ç¨‹çš„åœ°å€ç©ºé—´</h2><ol><li><strong>å®šä¹‰</strong></li></ol><p>â€‹<img src="https://s2.loli.net/2023/11/05/OG6tpPNZrFdEm7Y.png" style="zoom:67%;" /></p><ul><li>åˆæ³•çš„åœ°å€<ul><li>ä»£ç  (main, %rip ä¼šä»æ­¤å¤„å–å‡ºå¾…æ‰§è¡Œçš„æŒ‡ä»¤)ï¼Œåªè¯»</li><li>æ•°æ® (static int x)ï¼Œè¯»å†™</li><li>å †æ ˆï¼ˆint yï¼‰ï¼Œè¯»å†™</li><li>è¿è¡Œæ—¶åˆ†é…çš„å†…å­˜ï¼ˆï¼Ÿï¼Ÿï¼Ÿï¼‰ï¼Œè¯»å†™</li><li>åŠ¨æ€é“¾æ¥åº“ï¼ˆï¼Ÿï¼Ÿï¼Ÿï¼‰</li></ul></li><li>éæ³•çš„åœ°å€<ul><li>NULLï¼Œå¯¼è‡´segmentation fault</li></ul></li></ul><ol start="2"><li><p><strong>æŸ¥çœ‹è¿›ç¨‹çš„åœ°å€ç©ºé—´</strong></p><p>pmapï¼šreport memory of a process</p><p>ç”¨gdbæŸ¥çœ‹å½“å‰æ‰§è¡Œçš„è¿›ç¨‹çš„è¿›ç¨‹å·ï¼Œå†ç”¨pmapæŸ¥çœ‹è¿›ç¨‹çš„åœ°å€ç©ºé—´</p><p><img src="https://s2.loli.net/2023/11/05/dKPwflzYX1BqoOL.png" alt=""></p></li></ol><p>â€‹<img src="https://s2.loli.net/2023/11/05/L8nlSUbDyzViOK7.png" alt=""></p><p>â€‹å¯è§è¿›ç¨‹çš„åœ°å€ç©ºé—´æ˜¯è‹¥å¹²è¿ç»­çš„â€æ®µâ€œï¼Œâ€æ®µâ€œçš„å†…å­˜å¯ä»¥è®¿é—®ï¼Œä¸åœ¨æ®µå†…/è¿åæƒé™çš„å†…å­˜è®¿é—®ä¼šè§¦å‘SIGSEGV</p><ol start="3"><li><p><strong>vdsoï¼švirtual system calls</strong></p><p>linuxä¸­ç³»ç»Ÿè°ƒç”¨ååˆ†æ¶ˆè€—CPUèµ„æºï¼Œå› ä¸ºsyscallçš„æœ¬è´¨æ˜¯ä¸€ç§å¼‚å¸¸ï¼Œå½“è°ƒç”¨ä¸€ä¸ªsyscallæ—¶ä¼šè§¦å‘ CPU å¼‚å¸¸ï¼ŒCPU è¿›å…¥å¼‚å¸¸å¤„ç†æµç¨‹ã€‚CPU åœ¨å¼‚å¸¸å¤„ç†æµç¨‹ä¸­å¯ä»¥è¯†åˆ«åˆ°æœ¬æ¬¡å¼‚å¸¸æ˜¯ç”±äºsyscallå¼•èµ·çš„ï¼Œä»è€Œè¿›å…¥syscallçš„å¼‚å¸¸å¤„ç†æµç¨‹ä¸­ã€‚</p><p>ä½†å¦‚æœä¸€ä¸ªsyscallæ˜¯åªè¯»çš„ï¼Œé‚£ä¹ˆå®ƒæˆ–è®¸ä¸å¿…é™·å…¥å†…æ ¸æ‰§è¡Œ</p><p>å¦‚linuxä¸­çš„gettimeofday()</p><p>å¤§è‡´å®ç°åŸç†ï¼šåœ¨æ¯ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´éƒ½æ˜ å°„ä¸€ä¸ªvitural varçš„é¡µé¢ï¼Œè¿™ä¸ªé¡µé¢æ˜¯æ‰€æœ‰è¿›ç¨‹éƒ½å…±äº«çš„ï¼Œä¸‹åˆ—éƒ½æ˜¯æ— éœ€è¿›å…¥å†…æ ¸å°±å¾—è·å–çš„syscall</p></li></ol><p>â€‹<img src="https://s2.loli.net/2023/11/05/kRstXP9Zzx2Yv6L.png" alt=""></p><ol start="4"><li><p><strong>ç®¡ç†è¿›ç¨‹åœ°å€ç©ºé—´çš„ç³»ç»Ÿè°ƒç”¨</strong></p> <img src="https://s2.loli.net/2023/11/05/Vr94ZQGeDzYptWl.png" style="zoom:67%;" /></li></ol><p>â€‹ä¸€èˆ¬æ¥è¯´ï¼Œä¿®æ”¹ä¸€ä¸ªæ–‡ä»¶çš„å†…å®¹éœ€è¦å¦‚ä¸‹3ä¸ªæ­¥éª¤ï¼š</p><ul><li>æŠŠæ–‡ä»¶å†…å®¹è¯»å…¥åˆ°å†…å­˜ä¸­</li><li>ä¿®æ”¹å†…å­˜ä¸­çš„å†…å®¹ã€‚</li><li>æŠŠå†…å­˜çš„æ•°æ®å†™å…¥åˆ°æ–‡ä»¶ä¸­</li></ul><p>â€‹<img src="https://s2.loli.net/2023/11/05/ACMolNFirtJYLk6.png" alt=""></p><p>â€‹å¯ä»¥çœ‹å‡ºï¼Œ<strong>é¡µç¼“å­˜(page cache)</strong> æ˜¯è¯»å†™æ–‡ä»¶æ—¶çš„ä¸­é—´å±‚ï¼Œå†…æ ¸ä½¿ç”¨é¡µç¼“å­˜ä¸æ–‡ä»¶çš„æ•°æ®å—å…³è”èµ·æ¥ï¼Œæ‰€ä»¥åº”ç”¨ç¨‹åºè¯»å†™æ–‡ä»¶æ—¶ï¼Œå®é™…æ“ä½œçš„æ˜¯é¡µç¼“å­˜ã€‚<br>â€‹è€Œmmapå°±æ˜¯ç›´æ¥åœ¨ç”¨æˆ·ç©ºé—´è¯»å†™ï¼Œä½¿ç”¨mmapç³»ç»Ÿè°ƒç”¨å¯ä»¥å°†ç”¨æˆ·ç©ºé—´çš„è™šæ‹Ÿå†…å­˜åœ°å€ä¸æ–‡ä»¶è¿›è¡Œæ˜ å°„ï¼ˆç»‘å®šï¼‰ï¼Œå¯¹æ˜ å°„åçš„è™šæ‹Ÿå†…å­˜åœ°å€è¿›è¡Œè¯»å†™æ“ä½œå°±å¦‚åŒå¯¹æ–‡ä»¶è¿›è¡Œè¯»å†™æ“ä½œä¸€æ ·</p><p>â€‹<img src="https://s2.loli.net/2023/11/05/xbsf1RqTUk56YQF.png" alt=""></p><ol start="5"><li><strong>åœ°å€ç©ºé—´çš„éš”ç¦»</strong></li></ol><p>â€‹<img src="https://s2.loli.net/2023/11/05/LNSsjBE1fqyPHWV.png" style="zoom:67%;" /></p><p>â€‹è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¹‹é—´ä¸€èˆ¬æ˜¯ç›¸äº’éš”ç¦»çš„ï¼Œä½†æœ‰äº›åº”ç”¨ä¹Ÿå¯ä»¥è·¨è¿›ç¨‹è®¿é—®ï¼ˆå¦‚gdbï¼Œä¸ç„¶å°±æ²¡åŠæ³•è°ƒè¯•äº†ï¼Œå› ä¸ºgdbè‡ªå·±å°±æ˜¯ä¸ªè¿›ç¨‹å˜›ï¼‰<br>â€‹ä½†ä¹Ÿæœ‰ä¸€äº›hackæ–¹æ³•å¯ä»¥ä¿®æ”¹è¿›ç¨‹çš„å†…å­˜ï¼Œå¦‚æ¸¸æˆå¤–æŒ‚ã€ä»£ç æ³¨å…¥ï¼ˆhookingï¼‰</p><h2 id="Lecture6ã€-ç³»ç»Ÿè°ƒç”¨å’Œshell">Lecture6ã€ ç³»ç»Ÿè°ƒç”¨å’Œshell</h2><ol><li><p><strong>motivation</strong>ï¼šç”¨æˆ·ä¸èƒ½å¤Ÿç›´æ¥ä½¿ç”¨syscallï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ª<strong>èƒ½æŠŠæ“ä½œç³»ç»ŸAPIå°è£…èµ·æ¥</strong>çš„ç¨‹åºæ¥å¸®åŠ©äººç±»åˆ›å»º/ç®¡ç†è¿›ç¨‹ã€æ–‡ä»¶ã€‚ã€‚ç”¨æˆ·å»å’Œè¿™ä¸ªç¨‹åºäº¤äº’ã€‚</p><p>è¿™ä¸ªç¨‹åºå°±æ˜¯shellï¼ˆå†…æ ¸kernelæä¾›ç³»ç»Ÿè°ƒç”¨ï¼Œshellæä¾›ç”¨æˆ·æ¥å£ï¼‰</p></li><li><p><strong>shell</strong></p><p>shellæ˜¯ä¸€é—¨**â€æŠŠç”¨æˆ·æŒ‡ä»¤ç¿»è¯‘ä¸ºsyscallâ€œ**çš„ç¼–ç¨‹è¯­è¨€ï¼Œå¯ä»¥æŠŠå®ƒç†è§£ä¸ºåŒ…è£¹kernelçš„ä¸€å±‚å¤–å£³</p><ul><li>é‡å®šå‘ï¼šls &gt; a.txtï¼Œå°†æ ‡å‡†è¾“å‡ºé‡å®šå‘åˆ°æ–‡ä»¶ä¸­</li><li>åå°æ‰§è¡Œï¼šls &amp;ï¼Œè®©ç¨‹åºæˆ–è„šæœ¬åˆ‡æ¢åˆ°åå°æ‰§è¡Œ</li><li>é€»è¾‘æ‰§è¡Œï¼šgcc test.c &amp;&amp; ./a.out ï¼Œå½“å‰ä¸€ä¸ªå‘½ä»¤æˆç«‹æ—¶</li></ul></li><li><p><strong>gcc -static</strong></p><p>gcc ç¼–è¯‘, æœ‰ä¸ªé€‰é¡¹æ˜¯-static, å…¶ä½œç”¨æ˜¯å†³å®š ç¼–è¯‘-é“¾æ¥æ—¶, ä½¿ç”¨çš„åº“æ˜¯é™æ€åº“è¿˜æ˜¯åŠ¨æ€åº“</p><ul><li><p><strong>é™æ€åº“ï¼ˆå¸¸ä»¥aä¸ºç»“å°¾, ä¾‹å¦‚libxx.aï¼‰</strong></p><p>åœ¨é“¾æ¥æ—¶**å°†éœ€è¦çš„äºŒè¿›åˆ¶ä»£ç éƒ½â€œæ‹·è´â€**åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­(æ³¨æ„, åªæ‹·è´éœ€è¦çš„,ä¸ä¼šå…¨éƒ¨æ‹·è´) ä¼˜ç‚¹: ç¼–è¯‘æˆåŠŸçš„å¯æ‰§è¡Œæ–‡ä»¶å¯ä»¥ç‹¬ç«‹è¿è¡Œï¼Œè€Œä¸å†éœ€è¦å‘å¤–éƒ¨è¦æ±‚è¯»å–å‡½æ•°åº“çš„å†…å®¹ï¼› ç¼ºç‚¹: ç»´æŠ¤éš¾, æ¯æ¬¡æ›´æ–°, éƒ½éœ€è¦ä¾èµ–æ–¹é‡æ–°ç¼–è¯‘ã€‚å¦å¤–, ä¾èµ–æ–¹å› ä¸ºæ‹·è´äº†åº“çš„å†…å®¹, æ‰€ä»¥ç¼–è¯‘åçš„æ–‡ä»¶ä¼šæ¯”è¾ƒå¤§ã€‚</p></li><li><p><em><strong>*åŠ¨æ€åº“(å¸¸ä»¥soä¸ºç»“å°¾, <a href="http://xn--libxx-4d3hh90d.so">ä¾‹å¦‚libxx.so</a>):*</strong></em></p><p>é“¾æ¥æ—¶<strong>ä»…ä»…â€œæ‹·è´â€ä¸€äº›é‡å®šä½å’Œç¬¦å·è¡¨ä¿¡æ¯</strong>ï¼Œè¿™äº›ä¿¡æ¯å¯ä»¥åœ¨ç¨‹åºè¿è¡Œæ—¶å®ŒæˆçœŸæ­£çš„é“¾æ¥è¿‡ç¨‹ã€‚ ä¼˜ç‚¹: ç»´æŠ¤å®¹æ˜“, åªè¦å¯¹å¤–æ¥å£ä¸å˜, åˆ™åº“å¯ä»¥ä¸åœçš„æ›´æ–°, ä¾èµ–æ–¹ä¸éœ€è¦å†æ¬¡ç¼–è¯‘; ç¼ºç‚¹: ä¾èµ–æ–¹è¿è¡Œæ—¶éœ€è¦æ‰€æœ‰ä¾èµ–çš„soåº“éƒ½å­˜åœ¨ã€‚</p></li></ul><p>ç»¼ä¸Šï¼šæ‰€ä»¥ä¸¤è€…çš„æœ¬è´¨åŒºåˆ«æ˜¯ï¼Œè¯¥åº“æ˜¯å¦è¢«ç¼–è¯‘è¿›ç›®æ ‡ï¼ˆç¨‹åºï¼‰å†…éƒ¨</p></li></ol><h2 id="Lecture7ã€-Cæ ‡å‡†åº“çš„å®ç°">Lecture7ã€ Cæ ‡å‡†åº“çš„å®ç°</h2><ol><li><p><strong>é›¶ä¾èµ–ï¼ˆfreestandingï¼‰ç¯å¢ƒ</strong></p><ul><li><p>freestanding implementationï¼šä¸èƒ½åŒ…å«cæ ‡å‡†åº“ï¼Œåªèƒ½åŒ…å«åŸºæœ¬çš„å¤´æ–‡ä»¶</p>  <img src="https://s2.loli.net/2023/11/05/pyJ5sm7bltr1dcx.png" style="zoom:67%;" /></li><li><p>hosted implementationï¼šèƒ½åŒ…å«æ‰€æœ‰çš„cæ ‡å‡†åº“</p></li><li><p>freestanding environmentï¼šåœ¨è¿™ç§ç¯å¢ƒä¸‹ç¼–è¯‘çš„ç¨‹åºï¼Œä¸èƒ½åŒ…å«å®Œæ•´çš„cæ ‡å‡†åº“ï¼Œç”šè‡³è¿mainå…¥å£éƒ½æ²¡æœ‰ï¼Œå¦‚kernalå¼€å‘ï¼Œcæ ‡å‡†åº“å¼€å‘</p></li><li><p>hosted environmentï¼šè¿™ç§ç¯å¢ƒå°±æ˜¯æˆ‘ä»¬é€šå¸¸çš„ç¼–è¯‘ç¯å¢ƒï¼Œmainä½œä¸ºå…¥å£ï¼Œå¯ä»¥åŒ…å«å®Œæ•´çš„cæ ‡å‡†åº“</p></li></ul></li><li><p><strong>motivation</strong></p><p>cæ ‡å‡†åº“æ˜¯å¯¹ç³»ç»Ÿè°ƒç”¨çš„å°è£…</p></li><li><p><strong>å°è£…ï¼ˆ1ï¼‰ï¼šçº¯ç²¹çš„è®¡ç®—</strong></p><ul><li><p>å­—ç¬¦ä¸²/æ•°ç»„æ“ä½œï¼šstring.h</p></li><li><p>æ’åºå’ŒæŸ¥æ‰¾ï¼š</p>  <img src="https://s2.loli.net/2023/11/05/ldr8LEMzohPBN4q.png" style="zoom:67%;" /></li><li><p>math.hã€stdlib.hã€setjmp.hã€‚ã€‚ã€‚</p></li></ul></li><li><p><strong>å°è£…ï¼ˆ2ï¼‰ï¼šæ–‡ä»¶æè¿°ç¬¦</strong></p><p>linuxä¸­ä¸€åˆ‡çš†æ–‡ä»¶ï¼Œå½“è¿›ç¨‹æ‰“å¼€ç°æœ‰æ–‡ä»¶æˆ–è€…åˆ›å»ºæ–°æ–‡ä»¶æ—¶ï¼Œkernelå‘è¿›ç¨‹è¿”å›ä¸€ä¸ª<strong>æ–‡ä»¶æè¿°ç¬¦</strong>(file descriptorï¼Œfd)ï¼Œå®ƒæ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°å€¼ï¼ŒæŒ‡å‘è¢«æ‰“å¼€çš„æ–‡ä»¶ï¼Œæ‰€æœ‰æ‰§è¡ŒIOæ“ä½œçš„syscalléƒ½ä¼šé€šè¿‡è¯¥fd</p></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>* argv[])</span> </span>&#123;<br>    <span class="hljs-comment">// ä»¥åªè¯»æ¨¡å¼æ‰“å¼€ demo.txt æ–‡ä»¶</span><br>    <span class="hljs-type">int</span> fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;demo.txt&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (fd == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-built_in">perror</span>(<span class="hljs-string">&quot;open demo.txt error\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> EXIT_FAILURE;<br>    &#125;<br>    <span class="hljs-comment">// æ‰“å°è·å–åˆ°çš„æ–‡ä»¶æè¿°ç¬¦</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;demo.txt fd = %d \n&quot;</span>, fd);<br>    <span class="hljs-keyword">return</span> EXIT_SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹<img src="https://s2.loli.net/2023/11/05/1hgKdJORWnpyVvS.png" alt=""></p><p>â€‹ä¸ºä»€ä¹ˆæ˜¯3å‘¢ï¼Ÿå› ä¸º0 1 2 è¢«å ç”¨äº†</p><p>â€‹åœ¨UNIXç³»ç»Ÿä¸­ï¼Œç³»ç»Ÿåˆ›å»ºçš„æ¯ä¸ªè¿›ç¨‹é»˜è®¤éƒ½ä¼šæ‰“å¼€3ä¸ªæ–‡ä»¶ï¼šæ ‡å‡†è¾“å…¥ï¼ˆ0ï¼‰ã€æ ‡å‡†è¾“å‡ºï¼ˆ1ï¼‰ã€æ ‡å‡†é”™è¯¯ï¼ˆ2ï¼‰</p><p>â€‹è€Œè¿™äº›æ•´æ•°çš„æœ¬è´¨æ˜¯ä»€ä¹ˆå‘¢ â€”â€” <strong>æ–‡ä»¶æŒ‡é’ˆæ•°ç»„filesçš„index</strong></p><p>â€‹ä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªè¿›ç¨‹ä¼šä»files[0]ä¸­è¯»å–è¾“å…¥ï¼Œå°†è¾“å‡ºå†™å…¥files[1]ï¼Œå°†é”™è¯¯ä¿¡æ¯å†™å…¥files[2]ã€‚æ¯”å¦‚printfå‘å‘½ä»¤è¡Œæ‰“å°å­—ç¬¦ï¼Œä»è¿›ç¨‹çš„è§’åº¦æ¥çœ‹ï¼Œå°±æ˜¯å‘files[1]ä¸­å†™å…¥æ•°æ®ï¼›åŒç†ï¼Œscanfå°±æ˜¯è¿›ç¨‹è¯•å›¾ä»files[0]è¿™ä¸ªæ–‡ä»¶ä¸­è¯»å–æ•°æ®</p><p>â€‹<img src="https://s2.loli.net/2023/11/05/BnRJODCh9UjMZbt.png" alt=""></p><p>â€‹æ˜ç™½äº†ä¸Šè¿°åŸç†åï¼Œè¾“å‡ºè¾“å…¥é‡å®šå‘å°±å¾ˆå¥½ç†è§£äº†ï¼šè¾“å…¥é‡å®šå‘å°±æ˜¯æŠŠfiles[0]æŒ‡å‘ä¸€ä¸ªæ–‡ä»¶ï¼Œåˆ™ç¨‹åºä¼šä»è¿™ä¸ªæ–‡ä»¶ä¸­è¯»å–æ•°æ®è€Œä¸æ˜¯é”®ç›˜ï¼›è¾“å‡ºé‡å®šå‘åˆ™æ˜¯æŠŠfiles[1]æŒ‡å‘ä¸€ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆç¨‹åºçš„è¾“å‡ºå°±ä¸ä¼šå†™åˆ°æ˜¾ç¤ºå™¨è€Œæ˜¯å†™å…¥è¿™ä¸ªæ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">command</span> &lt; file.txt</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash"><span class="hljs-built_in">command</span> &gt; file.txt</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">cmd1 | cmd2 | cmd3</span><br></code></pre></td></tr></table></figure><p>â€‹å¦å¤–ï¼Œç®¡é“ç¬¦ä¹Ÿå¯ç”±æ­¤è§£é‡Šï¼šæŠŠä¸€ä¸ªè¿›ç¨‹çš„è¾“å‡ºæµå’Œå¦ä¸€ä¸ªè¿›ç¨‹çš„è¾“å…¥æµè¿æ¥èµ·æ¥å½¢æˆä¸€æ¡â€œç®¡é“â€</p><p>â€‹<img src="https://s2.loli.net/2023/11/05/3jEyXOZPMx5UIuA.png" alt=""></p><p>â€‹åˆ°è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºã€ŒLinux ä¸­ä¸€åˆ‡çš†æ–‡ä»¶ã€è®¾è®¡æ€è·¯çš„é«˜æ˜äº†ï¼Œä¸ç®¡æ˜¯è®¾å¤‡ã€å¦ä¸€ä¸ªè¿›ç¨‹ã€socketå¥—æ¥å­—è¿˜æ˜¯çœŸæ­£çš„æ–‡ä»¶ï¼Œå…¨éƒ¨éƒ½å¯ä»¥è¯»å†™ï¼Œç»Ÿä¸€è£…è¿›ä¸€ä¸ªç®€å•çš„<strong>filesæ•°ç»„</strong>ï¼Œè¿›ç¨‹é€šè¿‡ç®€å•çš„æ–‡ä»¶æè¿°ç¬¦è®¿é—®ç›¸åº”èµ„æºï¼Œå…·ä½“ç»†èŠ‚äº¤ç»™æ“ä½œç³»ç»Ÿï¼Œæœ‰æ•ˆè§£è€¦ï¼Œä¼˜ç¾é«˜æ•ˆã€‚</p><div class="note note-warning">            <p>ğŸ’¡ PS. æ¯ä¸ªè¿›ç¨‹ç»´æŠ¤ä¸€ä¸ªstruct_taskç»“æ„ä½“ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªfilesæ•°ç»„ï¼Œæ•°ç»„å¤§å°ï¼ˆæˆ–è€…è¯´fdçš„æœ€å¤§å€¼é—®é¢˜å¯å‚è€ƒ<a href="https://senlinzhan.github.io/2017/07/01/linux-tuning/">è¿™ç¯‡æ–‡ç« </a>ï¼‰</p>          </div><ol start="5"><li><p><strong>å°è£…ï¼ˆ3ï¼‰ï¼šåœ°å€ç©ºé—´</strong></p><p>mallocå’Œfree</p></li></ol><h2 id="Lecture8ã€å¯æ‰§è¡Œæ–‡ä»¶">Lecture8ã€å¯æ‰§è¡Œæ–‡ä»¶</h2><ol><li><p><strong>ç†è§£</strong></p><p>å¯æ‰§è¡Œæ–‡ä»¶çš„æœ¬è´¨ï¼š<strong>ä¸€ä¸ªæè¿°äº†çŠ¶æ€æœºçš„åˆå§‹çŠ¶æ€ + è¿ç§»çš„æ•°æ®ç»“æ„</strong></p> <img src="https://s2.loli.net/2023/11/05/zfwv85SBgLR3EiG.png" style="zoom: 50%;" /></li></ol><p>â€‹å¯æ‰§è¡Œæ–‡ä»¶æ˜¯è¢«execve()ç»™è°ƒç”¨çš„ï¼ŒæŠŠçŠ¶æ€æœºé‡ç½®ä¸ºå¯æ‰§è¡Œæ–‡ä»¶çš„åˆå§‹çŠ¶æ€</p><p>â€‹<img src="https://s2.loli.net/2023/11/05/naxRsQlX6BiJzKj.png" alt=""></p><ol start="2"><li><p><strong>chmod</strong></p><p>chmod +rwx fileï¼šç»™fileçš„æ‰€æœ‰ç”¨æˆ·å¢åŠ è¯»å†™æ‰§è¡Œçš„æƒé™</p></li><li><p><strong>ç¼–è¯‘é“¾æ¥</strong></p> <img src="https://s2.loli.net/2023/11/05/xpwnKZUXzgf3HPS.png" style="zoom: 50%;" /></li><li><p><strong>é™æ€ELFåŠ è½½å™¨</strong></p><p>å°†ç£ç›˜ä¸Šé™æ€é“¾æ¥çš„å¯æ‰§è¡Œæ–‡ä»¶æŒ‰ç…§ELF program headerï¼Œæ­£ç¡®åœ°æ¬è¿åˆ°å†…å­˜ä¸­æ‰§è¡Œ</p><p>æ“ä½œç³»ç»Ÿåœ¨execveæ—¶å®Œæˆï¼š</p><ul><li>æ“ä½œç³»ç»Ÿåœ¨å†…æ ¸æ€è°ƒç”¨mmap<ul><li>è¿›ç¨‹è¿˜æœªå‡†å¤‡å¥½æ—¶ï¼Œç”±å†…æ ¸ç›´æ¥æ‰§è¡Œ â€ç³»ç»Ÿè°ƒç”¨â€œ</li><li>æ˜ å°„å¥½ a.out çš„ä»£ç ã€æ•°æ®ã€å †åŒºã€å †æ ˆã€vvarã€vdsoã€vsyscall</li></ul></li><li>æ›´ç®€å•çš„å®ç°ï¼šç›´æ¥è¯»å…¥è¿›ç¨‹çš„åœ°å€ç©ºé—´</li></ul><p>åŠ è½½å®Œæˆä¹‹åï¼Œé™æ€é“¾æ¥çš„ç¨‹åºå°±å¼€å§‹ä»ELF entryå¼€å§‹æ‰§è¡Œï¼Œä¹‹åå°±å˜æˆæˆ‘ä»¬ç†Ÿæ‚‰çš„çŠ¶æ€æœºï¼Œå”¯ä¸€çš„è¡Œä¸ºå°±æ˜¯å–æŒ‡æ‰§è¡Œ</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">readelf -h a.out<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2023/11/05/kFcy8ALaUopSJgl.png" alt=""></p></li></ol><p>â€‹æˆ‘ä»¬è¿™é‡Œçœ‹åˆ°ï¼Œç¨‹åºçš„å…¥å£åœ°å€æ˜¯ï¼š<strong>Entry point address: 0x401be0</strong>ã€‚æˆ‘ä»¬æ¥ç€ç”¨gdbæ¥è°ƒè¯•ï¼š</p><p>â€‹<img src="https://s2.loli.net/2023/11/05/pElB3V2yFunt9ZH.png" alt=""></p><p>â€‹<img src="https://s2.loli.net/2023/11/05/pqjeC6RKyTPnYvB.png" alt=""></p><p>â€‹æˆ‘ä»¬ç”¨startiæ¥ä½¿å¾—ç¨‹åºåœ¨ç¬¬ä¸€æ¡æŒ‡ä»¤å°±åœä¸‹ï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p><ul><li>ç¨‹åºç¡®å®æ˜¯ä»0x400180å¼€å§‹çš„ï¼Œä¸æˆ‘ä»¬ä¸Šé¢æŸ¥åˆ°çš„å…¥å£åœ°å€ä¸€è‡´</li><li>è€Œæˆ‘ä»¬ç”¨cat /proc/[PID]/maps æ¥æŸ¥çœ‹è¿™ä¸ªç¨‹åºä¸­å†…å­˜çš„å†…å®¹ï¼Œçœ‹åˆ°æˆ‘ä»¬ä¹‹å‰æåˆ°çš„ä»£ç ã€æ•°æ®ã€å †åŒºã€å †æ ˆã€vvarã€vdsoã€vsyscalléƒ½å·²ç»è¢«æ˜ å°„è¿›äº†å†…å­˜ä¸­ã€‚</li></ul><p>â€‹è°ƒè¯•çš„ç»“æœç¬¦åˆæˆ‘ä»¬å¯¹é™æ€ç¨‹åºåŠ è½½æ—¶æ“ä½œç³»ç»Ÿçš„è¡Œä¸ºçš„é¢„æœŸ</p><h2 id="Lecture9ã€xv6ç®€ä»‹ã€ä¸Šä¸‹æ–‡åˆ‡æ¢">Lecture9ã€xv6ç®€ä»‹ã€ä¸Šä¸‹æ–‡åˆ‡æ¢</h2><ol><li><p>xv6ç®€ä»‹ï¼š</p><ul><li><p>MIT6.S081è¯¾ä¸­çš„å®éªŒæ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œposixæ ‡å‡†ï¼Œçº¯cï¼Œå¯è¿è¡Œåœ¨riscvä¸Š</p></li><li><p>æ¥è¿‘å®Œæ•´çš„unix shellä½“éªŒï¼Œå…·å¤‡åŸºæœ¬å·¥å…·é›†ï¼ˆwcã€echoã€catã€‚ã€‚ï¼‰</p></li><li><p>å‘½ä»¤æ‰§è¡Œã€ç®¡é“ã€é‡å®šå‘</p>  <img src="https://s2.loli.net/2023/11/05/YQ7MacIrKWCytxA.png" style="zoom:67%;" /></li></ul></li><li><p><strong>å¤„ç†å™¨çš„è™šæ‹ŸåŒ–</strong></p><p>ä¸€ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆæ­»å¾ªç¯ä¸èƒ½ä½¿è®¡ç®—æœºè¢«å½»åº•å¡æ­»ï¼Ÿå³ä½¿åœ¨æ‰§è¡Œä¸€ä¸ªæ°¸è¿œwhile(1)çš„ç¨‹åºï¼Œä¹Ÿå¯ä»¥å¦å¼€ä¸€ä¸ªç»ˆç«¯è¿›è¡Œæ“ä½œã€ä¹Ÿè¿˜èƒ½å‘é€killä¿¡å·ç»ˆæ­¢ç¨‹åºï¼Ÿ</p> <img src="https://s2.loli.net/2023/11/05/9UCJBD4EqboluKk.png" style="zoom:50%;" /></li></ol><p>â€‹<img src="https://s2.loli.net/2023/11/05/6KRHiQfXbPVUlej.png" style="zoom: 50%;" /></p><img src="https://s2.loli.net/2023/11/05/I7dorgOqaWUh2xl.png" style="zoom:50%;" /><ol start="3"><li><p><strong>ä¸Šä¸‹æ–‡åˆ‡æ¢</strong></p><p>CPUæ€»æ˜¯èƒ½å¤Ÿæ”¯æŒè¿œå¤§äºCPUæ•°é‡çš„ä»»åŠ¡çš„ç»è¡Œï¼Œæ“ä½œç³»ç»Ÿä¼šâ€œè½®æµâ€åˆ†é…CPUä¾›ä»»åŠ¡ä½¿ç”¨ï¼Œè¿™å°±è¦æ±‚CPUçŸ¥é“ä»å“ªé‡Œå»åŠ è½½ä»»åŠ¡ä»¥åŠä»å“ªé‡Œå¼€å§‹æˆ–ç»§ç»­å»åŠ è½½ä»»åŠ¡ï¼Œè€Œè¿™äº›ä¿¡æ¯éƒ½è¢«ä¿ç•™åœ¨CPUçš„<strong>å¯„å­˜å™¨</strong>ä¸­ï¼Œå…¶ä¸­å³å°†æ‰§è¡Œçš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€è¢«ä¿å­˜åœ¨<strong>ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰è¿™ä¸€ç‰¹æ®Šçš„å¯„å­˜å™¨</strong>ä¸­ï¼Œæˆ‘ä»¬å°†å¯„å­˜å™¨çš„è¿™äº›ä¿¡æ¯ç§°ä¸º<strong>CPUçš„ä¸Šä¸‹æ–‡</strong>ï¼Œä¹Ÿç§°<strong>ç¡¬ä»¶ä¸Šä¸‹æ–‡</strong></p><p>Linux æŒ‰ç…§ç‰¹æƒç­‰çº§ï¼ŒæŠŠè¿›ç¨‹çš„è¿è¡Œç©ºé—´åˆ†ä¸ºå†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´ï¼Œåˆ†åˆ«å¯¹åº”ç€ä¸‹å›¾ä¸­ï¼Œ CPU ç‰¹æƒç­‰çº§çš„ Ring 0 å’Œ Ring 3ã€‚</p><ul><li><p>å†…æ ¸ç©ºé—´ï¼ˆRing 0ï¼‰å…·æœ‰æœ€é«˜æƒé™ï¼Œå¯ä»¥ç›´æ¥è®¿é—®æ‰€æœ‰èµ„æºï¼›</p></li><li><p>ç”¨æˆ·ç©ºé—´ï¼ˆRing 3ï¼‰åªèƒ½è®¿é—®å—é™èµ„æºï¼Œä¸èƒ½ç›´æ¥è®¿é—®å†…å­˜ç­‰ç¡¬ä»¶è®¾å¤‡ï¼Œå¿…é¡»é€šè¿‡ç³»ç»Ÿè°ƒç”¨é™·å…¥åˆ°å†…æ ¸ä¸­ï¼Œæ‰èƒ½è®¿é—®è¿™äº›ç‰¹æƒèµ„æº</p><p><img src="https://s2.loli.net/2023/11/05/aZr2Gz5tR6IKydc.png" alt=""></p></li></ul></li></ol><p>â€‹è¿›ç¨‹æ—¢å¯ä»¥åœ¨ç”¨æˆ·ç©ºé—´è¿è¡Œï¼Œåˆå¯ä»¥åœ¨å†…æ ¸ç©ºé—´ä¸­è¿è¡Œã€‚è¿›ç¨‹åœ¨ç”¨æˆ·ç©ºé—´è¿è¡Œæ—¶ï¼Œè¢«ç§°ä¸ºè¿›ç¨‹çš„ç”¨æˆ·æ€ï¼Œè€Œé™·å…¥å†…æ ¸ç©ºé—´çš„æ—¶å€™ï¼Œè¢«ç§°ä¸ºè¿›ç¨‹çš„å†…æ ¸æ€</p><ol start="4"><li><p><strong>ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸ç³»ç»Ÿè°ƒç”¨çš„å…³ç³»</strong></p><p>ä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„è½¬å˜ï¼Œéœ€è¦é€šè¿‡<strong>ç³»ç»Ÿè°ƒç”¨</strong>æ¥å®Œæˆã€‚</p><p>ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ä¸­çš„è¿‡ç¨‹ï¼š</p><ul><li>ä¿å­˜ CPU å¯„å­˜å™¨é‡ŒåŸæ¥ç”¨æˆ·æ€çš„æŒ‡ä»¤ä½</li><li>ä¸ºäº†æ‰§è¡Œå†…æ ¸æ€ä»£ç ï¼ŒCPU å¯„å­˜å™¨éœ€è¦æ›´æ–°ä¸ºå†…æ ¸æ€æŒ‡ä»¤çš„æ–°ä½ç½®</li><li>è·³è½¬åˆ°å†…æ ¸æ€è¿è¡Œå†…æ ¸ä»»åŠ¡</li><li>å½“ç³»ç»Ÿè°ƒç”¨ç»“æŸåï¼ŒCPU å¯„å­˜å™¨éœ€è¦æ¢å¤åŸæ¥ä¿å­˜çš„ç”¨æˆ·æ€ï¼Œç„¶åå†åˆ‡æ¢åˆ°ç”¨æˆ·ç©ºé—´ï¼Œç»§ç»­è¿è¡Œè¿›ç¨‹</li></ul><p>æ‰€ä»¥<strong>ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ä¸­å‘ç”Ÿäº†ä¸¤æ¬¡CPUä¸Šä¸‹æ–‡åˆ‡æ¢</strong>ï¼ˆç”¨æˆ·æ€-å†…æ ¸æ€-ç”¨æˆ·æ€ï¼‰</p></li></ol><h2 id="Lecture10ã€å¤„ç†å™¨è°ƒåº¦">Lecture10ã€å¤„ç†å™¨è°ƒåº¦</h2><ol><li><p><strong>motivation</strong>ï¼šä¸Šä¸‹æ–‡åˆ‡æ¢æœºåˆ¶æ˜¯åœ¨ä¸­æ–­\ç³»ç»Ÿè°ƒç”¨æ—¶æ‰§è¡Œæ“ä½œç³»ç»Ÿä»£ç ï¼Œæ“ä½œç³»ç»Ÿå®ç°æ‰€æœ‰çŠ¶æ€æœºï¼ˆè¿›ç¨‹ï¼‰ä¸€è§†åŒä»çš„â€œå°å­˜â€ï¼Œä»è€Œå¯ä»¥æ¢å¤ä»»æ„ä¸€ä¸ªçŠ¶æ€æœºï¼ˆè¿›ç¨‹ï¼‰çš„æ‰§è¡Œã€‚è€Œå…·ä½“é€‰æ‹©å“ªä¸ªè¿›ç¨‹æ‰§è¡Œï¼Œå°±æ˜¯å¤„ç†å™¨è°ƒåº¦ç­–ç•¥é—®é¢˜ã€‚</p></li><li><p><strong>ä¸€äº›å¸¸è§è°ƒåº¦ç®—æ³•</strong></p><ul><li><p><strong>å…ˆæ¥å…ˆæœåŠ¡ç®—æ³•(FCFS: First Come, First Served)</strong></p><p>â€‹FCFSä¾æ®è¿›ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€çš„å…ˆåé¡ºåºæ’åˆ—ï¼Œå®ƒç®€å•ã€æ˜“äºå®ç°</p><p><img src="https://s2.loli.net/2023/11/05/J2R7IExVAhHcC8G.png" alt=""></p><p>FCFS å¯¹é•¿ä½œä¸šæœ‰åˆ©ï¼Œé€‚ç”¨äº CPU ç¹å¿™å‹ä½œä¸šçš„ç³»ç»Ÿï¼Œè€Œä¸é€‚ç”¨äº I/O ç¹å¿™å‹ä½œä¸šçš„ç³»ç»Ÿ</p></li><li><p><strong>æœ€çŸ­ä½œä¸šä¼˜å…ˆï¼ˆShortest Job First, SJFï¼‰</strong></p><p>ä¼š<strong>ä¼˜å…ˆé€‰æ‹©è¿è¡Œæ—¶é—´æœ€çŸ­çš„è¿›ç¨‹æ¥è¿è¡Œ</strong>ï¼Œè¿™æœ‰åŠ©äºæé«˜ç³»ç»Ÿçš„ååé‡</p><p>â€‹<img src="https://s2.loli.net/2023/11/05/SzIyVdDilM1396C.png" style="zoom:80%;" /></p><p>â€‹è¿™æ˜¾ç„¶å¯¹é•¿ä½œä¸šä¸åˆ©ï¼Œå¾ˆå®¹æ˜“é€ æˆé•¿ä½œä¸šç­‰å¾…è¿‡ä¹…çš„æç«¯ç°è±¡</p></li></ul></li><li><p><strong>æ—¶é—´ç‰‡è½®è½¬ç®—æ³•ï¼ˆRound-Robinï¼ŒRRï¼‰</strong></p><p><img src="https://s2.loli.net/2023/11/05/dbPD2hwGzBpvilj.png" alt=""></p></li></ol><p>â€‹<strong>æ¯ä¸ªè¿›ç¨‹è¢«åˆ†é…ä¸€ä¸ªæ—¶é—´æ®µï¼Œç§°ä¸ºæ—¶é—´ç‰‡ï¼ˆQuantumï¼‰ï¼Œå³å…è®¸è¯¥è¿›ç¨‹åœ¨è¯¥æ—¶é—´æ®µä¸­è¿è¡Œã€‚</strong></p><ul><li>å¦‚æœæ—¶é—´ç‰‡ç”¨å®Œï¼Œè¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼Œé‚£ä¹ˆå°†ä¼šæŠŠæ­¤è¿›ç¨‹ä» CPU é‡Šæ”¾å‡ºæ¥ï¼Œå¹¶æŠŠ CPU åˆ†é…å¦å¤–ä¸€ä¸ªè¿›ç¨‹ï¼›</li><li>Â·å¦‚æœè¯¥è¿›ç¨‹åœ¨æ—¶é—´ç‰‡ç»“æŸå‰é˜»å¡æˆ–ç»“æŸï¼Œåˆ™ CPU ç«‹å³è¿›è¡Œåˆ‡æ¢ï¼›</li></ul><p>â€‹å¦å¤–ï¼Œæ—¶é—´ç‰‡çš„é•¿åº¦å°±æ˜¯ä¸€ä¸ªå¾ˆå…³é”®çš„ç‚¹ï¼š</p><ul><li>å¦‚æœæ—¶é—´ç‰‡è®¾å¾—å¤ªçŸ­ä¼šå¯¼è‡´è¿‡å¤šçš„è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œé™ä½äº† CPU æ•ˆç‡ï¼›</li><li>å¦‚æœè®¾å¾—å¤ªé•¿åˆå¯èƒ½å¼•èµ·å¯¹çŸ­ä½œä¸šè¿›ç¨‹çš„å“åº”æ—¶é—´å˜é•¿</li></ul><p>â€‹é€šå¸¸æ—¶é—´ç‰‡è®¾ä¸º <code>20ms~50ms</code> é€šå¸¸æ˜¯ä¸€ä¸ªæ¯”è¾ƒåˆç†çš„æŠ˜ä¸­å€¼</p><p>â€‹é’ˆå¯¹Round-Robinçš„ä¸€ä¸ªæ”¹è¿›ç­–ç•¥ï¼š<strong>å¼•å…¥ä¼˜å…ˆçº§ï¼ˆLinuxä¸­çš„niceï¼‰</strong></p><p>â€‹ç”¨topæŸ¥çœ‹è¿›ç¨‹ä¼˜å…ˆçº§ï¼ˆNIé‚£ä¸€åˆ—ï¼‰ï¼Œä¸º-19åˆ°20çš„æ•´æ•°ï¼Œ-19ä¼˜å…ˆçº§æœ€é«˜ï¼Œ20æœ€ä½ï¼ˆè¶Šåã€nicenessè¶Šä½ï¼Œå°±è¶Šè¦å»æŠ¢èµ„æºï¼›è¶Šè€å¥½äººå°±è¶Šä¼šæŠŠèµ„æºè®©ç»™åˆ«äººï¼‰</p><p>â€‹<img src="https://s2.loli.net/2023/11/05/mvWGJz8B4FxrSnA.png" alt=""></p><p>â€‹å®Œå…¨åŸºäºä¼˜å…ˆçº§çš„è°ƒåº¦ç­–ç•¥åœ¨å®æ—¶æ“ä½œç³»ç»ŸRTOSä¸­åº”ç”¨è¾ƒå¤šï¼Œå³å®¹æ˜“æŠŠæ•´ä¸ªcpuèµ„æºç»™é«˜ä¼˜å…ˆçº§ä»»åŠ¡</p><p>â€‹linuxï¼šniceç›¸å·®10ï¼Œcpuèµ„æºè·å–ç‡ç›¸å·®10å€</p><p>â€‹<img src="https://s2.loli.net/2023/11/05/gtfEmQxRusMO6aP.png" alt=""></p><p>â€‹</p><p>â€‹<strong>Round-Robinçš„ä¸€ä¸ªé—®é¢˜</strong>ï¼šèµ„æºåˆ†é…ä¸å‡ã€‚å¦‚ç³»ç»Ÿä¸­æœ‰ä¸¤ä¸ªè¿›ç¨‹ï¼Œä¸€ä¸ªæ˜¯äº¤äº’å¼çš„vimï¼Œå•çº¿ç¨‹ï¼›å¦ä¸€ä¸ªæ˜¯32çº¿ç¨‹çš„è®¡ç®—è¿›ç¨‹ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°</p><ul><li>vimèŠ±0.1mså¤„ç†å®Œè¾“å…¥å°±åˆç­‰è¾“å…¥ï¼Œé©¬ä¸Šä¸»åŠ¨è®©å‡ºcpu</li><li>è®¡ç®—è¿›ç¨‹ä½¿vimåœ¨æœ‰è¾“å…¥å¯ä»¥å¤„ç†æ—¶è¢«å»¶è¿Ÿï¼Œå¤šçº¿ç¨‹é•¿è¾¾æ•°ç™¾msçš„å»¶è¿Ÿå¯¼è‡´å¡é¡¿</li></ul><ol start="4"><li><p><strong>ç­–ç•¥ï¼šåŠ¨æ€ä¼˜å…ˆçº§ï¼Œå¤šçº§åé¦ˆé˜Ÿåˆ—(MLFQ: Multi Level Feedback Queues)</strong></p><p>é¡¾åæ€ä¹‰ï¼š</p><ul><li>ã€Œå¤šçº§ã€è¡¨ç¤ºæœ‰å¤šä¸ªé˜Ÿåˆ—ï¼Œæ¯ä¸ªé˜Ÿåˆ—ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼ŒåŒæ—¶ä¼˜å…ˆçº§è¶Šé«˜æ—¶é—´ç‰‡è¶ŠçŸ­ã€‚</li><li>ã€Œåé¦ˆã€è¡¨ç¤ºå¦‚æœæœ‰æ–°çš„è¿›ç¨‹åŠ å…¥ä¼˜å…ˆçº§é«˜çš„é˜Ÿåˆ—æ—¶ï¼Œç«‹åˆ»åœæ­¢å½“å‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼Œè½¬è€Œå»è¿è¡Œä¼˜å…ˆçº§é«˜çš„é˜Ÿåˆ—</li></ul></li></ol><p>â€‹<img src="https://s2.loli.net/2023/11/05/W4Jr1Y6GZdQhzjH.png" style="zoom:80%;" /></p><p>â€‹æ¥çœ‹çœ‹ï¼Œå®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼š</p><ul><li>è®¾ç½®äº†å¤šä¸ªé˜Ÿåˆ—ï¼Œèµ‹äºˆæ¯ä¸ªé˜Ÿåˆ—ä¸åŒçš„ä¼˜å…ˆçº§ï¼Œæ¯ä¸ª<strong>é˜Ÿåˆ—ä¼˜å…ˆçº§ä»é«˜åˆ°ä½</strong>ï¼ŒåŒæ—¶<strong>ä¼˜å…ˆçº§è¶Šé«˜æ—¶é—´ç‰‡è¶ŠçŸ­</strong>ï¼›</li><li>æ–°çš„è¿›ç¨‹ä¼šè¢«æ”¾å…¥åˆ°ç¬¬ä¸€çº§é˜Ÿåˆ—çš„æœ«å°¾ï¼ŒæŒ‰å…ˆæ¥å…ˆæœåŠ¡çš„åŸåˆ™æ’é˜Ÿç­‰å¾…è¢«è°ƒåº¦ï¼Œå¦‚æœåœ¨ç¬¬ä¸€çº§é˜Ÿåˆ—è§„å®šçš„æ—¶é—´ç‰‡æ²¡è¿è¡Œå®Œæˆï¼Œåˆ™å°†å…¶è½¬å…¥åˆ°ç¬¬äºŒçº§é˜Ÿåˆ—çš„æœ«å°¾ï¼Œä»¥æ­¤ç±»æ¨ï¼Œç›´è‡³å®Œæˆï¼›</li><li>å½“è¾ƒé«˜ä¼˜å…ˆçº§çš„é˜Ÿåˆ—ä¸ºç©ºï¼Œæ‰è°ƒåº¦è¾ƒä½ä¼˜å…ˆçº§çš„é˜Ÿåˆ—ä¸­çš„è¿›ç¨‹è¿è¡Œã€‚å¦‚æœè¿›ç¨‹è¿è¡Œæ—¶ï¼Œæœ‰æ–°è¿›ç¨‹è¿›å…¥è¾ƒé«˜ä¼˜å…ˆçº§çš„é˜Ÿåˆ—ï¼Œåˆ™åœæ­¢å½“å‰è¿è¡Œçš„è¿›ç¨‹å¹¶å°†å…¶ç§»å…¥åˆ°åŸé˜Ÿåˆ—æœ«å°¾ï¼Œæ¥ç€è®©è¾ƒé«˜ä¼˜å…ˆçº§çš„è¿›ç¨‹è¿è¡Œï¼›</li></ul><p>â€‹å¯ä»¥å‘ç°ï¼Œå¯¹äºçŸ­ä½œä¸šå¯èƒ½å¯ä»¥åœ¨ç¬¬ä¸€çº§é˜Ÿåˆ—å¾ˆå¿«è¢«å¤„ç†å®Œã€‚å¯¹äºé•¿ä½œä¸šï¼Œå¦‚æœåœ¨ç¬¬ä¸€çº§é˜Ÿåˆ—å¤„ç†ä¸å®Œï¼Œå¯ä»¥ç§»å…¥ä¸‹æ¬¡é˜Ÿåˆ—ç­‰å¾…è¢«æ‰§è¡Œï¼Œè™½ç„¶ç­‰å¾…çš„æ—¶é—´å˜é•¿äº†ï¼Œä½†æ˜¯è¿è¡Œæ—¶é—´ä¹Ÿä¼šæ›´é•¿äº†ï¼Œæ‰€ä»¥è¯¥ç®—æ³•å¾ˆå¥½çš„<strong>å…¼é¡¾äº†é•¿çŸ­ä½œä¸šï¼ŒåŒæ—¶æœ‰è¾ƒå¥½çš„å“åº”æ—¶é—´ã€‚</strong></p><ol start="5"><li><p><strong>å®Œå…¨å…¬å¹³è°ƒåº¦ç®—æ³•ï¼ˆCFSï¼ŒCompletely Fair Schedulerï¼‰</strong></p><p><strong>idea</strong>ï¼šå–æ¶ˆæ—¶é—´ç‰‡çš„æ¦‚å¿µï¼Œé‡‡ç”¨åˆ†é…cpuä½¿ç”¨æ—¶é—´çš„æ¯”ä¾‹çš„æ–¹æ³•ã€‚å³ä¸¤ä¸ªä¼˜å…ˆçº§ç›¸åŒçš„è¿›ç¨‹åœ¨ä¸€ä¸ªcpuä¸Šè¿è¡Œï¼Œåˆ™æ¯ä¸ªè¿›ç¨‹éƒ½å°†åˆ†é…50%çš„cpuè¿è¡Œæ—¶é—´ã€‚è€Œä¼˜å…ˆçº§ä¸åŒæ—¶ï¼Œä¼˜å…ˆçº§è¶Šé«˜åˆ†é…çš„æƒé‡å°±è¶Šå¤šï¼Œå ç”¨cpuæ—¶é•¿å°±è¶Šé•¿</p><p><strong>åˆ†é…ç»™è¿›ç¨‹çš„æ—¶é—´ = æ€»çš„cpuæ—¶é—´ * è¿›ç¨‹çš„æƒé‡/å°±ç»ªé˜Ÿåˆ—ï¼ˆrunqueueï¼‰æ‰€æœ‰è¿›ç¨‹æƒé‡ä¹‹å’Œ</strong></p><p>CFSè°ƒåº¦å™¨ä¸­ï¼Œniceå€¼å’Œæƒé‡ä¹‹é—´å¯ä»¥äº’ç›¸è½¬æ¢ï¼Œå†…æ ¸æä¾›äº†ä¸€ä¸ªarrayè½¬æ¢niceå€¼å’Œæƒé‡</p> <img src="https://s2.loli.net/2023/11/05/okdLWE3n2DsBSZg.png" style="zoom:67%;" /></li></ol><p>â€‹å¦‚è¿›ç¨‹Açš„niceä¸º-1ï¼ŒBçš„niceä¸º0ï¼Œåˆ™ï¼š<br>$$<br>CPU\ usage\ of\ A=CPU\ time * \frac{1277}{1277+1024}=0.55*CPU\ time<br>$$</p><p>$$<br>CPU\ usage\ of\ B=CPU\ time * \frac{1024}{1277+1024}=0.45*CPU\ time<br>$$</p><div class="note note-warning">            <p>ğŸ’¡ PS. è¿™ä¹Ÿå°±æ˜¯ä¸ºå•¥è¯´niceå‡é«˜1ï¼Œèµ„æºåˆ©ç”¨ç‡å¤§æ¦‚å·®10%</p>          </div><p>â€‹æ¥ä¸‹æ¥ï¼Œæ›´é‡è¦çš„æ˜¯å¼•å…¥<strong>è™šæ‹Ÿæ—¶é—´</strong>ï¼ˆvirtual timeï¼‰çš„æ¦‚å¿µï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šè™½ç„¶æ¯ä¸ªè¿›ç¨‹å®é™…åˆ†é…åˆ°çš„cpuä½¿ç”¨æ—¶é—´ä¸ä¸€æ ·ï¼Œä½†æˆ‘ä»¬å¯ä»¥å°†å…¶è½¬åŒ–ä¸ºæ•°å€¼ä¸€æ ·çš„è™šæ‹Ÿæ—¶é—´ï¼Œä»è€Œè®©æ“ä½œç³»ç»Ÿè§‰å¾—ï¼Œâ€œohï¼Œé…±ç´«æ˜¯å…¬å¹³çš„ï¼Œæ¯ä¸ªäººçš„éœ€æ±‚æˆ‘éƒ½æ»¡è¶³å•¦â€<br>$$<br>virtual_runtime=real_time*\frac{1024}{weight}<br>$$<br>â€‹å‡å¦‚è°ƒåº¦å‘¨æœŸä¸º10ms</p><p>â€‹åˆ™Açš„è™šæ‹Ÿæ—¶é—´ä¸º$10ms*\frac{1277}{1277+1024}*\frac{1024}{1277}=4.45ms$</p><p>â€‹Bçš„è™šæ‹Ÿæ—¶é—´ä¸º$10ms*\frac{1024}{1277+1024}*\frac{1024}{1024}=4.45ms$</p><p>â€‹å¯è§ï¼Œé€šè¿‡ç®€å•çš„æƒé‡è½¬æ¢ï¼Œå°±å¯ä»¥æŠŠæ‰€æœ‰è¿›ç¨‹çš„è™šæ‹Ÿæ—¶é—´è°ƒæˆä¸€è‡´ï¼ˆå°½ç®¡å…¶å®é™…è¿è¡Œæ—¶é—´ä¸ä¸€æ ·ï¼‰ï¼Œåœ¨é€‰æ‹©ä¸‹ä¸€ä¸ªå³å°†è¿è¡Œçš„è¿›ç¨‹çš„æ—¶å€™ï¼Œåªéœ€è¦æ‰¾åˆ°è™šæ‹Ÿæ—¶é—´æœ€å°çš„è¿›ç¨‹å³å¯ã€‚</p><div class="note note-warning">            <p>ğŸ’¡ PS. CFSæœ‰ä¸€ç‚¹â€œå…¬å¹³ä¸æ˜¯å¹³åˆ†â€çš„å‘³é“äº†ï¼Œå®ƒæ—¢èƒ½åšåˆ°æŒ‰éœ€åˆ†é…ï¼ˆæƒé‡ä¸åŒåˆ™cpu usageä¸åŒï¼‰ï¼Œåˆèƒ½é€šè¿‡è™šæ‹Ÿæ—¶é—´åšåˆ°è¡¨é¢ä¸Šçš„â€œcompletely fairâ€ï¼Œä»¥ä¾¿OSå»å°½é‡å…¬æ­£å¹³å‡åœ°å»é€‰æ‹©ä¸‹ä¸€ä¸ªæ‰§è¡Œçš„è¿›ç¨‹ï¼Œå¾ˆèªæ˜çš„æƒ³æ³•</p>          </div><ol start="6"><li><p><strong>ä¼˜å…ˆçº§åè½¬</strong></p><p>æ ¡é•¿ã€ç³»ä¸»ä»»å’Œjyyä¸‰äººï¼Œæ ¡é•¿æƒ³å…ˆsleepå†æ‹¿é”ï¼Œç³»ä¸»ä»»ä¸€ç›´æ­»å¾ªç¯ï¼Œjyyç›´æ¥æ‹¿é”</p> <img src="https://s2.loli.net/2023/11/05/yi7ApogkNIh6enP.png" style="zoom:67%;" /></li></ol><p>â€‹ç­‰æ ¡é•¿ä¼‘æ¯å¥½æƒ³æ‹¿é”çš„æ—¶å€™ï¼Œè¯¶ï¼Œé—®é¢˜å‡ºç°äº†ï¼Œjyyåœ¨æŒæœ‰äº’æ–¥é”çš„æ—¶å€™è¢«èµ¶å‡ºäº†å¤„ç†å™¨ï¼Œä¸­ç­‰ä¼˜å…ˆçº§çš„ç³»ä¸»ä»»ä¸€ç›´åœ¨å ç”¨cpuï¼Œjyyæ— æ³•é‡Šæ”¾é” â€”â€” é‚£ä¹ˆï¼Œæ­¤æ—¶æ ¡é•¿ç”±äºæ‹¿ä¸åˆ°é”ï¼Œåªèƒ½ç­‰å¾…jyyï¼Œjyyåˆåœ¨ç­‰ç³»ä¸»ä»»ï¼Œæ‰€ä»¥å®é™…é€ æˆäº†é«˜ä¼˜å…ˆçº§çš„æ ¡é•¿æ— æ³•ä¸­æ–­ä¸­ä¼˜å…ˆçº§çš„ç³»ä¸»ä»»ï¼Œå³ä¼˜å…ˆçº§åè½¬</p><div class="note note-warning">            <p>ğŸ’¡ PS. æ ¡é•¿å› ä¸ºæ‹¿ä¸åˆ°é”è€Œç­‰å¾…jyyè¿™ä»¶äº‹æ˜¯æ²¡é—®é¢˜çš„ï¼Œå› ä¸ºè¿™æ˜¯OSå±‚é¢çš„è¯­ä¹‰ï¼Œä¼˜å…ˆçº§å†é«˜è¢«æŠ¢å æ—¶éƒ½åªèƒ½ç­‰å¾…</p>          </div><h2 id="Lecture11ã€è®¾å¤‡é©±åŠ¨åŸç†ä¸æ–‡ä»¶ç³»ç»ŸAPI">Lecture11ã€è®¾å¤‡é©±åŠ¨åŸç†ä¸æ–‡ä»¶ç³»ç»ŸAPI</h2><ol><li><p><strong>I/Oè®¾å¤‡çš„æŠ½è±¡</strong></p><p>I/Oè®¾å¤‡çš„ä¸»è¦åŠŸèƒ½ï¼š<strong>è¾“å…¥å’Œè¾“å‡º</strong></p><p>å¸¸è§çš„è®¾å¤‡ï¼ˆæ‰“å°æœºã€ç»ˆç«¯ã€ç¡¬ç›˜ï¼‰éƒ½æ»¡è¶³è¿™ä¸ªæ¨¡å‹</p><p>æ‰€ä»¥æ“ä½œç³»ç»Ÿæä¾›çš„ä¸‰ä¸ªæœ€åŸºæœ¬çš„syscal</p><ul><li>read - ä»è®¾å¤‡æŸä¸ªæŒ‡å®šçš„ä½ç½®è¯»å‡ºæ•°æ®</li><li>write - å‘è®¾å¤‡æŸä¸ªæŒ‡å®šä½ç½®å†™å…¥æ•°æ®</li><li>ioctl - è¯»å–/è®¾ç½®è®¾å¤‡çš„çŠ¶æ€</li></ul></li><li><p><strong>è®¾å¤‡é©±åŠ¨ç¨‹åº</strong></p><p>æŠŠç³»ç»Ÿè°ƒç”¨ (read/write/ioctl/â€¦) â€œç¿»è¯‘â€ æˆä¸è®¾å¤‡å¯„å­˜å™¨çš„äº¤äº’</p></li></ol><p>â€‹<img src="https://s2.loli.net/2023/11/05/wxZBm8ADe2pIla6.png" style="zoom:80%;" /></p><p>â€‹</p><ol start="3"><li><p><strong>æ–‡ä»¶ç³»ç»Ÿä»‹ç»</strong></p><p><strong>motivation</strong>ï¼šè®¾å¤‡åœ¨åº”ç”¨ç¨‹åºä¹‹é—´æ˜¯éœ€è¦å…±äº«çš„ï¼ˆå¤šä¸ªè¿›ç¨‹å¹¶è¡Œæ‰“å°ï¼Œå¦‚ä½•ä¿è¯ä¸æ··ä¹±ï¼›æ¯ä¸ªCUDAåº”ç”¨ç¨‹åºéƒ½æ˜¯ä¸€ç³»åˆ—CUDA APIçš„è°ƒç”¨ï¼‰ï¼›å¦å¤–ï¼Œåƒç£ç›˜è¿™æ ·çš„è®¾å¤‡éœ€è¦æ”¯æŒæ•°æ®çš„æŒä¹…åŒ–ï¼Œå¦‚æœè®©æ‰€æœ‰åº”ç”¨å…±äº«ç£ç›˜çš„è¯ï¼Œä¸€ä¸ªç¨‹åºbugæ“ä½œç³»ç»Ÿå°±æ²¡äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è®¾è®¡ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä»¥æ»¡è¶³ï¼š</p><ul><li>æä¾›åˆç†çš„APIä½¿å¤šä¸ªåº”ç”¨ç¨‹åºèƒ½å…±äº«æ•°æ®</li><li>æä¾›ä¸€å®šçš„éš”ç¦»ï¼Œä½¿bugçš„ä¼¤å®³ä¸èƒ½ä»»æ„æ‰©å¤§</li></ul></li></ol><p>â€‹<strong>æ–‡ä»¶ç³»ç»Ÿï¼šè™šæ‹Ÿç£ç›˜</strong></p><ul><li>ç£ç›˜ï¼ˆI/Oè®¾å¤‡ï¼‰=ä¸€ä¸ªå¯ä»¥è¯»å†™çš„å­—èŠ‚åºåˆ—</li><li>è™šæ‹Ÿç£ç›˜ï¼ˆæ–‡ä»¶ï¼‰=ä¸€ä¸ªå¯ä»¥è¯»å†™çš„åŠ¨æ€å­—èŠ‚åºåˆ—</li></ul><ol start="4"><li><p><strong>è™šæ‹Ÿç£ç›˜ï¼šå‘½åç®¡ç†</strong></p><p>ä¸ºäº†æ‰¾åˆ°æƒ³è¦çš„è™šæ‹Ÿç£ç›˜ï¼Œæœ€ç›´æ¥çš„ä¸€ä¸ªæ€è·¯å°±æ˜¯åˆ©ç”¨ä¿¡æ¯çš„å±€éƒ¨æ€§ï¼Œè®²è™šæ‹Ÿç£ç›˜ç»„ç»‡æˆå±‚æ¬¡ç»“æ„</p></li></ol><p>â€‹<img src="https://s2.loli.net/2023/11/05/kLZSEo5JsxOVnI2.png" alt="Untitled"></p><p>â€‹</p><p>â€‹æ–‡ä»¶ç³»ç»Ÿçš„æ ¹ï¼š</p><ul><li>windowï¼šæ¯ä¸ªè®¾å¤‡ï¼ˆé©±åŠ¨å™¨ï¼‰æ˜¯ä¸€æ£µæ ‘</li></ul><p>â€‹<img src="https://s2.loli.net/2023/11/05/XSchPK7egFGJnZW.png" style="zoom:67%;" /></p><ul><li>UNIXï¼šåªæœ‰ä¸€ä¸ªæ ¹</li></ul><ol start="5"><li><p><strong>ç›®å½•APIï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰</strong></p> <img src="https://s2.loli.net/2023/11/05/FUm43JsQMo9AO2z.png" style="zoom:67%;" /></li></ol>]]></content>
    
    
    <categories>
      
      <category>æ ¸å¿ƒç§‘æŠ€çœ‹ç¾å¸</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
      <tag>X86</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åŸºäºCPU SIMDå’Œwinogradçš„å·ç§¯è®¡ç®—åŠ é€ŸæŠ€æœ¯</title>
    <link href="/2023/09/15/winograd%E5%8D%B7%E7%A7%AF%E5%8A%A0%E9%80%9F%E7%AE%97%E6%B3%95/"/>
    <url>/2023/09/15/winograd%E5%8D%B7%E7%A7%AF%E5%8A%A0%E9%80%9F%E7%AE%97%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<p><strong>å‚è€ƒï¼š</strong></p><p><a href="https://no5-aaron-wu.github.io/2021/11/16/AI-Algorithm-4-Winograd/">AIç®—æ³•åŸºç¡€ï¼šWinogradç®—æ³•åŸç†</a></p><p><a href="https://www.cnblogs.com/shine-lee/p/10906535.html">å·ç§¯ç¥ç»ç½‘ç»œä¸­çš„Winogradå¿«é€Ÿå·ç§¯ç®—æ³•</a></p><p><a href="https://www.cnblogs.com/nanmi/p/13607515.html">ä»TensorRTçœ‹INT8é‡åŒ–åŸç†</a></p><p><a href="https://juejin.cn/post/7112354784622936077">MegEngine Inference å·ç§¯ä¼˜åŒ–ä¹‹ Im2col å’Œ winograd ä¼˜åŒ–</a></p><h1></h1><h3 id="ä¸€ã€introduction">ä¸€ã€<strong>introduction</strong></h3><ol><li><p><strong>motivation</strong></p><p>ç½‘ç»œè®­ç»ƒè€—æ—¶è¿‡å¤§ï¼Œå·ç§¯å±‚æ˜¯CNNå‰å‘æ¨ç†è®¡ç®—çš„ä¸»è¦è®¡ç®—ç“¶é¢ˆã€‚åœ¨å¹¿æ³›ä½¿ç”¨çš„CNNæ¨¡å‹ä¸­ï¼Œå·ç§¯å±‚çš„è¿ç®—é‡å¯å åˆ°95%ä»¥ä¸Šã€‚</p><p>â€‹<img src="https://s2.loli.net/2023/09/18/STyFurcMlhY1Q84.png" alt=""></p></li><li><p><strong>ç›´æ¥å·ç§¯ç®—æ³•</strong></p></li></ol><p><img src="https://s2.loli.net/2023/09/18/4bX8cHxhOtZuDkQ.png" alt=""></p><p><img src="https://s2.loli.net/2023/09/18/WbAez5gHyElVTOu.png" alt=""></p><p>â€‹ä¸ºå•¥ç›´æ¥å·ç§¯ç®—æ³•å®¹æ˜“æ‹–æ…¢æ€§èƒ½å‘¢ï¼Ÿ</p><ul><li>æœ€å†…å±‚çš„ä¹˜åŠ è¯­å¥ï¼ˆä¼ªä»£ç çš„ç¬¬9è¡Œï¼‰æ— æ³•å‘é‡åŒ–ï¼Œå› ä¸ºæ— æ³•åœ¨å·ç§¯æ ¸ä¸Šè¿ç»­è¯»å…¥ä¸€ä¸ªå‘é‡å¯„å­˜å™¨é•¿åº¦çš„æ•°æ®</li><li>ä¼šé‡å¤è¯»æ•°æ®ï¼Œç±»ä¼¼äºé€’å½’è®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼Œç¼ºä¹è®°å¿†åŒ–è¿‡ç¨‹</li></ul><h3 id="äºŒã€å·ç§¯åŠ é€Ÿç®—æ³•">äºŒã€å·ç§¯åŠ é€Ÿç®—æ³•</h3><ol><li><p><strong>ä»‹ç»</strong></p><p>Winogradç®—æ³•èµ·æºäº1980å¹´ï¼Œä½œè€…Shmuel Winograd åœ¨æ–‡ç« <a href="https://epubs.siam.org/doi/abs/10.1137/0209021">ã€ŠOn multiplication of polynomials modulo a polynomialã€‹</a>ä¸­æå‡ºçš„å‡å°‘FIRæ»¤æ³¢å™¨è®¡ç®—é‡çš„ä¸€ä¸ªç®—æ³•ã€‚ä»–æŒ‡å‡ºï¼Œå¯¹äºè¾“å‡ºä¸ªæ•°ä¸ºmï¼Œå‚æ•°ä¸ªæ•°ä¸ºrçš„FIRæ»¤æ³¢å™¨ï¼Œä¸éœ€è¦mÃ—ræ¬¡ä¹˜æ³•è®¡ç®—ï¼Œè€Œåªéœ€è¦u(F(m,r))=m+râˆ’1æ¬¡ä¹˜æ³•è®¡ç®—å³å¯ã€‚<br>åæ¥ï¼Œæœ‰äººå‘ç°æ­¤ç®—æ³•å¯ä»¥ç”¨æ¥ä¼˜åŒ–åŠ é€ŸCNNç½‘ç»œçš„å·ç§¯è®¡ç®—<a href="https://arxiv.org/pdf/1509.09308.pdf">ã€ŠFast Algorithms for Convolutional Neural Networksã€‹</a>ï¼Œä»æ­¤Winogradç®—æ³•è¢«å¹¿æ³›åº”ç”¨äºå„æ¨ç†æ¡†æ¶ä¸­ã€‚</p></li><li><p><strong>1D winogradç®—æ³•</strong></p><p>ä»¥1ç»´å·ç§¯$F(2, 3)$ä¸ºä¾‹ï¼Œè¾“å…¥ä¿¡å·$d=[d_0,d_1,d_2,d_3]^T$ï¼Œå·ç§¯æ ¸$g=[g_0,g_1,g_2]^T$ï¼Œé‚£ä¹ˆå·ç§¯å¯ä»¥å†™æˆä¸‹åˆ—çŸ©é˜µä¹˜æ³•å½¢å¼ï¼š<br>$$<br>F(2,3)=\begin{bmatrix}d_0&amp;d_1&amp;d_2\d_1&amp;d_2&amp;d_3\end{bmatrix} \begin{bmatrix}g_0\g_1\g_2\end{bmatrix}=\begin{bmatrix}r_0\r_1\end{bmatrix}<br>$$<br>å¦‚æœè¿™ä¸ªè®¡ç®—è¿‡ç¨‹ä½¿ç”¨æ™®é€šçš„çŸ©é˜µä¹˜æ³•ï¼Œä¸€å…±éœ€è¦ <strong>6 æ¬¡ä¹˜æ³• + 4æ¬¡åŠ æ³•</strong>ï¼š<br>$$<br>r_0=d_0<em>g_0+d_1</em>g_1+d_2*g_2<br>$$<br>ä½†æ˜¯ï¼Œæˆ‘ä»¬ä»”ç»†è§‚å¯Ÿä¸€ä¸‹ï¼Œå·ç§¯è¿ç®—ä¸­è¾“å…¥ä¿¡å·è½¬æ¢å¾—åˆ°çš„çŸ©é˜µä¸æ˜¯ä»»æ„çŸ©é˜µï¼Œå…¶æœ‰è§„å¾‹çš„åˆ†å¸ƒç€å¤§é‡çš„é‡å¤å…ƒç´ ï¼Œä¾‹å¦‚$d_1$å’Œ$d_2$ã€‚Winogradåšäº†å¦‚ä¸‹å˜æ¢ï¼š</p><p>$$<br>F(2,3)=\begin{bmatrix}d_0&amp;d_1&amp;d_2\d_1&amp;d_2&amp;d_3\end{bmatrix}\begin{bmatrix}g_0\g_1\g_2\end{bmatrix}=\begin{bmatrix}m_1+m_2+m_3\m_2-m_3-m_4\end{bmatrix}<br>$$<br>å…¶ä¸­ï¼Œ</p></li></ol><p>$$<br>\begin{aligned}m_1&amp;=(d_0-d_2)g_0&amp;m_2=(d_1+d_2)\frac{g_0+g_1+g_2}{2}\m_4&amp;=(d_1-d_3)g_2&amp;m_3=(d_2-d_1)\frac{g_0-g_1+g_2}{2}\end{aligned}<br>$$</p><p>â€‹åœ¨CNNçš„æ¨ç†é˜¶æ®µï¼Œå·ç§¯æ ¸ä¸Šçš„å…ƒç´ æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥ä¸Šå¼ä¸­å’Œ g ç›¸å…³çš„å¼å­å¯ä»¥æå‰åœ¨æ¨¡å‹åˆå§‹åŒ–é˜¶æ®µç®—å¥½ï¼Œæ•´ä¸ªæ¨ç†é˜¶æ®µåªç”¨è®¡ç®—ä¸€æ¬¡ï¼Œå› æ­¤å¯ä»¥å¿½ç•¥ã€‚æ‰€ä»¥è¿™é‡Œä¸€å…±éœ€è¦ <strong>4æ¬¡ä¹˜æ³• + 8æ¬¡åŠ æ³•</strong>ã€‚</p><p>â€‹ä¸Šé¢å…¶å®å°±æ˜¯1Dçš„Winogradç®—æ³•ï¼Œæˆ‘ä»¬å°†ä¸Šé¢çš„è®¡ç®—è¿‡ç¨‹å†™æˆçŸ©é˜µçš„å½¢å¼ï¼š<br>$$<br>Y=A^T[(Gg)\odot(B^Td)]<br>$$<br>â€‹å…¶ä¸­ï¼Œ</p><ul><li><p>$\odot$è¡¨ç¤ºelement-wise multiplicationï¼ˆHadamard productï¼‰ï¼Œå³å¯¹åº”ä½ç½®ç›¸ä¹˜æ“ä½œï¼›</p></li><li><p>$g$ è¡¨ç¤ºå·ç§¯æ ¸ï¼›</p></li><li><p>$d$ è¡¨ç¤ºè¾“å…¥ç‰¹å¾å›¾ï¼›</p></li><li><p>$G$ è¡¨ç¤ºå·ç§¯æ ¸å˜æ¢çŸ©é˜µï¼Œå°ºå¯¸ä¸º$(u+kâˆ’1) Ã— k$ï¼›</p></li><li><p>$B^T$ è¡¨ç¤ºè¾“å…¥å˜æ¢çŸ©é˜µï¼Œå°ºå¯¸ä¸º$(u+kâˆ’1) Ã— k$ï¼›</p></li><li><p>$A^T$ è¡¨ç¤ºè¾“å‡ºå˜æ¢çŸ©é˜µï¼Œå°ºå¯¸ä¸º$(u+kâˆ’1) Ã— u$ï¼›</p></li><li><p>$u$ è¡¨ç¤ºè¾“å‡ºå°ºå¯¸ï¼Œ$k$è¡¨ç¤ºå·ç§¯æ ¸å°ºå¯¸ï¼Œ$su=(u+kâˆ’1)$è¡¨ç¤ºè¾“å…¥å°ºå¯¸</p><p>å„çŸ©é˜µå…·ä½“å€¼å¦‚ä¸‹ï¼š</p></li></ul><p>$$<br>B^T=\begin{bmatrix}1&amp;0&amp;-1&amp;0\0&amp;1&amp;1&amp;0\0&amp;-1&amp;1&amp;0\0&amp;1&amp;0&amp;-1\end{bmatrix}<br>$$</p><p>$$<br>G=\begin{bmatrix}1&amp;0&amp;0\\frac12&amp;\frac12&amp;\frac12\\frac12&amp;-\frac12&amp;\frac12\0&amp;0&amp;1\end{bmatrix}<br>$$</p><p>$$<br>g=\begin{bmatrix}{g_{0}}&amp;{g_{1}}&amp;{g_{2}}\end{bmatrix}^{T}<br>$$</p><p>$$<br>d=\begin{bmatrix}d_0&amp;&amp;d_1&amp;&amp;d_2&amp;&amp;d_3\end{bmatrix}^T<br>$$</p><p>â€‹$G, B^T, A^T$ä¸‰ä¸ªå˜æ¢çŸ©é˜µçš„æ¨å¯¼åŸç†åŠè¿‡ç¨‹å¯ä»¥é€šè¿‡githubå·¥å…·<a href="https://github.com/andravin/wincnn">wincnn</a>è®¡ç®—ï¼š</p><p><img src="https://s2.loli.net/2023/09/18/AeutOlUp2kZTqQg.png" alt="è®¡ç®—F(2,3)çš„å˜æ¢çŸ©é˜µ"></p><p><img src="https://s2.loli.net/2023/09/18/hPkeuWsfGYZUr4t.png" alt="è®¡ç®—F(4,3)çš„å˜æ¢çŸ©é˜µ"></p><ol start="3"><li><p><strong>å…³äºä¹˜æ³•å’ŒåŠ æ³•çš„è®¡ç®—é‡è®¨è®º</strong></p><p>ä¸ºå•¥ä»ç»å…¸å·ç§¯çš„6æ¬¡ä¹˜æ³• + 4æ¬¡åŠ æ³•ï¼Œåˆ°winogradçš„4æ¬¡ä¹˜æ³• + 8æ¬¡åŠ æ³•å°±è®¤ä¸ºæ˜¯è€—æ—¶æ›´å°‘æï¼Ÿ</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç»å…¸çš„äºŒè¿›åˆ¶å…¨åŠ å™¨ï¼Œè¾“å…¥Aå’ŒBä»¥åŠè¿›ä½Cinï¼Œè¾“å‡ºSumå’Œè¿›ä½è¾“å‡ºCo</p><p><img src="https://s2.loli.net/2023/09/19/rbI1T2WBDkCsE5O.png" alt="äºŒè¿›åˆ¶å…¨åŠ å™¨"></p><p>è€Œå®ç°ä¹˜æ³•å¸¸ç”¨çš„æ–¹æ³•æ˜¯ç±»ä¼¼äºæ‰‹å·¥è®¡ç®—ä¹˜æ³•çš„æ–¹å¼ï¼š</p></li></ol><p>â€‹<img src="https://s2.loli.net/2023/09/19/FpZUAQt4Wm6kJKh.png" alt=""></p><p>â€‹å¯¹åº”çš„ç¡¬ä»¶ç»“æ„å°±æ˜¯é˜µåˆ—ä¹˜æ³•å™¨ï¼Œè®¡ç®—æ€è·¯æ˜¯ç”Ÿæˆéƒ¨åˆ†ç§¯ï¼Œç´¯åŠ éƒ¨åˆ†ç§¯å’Œæœ€ç»ˆç›¸åŠ </p><p>â€‹<img src="https://s2.loli.net/2023/09/19/JAehzRkBIYyFKCq.png" alt="é˜µåˆ—ä¹˜æ³•å™¨"></p><p>â€‹å¯è§ä¹˜æ³•å™¨æ— è®ºæ˜¯å…ƒä»¶é¢ç§¯è¿˜æ˜¯è®¡ç®—è€—æ—¶éƒ½å¤§äºåŠ æ³•å™¨</p><p>â€‹<strong>ä½†æ˜¯ï¼Œä¸Šè¿°ç»å…¸ç†è§£é€‚ç”¨äºç°ä»£ä»£ç ä¼˜åŒ–å—ï¼Ÿ</strong></p><p>â€‹å¯¹äºä¸‹é¢è¿™æ ·ä¸€æ®µä»£ç ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> sum;<br>    sum = <span class="hljs-number">10</span>;<br>    sum *= <span class="hljs-number">3</span>;<br>    <span class="hljs-keyword">return</span> sum;<br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹ä½¿ç”¨gcc -S -masm=intelå¾—åˆ°æ±‡ç¼–è¯­å¥ï¼š</p><p>â€‹<img src="https://s2.loli.net/2023/09/19/Q4O2SejG36Bwv79.png" alt=""></p><p>â€‹å¯ä»¥çœ‹åˆ°ï¼Œsum*=3è¢«æ‹†æˆäº†1æ¡movå’Œä¸¤æ¡addï¼Œæ²¡æœ‰ç”¨ä¹˜æ³•</p><p>â€‹å¦‚æœæ˜¯sum*=2çš„è¯ï¼Œåˆ™ä¸ºï¼š</p><p>â€‹<img src="https://s2.loli.net/2023/09/19/QH3tJEMeopzyZ8B.png" alt=""></p><p>â€‹è¿™ä¸‹è¿addéƒ½çœäº†ï¼Œç›´æ¥salç®—æœ¯å·¦ç§»ä¸€ä½ï¼Œå³sum&lt;&lt;=1</p><p>â€‹ä¸Šè¿°æƒ…å†µè¿˜éƒ½åªæ˜¯-O0ç¼–è¯‘ä¼˜åŒ–ï¼Œå¦‚æœæˆ‘ä»¬å¼€åˆ°-O3</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> i, sum = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">10</span>; i++) &#123;<br>        sum += <span class="hljs-number">2</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> sum;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2023/09/19/OQZjfstRBLKE2uS.png" alt=""></p><p>éå¸¸æœ‰æ„æ€ï¼Œå¾ªç¯ç›´æ¥è¢«ä¼˜åŒ–æ‰äº†</p><p>å¦å¤–ï¼Œåœ¨ç°ä»£cpuçš„åˆ†æ”¯é¢„æµ‹ã€SIMDå‘é‡è¿ç®—çš„ä½œç”¨ä¸‹ï¼Œæ•°å€¼è®¡ç®—çš„è€—æ—¶ç»ä¸ä»…ä»…æ˜¯â€œä¹˜æ³•æ¯”åŠ æ³•æ…¢â€è¿™ä¹ˆç®€å•ï¼Œè¿™ç»™æˆ‘ä»¬çš„å¯å‘æ˜¯ï¼Œ<strong>åªè¦å†™å‡ºå¯è¯»æ€§è¶³å¤Ÿå¥½çš„ä»£ç å°±è¡Œï¼Œä¸è¦è‡ªä½œèªæ˜åœ°å»äººä¸ºä¼˜åŒ–ï¼Œç¼–è¯‘å™¨ä¼šå¸®ä½ åšå¥½è¿™ä»¶äº‹çš„ï¼Œpremature optimization is the root of evil</strong></p><ol start="4"><li><strong>2D winogradç®—æ³•</strong></li></ol><p>å°†$F(2,3)$æ‰©å±•åˆ°$F(2Ã—2,3Ã—3)$:</p>  <img src="https://s2.ax1x.com/2019/05/22/VpBFc6.png" style="zoom:67%;" /><p>â€‹æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸Šé¢åˆ‡åˆ†çš„æ¯ä¸€å—å…¶å®é™…å°±æ˜¯1Dçš„å·ç§¯æ“ä½œï¼Œå†™æˆçŸ©é˜µå—å½¢å¼ï¼š</p><img src="https://s2.ax1x.com/2019/05/22/VpDxY9.png" style="zoom:67%;" /><img src="https://s2.loli.net/2023/09/18/WgXk63bvhR1Mquy.png" style="zoom: 80%;" /><p>â€‹ä¸Šå›¾ä¸­æœ€åå¾—åˆ°$M_0â€¦M_3$çš„æ“ä½œä¸º4æ¬¡çŸ©é˜µåŠ æ³•ä»¥åŠ4æ¬¡çŸ©é˜µä¹˜æ³•ï¼Œç”±$M_0â€¦M_3$å¾—åˆ°$[R0,R1]^T$ä¸º4æ¬¡çŸ©é˜µåŠ æ³•ï¼ŒåŒæ ·$W$çŸ©é˜µçš„è½¬æ¢çš„è®¡ç®—é‡å¿½ç•¥ä¸è®¡ã€‚</p><ul><li>$K_{0â€¦3}$ä¹‹é—´çš„4æ¬¡çŸ©é˜µåŠ æ³•ï¼Œ æ¯æ¬¡å®é™…ä¸º4æ¬¡åŠ æ³•ï¼ˆæ³¨æ„ä¸è¦è¢«ä¸Šé¢æ‰©å±•åçš„$K$çŸ©é˜µåˆ’åˆ†çš„å°æ–¹å—ä¸­6ä¸ªå…ƒç´ æ‰€è¿·æƒ‘ï¼Œå…¶ä¸­æœ‰é‡å¤çš„å…ƒç´ ï¼‰ï¼Œå…±4Ã—4=16æ¬¡åŠ æ³•ï¼›</li><li>4æ¬¡çŸ©é˜µä¹˜æ³•å¯ä»¥è½¬æ¢ä¸º4æ¬¡ <strong>1D Winograd</strong> æ¥è®¡ç®—ï¼Œæ¯æ¬¡ <strong>1D Winograd</strong> è®¡ç®—ä¸­æœ‰4æ¬¡ä¹˜æ³•ï¼Œ8æ¬¡åŠ æ³•ï¼Œå…±4Ã—4=16æ¬¡ä¹˜æ³•ï¼Œ4Ã—8=32æ¬¡åŠ æ³•ï¼›</li><li>æœ€å$M_0â€¦M_3$ä¹‹é—´çš„4æ¬¡çŸ©é˜µåŠ æ³•ï¼Œç”±äº$M$çŸ©é˜µçš„å°ºå¯¸ä¸º2Ã—1ï¼Œæ‰€ä»¥å…±4Ã—2=8æ¬¡åŠ æ³•ï¼›ç»¼ä¸Šï¼Œ$F(2Ã—2,3Ã—3)$çš„Winogradç®—æ³•å…± <strong>16æ¬¡ä¹˜æ³•å’Œ56æ¬¡åŠ æ³•</strong>ï¼Œå¦‚æœä½¿ç”¨å¸¸è§„å·ç§¯è¿ç®—ï¼Œåˆ™éœ€è¦ <strong>36æ¬¡ä¹˜æ³•å’Œ32æ¬¡åŠ æ³•</strong></li></ul><p>â€‹ä¸Šé¢çš„è®¡ç®—è¿‡ç¨‹å†™æˆçŸ©é˜µçš„å½¢å¼å¦‚ä¸‹:<br>$$<br>Y=A^T[[GgG^T]\odot[B^TdB]]A<br>$$</p><ol start="5"><li><p><strong>1Dåˆ°2Dçš„å…¬å¼æ¨å¯¼</strong></p> <div class="note note-warning">            <p>çº¦å®šï¼šå¤§å†™å­—æ¯æˆ–å°å†™å­—æ¯åŠ ä¸Šç®­å¤´å‡ä»£è¡¨çŸ©é˜µæˆ–å‘é‡ï¼Œ$K_0$ä¸$\overrightarrow{d_0}$å‡è¡¨ç¤ºè¾“å…¥çŸ©é˜µçš„ç¬¬ä¸€è¡Œï¼Œ$W_0$ä¸$\overrightarrow{k_0}$å‡è¡¨ç¤ºå·ç§¯æ ¸çš„ç¬¬ä¸€è¡Œ</p><p>è¿™é‡Œæ²¿ç”¨2D Winogradæ¨å¯¼ä¸­çš„å­—æ¯è¡¨ç¤ºï¼Œæœ€åä¼šè½¬ä¸º1D Winogradæ¨å¯¼ä¸­çš„å­—æ¯è¡¨ç¤º</p>          </div></li></ol><p>â€‹é¦–å…ˆå¯¹ä¸Šè¿°å…¬å¼è¿›è¡Œé‡æ’ï¼Œè¾“å‡ºä¸º2Ã—2çŸ©é˜µï¼š<br>$$<br>[R_0,R_1]=[M_0+M_1+M_2,M_1-M_2-M_3]\=[M_0,M_1,M_2,M_3]\begin{bmatrix}1&amp;0\1&amp;1\1&amp;-1\0&amp;-1\end{bmatrix}=[M_0,M_1,M_2,M_3]A<br>$$<br>â€‹ç»“åˆä¸Šé¢è®¡ç®—ä»£å…¥$M_n$å¾—ä¸‹å¼ï¼š<br>$$<br>\begin{aligned}<br>&amp;[R_0,R_1]= \<br>&amp;\left[A^{T}[(GW_{0})\odot(B^{T}(K_{0}-K_{2}))],A^{T}[(G\frac{W_{0}+W_{1}+W_{2}}{2})\odot(B^{T}(K_{1}+K_{2}))],\right. \<br>&amp;A^{T}[(G\frac{W_{0}-W_{1}+W_{2}}{2})\odot(B^{T}(K_{2}-K_{1}))],A^{T}[(GW_{2})\odot(B^{T}(K_{1}-K_{3}))]\Biggr]A \<br>&amp;=A^T\bigg[[(GW_0)\odot(B^T(K_0-K_2))],[(G\frac{W_0+W_1+W_2}{2})\odot(B^T(K_1+K_2))], \<br>&amp;[(G\frac{W_0-W_1+W_2}2)\odot(B^T(K_2-K_1))],[(GW_2)\odot(B^T(K_1-K_3))]\Biggr]A<br>\end{aligned}<br>$$<br>â€‹ç”±äºhadamard productï¼ˆ$\odot$ï¼‰å’Œconcatï¼ˆ,ï¼‰æ“ä½œå¯ä»¥äº¤æ¢è€Œä¸å½±å“ç»“æœï¼Œå› æ­¤ï¼š<br>$$<br>\begin{aligned}<br>&amp;[R_0,R_1]= \<br>&amp;A^T\bigg[(G[W_0,\frac{W_0+W_1+W_2}{2},\frac{W_0-W_1+W_2}{2},W_2])\odot\big(B^T[K_0-K_2,K_1+K_2,K_2-K_1,K_1-K_3]\big)\bigg]A \<br>&amp;=A^T\bigg[(G[W_0,W_1,W_2]\begin{bmatrix}1&amp;\frac{1}{2}&amp;\frac{1}{2}&amp;0\0&amp;\frac{1}{2}&amp;-\frac{1}{2}&amp;0\0&amp;\frac{1}{2}&amp;\frac{1}{2}&amp;1\end{bmatrix})\odot(B^T[K_0,K_1,K_2,K_3]\begin{bmatrix}1&amp;0&amp;0&amp;0\0&amp;1&amp;-1&amp;1\-1&amp;1&amp;1&amp;0\0&amp;0&amp;0&amp;-1\end{bmatrix})\bigg]A \<br>&amp;=A^T\bigg[(G[\overrightarrow{k_0},\overrightarrow{k_1},\overrightarrow{k_2}]G^T)\odot(B^T[\overrightarrow{d_0},\overrightarrow{d_1},\overrightarrow{d_2},\overrightarrow{d_3}]B)\bigg]A \<br>&amp;=A^T[(GKG^T)\odot(B^TDB)]A<br>\end{aligned}<br>$$</p><ol start="6"><li><p><strong>æ€»ç»“</strong></p><p>Winogradç®—æ³•å¯ä»¥åˆ†ä¸º4ä¸ªæ­¥éª¤ï¼š</p></li></ol><ul><li><ol><li>åˆå§‹åŒ–æœŸé—´å®Œæˆå·ç§¯æ ¸çš„å˜æ¢<code>weightTransform</code>ï¼Œå³ï¼š$GKG^T$</li></ol></li><li><ol start="2"><li>è¿è¡ŒæœŸé—´å®Œæˆè¾“å…¥æ•°æ®çš„å˜æ¢<code>sourceTransform</code>ï¼Œå³ï¼š$B^TDB$</li></ol></li><li><ol start="3"><li>è¿è¡ŒæœŸé—´å®Œæˆè¾“å…¥æ•°æ®ä¸æƒé‡çš„<code>MatMul</code>ï¼Œå³ï¼š$(GKG^T)\odot(B^TDB)$</li></ol></li><li><ol start="4"><li>è¿è¡ŒæœŸé—´å®Œæˆè¾“å‡ºæ•°æ®çš„å˜æ¢<code>dstTransform</code>ï¼Œå³ï¼š$A^T[(GKG^T)\odot(B^TDB)]A$</li></ol></li></ul>]]></content>
    
    
    <categories>
      
      <category>è‡ªå·±äº‹æƒ…é è‡ªå·±</category>
      
    </categories>
    
    
    <tags>
      
      <tag>SIMD</tag>
      
      <tag>ä½“ç³»ç»“æ„</tag>
      
      <tag>AIè¾¹ç¼˜è®¡ç®—</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è®ºæ–‡å­¦ä¹ ï¼šA survey of distributed optimization</title>
    <link href="/2023/09/10/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BC%98%E5%8C%96%E7%BB%BC%E8%BF%B0/"/>
    <url>/2023/09/10/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BC%98%E5%8C%96%E7%BB%BC%E8%BF%B0/</url>
    
    <content type="html"><![CDATA[<p>ä¸€äº›å‚è€ƒï¼š</p><p><a href="https://forshining.github.io/posts/2022/07/blog-post-DistriOptim/">Distributed Optimization Algorithms</a></p><h2 id="åˆ†å¸ƒå¼ä¼˜åŒ–ï¼ˆDistributed-Optimizationï¼‰å‰ç½®ä»‹ç»å’Œä¸€äº›æ€è€ƒï¼š">åˆ†å¸ƒå¼ä¼˜åŒ–ï¼ˆDistributed Optimizationï¼‰å‰ç½®ä»‹ç»å’Œä¸€äº›æ€è€ƒï¼š</h2><p><strong>ç°å®èƒŒæ™¯</strong>ï¼šæœ€ä¼˜ç¼–é˜Ÿæ§åˆ¶é—®é¢˜ï¼Œå³æ—¢è¦æ±‚å®ç°ä¼ ç»Ÿçš„ä½ç½®consensusä»¥å½¢æˆç‰¹å®šç¼–é˜Ÿï¼Œä¹Ÿè¦åœ¨æŸäº›æŒ‡æ ‡ï¼ˆå˜æ¢é˜Ÿå½¢æ—¶çš„æ€»ç§»åŠ¨è·ç¦»ã€èƒ½è€—balabalaï¼‰è¾¾åˆ°æœ€ä¼˜ã€‚<br>$$<br>æ¯ä¸ªæ™ºèƒ½ä½“çš„ä»£ä»·å‡½æ•°ï¼šf_i(\phi_i)=c_i|\phi_i-\phi_i(0)|_2^2<br>$$</p><p>$$<br>æ€»çš„çš„ä»£ä»·å‡½æ•°ï¼šf(\phi)=\sum_{i=1}^Nc_i|{\phi_i}-\phi_i(0)|_2^2<br>$$</p><p><strong>æ¯”è¾ƒ</strong>ï¼š</p><ul><li><p><strong>å’Œä¼ ç»Ÿconsensus</strong>ï¼š</p><p>ä¼ ç»Ÿconsensusä¸è¦æ±‚è¾¾åˆ°æœ€ä¼˜ï¼›</p><p>ç›¸å½“äºæ˜¯åœ¨ä¼ ç»Ÿconsensusçš„åŸºç¡€ä¸Šå¤šåŠ äº†ä¸€é“æœ€ä¼˜çš„è€ƒè™‘ï¼›</p><p>æ‹“æ‰‘ç»“æ„ä¸å½±å“åˆ†å¸ƒå¼ä¼˜åŒ–çš„å…·ä½“æ”¶æ•›å€¼</p></li><li><p><strong>å’Œæ™®é€šä¼˜åŒ–</strong>ï¼š</p><p>è€ƒè™‘æ‹“æ‰‘ä¿¡æ¯ï¼Œä¸æ˜¯åˆ†åˆ«è®¡ç®—æ¯ä¸ªä¸ªä½“çš„æœ€ä¼˜ç„¶åç›¸åŠ ï¼›</p><p>æœ€ç»ˆå„agentçš„æ”¶æ•›å€¼æ˜¯ä¸€è‡´çš„ï¼Œè€Œå¦‚æœå•è€ƒè™‘ä¸ªä½“ç›®æ ‡å‡½æ•°çš„è¯é‚£æ”¶æ•›å€¼è‚¯å®šä¸ä¸€æ ·</p></li></ul><p><strong>Q1</strong>ï¼šä»£ä»·å‡½æ•°çš„è‡ªå˜é‡ä¸€å®šè¦æ˜¯æ™ºèƒ½ä½“çš„çŠ¶æ€ xi å—ï¼Ÿ</p><p><strong>A1</strong>ï¼šå¯¹äºç»å…¸åˆ†å¸ƒå¼ä¼˜åŒ–é—®é¢˜æ¥è¯´ä¸€èˆ¬æ˜¯è¿™æ ·ï¼Œä½†ä¹Ÿå¯æ”¹å˜è‡ªå˜é‡å¾—åˆ°å…¶å®ƒå½¢å¼çš„é—®é¢˜ã€‚å¦‚å”äºæ¶›åµŒå…¥å¼ä½œå“ä¸­ç ”ç©¶çš„å°±æ˜¯æœ€ä¼˜è¾“å‡ºä¸€è‡´æ€§é—®é¢˜ï¼ˆoptimal output consensusï¼‰ï¼Œè‡ªå˜é‡æ˜¯è¾“å‡ºå€¼y â€”â€” å½“ç„¶ï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯ä¸ªåˆ†å¸ƒå¼ä¼˜åŒ–é—®é¢˜ï¼Œç”¨çš„è¿˜æ˜¯é‚£äº›ä¼˜åŒ–ç®—æ³•ï¼ˆ$f(y)=\sum_{i=1}^{N}f_{i}(y)$ï¼‰</p><img src="https://s2.loli.net/2024/01/09/ctvoWzyQZY9k2uN.png" style="zoom:80%;" /><p><strong>Q2</strong>ï¼šæ¯ä¸ªæ™ºèƒ½ä½“çš„$f_i(x_i)$æœ€ç»ˆçš„æ”¶æ•›å€¼æ˜¯ç›¸åŒçš„å—ï¼Ÿ</p><p><strong>A2</strong>ï¼šä¸¥æ ¼æ¥è¯´ä¸æ˜¯ç›¸åŒï¼Œè€Œæ˜¯è¾¾æˆconsensusï¼›è‡³äºè¿™ä¸ªconsensusæ˜¯å®Œå…¨ç›¸ç­‰ï¼ˆä¸€èˆ¬çš„åˆ†å¸ƒå¼ä¼˜åŒ–é—®é¢˜ï¼‰è¿˜æ˜¯å·®äº†ä¸€ä¸ªå›ºå®šå¸¸æ•°ï¼ˆç¼–é˜Ÿé—®é¢˜ï¼‰å°±å–å†³äºé—®é¢˜æœ¬èº«äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>åˆ†å¸ƒå¼ä¼˜åŒ–ä¸­çš„consensuséƒ¨åˆ†å’Œä¼ ç»Ÿconsensusæ˜¯ä¸€å›äº‹</strong>ã€‚</p><p><strong>Q3</strong>ï¼šåˆ†å¸ƒå¼ä¼˜åŒ–çš„æœ€ç»ˆç»“æœå’Œæ™®é€šconsensusç»“æœæ˜¯ä¸€æ ·çš„å—ï¼Ÿ</p><p><strong>A3</strong>ï¼šæ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œçœ‹ä¼˜åŒ–éƒ¨åˆ†é•¿å•¥æ ·ã€‚<strong>åˆ†å¸ƒå¼ä¼˜åŒ–=æ™®é€šconsensusï¼ˆç¾¤ä½“äº¤äº’ï¼‰ + æ™®é€šä¼˜åŒ–ï¼ˆä¸ªä½“è®¡ç®—ï¼‰</strong>ï¼Œå…¶ä¸­consensuséƒ¨åˆ†çš„ç»“æœå°±æ˜¯å¸¸è§„ä¸€è‡´æ€§ç®—æ³•å¾—åˆ°çš„ç»“æœï¼Œå®ƒä¿è¯äº†å„agentçš„æ”¶æ•›å€¼æ˜¯ç›¸åŒçš„ï¼ˆæˆ–è€…å·®ä¸€ä¸ªå¸¸æ•°ï¼‰ï¼›è€Œä¼˜åŒ–éƒ¨åˆ†å†³å®šäº†è¿™ä¸ªæ”¶æ•›å€¼å…·ä½“æ˜¯å¤šå°‘ã€‚</p><p>å¦‚ä¸‹é¢é‚£ä¸ªDGDçš„ä»¿çœŸä¸­ï¼Œç›®æ ‡å‡½æ•°æ˜¯$x^2$æ—¶ï¼Œæ”¶æ•›å€¼ä¸º0ï¼›ä¸º$(x-1)^2$æ”¶æ•›å€¼å°±ä¸º1äº†ï¼ˆå½“ç„¶ï¼Œè¿™æ˜¯èƒ½æ”¶æ•›çš„æƒ…å†µï¼Œæ‹“æ‰‘å›¾ä¸­æ²¡æœ‰ç”Ÿæˆæ ‘æ—¶è‚¯å®šå°±æ”¶æ•›ä¸åˆ°è¿™ä¸ªå€¼äº†ï¼›æœ‰ç”Ÿæˆæ ‘æ—¶æ‹“æ‰‘ä¸åŒæ”¶æ•›é€Ÿåº¦ä¹Ÿä¼šä¸åŒï¼‰</p><p><img src="https://s2.loli.net/2024/01/09/gchpqSDbjUXTkxP.png" alt=""></p><p><img src="https://s2.loli.net/2024/01/09/oaKrSbzlkR6874s.png" alt=""></p><p><strong>Q4</strong>ï¼šæ™®é€šconsensusçš„æ‹“æ‰‘å½±å“æœ€ç»ˆçš„æ”¶æ•›å€¼ï¼Œè€Œåˆ†å¸ƒå¼ä¼˜åŒ–çš„æ‹“æ‰‘ä¸å½±å“ï¼Œå¯¹å—ï¼Ÿ</p><p><strong>A4</strong>ï¼šå‡è®¾å¤§å‰ææ˜¯æ‹“æ‰‘ä¸­å­˜åœ¨ç”Ÿæˆæ ‘ï¼Œé‚£ä¹ˆ<strong>æ™®é€šconsensusçš„æœ€ç»ˆæ”¶æ•›å€¼ç¡®å®å–å†³äºæ‹“æ‰‘ç»“æ„</strong>ï¼Œå› ä¸ºä»consensusç®—æ³•å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œç®—æ³•æœ¬èº«åªä¿è¯å„èŠ‚ç‚¹å€¼è¾¾åˆ°ä¸€è‡´ï¼Œè€Œä¸ä¿è¯è¿™ä¸ªå€¼å…·ä½“æ˜¯å¤šå°‘ï¼Œæ‹“æ‰‘ä¸åŒæ—¶ï¼Œèƒ½åˆ†äº«çš„ä¿¡æ¯ç¨‹åº¦ä¸åŒï¼Œæ”¶æ•›å€¼è‡ªç„¶å°±ä¸ä¸€æ ·ã€‚</p><p><img src="https://s2.loli.net/2023/09/11/unY1li45ovgDGUR.png" alt="æ— å‘å›¾"></p><p>æ— éœ€å¤ªå¤šè§£é‡Šï¼Œä¸ºæ— å‘å›¾å®Œå…¨è¿é€šæ—¶ï¼Œæœ€ç»ˆå„èŠ‚ç‚¹å€¼è¶‹äºå…¨å±€çš„å¹³å‡å€¼</p><p><img src="https://s2.loli.net/2023/09/11/ST9zrA3w4no6muy.png" alt="æœ‰å‘å›¾"></p><p>ä¸ºæœ‰å‘å›¾æ—¶ï¼Œå› ä¸ºä¸æ˜¯å„èŠ‚ç‚¹ä¹‹é—´éƒ½è¿˜èƒ½â€œå‡åŒ€åœ°â€é€šä¿¡ï¼Œæ‰€ä»¥ç»“æœä¹Ÿä¸å†æ˜¯å…¨å±€å¹³å‡</p><p>è€Œå¯¹äºåˆ†å¸ƒå¼ä¼˜åŒ–æ¥è¯´ï¼Œå¯ä»¥æŠŠæ”¶æ•›è¿‡ç¨‹æ‹†æˆç‹¬ç«‹çš„ä¸¤éƒ¨åˆ†æ¥ç†è§£ï¼š<br>ç¬¬ä¸€éƒ¨åˆ†ï¼Œæ‹“æ‰‘èµ·ä½œç”¨ï¼Œç»å…¸consensusä¿è¯äº†å„agentå€¼ä¸€è‡´ï¼ˆä¸ç®¡æ˜¯å…¨å±€å¹³å‡å€¼è¿˜æ˜¯åŠ æƒå¹³å‡å€¼ï¼Œåæ­£æ˜¯ä¸€è‡´çš„ï¼‰ï¼›<br>ç¬¬äºŒéƒ¨åˆ†ï¼Œæ‹“æ‰‘ä¸èµ·ä½œç”¨ï¼Œå„è‡ªæ¢¯åº¦ä¸‹é™ï¼Œè¾¾åˆ°ç›®æ ‡å‡½æ•°çš„ï¼ˆå±€éƒ¨ï¼‰æœ€ä¼˜ç‚¹ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ™®é€šconsensusä¸­ï¼Œç”±äºæ‹“æ‰‘ä¸åŒï¼Œå¯èƒ½å¯¼è‡´â€è¿˜æ²¡æ¥å¾—åŠæ”¶æ•›åˆ°å…¨å±€å¹³å‡ï¼Œå¤§å®¶çš„å€¼å°±ç›¸åŒäº†ï¼Œé‚£å¥½å§ï¼Œåªèƒ½åœä¸‹æ¥äº†â€œï¼›è€Œåœ¨åˆ†å¸ƒå¼ä¼˜åŒ–ä¸­ï¼Œå°±ç®—è¾¾åˆ°äº†è¯¥æ‹“æ‰‘ä¸‹çš„åŠ æƒå¹³å‡ï¼Œåªè¦æ¢¯åº¦ä¸ä¸º0ã€æ²¡åˆ°ç›®æ ‡å‡½æ•°çš„æœ€ä¼˜ç‚¹ï¼Œé‚£å°±è¿˜ä¼šæ‹–ç€$x_i$ç»§ç»­å˜æ¢ï¼Œç›´è‡³è¾¾åˆ°æœ€ä¼˜ä¸”ä¸€è‡´ã€‚<br>æ‰€ä»¥<strong>åˆ†å¸ƒå¼ä¼˜åŒ–çš„æ‹“æ‰‘ä»…å½±å“æ”¶æ•›é€Ÿåº¦å’Œç¨³å®šæ€§ï¼Œä¸å½±å“å…·ä½“æ”¶æ•›å€¼</strong>ã€‚</p><h1>A survey of distributed optimization, 2019, Annual Reviews in Control</h1><h3 id="ä¸€ã€introduction">ä¸€ã€introduction</h3><ol><li><strong>åˆ†å¸ƒå¼ä¼˜åŒ–</strong><br>$$<br>\min_{x\in\mathbb{R}^n}\sum_{i=1}^Nf_i(x),<br>$$</li></ol><h3 id="äºŒã€ç¦»æ•£æ—¶é—´åˆ†å¸ƒå¼ä¼˜åŒ–ç®—æ³•">äºŒã€ç¦»æ•£æ—¶é—´åˆ†å¸ƒå¼ä¼˜åŒ–ç®—æ³•</h3><ol><li><p><strong>é€’å‡æ­¥é•¿ï¼ˆdiminishing step-sizesï¼‰</strong></p><p><strong>DGD: Distributed Gradient Descent</strong><br>$$<br>x_i(k+1)=\sum_{j=1}^Nw_{ij}(k)x_j(k)-\alpha(k)s_i(k),<br>$$<br>å…¶ä¸­$w_{ij}(k)$æ˜¯è¾¹çš„æƒé‡ï¼Œ$s_i(k)$æ˜¯å±€éƒ¨å‡½æ•°$f_i(x)$çš„ï¼ˆæ¬¡ï¼‰æ¢¯åº¦ï¼Œ$\alpha(k)&gt;0$æ˜¯é€’å‡çš„æ­¥é•¿ï¼Œå…¶æ»¡è¶³ï¼š<br>$$<br>\sum_{k=0}^\infty\alpha\left(k\right)=\infty,\sum_{k=0}^\infty\alpha^2(k)&lt;\infty,<br>$$</p><p>$$<br>\alpha\left(k\right)\leq\alpha\left(s\right)\mathrm{~for~all~}k&gt;s\geq0.<br>$$</p> <div class="note note-warning">            <p>ğŸ’¡ PS. æ³¨æ„ï¼ŒåŸæ–‡ä¸­å‡è®¾äº†$\sum_{j=1}^m w_{ij}(k)=1$ï¼Œå³è¾¹çš„æƒé‡æ˜¯å‡å€¼å½’ä¸€åŒ–äº†çš„ï¼Œæ‰€ä»¥ä¸Šé¢çš„å…¬å¼ä¸­çš„consensuséƒ¨åˆ†å’Œå¸¸è§çš„ä¸€è‡´æ€§ç®—æ³•$x_i(k+1)=x_i(k)+u,\quad u=\sum a_{ij}(x_j-x_i)$å…¶å®æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼ˆæ¨å¯¼ç•¥ï¼‰</p>          </div><p>DGDç®—æ³•æœ¬è´¨ä¸Šæ˜¯å°†ä¼˜åŒ–è¿‡ç¨‹åˆ†æˆäº†ä¸¤éƒ¨åˆ†ï¼šä¸€éƒ¨åˆ†æ˜¯consensus,å³åˆ©ç”¨Weight matrixå°†è¿é€šèŠ‚ç‚¹çš„ä¿¡æ¯åšä¸€ä¸ªæ²Ÿé€šï¼›å¦ä¸€éƒ¨åˆ†å°±æ˜¯ä¼ ç»Ÿçš„æ¢¯åº¦ä¸‹é™ï¼Œè¿™é‡Œçš„æ¢¯åº¦ä¸‹é™æ˜¯é’ˆå¯¹æ¯ä¸€ä¸ªlocalèŠ‚ç‚¹ã€‚è€ŒDGDæœ‰ä¸€ä¸ªæ˜¾è‘—çš„ç¼ºç‚¹ï¼šå¦‚æœDGDå½“ä¸­çš„æ­¥é•¿é€‰æ‹©å¸¸æ•°çš„è¯ï¼Œé‚£ä¹ˆä¼šå¾—åˆ°inexact convergenceï¼›è€Œå¦‚æœé€‰æ‹©é€æ¸è¶‹äºé›¶çš„æ­¥é•¿(diminishing step size)ï¼Œé‚£ä¹ˆè™½ç„¶å¯ä»¥å¾—åˆ°exact convergence, ä½†æ˜¯ä¼šé€ æˆè¾ƒæ…¢çš„æ”¶æ•›é€Ÿåº¦ï¼Œè¿™åœ¨å®é™…åº”ç”¨å½“ä¸­æ˜¯ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜ã€‚</p> <figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs matlab"><span class="hljs-comment">% DGDä»¿çœŸ</span><br><br>num_nodes = <span class="hljs-number">5</span>;  <span class="hljs-comment">% èŠ‚ç‚¹æ•°é‡</span><br><br><span class="hljs-comment">% æœ‰å‘å›¾</span><br>adjacency_matrix_dir = [ <span class="hljs-number">1</span>  <span class="hljs-number">0</span> <span class="hljs-number">-1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>;<br>                        <span class="hljs-number">-1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span> <span class="hljs-number">-1</span>;<br>                        <span class="hljs-number">-1</span> <span class="hljs-number">-1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>;<br>                         <span class="hljs-number">0</span>  <span class="hljs-number">0</span> <span class="hljs-number">-1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span>;<br>                         <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span> <span class="hljs-number">-1</span>  <span class="hljs-number">1</span>];  <br><br><span class="hljs-comment">% æ— å‘å›¾</span><br>adjacency_matrix_undir = [ <span class="hljs-number">2</span> <span class="hljs-number">-1</span> <span class="hljs-number">-1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>;<br>                          <span class="hljs-number">-1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span> <span class="hljs-number">-1</span>;<br>                          <span class="hljs-number">-1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">2</span> <span class="hljs-number">-1</span>  <span class="hljs-number">0</span>;<br>                           <span class="hljs-number">0</span>  <span class="hljs-number">0</span> <span class="hljs-number">-1</span>  <span class="hljs-number">2</span> <span class="hljs-number">-1</span>;<br>                           <span class="hljs-number">0</span> <span class="hljs-number">-1</span>  <span class="hljs-number">0</span> <span class="hljs-number">-1</span>  <span class="hljs-number">2</span>];  <br><br><br><span class="hljs-comment">% åˆå§‹åŒ–èŠ‚ç‚¹å‚æ•°å’Œæœ¬åœ°æ¢¯åº¦</span><br><span class="hljs-comment">%node_params = rand(num_nodes, 1);  % åˆå§‹å‚æ•°</span><br>node_params = [<span class="hljs-number">0.1</span> <span class="hljs-number">0.2</span> <span class="hljs-number">0.3</span> <span class="hljs-number">0.4</span> <span class="hljs-number">0.5</span>]&#x27;;<br>local_gradients = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">% è®¾ç½®å…¨å±€ç›®æ ‡å‡½æ•°ï¼ˆç¤ºä¾‹ä¸­ä¸ºç®€å•çš„å¹³æ–¹å’Œï¼‰</span><br>global_objective = @(x) sum(x.^<span class="hljs-number">2</span>);<br><br>num_iterations = <span class="hljs-number">1000</span>;<br>consensus_ratio = <span class="hljs-number">0.01</span>;<br>fixed_step_size = <span class="hljs-number">0.005</span>;<br>diminish_step_size = <span class="hljs-number">0.005</span>;<br><br><span class="hljs-comment">% åˆ›å»ºç”¨äºå­˜å‚¨å¯è§†åŒ–æ•°æ®çš„æ•°ç»„</span><br>param_history = <span class="hljs-built_in">zeros</span>(num_iterations, num_nodes);<br><br>iteration_converge = <span class="hljs-number">0</span>;<br>difference = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">for</span> iteration = <span class="hljs-number">1</span>:num_iterations<br>    <span class="hljs-keyword">for</span> node = <span class="hljs-number">1</span>:num_nodes<br>        local_gradients = <span class="hljs-number">2</span> * node_params(node);<br>        <br>        <span class="hljs-comment">% ä¸€è‡´æ€§éƒ¨åˆ†</span><br>        <span class="hljs-keyword">for</span> neighbor = <span class="hljs-number">1</span>:num_nodes<br>            <span class="hljs-keyword">if</span> adjacency_matrix_undir(node, neighbor) == <span class="hljs-number">-1</span><br>                node_params(node) = node_params(node) - consensus_ratio * (node_params(node) - node_params(neighbor));<br>            <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">end</span><br><br>        <span class="hljs-comment">% æ¢¯åº¦ä¸‹é™éƒ¨åˆ†</span><br>        diminish_step_size = <span class="hljs-number">-0.0045</span>/<span class="hljs-number">1000</span>*iteration + <span class="hljs-number">0.005</span>;<br>        node_params(node) = node_params(node) - fixed_step_size * local_gradients;<br>    <span class="hljs-keyword">end</span><br>    <br>    <span class="hljs-comment">% å­˜å‚¨å‚æ•°å†å²</span><br>    param_history(iteration, :) = node_params;<br><br>    <span class="hljs-comment">% è®°å½•æ”¶æ•›æ‰€éœ€è¿­ä»£æ¬¡æ•°</span><br>    <span class="hljs-keyword">for</span> node = <span class="hljs-number">2</span>:num_nodes<br>        difference = difference + <span class="hljs-built_in">abs</span>(node_params(<span class="hljs-number">1</span>)-node_params(node));<br>    <span class="hljs-keyword">end</span><br>    <br>    <span class="hljs-keyword">if</span>  iteration_converge == <span class="hljs-number">0</span> &amp;&amp; difference &lt; <span class="hljs-number">0.001</span><br>        iteration_converge = iteration;<br>    <span class="hljs-keyword">end</span><br>    difference = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">% è¾“å‡ºæœ€ç»ˆçš„å…¨å±€æœ€ä¼˜è§£</span><br>global_minimizer = node_params;<br>global_minimum = global_objective(global_minimizer);<br>fprintf(<span class="hljs-string">&#x27;å…¨å±€æœ€ä¼˜è§£ï¼š\n&#x27;</span>);<br>fprintf(<span class="hljs-string">&#x27;%2f\n&#x27;</span>, global_minimizer);<br>fprintf(<span class="hljs-string">&#x27;å…¨å±€æœ€å°å€¼ï¼š%f\n&#x27;</span>, global_minimum);<br>fprintf(<span class="hljs-string">&#x27;æ”¶æ•›çš„è¿­ä»£æ¬¡æ•°ï¼š%d\n&#x27;</span>, iteration_converge);<br><br><br><span class="hljs-built_in">figure</span>;<br><span class="hljs-built_in">hold</span> on;<br><span class="hljs-keyword">for</span> node = <span class="hljs-number">1</span>:num_nodes<br>    <span class="hljs-built_in">plot</span>(<span class="hljs-number">1</span>:num_iterations, param_history(:, node), <span class="hljs-string">&#x27;LineWidth&#x27;</span>, <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;DisplayName&#x27;</span>, sprintf(<span class="hljs-string">&#x27;èŠ‚ç‚¹ %d&#x27;</span>, node));<br><span class="hljs-keyword">end</span><br>xlabel(<span class="hljs-string">&#x27;è¿­ä»£æ¬¡æ•°&#x27;</span>);<br>ylabel(<span class="hljs-string">&#x27;èŠ‚ç‚¹å‚æ•°&#x27;</span>);<br>title(<span class="hljs-string">&#x27;èŠ‚ç‚¹å‚æ•°éšæ—¶é—´çš„å˜åŒ–&#x27;</span>);<br><span class="hljs-built_in">legend</span>(<span class="hljs-string">&#x27;Location&#x27;</span>, <span class="hljs-string">&#x27;Best&#x27;</span>);<br>grid on;<br><span class="hljs-built_in">hold</span> off;<br><br></code></pre></td></tr></table></figure><p>ä»¿çœŸç»“æœï¼š</p><p>è§å¼€å¤´Q3</p></li><li><p><strong>å›ºå®šæ­¥é•¿ï¼ˆfixed step-sizesï¼‰</strong></p><p><strong>EXTRA: Exact first-order algorithm</strong></p><p>ç¬¬ä¸€æ­¥ï¼š<br>$$<br>x_i(1)=\sum_{j=1}^Nw_{ij}x_j(0)-\alpha\nabla f_i(x_i(0)),<br>$$</p></li></ol><p>â€‹å…¶ä¸­$\alpha&gt;0$æ˜¯å›ºå®šæ­¥é•¿<br>â€‹</p><p>â€‹ç¬¬äºŒæ­¥ï¼š<br>$$<br>\begin{aligned}x_i(k+2)&amp;=x_i(k+1)+\sum_{j=1}^Nw_{ij}x_j(k+1)-\sum_{j=1}^N\tilde{w}_{ij}x_j(k)-\alpha\left(\nabla f_i(x_i(k+1))-\nabla f_i(x_i(k))\right),\mathrm{~}k=0,\mathrm{~}1,\ldots,\end{aligned}<br>$$<br>â€‹ç›¸è¾ƒäºDGDç®—æ³•ï¼ŒEXTRAç”¨åˆ°äº†å‰ä¸¤æ­¥çš„æ¢¯åº¦ä¿¡æ¯ï¼Œæ–‡çŒ®è¡¨æ˜ï¼Œ<strong>EXTRAå¯ä»¥çœ‹ä½œæ˜¯å…·æœ‰è¯¯å·®æ ¡æ­£é¡¹çš„DGD</strong></p><p>â€‹<strong>DIGingï¼š distributed inexact gradient method and the gradient tracking</strong></p><p>â€‹å…¬å¼å¦‚ä¸‹ï¼š<br>$$<br>x_i(k+1) =\sum_{j=1}^Nw_{ij}x_j(k)-\alpha y_i(k),<br>$$</p><p>$$<br>y_{i}(k+1) =\sum_{i=1}^Nw_{ij}y_j(k)+\nabla f_i(x_i(k+1))-\nabla f_i(x_i(k))<br>$$</p><p>â€‹<strong>Distributed PI algorithm</strong></p><p>â€‹å…¬å¼å¦‚ä¸‹ï¼š<br>$$<br>x_i(k+1)=x_i(k)-v_i(k)-\alpha\nabla f_i(x_i(k))-\beta\sum_{j\in\mathcal{N}<em>i}a</em>{ij}(x_i(k)-x_j(k)),<br>$$</p><p>$$<br>\nu_i(k+1) =v_i(k)+\alpha\beta\sum_{j\in\mathcal{N}<em>i}a</em>{ij}(x_i(k)-x_j(k))<br>$$</p><ol start="3"><li><p><strong>ä¸€é˜¶æ¢¯åº¦ç®—æ³•</strong></p><p><strong>Distributed PI algorithm</strong></p><p>å…¬å¼å¦‚ä¸‹ï¼š<br>$$<br>\dot{x}<em>i(t) =\sum</em>{j=1}^Na_{ij}(x_j(t)-x_i(t))+\sum_{j=1}^Na_{ij}(\nu_j(t)-\nu_i(t))-\nabla f_i(x_i(t)),<br>$$</p></li></ol><p>$$<br>\dot{\nu}<em>i(t) =\sum</em>{j=1}^Na_{ij}(x_i(t)-x_j(t))<br>$$</p><ol start="4"><li><p><strong>äºŒé˜¶æ¢¯åº¦ç®—æ³•</strong></p><p><strong>Zero-Gradient-Sum Algorithm</strong></p><p>å…¬å¼å¦‚ä¸‹ï¼š<br>$$<br>\dot{x}<em>i(t)=\gamma\left(\nabla^2f_i(x_i(t))\right)^{-1}\sum</em>{j\in\mathcal{N}<em>i}a</em>{ij}(x_j(t)-x_i(t))<br>$$</p></li></ol><h3 id="å››ã€æ‹“å±•åœºæ™¯ä¸­çš„åˆ†å¸ƒå¼ä¼˜åŒ–ç®—æ³•">å››ã€æ‹“å±•åœºæ™¯ä¸­çš„åˆ†å¸ƒå¼ä¼˜åŒ–ç®—æ³•</h3><ol><li><strong>æœ‰å‘å›¾</strong></li></ol><p><strong>Distributed Push-Sum Based Algorithmï¼ˆç¦»æ•£æ—¶é—´ï¼‰</strong></p><p>å¤§éƒ¨åˆ†ç°æœ‰çš„æœ‰å‘å›¾ç¦»æ•£æ—¶é—´åˆ†å¸ƒå¼ç®—æ³•éƒ½æ˜¯åŸºäºæ¨å’Œ</p><p>â€‹</p><ol start="2"><li><p><strong>æ—¶å»¶</strong></p></li><li><p><strong>éšæœºæ‹“æ‰‘</strong></p></li><li><p><strong>äº‹ä»¶è§¦å‘æœºåˆ¶</strong>ï¼ˆç²¾è¯»ï¼ï¼‰</p></li><li><p><strong>æœ‰é™æ—¶é—´æ”¶æ•›</strong></p></li></ol>]]></content>
    
    
    <categories>
      
      <category>ç§‘ç ”åªä¸ºæŠŠä¸šæ¯•</category>
      
    </categories>
    
    
    <tags>
      
      <tag>åˆ†å¸ƒå¼ä¼˜åŒ–</tag>
      
      <tag>å¤šæ™ºèƒ½ä½“æ§åˆ¶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ¸¯æ¾³æ·±å°è®°</title>
    <link href="/2023/08/11/%E6%B8%AF%E6%BE%B3%E6%B7%B1%E5%B0%8F%E8%AE%B0/"/>
    <url>/2023/08/11/%E6%B8%AF%E6%BE%B3%E6%B7%B1%E5%B0%8F%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1>DAY -1ï¼ˆ8.4ï¼Œ8.5ï¼‰ï¼šä¸ªäººåŸå› å…ˆå»äº†è¶Ÿç æµ·å’Œå¹¿å·</h1><p><strong>ç æµ·</strong>ï¼š é•¿éš†æµ·æ´‹ç‹å›½ï¼Œé—¨ç¥¨å·¨è´µï¼ˆæˆäººæ™®ç¥¨450ï¼Œå“¥ä»¬è¿™è¾ˆå­è§è¿‡çš„æœ€è´µçš„å›½å†…æ¸¸ä¹åœºï¼‰ï¼Œäººå·¨å¤šï¼ˆæ²¡æœ‰ä¸€ä¸ªæ¸¸ä¹é¡¹ç›®æ’é˜Ÿä½äº1hçš„ï¼‰ï¼Œé¡¹ç›®è¾ƒæ— èŠï¼ˆæ™®é€šæ¸¸ä¹åœºé¡¹ç›® + æµ·æ´‹ç”Ÿç‰©é¦†ï¼‰ï¼Œå”¯ä¸€ç•¥å€¼ç¥¨ä»·çš„å°±æ˜¯æ™šä¸Šå…«ç‚¹åŠçš„çƒŸèŠ±ç§€+æ— äººæœºè¡¨æ¼”ï¼Œä»Šç”Ÿä¸å¯èƒ½å†å»ç¬¬äºŒæ¬¡ï¼Œä¸è¿‡å¹¸å¥½å¦¹å¦¹ç©å¾—å¾ˆå¼€å¿ƒï¼Œé‚£ä¹Ÿè¡Œå­ã€‚</p><p><img src="https://s2.loli.net/2023/08/19/INDUbPTQw5xCKtE.jpg" alt="å¼€å¿ƒçš„å¦¹å¦¹å’Œè›‹ä»”æ´¾å¯¹å°é»‘è›‹~"></p><p>å¦å¤–å°è±¡æ·±åˆ»çš„æ˜¯å°å§¨å¤«å’Œä»–çš„èµ„æ·±é’“é±¼å‹è‡ªåˆ¶çš„è±ªåç”Ÿé±¼ç‰‡åˆºèº«ï¼Œè™½ç„¶å±±çŒªåƒä¸æ¥ç»†ç³ ï¼Œå‘³é“ä¸æ•¢æ­ç»´ï¼Œä½†ç¡®å®ç¬¦åˆæˆ‘å¯¹è€å¹¿æ·±å¤œå¤§æ’æ¡£çš„æƒ³è±¡ã€‚</p><p><img src="https://s2.loli.net/2023/08/19/TF46A2L9w8oJRmv.jpg" alt=""></p><p><strong>å¹¿å·ï¼š</strong> å»äº†å‰å¾®ä¿¡å›­åŒºæ€»éƒ¨ï¼ˆä¸€ä¸ªéå¸¸ä¸èµ·çœ¼çš„å·¥ä¸šå›­åŒºï¼Œç°å·²æ¬è¿è‡³ç¶æ´²æ–°å¤§æ¥¼ï¼‰å’Œå¹¿å·å¡”ï¼Œä¹å–„å¯é™ˆï¼Œä¸­è§„ä¸­çŸ©ï¼Œæ™šé¥­ç²¤èœé¦†å­çš„ç™½æ–©é¸¡ä¸é”™</p><p><strong>ç æµ·å¹¿å·æ•´ä½“è¯„ä»·</strong>ï¼š â­â­â­</p><h1>DAY0ï¼ˆ8.6ï¼‰ï¼šæ·±åœ³è½è„š</h1><p>ç¬¬ä¸€ç«™æ˜¯æ·±åœ³å¤§å­¦åŸ â€”â€” åŒæ—¶æ±‡èšæ¸…åæ·±åœ³ç ”ç©¶é™¢ã€åŒ—å¤§æ·±åœ³ç ”ç©¶é™¢ã€å“ˆå·¥æ·±ä¸‰æ‰€åæ ¡ï¼Œé˜µå®¹è±ªåï¼Œä½†æ›´è±ªåçš„æ˜¯æ ¡å›­ç¯å¢ƒï¼šè“å¾—é€å½»å¾—å¦‚åŠ¨æ¼«ä¸€èˆ¬çš„å¤©ç©ºã€å¶æœ‰æ¤°æ ‘çŸ—ç«‹åœ¨è·¯è¾¹ã€é£æ ¼ç°ä»£åŒ–çš„ç²¾è‡´æ•™å­¦å¤§æ¥¼ï¼Œé“è·¯å®½æ•ã€æ ¡å›­æ•´æ´ã€æ— ä¸€å®¶åç§‘ç»æœ›å¡è·¯è¾¹å°åº—ä¹‹ç±»çš„å•†å®¶ï¼Œåƒæäº†youtubeé‡Œè§åˆ°çš„ç¾å›½å¤§å­¦æ™¯è±¡ã€‚å¹³å¿ƒè€Œè®ºï¼Œæ¥è¿™å„¿ä¹‹å‰ï¼Œæˆ‘äº•åº•ä¹‹è›™åœ°è®¤ä¸ºå…¨å¤§é™†çš„é«˜æ ¡éƒ½å’Œåç§‘æ­¦å¤§ä¹‹æµå¤§å·®ä¸å·®ï¼Œä»æœªè®¾æƒ³å›½å†…æ ¡å›­ä¹Ÿèƒ½æœ‰å¦‚æ­¤ç²¾è‡´ä¼˜é›…ä¹‹æ™¯ã€‚</p><p><img src="https://s2.loli.net/2023/08/19/8FACdUKZRfwemoP.jpg" alt=""></p><p><img src="https://s2.loli.net/2023/08/19/ZKUDzVB4pRIvA68.jpg" alt=""></p><p><img src="https://s2.loli.net/2023/08/19/zWHuGy9Mwn4Ooms.jpg" alt="åŒ—å¤§æ±‡ä¸°å•†å­¦é™¢"></p><p><img src="https://s2.loli.net/2023/08/19/mpECJqxtPMKQh4s.jpg" alt=""></p><p><img src="https://s2.loli.net/2023/08/19/lTi9c2woW1eg8ma.jpg" alt=""></p><p><img src="https://s2.loli.net/2023/08/19/nboUWrmgdtBGYIw.jpg" alt=""></p><p>è¿™æ˜¯æ±‡ä¸°å•†å­¦é™¢çš„æ•™å¸ˆå¢™ï¼Œè¿˜æœ‰é¸£äººæ•™æˆå’ŒæŸ¯å—æ•™æˆhhï¼Œæ”¾åœ¨åç§‘è‡ªåŠ¨åŒ–ç»å¯¹æ˜¯å¤§é€†ä¸é“è¡Œä¸ºï¼Œå¯èƒ½è¿™å’ŒåŒ—å¤§çš„ã€æ·±åœ³çš„ã€å¹¿ä¸œçš„è‡ªç”±åŒ…å®¹è€Œå‘è¾¾çš„æ°”æ¯æ˜¯ç›¸é€šçš„å§ï¼Œæˆ‘çˆ±åŒ—å¤§ã€‚</p><p>æ•´ä½“è¯„ä»·ï¼šâ­â­â­â­â­</p><h1>DAY1ï¼ˆ8.7ï¼‰ï¼šhkä¸­å¿ƒè€è¡—åŒº + ç»´å¤šåˆ©äºšæ¸¯</h1><p>æ—©ä¸Š8ç‚¹ç»æ·±åœ³ç¦ç”°å£å²¸è¿‡å…³ï¼Œ40minåœ°é“åˆ°è¾¾ç¬¬ä¸€ç«™ï¼šæ—ºè§’åæ˜Ÿå†°å®¤ã€‚</p><p>ä¸Šæ¥ä¾¿æ˜¯ä¸€è®°ä¸‹é©¬å¨ï¼Œ40æ¥å²çš„ä¸­å¹´è€æ¿å¨˜çº¦è«æ˜¯æ¥å¾…è¿‡æ— æ•°å¤§é™†æ¸¸å®¢äº†ï¼Œåœ¨ç¬¬ä¸€å¥â€œä½ å“‹é£Ÿä¹œå•Šï¼Ÿâ€è€Œæˆ‘ä»¬æ¯«æ— ååº”åï¼Œç¬é—´ç”±çƒ­æƒ…æ‹›å¾…çŠ¶æ€åˆ‡æ¢ä¸ºä¾‹è¡Œå…¬äº‹çŠ¶æ€ï¼Œä¸‰ä¸‹äº”é™¤äºŒ<strong>æŠ¢ç€</strong>å¸®æˆ‘ä»¬ç‚¹äº†é”€é‡æœ€é«˜çš„ã€40$ä¸€ä»½çš„â€œå…¬ä»”é¢å¥—é¤â€ï¼Œå‘ˆä¸Šæ¥ä¸€è¡Œäº”äººç›´æ¥å‚»çœ¼ï¼Œæ¥hkå°±ç»™å“¥ä»¬åƒæ–¹ä¾¿é¢æ˜¯å§ğŸ˜¡ğŸ˜¡</p><p><img src="https://s2.loli.net/2023/08/19/faSwFpkQNBUxq7C.png" alt="å¦‚ä¸Šå›¾ï¼Œå½“ç„¶ï¼Œæ²¡æœ‰é¸¡ç¿…"></p><p>æ¥ä¸‹æ¥å‡ å¤©ï¼Œæˆ‘ä»¬ä¾¿ä»¥â€œä¸€é¢â€ä½œä¸ºä»·æ ¼è®¡é‡å•ä½ï¼Œè­¬å¦‚711ä¸€ç“¶çŸ¿æ³‰æ°´æ˜¯1/4é¢ï¼Œåœ¨æ½®æ±•åƒäº†äººå‡2.5é¢çš„ç‰›è‚‰ã€‚</p><p>åç»­ä¸€è·¯ç»å…¸è·¯çº¿æ‰«è¡—ï¼Œäºšçš†è€è¡— â€“ é’µå…°è¡—ï¼ˆæ‰çŸ¥é“è¿™ä¸ªå¤æƒ‘ä»”åœ£åœ°æ˜¯Portland streetçš„éŸ³è¯‘ï¼‰-- æ²¹éº»åœ° â€“ å°–æ²™å’€</p><p><img src="https://s2.loli.net/2023/08/19/S9emHv7xycCPMiN.jpg" alt=""></p><p><img src="https://s2.loli.net/2023/08/19/vlLqJHtVrWpF276.jpg" alt=""></p><p><img src="https://s2.loli.net/2023/08/19/wTiupgIJmhx1oPF.jpg" alt="å¤¹ä¸ªç§è´§ï¼Œbang bang bangï¼"></p><p>ä¸­é€”å°è±¡è¾ƒæ·±ä¹‹äº‹æ˜¯å°çº¢ä¹¦æ¨èçš„â€œæ¾³æ´²ç‰›å¥¶å…¬å¸â€é¡¾å®¢çˆ†æ»¡ï¼Œäºæ˜¯å¦å¯»æ—è¾¹ä¸€å®¶ç³–æ°´é“ºï¼Œè€æ¿å¨˜åŒæ ·æ˜¯å››äº”åæ¥å²çš„ä¸ä¼šæ™®é€šè¯çš„hkå¤§å¦ˆä¸€æšé¸­~ï¼Œæ¯”å†°å®¤è€æ¿å¨˜æ›´ç¦»è°±çš„æ˜¯å¥¹ä¼¼ä¹çœŸçš„å®Œå…¨ä¸ä¼šæ™®é€šè¯ï¼ˆç”šè‡³å¬ä¸æ‡‚ï¼‰ï¼Œç´¢æ€§æ”¾å¼ƒï¼Œç›´æ¥è‹±è¯­äº¤æµï¼Œå¹¸å¥½äººå®¶â€œpay the billâ€è¿˜æ˜¯å¬å¾—æ‡‚ã€‚</p><p>ä¸‹åˆåå¤©æ˜Ÿå°è½®è¿‡æµ·å»äº†é¦™æ¸¯å—ï¼Œå’ŒåŒ—éƒ¨ç»å…¸è¡—åŒºçœŸçš„å¤©å·®åœ°åˆ«ä¸¤ç§æ™¯è±¡ï¼šé“ºå¤©ç›–åœ°çš„æ‘©å¤©å¤§å¦ã€å…‰æ»‘åå…‰çš„å¤§æ¥¼è½åœ°å¤–çª—ã€é¢ç§¯å ªæ¯”å­¦æ ¡é£Ÿå ‚çš„diorã€gucciå¥¢ä¾ˆå“ç‹¬ç«‹ä¸“å–åº—ã€æ•°ä¸æ¸…çš„é‡‘èè¯åˆ¸å…¬å¸ã€æ¥æ¥å¾€å¾€çš„æ¸…ä¸€è‰²è¡¬è¡«è¥¿è£¤çš®é‹é‡‘èç”·å’ŒåŠè£™å¹³åº•å•é‹é‡‘èå¥³ï¼Œä¸Šä¸€æ¬¡è§åˆ°è¿™æ ·çš„æ™¯è±¡è¿˜æ˜¯æœ‹å‹åœˆå‘çš„æ´›æ‰çŸ¶è¥¿æµ·å²¸å¤§éƒ½å¸‚ï¼Œhkè¿™ç•ªå›½é™…å¤§éƒ½å¸‚æ™¯è±¡çœŸçš„åœ¨å›½å†…å…¶å®ƒä»»ä½•ä¸€ä¸ªåœ°æ–¹éƒ½è§ä¸ç€ï¼Œç¹è£ã€å¹²å‡€ã€ç°ä»£ã€è“å¤©ï¼Œåˆå……æ»¡å‹è¿«ã€ç„¦è™‘ã€ç²¾è‹±å’Œæ¶ˆè´¹ï¼ŒåŒ—äº¬ä¸Šæµ·æ·±åœ³éƒ½æ²¡è¿™ç•ªæ„Ÿè§‰ã€‚</p><p><img src="https://s2.loli.net/2023/08/19/YRmVJTdfneMyxoL.jpg" alt=""></p><p><img src="https://s2.loli.net/2023/08/19/SyoZvdMX3J9Uctz.jpg" alt=""></p><p><img src="https://s2.loli.net/2023/08/19/hERTU6Yf9qBD85l.jpg" alt=""></p><p><img src="https://s2.loli.net/2023/08/19/CkrtziGwmExBXen.jpg" alt=""></p><p><img src="https://s2.loli.net/2023/08/19/EjnoSuYgQO3fV1y.jpg" alt=""></p><p>æ™šä¸Šç»å…¸ç»´å¤šåˆ©äºšæ¸¯ + æ˜Ÿå…‰å¤§é“ï¼Œè¿™å€’æ˜¯ä¸­è§„ä¸­çŸ©çš„å¤œæ™šæµ·å²¸åŸå¸‚æ™¯è±¡ï¼Œå¹¶æ²¡æœ‰æ¯”æ­¦æ±‰æ±Ÿæ»©æ›´å¥½çœ‹ï¼›åè€Œç»™æˆ‘å°è±¡æ›´æ·±çš„æ˜¯K11å•†åœºé‡Œä¼—å¤šé—®æ‰€æœªé—»çš„è½»å¥¢é‡å¥¢åº—å’Œæ¥æ¥å¾€å¾€çš„è¥¿è£…é‡‘èç”·å¥³ï¼Œéå¸¸ä¹‹internationalå“ˆ</p><p><img src="https://s2.loli.net/2023/08/19/L5Bym4XFjzuMbro.jpg" alt=""></p><h1>DAY2ï¼ˆ8.8ï¼‰ï¼šä¸­ç¯ä¸Šç¯CBD + é¦™æ¸¯å¤§å­¦</h1><p>ä¸Šåˆè¥¿ä¹æ–‡åŒ–åŒº+ä¸­ç¯ä¸Šç¯é‡‘èåŒºCBD â€”â€” æ¸…ä¸€è‰²çš„è¯åˆ¸é“¶è¡Œè´¸æ˜“å†™å­—å¤§æ¥¼ï¼Œä»¥åŠä»·å€¼ä¸¤é¢çš„ä¸€ç¢—å‰é‡å®¶ç›–é¥­</p><p><img src="D:/files-qlh/photography_qlh/hk%E6%97%85%E8%A1%8C/jpg/IMG_20230807_153424.jpg" alt=""></p><p><img src="https://s2.loli.net/2023/08/19/9KMi5yZxJ6ThPEA.jpg" alt=""></p><p><img src="https://s2.loli.net/2023/08/19/am5odq64MD39uYA.jpg" alt=""></p><p>ä¸‹åˆçš„æ¸¯å¤§ä¹‹è¡Œå€’æ˜¯å°è±¡æ·±åˆ» â€”â€” é¦–å…ˆï¼Œæ¸¯å¤§åœ°é“ç«™ç›´é€šæ•™å­¦æ¥¼äºŒæ¥¼ï¼Œå‡ºé—¨å°±æ˜¯äººå®¶çš„å®éªŒå®¤è¿™ä»¶äº‹å°±ä»¤æˆ‘éš¾ä»¥ç½®ä¿¡ï¼Œå¥½çš„å¤§å­¦çœŸæ²¡æœ‰å›´å¢™ï¼Œä¹Ÿä¸çŸ¥é“æŸäº›æ­¦æ±‰çå–»è·¯é«˜æ ¡å›´æˆä¸ªç›‘ç‹±å›¾å•¥ï¼Œæ€•æ¸¸å®¢æŠŠä½ å®éªŒå®¤é‚£ç‚¹bæŠ€æœ¯å·äº†å»æ‹¿è¯ºå¥–æ˜¯å§ğŸ˜ªå¦å¤–ï¼Œæ¸¯å¤§å»ºç­‘é£æ ¼ä¹Ÿå’ŒæŸæ ¡æ–¹æ–¹æ­£æ­£çš„å¹³å¤´æˆ¿å¤§ä¸ºè¿¥ä¹ â€”â€” å¤è€ã€ä¼˜é›…ã€ç´§è‡´è€Œåˆé™è°§ï¼Œæ¥ç”Ÿè¦åšæ¸¯å¤§äººğŸ˜­</p><p><img src="https://s2.loli.net/2023/08/19/S6iQeHjg3Mhw42V.jpg" alt=""></p><p><img src="https://s2.loli.net/2023/08/19/eOos8wEu2pH1YqM.jpg" alt=""></p><p><img src="https://s2.loli.net/2023/08/19/yRb3mJ8Ks6YGxVo.jpg" alt=""></p><p>åŸè®¡åˆ’çš„å¤ªå¹³å±±é¡¶å€’æ˜¯æ²¡å»ï¼Œäººå¤ªå¤šï¼Œäºæ˜¯åœ¨ä¸€æ—çš„é¦™æ¸¯å…¬å›­é‡Œè½¬äº†è½¬ï¼ŒçœŸç¾å•Šï¼Œå†å¤šçœ‹ä¸€çœ¼å§ã€‚</p><p><img src="https://s2.loli.net/2023/08/19/ZrG7xjl9RsmTcW3.jpg" alt=""></p><p><img src="https://s2.loli.net/2023/08/19/rNj8cUB1WxAmZ2E.jpg" alt=""></p><p><img src="https://s2.loli.net/2023/08/19/InjPzaMHcCWYrbs.jpg" alt=""></p><p><img src="https://s2.loli.net/2023/08/19/pYinoWBr18TZuE4.jpg" alt="å¥½åƒGTA5é‡Œçš„åœ£è«å¦®å¡æµ·æ»©å•Š"></p><p>hkæ•´ä½“è¯„ä»·ï¼šâ­â­â­â­â­</p><h1>DAY3ï¼ˆ8.9ï¼‰ï¼šæ¾³é—¨ä¸€æ—¥æ¸¸</h1><p>æ—©ä¸Šæ·±åœ³æœºåœºç å¤´ â€”â€” ç æµ·æ¨ªç´ç å¤´ï¼Œæ¨ªç´å£å²¸è¿‡å…³ï¼Œ11ç‚¹åˆ°æ¾³é—¨</p><p>æ¾³é—¨ç›¸å¯¹æ¥è¯´æ²¡é‚£ä¹ˆå¤¸å¼ ï¼Œå’ŒçœŸæ­£çš„metropolitan hkæ¯”èµ·æ¥ï¼Œæ›´åƒæ˜¯ä¸€ä¸ªé£æ ¼ç›¸å½“ç‹¬ç‰¹çš„å›½å†…æ—…è¡Œåº¦å‡æ‘ï¼šæ™®é€šè¯æ›´æ™®åŠã€å¯¹æ¸¸å®¢æ›´çƒ­æƒ…å‹å¥½ã€æ™¯ç‚¹èµ„æºæ›´ä¸°å¯Œï¼›å½“ç„¶ï¼Œä¹Ÿè¿˜æ˜¯æœ‰è¯¸å¤šå¤§é™†è§ä¸åˆ°çš„æ™¯è±¡ï¼ŒèµŒåœºè èœä¸šã€å‡ä»·3000ä¸€æ™šçš„é…’åº—ã€å†…é™†ä¸æ•¢æƒ³è±¡çš„ç¦åˆ©å¾…é‡ã€‚ã€‚</p><p><img src="https://s2.loli.net/2023/08/19/OcHVinJUa3jQFXo.jpg" alt="å·´é»äººä»¿åˆ¶å·´é»é“å¡”"></p><p><img src="https://s2.loli.net/2023/08/19/LuxtOQ6mnHSaCXI.jpg" alt=""></p><p><img src="https://s2.loli.net/2023/08/19/PtiErDU3LTyoHRW.jpg" alt="è‘—åå®˜ä¹Ÿè¡—"></p><p><img src="https://s2.loli.net/2023/08/19/jzuQ3J4TxhCvPcr.jpg" alt=""></p><p><img src="https://s2.loli.net/2023/08/19/DVHly9K6YBL1qcw.jpg" alt="æ°¸åˆ©çš‡å®«"></p><p>æœ€æœ‰æ„æ€å½“ç„¶æ˜¯æ–°è‘¡äº¬å•¦ï¼éå¸¸é¢ è¦†æˆ‘å¯¹èµŒåœºçš„åˆ»æ¿å°è±¡ï¼Œä»€ä¹ˆç¾å¥³è·å®˜åœ¨çº¿å‘ç‰Œæ ¹æœ¬è§ä¸ç€ï¼ˆå½“ç„¶ä¹Ÿå¯èƒ½åªæ˜¯æˆ‘è§ä¸ç€ï¼‰ï¼äº‹å®ä¸Šæ¾³é—¨çš„è èœä¸šéå¸¸ä¹‹æ­£è§„ï¼Œæ¯å±‚æ¥¼è¶³çƒåœºå¤§å°çš„åœºåœ°ä¸Šï¼Œæ‘†äº†æ— æ•°å¼ ç¯å½¢èµŒæ¡Œï¼Œè·å®˜ååœ¨ä¸­é—´å½“åº„å®¶ï¼Œå®¢äººå›´ç€ä»–ä¸ä¹‹å¯¹èµŒï¼Œä»€ä¹ˆæ¸¸æˆéƒ½æœ‰ï¼Œ21ç‚¹ã€å¹¸è¿6ã€æ‘‡éª°å­ã€‚ã€‚è·å®˜æ¸…ä¸€è‰²æ­£å¼å·¥ä½œæœï¼Œå¤§å¤š50å·¦å³å¤§å”å¤§å¦ˆï¼Œå¸¦ä¸ªå£ç½©ï¼Œé¢æ— è¡¨æƒ…ï¼Œå°±æ˜¯ä¸ªæ— æƒ…çš„å‘ç‰Œæœºå™¨ã€‚ä¼¼ä¹è·å®˜åªæ˜¯ä¸Šç­ä¸‹ç­æ‹¿æ­»å·¥èµ„çš„æ‰“å·¥äººï¼Œè¾“èµ¢è·Ÿä»–ä»¬æ²¡ä»»ä½•å…³ç³»ã€‚</p><p>æ­¤å¤–å„ç±»ç»†èŠ‚ä¸å¤§é™†æ‰€ä¸èƒ½è§ä¹‹æœ‰è¶£æ™¯è±¡éå¸¸å¤šï¼Œè¯»è€…è¯¸å›æœ‰æœºä¼šåŠ¡å¿…äº²èº«ä½“ä¼šã€‚</p><p>æ¾³é—¨è¯„ä»·ï¼šâ­â­â­â­</p><h1>DAY4ï¼ˆ8.10ï¼‰ï¼šæ½®æ±•åŠæ—¥æ¸¸</h1><p>ç›®çš„ååˆ†å•çº¯ï¼Œä½“éªŒä¼ è¯´ä¸­æ­£å®—çš„æ½®æ±•ç‰›è‚‰ã€‚</p><p>ç‰›è‚‰åƒäº†ï¼Œå„ç±»è‚¥ç‰›é›ªèŠ±åŒ™ä»é»„å–‰ä¸‰å®åƒåˆ°æ’‘äººå‡æ‰2.5é¢ï¼Œè¾ƒä¹‹æ³›æ‚¦åŸåŠ¨è¾„ä¸Šåƒçš„æ½®æ±•ç‰›è‚‰ç«é”…åº”å½“è¯´æ€§ä»·æ¯”éå¸¸é«˜ã€‚</p><p>ä½†æ˜¯ï¼Œå’Œç‰›è‚‰ç›¸æ¯”ï¼Œæ½®æ±•ç»™æˆ‘å°è±¡æœ€æ·±çš„è¿˜æ˜¯å½“æ—¥åˆšå‡ºé…’åº—ï¼Œå°±ç‹‚é£å¤§ä½œï¼Œæš´é›¨éª¤èµ·ï¼Œé›·é¸£é—ªç”µï¼Œå¤©ç¿»åœ°è¦†ã€‚æ½®æ±•çš„æš´é›¨å’Œæ­¦æ±‰çš„æš´é›¨æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ­¦æ±‰çš„é›¨å†å‡¶çŒ›éƒ½æ˜¯åœ¨ç›´ä¸Šç›´ä¸‹çš„æ–¹å‘åŠ å¤§æ°´æµé‡ï¼Œæ˜¯æœ‰è¿¹å¯å¾ªã€æœ‰åŠæ³•é˜²å¾—ä½çš„ï¼Œå¤§æ¦‚å°±åƒä¸€ä¸ªçŸ¥ä¹¦è¾¾ç†çš„å¯¼å¸ˆå¯¹ä½ çš„åƒåœ¾è®ºæ–‡è¾“å‡ºï¼Œè™½ç„¶æ˜¯éª‚ï¼Œä½†ä¹Ÿæ˜¯æœ‰é€»è¾‘ã€è®²ç« æ³•åœ°éª‚ï¼›è€Œæ½®æ±•çš„é›¨æ˜¯ä¸è®²ä»»ä½•è§„å¾‹çš„ï¼Œç“¢ç›†å¤§é›¨åœ¨ç‹‚ä¹±å¤§é£çš„åŠ æŒä¸‹ï¼Œå¿½å·¦å¿½å³ï¼Œå‰åå¤¹å‡»ï¼Œä¸€æŠŠé›¨ä¼ä¸å¯èƒ½é˜²å¾—ä½ï¼Œä¸€åˆ†é’Ÿä¹‹å†…å¿…æ¹¿èº«è¯±æƒ‘ï¼Œè¿™å¤§æ¦‚å°±åƒæˆ‘å¦ˆå‘è„¾æ°”ï¼Œä½ è¦æ˜¯æƒ³è¯•å›¾ä»é€»è¾‘å±‚é¢æ‰¾å‡ºæ¼æ´ç„¶ååå‡»é‚£æ˜¯ä¸å¯èƒ½çš„ â€”â€” åªè¦å¤„å¤„æ˜¯æ¼æ´ï¼Œé‚£å°±æ²¡æœ‰æ¼æ´ã€‚ä¸è¿‡è¯è¯´å›æ¥ï¼Œä½“éªŒä¸€åœºæ­¦æ±‰ä»æœªè§è¿‡çš„å¤§é›¨ã€å“ªæ€•æµ‘èº«è¢«æ·‹é€ä¹Ÿæ˜¯æœ‰æ„æ€çš„äº‹ï¼Œæƒ³æ¥è¿™å°±æ˜¯æ—…è¡Œçš„æ„ä¹‰å§ã€‚</p><p><img src="https://s2.loli.net/2023/08/19/xwCPT82uorFV5Q9.png" alt=""></p><p>æ½®æ±•è¯„ä»·ï¼šâ­â­â­</p>]]></content>
    
    
    <categories>
      
      <category>å¶å°”ä¹Ÿå¾—æ‘¸æ‘¸é±¼</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é¦™æ¸¯</tag>
      
      <tag>æ¾³é—¨</tag>
      
      <tag>æ—…æ¸¸</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>event-triggeredç³»åˆ—è®ºæ–‡å­¦ä¹ </title>
    <link href="/2023/07/20/event_triggered/"/>
    <url>/2023/07/20/event_triggered/</url>
    
    <content type="html"><![CDATA[<h1>Paper 1ï¼šEvent-Triggered Real-Time Scheduling of Stabilizing Control Tasks, 2007, TAC</h1><h3 id="ä¸€ã€motivation">ä¸€ã€motivation</h3><p>â€‹ä¼ ç»Ÿçš„å›ºå®šæ—¶é—´å‘¨æœŸçš„é‡‡æ ·æ–¹å¼ç¼ºä¹ä¸¥æ ¼é‡åŒ–è¯æ˜ï¼ˆæ—¶é—´å‘¨æœŸä¸ºå¤šå°‘åˆé€‚ï¼Ÿå°‘äº†ä¸å‡†ç¡®ï¼Œå¤šäº†æµªè´¹èµ„æºï¼‰ï¼Œè€Œåœ¨å¾®å‹å¤„ç†å™¨ä¸Šåˆå¸Œæœ›èƒ½å°½å¯èƒ½èŠ‚çº¦è®¡ç®—èµ„æºï¼Œæ‰€ä»¥è€ƒè™‘å°†å‘¨æœŸé‡‡æ ·è½¬æ¢ä¸ºéå‘¨æœŸé‡‡æ ·ï¼Œ<strong>é‡‡æ ·æ—¶é—´ç”±æŸä¸ªâ€œäº‹ä»¶â€æ¥è§¦å‘</strong>ã€‚</p><h3 id="äºŒã€é¢„å¤‡çŸ¥è¯†">äºŒã€é¢„å¤‡çŸ¥è¯†</h3><ol><li><strong>$k$ç±»å‡½æ•°ã€$k_\infty$ç±»å‡½æ•°</strong></li></ol><p>â€‹å¦‚æœè¿ç»­å‡½æ•°$\alpha:[0,a) \rightarrow [0,\infty)$ä¸¥æ ¼é€’å¢ï¼Œä¸”$\alpha(0)=0$ï¼Œåˆ™$\alpha$å±äº$k$ç±»å‡½æ•°ï¼›æ›´è¿›ä¸€æ­¥åœ°ï¼Œå¦‚æœ$a=\infty$ï¼Œå½“$r\rightarrow \infty$æ—¶ï¼Œ$\alphaÂ®\rightarrow\infty$ï¼Œé‚£ä¹ˆ$\alpha$å±äº$k_\infty$ç±»å‡½æ•°</p><ol start="2"><li><p><strong>é—®é¢˜æè¿°</strong></p><p>æ§åˆ¶ç³»ç»Ÿï¼š$\dot x=f(x,u)$</p><p>åé¦ˆæ§åˆ¶ï¼š$u=k(x)$</p><p>æ’å®šæ§åˆ¶ï¼š$t\in[t_i+\Delta,t_{i+1}+\Delta]\Longrightarrow u(t)=u(t_i+\Delta)$ï¼ˆÎ”æ˜¯ç°å®ä¸­çš„é¢å¤–è€—æ—¶ï¼ŒIOè¯»å–ã€è®¡ç®—è€—æ—¶ä¹‹ç±»çš„ï¼‰</p><p>æµ‹é‡è¯¯å·®ï¼š$t\in[t_i+\Delta,t_{i+1}+\Delta]\Longrightarrow e(t)=x(t_i)-x(t)$</p></li><li><p><strong>ISS Lyapunovå‡½æ•°</strong></p><p><img src="https://s2.loli.net/2023/07/20/S6gNBRb1uwmIx2j.png" alt=""></p><p>å…¶ä¸­$\underline\alpha,\alpha,\overline\alpha,\gamma$éƒ½æ˜¯$k_\infty$ç±»å‡½æ•°</p></li></ol><h3 id="ä¸‰ã€event-triggered-æœºåˆ¶">ä¸‰ã€event-triggered æœºåˆ¶</h3><ol><li><p>å¦‚æœæˆ‘ä»¬è®¾ç½®æœ‰å…³è¯¯å·®çš„çº¦æŸæ¡ä»¶ä¸ºï¼š<br>$$<br>\gamma(|e|)\leq\sigma\alpha(|x|),\quad\sigma&gt;0\quad\quad(8)<br>$$<br>å°†å…¶ä»£å…¥å…¬å¼ (5) å¯å¾—ï¼š<br>$$<br>\frac{\partial V}{\partial x}f(x,k(x+e))\leq(\sigma-1)\alpha(|x|)<br>$$<br>é‚£ä¹ˆæ­¤æ—¶æˆ‘ä»¬åªéœ€è¦è®©$\sigma&lt;1$å°±å¯ä¿è¯Lyapunovå‡½æ•° V æ˜¯é€’å‡çš„ã€‚å› æ­¤ï¼Œ<strong>æˆ‘ä»¬å¯ä»¥å°†äº‹ä»¶è§¦å‘è§„åˆ™è®¾ç½®ä¸ºä¸‹å¼ï¼š</strong><br>$$<br>\gamma(|e|)=\sigma\alpha(|x|)\quad\quad(9)<br>$$</p></li><li><p>åœ¨è®¾ç½®å¥½è§¦å‘è§„åˆ™ä¹‹åï¼Œä¸€ä¸ªç›¸åº”çš„é—®é¢˜æ˜¯ï¼šè§¦å‘æ—¶é—´ç”± (9) éšå¼å®šä¹‰ï¼Œé‚£å¦‚ä½•ä¿è¯ä¸¤æ¬¡è§¦å‘æ—¶é—´ä¸ä¼šæ— é™æ¥è¿‘ï¼Œä»è€Œé€ æˆèŠè¯ºè¡Œä¸ºå‘¢ï¼Ÿ</p><p>åŸæ–‡é€šè¿‡Lipschitzæ¡ä»¶è¯æ˜äº†åªè¦æ—¶å»¶Î”è¶³å¤Ÿå°ï¼Œåˆ™æœ€å°æ‰§è¡Œé—´éš”æ—¶é—´å­˜åœ¨ï¼Œ<strong>ä¹Ÿå°±ä¿è¯äº†$t_i-t_{i+1}$çš„ä¸‹ç•Œï¼Œå³$t_i-t_{i+1}\ge\tau,\tau\in\mathbb{R}^{+}$</strong></p><p>å…·ä½“è¯æ˜è¿‡ç¨‹ç•¥</p><p><img src="https://s2.loli.net/2023/07/20/5dLwEYT3qFBMvit.png" alt=""></p></li><li><p><strong>ä»¿çœŸä»£ç </strong><br>$$<br>\left[\begin{matrix}\dot{x}_1\\<br>\dot{x}_2\end{matrix}\right]=\left[\begin{matrix}0&amp;1\\<br>-2&amp;3\end{matrix}\right]\left[\begin{matrix}x_1\\<br>x_2\end{matrix}\right]+\left[\begin{matrix}0\\<br>1\end{matrix}\right]u<br>$$</p><p>$$<br>V=x^TPx<br>$$</p><p>$$<br>\begin{aligned}\partial V/\partial x(Ax+BKx)=-x^{T}Qx\end{aligned}<br>$$</p><p>$$<br>P=\left[\begin{array}{cc}1&amp;\frac{1}{4}\\<br>\frac{1}{4}&amp;1\end{array}\right],\quad Q=\left[\begin{array}{cc}\frac{1}{2}&amp;\frac{1}{4}\\<br>\frac{1}{4}&amp;\frac{3}{2}\end{array}\right]<br>$$</p><p>æŠŠæµ‹é‡è¯¯å·®å¸¦å…¥è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬æœ‰ï¼š<br>$$<br>\frac{\partial V}{\partial x}\Big(Ax+BKx+BKe\Big)\leq-a|x|^2+b|e|x|<br>$$<br>å…¶ä¸­<br>$$<br>a=\lambda_m(Q)&gt;0.44\quad b=|K^TB^TP+PBK|=8<br>$$<br>$\lambda_m(Q)$è¡¨ç¤º Q çš„æœ€å°ç‰¹å¾å€¼ï¼Œ$\sigma b$åº”æ¯”0.44æ›´å°ï¼Œç®—å‡ºæ¥$\sigma$çš„ä¸Šç•Œçº¦ä¸º0.05ï¼Œæˆ‘ä»¬å¯ä»¥å–$\sigmaâ€™=0.03$</p> <figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs matlab"><span class="hljs-comment">% Tabuada, P. (2007). </span><br><span class="hljs-comment">% Event-triggered real-time scheduling of stabilizing control tasks.</span><br><span class="hljs-comment">% IEEE Transactions on Automatic Control,52(9), 1680-1685.</span><br><br><br>clc;        <br>clear;      <br>close all;<br><br><span class="hljs-comment">%% system define</span><br>A = [<span class="hljs-number">0</span> <span class="hljs-number">1</span>; <span class="hljs-number">-2</span> <span class="hljs-number">3</span>];<br>B = [<span class="hljs-number">0</span>; <span class="hljs-number">1</span>];<br>K = [<span class="hljs-number">1</span> <span class="hljs-number">-4</span>];<br>P = [<span class="hljs-number">1</span> <span class="hljs-number">0.25</span>; <span class="hljs-number">0.25</span> <span class="hljs-number">1</span> ];<br>Q = [<span class="hljs-number">0.5</span> <span class="hljs-number">0.25</span>; <span class="hljs-number">0.25</span> <span class="hljs-number">1.5</span>];<br>x0 = [<span class="hljs-number">0.5</span> <span class="hljs-number">0.5</span>]&#x27;;<br>dt = <span class="hljs-number">0.001</span>;<br>trigger_count = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">% sigmaæ˜¯ä¸Šç•Œï¼Œsigma_primeåº”å°äºsigma</span><br><span class="hljs-comment">% åŸè®ºæ–‡ä¸­æœ‰è§£é‡Š</span><br>sigma_prime = <span class="hljs-number">0.03</span>;<br>sigma = <span class="hljs-number">0.05</span>;<br><br><span class="hljs-comment">%% simulation</span><br>x_buffer = [];<br>u_buffer = [];<br>error_buffer = [];<br>error_trigger = [];<br>error_upper_bound = [];<br><br>x = x0;         <br>u = K*x0;    <br>syms s<br><br><span class="hljs-comment">% å®šå¸¸è¿ç»­ç³»ç»Ÿæ–¹ç¨‹çš„ç¦»æ•£åŒ–</span><br><span class="hljs-comment">% å…·ä½“è®¡ç®—åŸç†å¯å‚è€ƒhttps://zhuanlan.zhihu.com/p/556915351çš„2.2èŠ‚</span><br>Ad = expm(A*dt);<br>Bd = int(expm(A*s),<span class="hljs-number">0</span>,dt)*B;<br>Bd = eval(Bd);<br><br><br><span class="hljs-keyword">for</span> step = <span class="hljs-number">1</span>:<span class="hljs-number">15000</span><br>    error = x - x0;<br>    <span class="hljs-comment">% æ¬§å‡ é‡Œå¾—èŒƒæ•°ä¹Ÿæ˜¯ä¸€ç§kç±»å‡½æ•°</span><br>    <span class="hljs-keyword">if</span> norm(error) &gt;= sigma_prime * norm(x)<br>        x0 = x;<br>        u = K*x0;<br>        trigger_count = trigger_count + <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">end</span><br>    x = Ad*x + Bd*u;<br>    <br>    E = norm(error);<br>    ET = sigma_prime * norm(x);<br>    EUB = sigma * norm(x);<br><br>    error_buffer = [error_buffer E];<br>    error_trigger = [error_trigger ET];<br>    error_upper_bound = [error_upper_bound EUB];<br>    x_buffer = [x_buffer x];<br>    u_buffer = [u_buffer u];<br>    <br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">%% plot</span><br><br><span class="hljs-built_in">figure</span>(<span class="hljs-number">1</span>)<br><span class="hljs-built_in">hold</span> on<br><span class="hljs-built_in">plot</span>(x_buffer&#x27;, <span class="hljs-string">&#x27;LineWidth&#x27;</span>, <span class="hljs-number">1.5</span>);<br><span class="hljs-built_in">plot</span>(u_buffer, <span class="hljs-string">&#x27;LineWidth&#x27;</span>, <span class="hljs-number">1.5</span>);<br><span class="hljs-built_in">legend</span>(<span class="hljs-string">&#x27;x1&#x27;</span>, <span class="hljs-string">&#x27;x2&#x27;</span>, <span class="hljs-string">&#x27;u&#x27;</span>);<br><br><span class="hljs-built_in">figure</span>(<span class="hljs-number">2</span>)<br><span class="hljs-built_in">hold</span> on<br><span class="hljs-built_in">plot</span>(error_buffer, <span class="hljs-string">&#x27;LineWidth&#x27;</span>, <span class="hljs-number">1</span>);<br><span class="hljs-built_in">plot</span>(error_trigger, <span class="hljs-string">&#x27;LineWidth&#x27;</span>, <span class="hljs-number">1.5</span>, <span class="hljs-string">&#x27;Color&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>);<br><span class="hljs-built_in">plot</span>(error_upper_bound, <span class="hljs-string">&#x27;LineWidth&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;Color&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>);<br><span class="hljs-built_in">legend</span>(<span class="hljs-string">&#x27;error&#x27;</span>, <span class="hljs-string">&#x27;error trigger&#x27;</span>, <span class="hljs-string">&#x27;error upper bound&#x27;</span>);<br><br>fprintf(<span class="hljs-string">&#x27;the system has been triggered %d times in all\n&#x27;</span>, trigger_count);<br><br></code></pre></td></tr></table></figure><p>ä»¿çœŸç»“æœï¼š</p><p><img src="https://s2.loli.net/2023/07/20/6xms4BwDbjktp5T.png" alt=""></p><p><img src="https://s2.loli.net/2023/07/20/q5raNL71SfctwA2.png" alt=""></p></li></ol><p>â€‹å¯è§æœ€åçš„å®é™…è¯¯å·®ç¡®å®åœ¨ç”±äº‹ä»¶è§¦å‘è§„åˆ™é™åˆ¶çš„è¯¯å·®ä¹‹ä¸‹ï¼Œç³»ç»Ÿä¹Ÿè¾¾åˆ°äº†æ”¶æ•›çŠ¶æ€</p><h1>Paper 2ï¼šDistributed Event-Triggered Control for Multi-Agent Systems, 2012, TAC</h1><h3 id="ä¸€ã€motivationï¼š">ä¸€ã€motivationï¼š</h3><ol><li>ä¸Šä¸€ç¯‡æ–‡çŒ®æ²¡æâ€å¤šæ™ºèƒ½ä½“â€œï¼Œè®²çš„åªæ˜¯ä¸€ä¸ªæ™®é€šçš„æ§åˆ¶ç³»ç»Ÿçš„äº‹ä»¶è§¦å‘ï¼›è€Œè¿™ç¯‡æ–‡ç« è®²çš„MASä¸­çš„äº‹ä»¶è§¦å‘</li><li>åˆ†ä¸ºé›†ä¸­å¼ï¼ˆå„ä¸ªèŠ‚ç‚¹éƒ½çŸ¥é“å…¨å±€ä¿¡æ¯ï¼Œå¦‚æ‹‰æ™®æ‹‰æ–¯çŸ©é˜µï¼‰å’Œåˆ†å¸ƒå¼ï¼ˆå„èŠ‚ç‚¹åªçŸ¥é“è‡ªå·±çš„é‚»å±…ä¿¡æ¯ï¼‰</li><li>ç»™å‡ºäº†è‡ªè§¦å‘å…¬å¼ï¼šç®—å‡ºä¸¤æ¬¡è§¦å‘æ—¶é—´ä¹‹é—´çš„ä¸Šé™ï¼Œåªè¦é—´éš”ä¸è¶…è¿‡è¿™ä¸ªä¸Šé™æœ€åå°±èƒ½ç¨³å®š</li></ol><h3 id="äºŒã€é›†ä¸­å¼äº‹ä»¶è§¦å‘">äºŒã€é›†ä¸­å¼äº‹ä»¶è§¦å‘</h3><p>æ¨¡å‹ï¼šå•ç§¯åˆ†å™¨ $\dot{x_i}=u_i$</p><p>æ§åˆ¶å™¨ï¼š$u=-Lx$</p><p>æ‹“æ‰‘å…³ç³»ï¼šæ— å‘è¿é€šå›¾</p><img src="https://s2.loli.net/2023/08/29/ymxOnwAiJQBofkR.png" style="zoom:67%;" /><img src="https://s2.loli.net/2023/08/29/s7liCN6L3qSYx2Q.png" style="zoom:67%;" /><p>ç”±ä¸Šè¿°æ¨å¯¼å¯çŸ¥ï¼Œäº‹ä»¶è§¦å‘æ¡ä»¶ä¸ºï¼š<br>$$<br>||e||=\sigma\frac{||Lx||}{||L||}<br>$$</p><h3 id="äºŒã€åˆ†å¸ƒå¼äº‹ä»¶è§¦å‘">äºŒã€åˆ†å¸ƒå¼äº‹ä»¶è§¦å‘</h3><p>åŸºæœ¬æ€è·¯æ˜¯æ¯ä¸ªæ™ºèƒ½ä½“éƒ½åªèƒ½è·å–é‚»å±…ä¿¡æ¯ï¼Œæ— æ³•å¾—çŸ¥å…¨å±€ä¿¡æ¯ï¼ˆLaplaceçŸ©é˜µï¼‰ï¼›å“å“ä¸€é€šæ¨å¯¼åå¾—åˆ°æ¯ä¸ªæ™ºèƒ½ä½“çš„äº‹ä»¶è§¦å‘æ¡ä»¶ï¼š<br>$$<br>e_i^2=\frac{\sigma_ia(1-a|N_i|)}{N_i}z_i^2<br>$$</p><h3 id="ä¸‰ã€è‡ªè§¦å‘">ä¸‰ã€è‡ªè§¦å‘</h3><p>ideaï¼šæ¨å¯¼å‡ºä¸¤æ¬¡è§¦å‘æ—¶é—´çš„é—´éš”ä¸Šç•Œï¼Œå³åªè¦æ—¶é—´é—´éš”åˆ«è¶…è¿‡è¿™ä¸ªä¸Šç•Œå°±èƒ½ç¨³å®šï¼›åœ¨è‡ªè§¦å‘ä¸­ï¼Œâ€œäº‹ä»¶â€ä¸å†ç”±è¯¯å·®eå†³å®šï¼Œè€Œæ˜¯å–å†³äºé—´éš”æ—¶é—´<br>$$<br>\begin{aligned}\Delta&amp;=4\sigma^4\left|(Lx(t_i))^TLLx(t_i)\right|^2\&amp;+4\sigma^2\left|L^2x(t_i)\right|^2\cdot\left(|Lx(t_i)|^2|L|^2-\sigma^2\left|L^2x(t_i)\right|^2\right)&gt;0.\end{aligned}<br>$$</p><p>$$<br>t_{i+1}-t_i\leq\frac{-2\sigma^2\left(Lx(t_i)\right)^TLLx(t_i)+\sqrt{\Delta}}{2\left(|Lx(t_i)|^2|L|^2-\sigma^2|L^2x(t_i)|^2\right)}<br>$$</p><h3 id="å››ã€ä»¿çœŸ">å››ã€ä»¿çœŸ</h3><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><code class="hljs matlab"><span class="hljs-comment">% Distributed Event-Triggered Control for Multi-Agent Systems, 2012, TAC</span><br><br>clc;        <br>clear;      <br>close all;<br><br><span class="hljs-comment">%% system define</span><br>L = [<span class="hljs-number">1</span> <span class="hljs-number">-1</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-number">-1</span> <span class="hljs-number">3</span> <span class="hljs-number">-1</span> <span class="hljs-number">-1</span>;<br>    <span class="hljs-number">0</span> <span class="hljs-number">-1</span> <span class="hljs-number">2</span> <span class="hljs-number">-1</span>;<br>    <span class="hljs-number">0</span> <span class="hljs-number">-1</span> <span class="hljs-number">-1</span> <span class="hljs-number">2</span>];<br><br>x0 = [<span class="hljs-number">0.1</span> <span class="hljs-number">0.2</span> <span class="hljs-number">0.3</span> <span class="hljs-number">0.4</span>]&#x27;;<br><br>sigma = <span class="hljs-number">0.65</span>;<br>sigma_1 = <span class="hljs-number">0.55</span>;<br>sigma_2 = <span class="hljs-number">0.55</span>;<br>sigma_3 = <span class="hljs-number">0.75</span>;<br>sigma_4 = <span class="hljs-number">0.75</span>;<br>alpha = <span class="hljs-number">0.2</span>;<br><br>dt = <span class="hljs-number">0.001</span>;<br>trigger_count_1 = <span class="hljs-number">0</span>;<br>trigger_count_2 = <span class="hljs-number">0</span>;<br>trigger_count_3 = <span class="hljs-number">0</span>;<br>trigger_count_4 = <span class="hljs-number">0</span>;<br><br><br><span class="hljs-comment">%% é›†ä¸­å¼-äº‹ä»¶è§¦å‘</span><br>x_buffer_1 = [];<br>u_buffer_1 = [];<br>error_buffer_1 = [];<br>error_upper_bound_1 = [];<br><br>x = x0;         <br>u = -L*x0;    <br><br>B = <span class="hljs-built_in">ones</span>(<span class="hljs-number">4</span>, <span class="hljs-number">1</span>);<br>syms s;<br>Bd = int(expm(<span class="hljs-built_in">zeros</span>(<span class="hljs-number">4</span>,<span class="hljs-number">4</span>)*s),<span class="hljs-number">0</span>,dt)*B;<br>Bd = eval(Bd);<br><br><span class="hljs-keyword">for</span> step = <span class="hljs-number">1</span>:<span class="hljs-number">5000</span><br>    error = x - x0;<br>    E = norm(error);<br><br>    <span class="hljs-keyword">if</span> E &gt;= sigma * norm(L*x)/norm(L)<br>        x0 = x;<br>        u = -L*x0;<br>        trigger_count_1 = trigger_count_1 + <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">end</span><br>    x = x + Bd.*u;<br><br>    EUB = sigma * norm(L*x)/norm(L);<br><br>    error_buffer_1 = [error_buffer_1 E];<br>    error_upper_bound_1 = [error_upper_bound_1 EUB];<br>    x_buffer_1 = [x_buffer_1 x];<br>    u_buffer_1 = [u_buffer_1 u];<br>    <br><span class="hljs-keyword">end</span><br><br><br><span class="hljs-comment">%% é›†ä¸­å¼-è‡ªè§¦å‘</span><br>x_buffer_2 = [];<br>u_buffer_2 = [];<br>error_buffer_2 = [];<br>error_upper_bound_2 = [];<br><br>x0 = [<span class="hljs-number">0.1</span> <span class="hljs-number">0.2</span> <span class="hljs-number">0.3</span> <span class="hljs-number">0.4</span>]&#x27;;<br>x = x0;         <br>u = -L*x0;  <br><br>t_now = <span class="hljs-number">0</span>;<br>time_upper_bound = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">for</span> step = <span class="hljs-number">1</span>:<span class="hljs-number">5000</span><br>    error = x - x0;<br>    E = norm(error);<br>    t_next = dt*step;<br><br>    <span class="hljs-keyword">if</span> t_next - t_now &gt;= time_upper_bound<br>        x0 = x;<br>        u = -L*x0;<br>        t_now = t_next;<br>        time_upper_bound = <span class="hljs-number">0.2</span>*calculate_fun(sigma, L, x0);<br>        trigger_count_2 = trigger_count_2 + <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">end</span><br><br>    x = x + Bd.*u;<br><br>    EUB = sigma * norm(L*x)/norm(L);<br><br>    error_buffer_2 = [error_buffer_2 E];<br>    error_upper_bound_2 = [error_upper_bound_2 EUB];<br>    x_buffer_2 = [x_buffer_2 x];<br>    u_buffer_2 = [u_buffer_2 u];<br><span class="hljs-keyword">end</span><br><br><span class="hljs-built_in">figure</span>(<span class="hljs-number">1</span>)<br>subplot(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>);<br><span class="hljs-built_in">hold</span> on<br><span class="hljs-built_in">plot</span>(x_buffer_1&#x27;, <span class="hljs-string">&#x27;LineWidth&#x27;</span>, <span class="hljs-number">1.5</span>);<br><span class="hljs-built_in">plot</span>(u_buffer_1&#x27;, <span class="hljs-string">&#x27;LineWidth&#x27;</span>, <span class="hljs-number">1.5</span>);<br><span class="hljs-built_in">legend</span>(<span class="hljs-string">&#x27;x1&#x27;</span>, <span class="hljs-string">&#x27;x2&#x27;</span>, <span class="hljs-string">&#x27;x3&#x27;</span>, <span class="hljs-string">&#x27;x4&#x27;</span>, <span class="hljs-string">&#x27;u1&#x27;</span>, <span class="hljs-string">&#x27;u2&#x27;</span>, <span class="hljs-string">&#x27;u3&#x27;</span>, <span class="hljs-string">&#x27;u4&#x27;</span>);<br>title(<span class="hljs-string">&quot;é›†ä¸­å¼-äº‹ä»¶è§¦å‘&quot;</span>);<br><br>subplot(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>);<br><span class="hljs-built_in">hold</span> on<br><span class="hljs-built_in">plot</span>(error_buffer_1, <span class="hljs-string">&#x27;LineWidth&#x27;</span>, <span class="hljs-number">1</span>);<br><span class="hljs-built_in">plot</span>(error_upper_bound_1, <span class="hljs-string">&#x27;LineWidth&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;Color&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>);<br><span class="hljs-built_in">legend</span>(<span class="hljs-string">&#x27;error&#x27;</span>, <span class="hljs-string">&#x27;error upper bound&#x27;</span>);<br>title(<span class="hljs-string">&quot;é›†ä¸­å¼-äº‹ä»¶è§¦å‘&quot;</span>);<br><br>fprintf(<span class="hljs-string">&#x27;1ï¼š triggered %d times in all\n&#x27;</span>, trigger_count_1);<br><br>subplot(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>);<br><span class="hljs-built_in">hold</span> on<br><span class="hljs-built_in">plot</span>(x_buffer_2&#x27;, <span class="hljs-string">&#x27;LineWidth&#x27;</span>, <span class="hljs-number">1.5</span>);<br><span class="hljs-built_in">plot</span>(u_buffer_2&#x27;, <span class="hljs-string">&#x27;LineWidth&#x27;</span>, <span class="hljs-number">1.5</span>);<br><span class="hljs-built_in">legend</span>(<span class="hljs-string">&#x27;x1&#x27;</span>, <span class="hljs-string">&#x27;x2&#x27;</span>, <span class="hljs-string">&#x27;x3&#x27;</span>, <span class="hljs-string">&#x27;x4&#x27;</span>, <span class="hljs-string">&#x27;u1&#x27;</span>, <span class="hljs-string">&#x27;u2&#x27;</span>, <span class="hljs-string">&#x27;u3&#x27;</span>, <span class="hljs-string">&#x27;u4&#x27;</span>);<br>title(<span class="hljs-string">&quot;é›†ä¸­å¼-è‡ªè§¦å‘&quot;</span>);<br><br>subplot(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">4</span>);<br><span class="hljs-built_in">hold</span> on<br><span class="hljs-built_in">plot</span>(error_buffer_2, <span class="hljs-string">&#x27;LineWidth&#x27;</span>, <span class="hljs-number">1</span>);<br><span class="hljs-built_in">plot</span>(error_upper_bound_2, <span class="hljs-string">&#x27;LineWidth&#x27;</span>, <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;Color&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>);<br><span class="hljs-built_in">legend</span>(<span class="hljs-string">&#x27;error&#x27;</span>, <span class="hljs-string">&#x27;error upper bound&#x27;</span>);<br>title(<span class="hljs-string">&quot;é›†ä¸­å¼-è‡ªè§¦å‘&quot;</span>);<br><br>fprintf(<span class="hljs-string">&#x27;2ï¼š triggered %d times in all\n&#x27;</span>, trigger_count_2);<br><br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2023/08/29/gNkK4ruI9ZVX5FQ.png" alt=""></p>]]></content>
    
    
    <categories>
      
      <category>ç§‘ç ”åªä¸ºæŠŠä¸šæ¯•</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ååŒæ§åˆ¶</tag>
      
      <tag>äº‹ä»¶è§¦å‘</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>EE364Aç¬”è®°</title>
    <link href="/2023/06/14/%E3%80%8AEE364A%E7%AC%94%E8%AE%B0%E3%80%8B/"/>
    <url>/2023/06/14/%E3%80%8AEE364A%E7%AC%94%E8%AE%B0%E3%80%8B/</url>
    
    <content type="html"><![CDATA[<h1>ã€ŠEE364Aç¬”è®°ã€‹</h1><h1>Lecture_1 Introduction</h1><ol><li><strong>æœ€å°äºŒä¹˜é—®é¢˜</strong></li></ol><p><img src="https://s2.loli.net/2023/06/14/6hporxeNmGwjKbC.png" alt=""></p><ul><li>æœ‰è§£æè§£ï¼š$x^*=(A^TA)^{-1}A^Tb$</li><li>ç°å·²æœ‰æˆç†Ÿæ–¹æ³•å’Œè½¯ä»¶æ¥è§£å†³æœ€å°äºŒä¹˜é—®é¢˜</li></ul><ol start="2"><li><strong>çº¿æ€§è§„åˆ’é—®é¢˜</strong></li></ol><p><img src="https://s2.loli.net/2023/06/14/Ty8cbCUN71uZdYv.png" alt=""></p><ul><li>æ²¡æœ‰è§£æè§£</li><li>ç°å·²æœ‰æˆç†Ÿæ–¹æ³•å’Œè½¯ä»¶æ¥è§£å†³çº¿æ€§è§„åˆ’é—®é¢˜</li></ul><ol start="3"><li><strong>å‡¸ä¼˜åŒ–é—®é¢˜</strong></li></ol><p><img src="https://s2.loli.net/2023/06/14/UzswpgkhnlICyQf.png" alt=""></p><p>â€‹å…¶ä¸­ç›®æ ‡å‡½æ•° f0 å’Œçº¦æŸå‡½æ•° fi éƒ½æ˜¯å‡¸çš„ï¼Œå³æ»¡è¶³ï¼š</p><p><img src="https://s2.loli.net/2023/06/14/OWtH2KeDRAimNac.png" alt=""></p><h1>Lecture_2 Convex sets</h1><h3 id="ä¸€ã€å‡¸åŒ…ä¸å‡¸é›†">ä¸€ã€å‡¸åŒ…ä¸å‡¸é›†</h3><p>â€‹è§<a href="https://qlhhahaha.github.io/2023/04/13/%E3%80%8A%E6%9C%80%E4%BC%98%E5%8C%96%E8%AE%A1%E7%AE%97%E6%96%B9%E6%B3%95%EF%BC%88%E6%96%87%E5%86%8D%E6%96%87%EF%BC%89%E7%AC%94%E8%AE%B0%E3%80%8B/#%E7%AC%AC%E4%BA%8C%E7%AB%A0%E3%80%81%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86">ã€Šæœ€ä¼˜åŒ–è®¡ç®—æ–¹æ³•ï¼ˆæ–‡å†æ–‡ï¼‰ç¬”è®°ã€‹</a></p><h3 id="äºŒã€å¦‚ä½•ä¿è¯ä¸€ä¸ªé›†åˆCçš„å‡¸æ€§">äºŒã€å¦‚ä½•ä¿è¯ä¸€ä¸ªé›†åˆCçš„å‡¸æ€§</h3><ol><li><strong>ä½¿ç”¨å®šä¹‰</strong></li></ol><p><img src="https://s2.loli.net/2023/06/14/RGnYNVfLv2zU1Zh.png" alt=""></p><ol start="2"><li><strong>è¯æ˜Cæ˜¯ç”±ç®€å•å‡¸é›†ç»è¿‡ä»¥ä¸‹æ“ä½œå¾—åˆ°ï¼š</strong></li></ol><ul><li><p>â€‹**ç›¸äº¤ï¼š**ä»»æ„ä¸ªæ•°çš„å‡¸é›†ç›¸äº¤ä»ä¸ºå‡¸é›†</p><p><img src="https://s2.loli.net/2023/06/14/qIwAbr251N4MTV6.png" alt=""></p></li></ul><p>â€‹ä¸ºä»€ä¹ˆè¯´Sæ˜¯å‡¸é›†æï¼Ÿ<br>â€‹é¦–å…ˆcosæ˜¯å¶å‡½æ•°ï¼Œæ‰€ä»¥ t çš„èŒƒå›´ç®€åŒ–ä¸º0åˆ°pi/3ï¼Œæˆ‘ä»¬å‡è®¾ t ä¸ºè¯¥èŒƒå›´ä¸­çš„æŸä¸ªå®šå€¼ï¼›<br>â€‹å®šä¹‰å­é›†$S_t={ x\in R^m  |   \left\vert p(t)\right\vert \le1 }$ï¼Œå³å…ˆå›ºå®š t ï¼Œ<br>â€‹åˆ™æ­¤æ—¶$\left\vert p(t)\right\vert \le1$æ˜¯ä¸¤ä¸ªåŠå¹³é¢çš„äº¤é›†ï¼ˆå› ä¸º p(t)æ˜¯[cos t, cos 2t]å’Œ[x1, x2]çš„å†…ç§¯ï¼Œ$p(t) \le1$æ˜¯ä¸ªåŠå¹³é¢ï¼Œ $p(t) \ge -1$ä¹Ÿæ˜¯ä¸ªåŠå¹³é¢ ï¼‰ï¼Œæ‰€ä»¥ St ä¸ºå‡¸é›†<br>â€‹è€Œ$S=\cap S_t ,t\in(0,\pi/3)$ï¼Œå³ä¸ºæ— æ•°ä¸ªå‡¸é›†çš„äº¤é›†ï¼Œæ•… S ä»æœªå‡¸é›†ï¼ˆè§ä¸Šå³å›¾ï¼‰</p><ul><li>**ä»¿å°„å‡½æ•°ï¼š**å‡¸é›†ç»ä»¿å°„å˜æ¢ï¼ˆç¼©æ”¾ã€å¹³ç§»ã€æŠ•å½±ï¼‰ä»æ˜¯å‡¸é›†</li><li><strong>é€è§†å‡½æ•°ä¸çº¿æ€§åˆ†å¼å‡½æ•°</strong></li></ul><p>â€‹é€è§†å‡½æ•°Pï¼š$R^{n+1}\rightarrow R^n$</p><p><img src="https://s2.loli.net/2023/06/14/ZBbct6EWzUN5LQu.png" alt=""></p><p>â€‹çº¿æ€§åˆ†å¼å‡½æ•° fï¼š$R^{n}\rightarrow R^m$</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/4tYHiAjksyeaL5D.png" alt=""></p><h3 id="ä¸‰ã€æ”¯æ’‘è¶…å¹³é¢å®šç†">ä¸‰ã€æ”¯æ’‘è¶…å¹³é¢å®šç†</h3><p>â€‹å¦‚æœCæ˜¯å‡¸é›†ï¼Œé‚£ä¹ˆåœ¨å…¶æ¯ä¸€ä¸ªè¾¹ç•Œç‚¹ä¸Šéƒ½å­˜åœ¨è‡³å°‘ä¸€ä¸ªæ”¯æ’‘è¶…å¹³é¢ï¼ˆå‡ ä½•æ„ä¹‰æ˜¯åˆ‡çº¿ã€åˆ‡é¢ï¼‰</p><div class="note note-warning">            <p>â€‹ğŸ’¡ PS. æ”¯æ’‘è¶…å¹³é¢ä¸ä¸€å®šå”¯ä¸€ï¼Œå¦‚çŸ©å½¢é¡¶ç‚¹å¤„å°±æœ‰æ— æ•°ä¸ªè¶…å¹³é¢ï¼ˆå› ä¸ºè¾¹ç•Œçªå˜ï¼‰<br>â€‹</p>          </div><h1>Lecture_3 Convex functions</h1><ol><li><p><strong>å¸¸è§å‡¸å‡½æ•°</strong></p><ul><li><p>æŒ‡æ•°å‡½æ•°</p></li><li><p>å¹‚å‡½æ•°ï¼š$x^\alpha,\alpha \ge1,or ,\alpha\le0$</p></li><li><p>ç†µå‡½æ•°ï¼š$xlogx$</p></li><li><p>æ‰€æœ‰çš„èŒƒæ•°</p></li></ul></li><li><p><strong>æ‹“å±•å‡½æ•°</strong></p></li></ol><p><img src="https://s2.loli.net/2023/06/14/KOfqJhre8BkpQtL.png" alt=""></p><ol start="3"><li><strong>ä¸Šå¢ƒå›¾ï¼ˆepigraphï¼‰</strong></li></ol><p>â€‹<img src="https://s2.loli.net/2023/06/14/jqlZ5VfMLDPOIUc.png" alt=""></p><p>â€‹f ä¸ºå‡¸å‡½æ•° $\iff$ çš„ä¸Šå¢ƒå›¾ä¸ºå‡¸é›†</p><ol start="4"><li><p><strong>å…±è½­å‡½æ•°</strong></p> <img src="https://s2.loli.net/2023/06/14/ThjPmMAYB8sZWNk.png" style="zoom:80%;" /></li></ol><p>â€‹$f^*$å§‹ç»ˆæ˜¯å‡¸å‡½æ•°ï¼ˆå³ä½¿ f ä¸å‡¸ï¼‰</p><p>â€‹ä¸¾ä¾‹ï¼š</p><p><img src="https://s2.loli.net/2023/06/14/pgZPLbSGxHqQcVW.png" alt=""></p><ol start="5"><li><strong>æ‹Ÿå‡¸å‡½æ•°ï¼ˆquasiconvex functionï¼‰</strong></li></ol><p>â€‹å®šä¹‰ï¼šè‹¥ dom f ä¸ºå‡¸é›†ï¼Œä¸”å¯¹ä»»æ„çš„ Î± ï¼Œå…¶ä¸‹æ°´å¹³é›†<br>$$<br>S_\alpha={x\in domf | f(x) \le \alpha }<br>$$<br>â€‹<img src="https://s2.loli.net/2023/06/14/FxYt8vHmyijQPbB.png" style="zoom:67%;" /></p><h1>Lecture_4 Convex optimization problems</h1><ol><li><strong>æ ‡å‡†å½¢å¼</strong></li></ol><p>â€‹<img src="https://s2.loli.net/2023/06/14/xU72RaZtkAoOp6s.png" alt=""></p><ol start="2"><li><strong>å‡¸ä¼˜åŒ–é—®é¢˜</strong></li></ol><p>â€‹<img src="https://s2.loli.net/2023/06/14/M6ZID7QrkEmhdbV.png" alt=""></p><p>â€‹å…¶ä¸­ fi(x) éƒ½æ˜¯å‡¸çš„ï¼›ç­‰å¼çº¦æŸæ˜¯ä»¿å°„çš„</p><p>â€‹<div class="note note-warning">            <p>â€‹ğŸ’¡ PS. å‡¸ä¼˜åŒ–é—®é¢˜çš„ä»»ä½•å±€éƒ¨æœ€ä¼˜è§£éƒ½æ˜¯å…¨å±€æœ€ä¼˜è§£<br>â€‹</p>          </div></p><ol start="3"><li><p><strong>ä¸€äº›å¸¸è§çš„è½¬æ¢æŠ€å·§</strong></p><ul><li><strong>æ¶ˆé™¤ç­‰å¼çº¦æŸ</strong></li></ul><p><img src="https://s2.loli.net/2023/06/14/GNf9QxmPc76VF4z.png" alt=""></p><p>â€‹å³å…ˆæŠŠ Ax=b è§£å‡ºæ¥ï¼Œå†å¸¦åˆ°ä¸ç­‰å¼çº¦æŸä¸­</p><ul><li><strong>å¼•å…¥ç­‰å¼çº¦æŸ</strong></li></ul><p><img src="https://s2.loli.net/2023/06/14/gavAucWLDYkzfhp.png" alt=""></p><ul><li><strong>å¼•å…¥æ¾å¼›å˜é‡</strong></li></ul></li><li><p><strong>çº¿æ€§è§„åˆ’é—®é¢˜ï¼ˆLinear Program, LPï¼‰</strong></p></li></ol><p><img src="https://s2.loli.net/2023/06/14/RhoVEv6rnT4g9W5.png" alt=""></p><p>â€‹å‡ ä½•è§£é‡Šä¸ºï¼Œçº¿æ€§è§„åˆ’çš„å¯è¡ŒåŸŸæ˜¯å¤šé¢ä½“Pï¼Œè¯¥æœ€ä¼˜é—®é¢˜å°±æ˜¯è¦åœ¨Pä¸Šæ±‚ä»¿å°„å‡½æ•°$c^Tx+d$çš„æå°å€¼</p><p>â€‹<strong>ä¸¾ä¾‹ï¼š</strong></p><p>â€‹ä¸€ä»½å¥åº·çš„é¥®é£ŸåŒ…å«mç§ä¸åŒçš„è¥å…»ï¼Œæ¯ç§è‡³å°‘éœ€è¦b1,â€¦,bmã€‚æˆ‘ä»¬å¯ä»¥ä»nç§é£Ÿç‰©ä¸­é€‰æ‹©éè´Ÿçš„é‡x1ï¼Œâ€¦ ï¼Œxnä»¥æ„æˆä¸€ä»½é£Ÿè°±ã€‚å•ä½ç¬¬ j ç§é£Ÿå“å«æœ‰è¥å…» i çš„é‡ä¸º ajï¼Œè€Œä»·æ ¼ä¸º cjã€‚æˆ‘ä»¬å¸Œæœ›è®¾è®¡å‡ºä¸€ä»½æœ€ä¾¿å®œçš„æ»¡è¶³è¥å…»éœ€æ±‚çš„é£Ÿè°±ã€‚è¿™ä¸€é—®é¢˜å¯ä»¥æè¿°ä¸ºçº¿æ€§è§„åˆ’</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/dmYERS9ArT4ockG.png" alt=""></p><ol start="5"><li><strong>äºŒæ¬¡ä¼˜åŒ–é—®é¢˜ï¼ˆQuadratic programï¼ŒQPï¼‰</strong></li></ol><p>â€‹ç›®æ ‡å‡½æ•°æ˜¯å‡¸äºŒæ¬¡å‹ä¸”çº¦æŸå‡½æ•°ä¸ºä»¿å°„</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/zpdoy2Ww67TD5Or.png" alt=""></p><p>â€‹å‡ ä½•è§£é‡Šï¼šå¯è¡Œé›†æ˜¯å¤šé¢ä½“Pï¼Œè™šçº¿ä¸ºå‡¸äºŒæ¬¡ç›®æ ‡å‡½æ•°çš„ç­‰ä½çº¿</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/veWtf29I3QhjOD8.png" style="zoom:67%;" /></p><p>â€‹çº¿æ€§è§„åˆ’æ˜¯äºŒæ¬¡è§„åˆ’çš„ç‰¹ä¾‹ï¼ˆPå–0æ—¶é€€åŒ–ä¸ºçº¿æ€§è§„åˆ’ï¼‰</p><ol start="6"><li><strong>äºŒæ¬¡çº¦æŸäºŒæ¬¡è§„åˆ’é—®é¢˜ï¼ˆQCQPï¼‰</strong></li></ol><p>â€‹<img src="https://s2.loli.net/2023/06/14/VnTWEzr49bo8uHa.png" alt=""></p><p>â€‹åœ¨äºŒæ¬¡è§„åˆ’çš„åŸºç¡€ä¸Šï¼Œè‹¥ä¸ç­‰å¼çº¦æŸæ¡ä»¶ä¹Ÿæ˜¯å‡¸äºŒæ¬¡å‹ï¼Œåˆ™ç§°ä¹‹ä¸ºQCQP</p><ol start="7"><li><strong>äºŒé˜¶é”¥è§„åˆ’ï¼ˆSecond order cone programmingï¼ŒSOCPï¼‰</strong></li></ol><p>â€‹<img src="https://s2.loli.net/2023/06/14/u3QPtmK7WOAqjrY.png" alt=""></p><p>â€‹å½“ ci = 0æ—¶ï¼Œé€€åŒ–ä¸ºä¸€ä¸ªQCQPé—®é¢˜</p><h1>Lecture_5 Duality</h1><ol><li><strong>Lagrangeå¯¹å¶å‡½æ•°</strong></li></ol><p>â€‹ä¸€ä¸ªæ ‡å‡†å½¢å¼çš„é—®é¢˜ï¼ˆä¸è¦æ±‚æ˜¯å‡¸çš„ï¼‰</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/yVwbc4Fizgvo6Hs.png" style="zoom:67%;" /></p><p>â€‹æŠŠå®ƒå†™æˆ</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/HVapvMDbdsgy8xm.png" style="zoom:67%;" /></p><p>â€‹æ‰€è°“çš„Lagrangeå¯¹å¶å‡½æ•°ï¼Œå°±æ˜¯å»æ±‚å®ƒçš„ä¸‹ç¡®ç•Œ</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/XQI8zJFKjD4eNME.png" style="zoom:80%;" /></p><p>â€‹å¯¹äºå¯è¡ŒåŸŸå†…æ‰€æœ‰çš„$\tilde{x}$ï¼Œçš†æœ‰$p^* \ge g(\lambda,v)$ï¼Œå³$g(\lambda,v)$æ˜¯åŸé—®é¢˜æœ€ä¼˜å€¼çš„ä¸‹ç•Œ</p><ol start="2"><li><strong>ä¸¾ä¾‹ï¼šçº¿æ€§æ–¹ç¨‹ç»„çš„æœ€å°äºŒä¹˜è§£</strong></li></ol><p>â€‹è€ƒè™‘é—®é¢˜ï¼š</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/bfNtnDGL4EU3sd1.png" style="zoom:67%;" /></p><p>â€‹å…¶Lagrangeå‡½æ•°ä¸ºï¼š</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/4L83i2favGyA9wQ.png" style="zoom:67%;" /></p><p>â€‹ä¸ºå¾—æœ€å°å€¼ï¼Œæ±‚å…¶å¯¼æ•°ï¼š</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/lyd6zVUIMFagND9.png" style="zoom:67%;" /></p><img src="https://s2.loli.net/2023/06/14/GNsDmbSezfZXlxK.png" style="zoom:67%;" /><p>â€‹æ‰€ä»¥å¯å¾—åŸé—®é¢˜æœ€ä¼˜è§£çš„ä¸‹ç•Œä¸ºï¼š</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/3fhGcy8n92x6LBH.png" style="zoom:67%;" /></p><ol start="3"><li><strong>Lagrangeå¯¹å¶é—®é¢˜</strong></li></ol><p>â€‹æ±‚Lagrangeå‡½æ•°çš„æœ€å¤§å€¼ï¼Œä¹Ÿå°±æ˜¯åŸé—®é¢˜çš„æœ€å¥½ä¸‹ç•Œï¼Œè¿™å°±æ˜¯æ‰€è°“çš„Lagrangeå¯¹å¶é—®é¢˜</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/D4RoZHMqxLeYQgh.png" style="zoom:67%;" /></p><p>â€‹<strong>ä¸¾ä¾‹ï¼š</strong></p><p>â€‹<img src="https://s2.loli.net/2023/06/14/NaHJB97GxjZh1u5.png" style="zoom: 80%;" /></p><p>â€‹å…¶Lagrangeå‡½æ•°ä¸ºï¼š</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/WIP4YJpu8gRl2rH.png" style="zoom:80%;" /></p><p>â€‹<div class="note note-warning">            <p>â€‹ğŸ’¡ PS. æ³¨æ„ï¼šæ­¤æ—¶ x çš„å®šä¹‰åŸŸæ˜¯Rï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ç”¨å†å»è€ƒè™‘ (x-2)(x-4)ä¸ºè´Ÿè¿™ä¸ªçº¦æŸæ¡ä»¶ï¼Œå› ä¸ºLagrangeå‡½æ•°æœ¬èº«å°±å·²ç»åŒ…å«äº†è¿™ä¸ªæ¡ä»¶<br>â€‹</p>          </div></p><p>â€‹é‚£ä¹ˆæ˜¾è€Œæ˜“è§ï¼Œå¯¹äºè¿™ä¸ªä»¥ Î» ä¸ºè‡ªå˜é‡çš„äºŒæ¬¡å‡½æ•°ï¼Œ$\lambda \le -1$æ—¶ä¸‹ç¡®ç•Œä¸º -âˆ ;$\lambda &gt; -1$æ—¶ï¼Œåœ¨$\tilde{x}=3\lambda/(1+\lambda)$å¤„å–æœ€å°å€¼ï¼Œå³</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/6bZegP2RjIQMhKB.png" alt=""></p><p>â€‹æ­¤æ—¶æˆ‘ä»¬å¾—åˆ°äº†æ‰€è°“çš„Lagrangeå¯¹å¶é—®é¢˜ï¼š</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/Ec1fbjwuSgXpRno.png" alt=""></p><p>â€‹å®¹æ˜“éªŒè¯å¾—åˆ°æ­¤æ—¶çš„æœ€ä¼˜ç‚¹ä¸º Î»=2ï¼Œæœ€ä¼˜å€¼ä¸º5ï¼Œå’ŒåŸé—®é¢˜ä¸€è‡´ï¼ˆè¿™æ˜¯å¿…ç„¶çš„ï¼Œå› ä¸ºå½“ x å±äº(2, 4)æ—¶ä¸ç­‰å¼ä¸¥æ ¼æˆç«‹ï¼Œå³æ»¡è¶³Slateræ¡ä»¶ï¼Œä¸”åŸé—®é¢˜æ˜¯å‡¸é—®é¢˜ï¼Œé‚£ä¹ˆå¼ºå¯¹å¶æ€§æˆç«‹ï¼‰</p><p>â€‹<div class="note note-warning">            <p>â€‹ğŸ’¡ PS. é™¤äº†Slateræ¡ä»¶ä¹‹å¤–ï¼Œè¿˜æœ‰å…¶å®ƒå¾ˆå¤šåˆ¤æ–­å‡†åˆ™<br>â€‹</p>          </div></p><ol start="4"><li><strong>å¼ºå¼±å¯¹å¶æ€§</strong></li></ol><p>â€‹Lagrangeå¯¹å¶é—®é¢˜çš„æœ€ä¼˜å€¼ç”¨$d^*$è¡¨ç¤º</p><ul><li>å¼±å¯¹å¶æ€§æŒ‡$d^* \le p^*$ï¼Œå¼±å¯¹å¶æ€§å§‹ç»ˆæ»¡è¶³ï¼ˆå³ä½¿åŸé—®é¢˜ä¸æ˜¯å‡¸çš„ï¼‰</li><li>å¼ºå¯¹å¶æ€§æŒ‡$d^* = p^*$ï¼ŒåŸé—®é¢˜æ˜¯å‡¸çš„æ—¶å€™é€šå¸¸ï¼ˆä½†ä¸æ€»æ˜¯ï¼‰æ»¡è¶³å¼ºå¯¹å¶æ€§</li></ul><ol start="5"><li><strong>Slaterçº¦æŸå‡†åˆ™</strong></li></ol><p>â€‹å¯¹äºä¸€ä¸ªå‡¸é—®é¢˜</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/HOyYXrIz5w9Bnba.png" alt=""></p><p>â€‹å¦‚æœå­˜åœ¨ä¸€ä¸ªç‚¹$x \in intD$ï¼ˆå†…ç‚¹ï¼‰ï¼Œä½¿å¾—$f_i(x)&lt;0, and,Ax=b$ï¼ˆå³ä¸ç­‰å¼çº¦æŸä¸¥æ ¼æˆç«‹ï¼‰ï¼Œåˆ™ç§°ä¹‹ä¸ºæ»¡è¶³Slaterçº¦æŸï¼Œæ­¤æ—¶å¼ºå¯¹å¶æ€§æˆç«‹</p><ol start="6"><li><strong>äº’è¡¥æ¾å¼›æ€§ï¼ˆComplementary slacknessï¼‰</strong></li></ol><p>â€‹å‡è®¾å¼ºå¯¹å¶æ€§æˆç«‹ï¼Œ$x^<em>$æ˜¯åŸé—®é¢˜æœ€ä¼˜è§£ï¼Œ$(\lambda^</em>,\nu^*)$æ˜¯å¯¹å¶é—®é¢˜çš„æœ€ä¼˜è§£</p><p>â€‹åˆ™æœ‰ï¼š</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/c13xleTfoOuFUPB.png" alt=""></p><p>â€‹å¾—åˆ°ç»“è®ºï¼š</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/ibavpBdZtWIGM9U.png" alt=""></p><p>â€‹è¯¥ç»“è®ºå°±æ˜¯æ‰€è°“çš„äº’è¡¥æ¾å¼›æ€§</p><ol start="7"><li><strong>KKTæœ€ä¼˜æ¡ä»¶</strong></li></ol><p>â€‹<img src="https://s2.loli.net/2023/06/14/icf9kDuy5ATP4v3.png" alt=""></p><p>â€‹å¯¹äºä¸€ä¸ªå‡¸é—®é¢˜æ¥è¯´ï¼Œè‹¥æŸç»„$(\tilde{x},\tilde{\lambda},\tilde{\nu})$æ»¡è¶³KKTæ¡ä»¶ï¼Œé‚£å®ƒä»¬å°±æ˜¯æœ€ä¼˜è§£</p><h1>Lecture_6 Approximation and fitting</h1><ol><li><strong>èŒƒæ•°é€¼è¿‘</strong></li></ol><p>â€‹å…¸å‹çš„èŒƒæ•°é€¼è¿‘é—®é¢˜æ˜¯å…·æœ‰ä»¥ä¸‹å½¢å¼çš„æ— çº¦æŸé—®é¢˜ï¼š</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/jSk2PFMpO6194Bc.png" alt=""></p><p>â€‹ä»<strong>é€¼è¿‘</strong>çš„è§’åº¦è¿›è¡Œè§£é‡Šï¼š</p><p>â€‹é€šè¿‡å°† Ax è¡¨ç¤ºä¸º$Ax=x_1a_1+â€¦+x_na_n$ï¼Œå…¶ä¸­ ai ä¸º A çš„åˆ—ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒèŒƒæ•°é€¼è¿‘é—®é¢˜çš„ç›®æ ‡æ˜¯ç”¨ A çš„åˆ—çš„çº¿æ€§ç»„åˆï¼Œå°½å¯èƒ½å‡†ç¡®åœ°é€¼è¿‘æˆ–æ‹Ÿåˆå‘é‡ b</p><ol start="2"><li><strong>æœ€å°äºŒä¹˜é€¼è¿‘</strong></li></ol><p>â€‹å–èŒƒæ•°ä¸º2ï¼Œåˆ™åŸé—®é¢˜è½¬æ¢ä¸ºï¼š<br>$$<br>min ||Ax-b||_2^2<br>$$<br>â€‹å°†ç›®æ ‡å‡½æ•°è¡¨ç¤ºä¸ºå‡¸äºŒæ¬¡å‡½æ•°ï¼š<br>$$<br>f(x)=x^TA^TAx-2b^TAx+b^Tb<br>$$<br>â€‹æ±‚å…¶å¯¼æ•°æœ‰ï¼š<br>$$<br>\nabla f(x)=2A^TAx-2A^Tb=0<br>$$<br>â€‹å³ x æ»¡è¶³ï¼š<br>$$<br>A^TAx=A^Tb<br>$$<br>â€‹å¯å¾—å…¶å”¯ä¸€è§£$x=(A^TA)^{-1}A^Tb$</p><ol start="3"><li><strong>ç½šå‡½æ•°é€¼è¿‘</strong></li></ol><p>â€‹$l_p$èŒƒæ•°é€¼è¿‘é—®é¢˜çš„ç›®æ ‡å‡½æ•°ä¸ºï¼š<br>$$<br>(|r_1|^p+\cdots+|r_m|^p)^{1/p}<br>$$<br>â€‹å…¶ä¸­ ri = Ax - b ï¼Œç§°ä¹‹ä¸ºæ®‹å·®ï¼Œæ‰€è°“çš„èŒƒæ•°é€¼è¿‘ï¼Œå°±æ˜¯è¦æ®‹å·®å°½å¯èƒ½åœ°å°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æŠŠèŒƒæ•°é€¼è¿‘é—®é¢˜è½¬æ¢ä¸ºä»¥ä¸‹å½¢å¼ï¼š</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/aLej2nqWCifJ9xI.png" alt=""></p><p>â€‹å…¶ä¸­ Î¦ ç§°ä¹‹ä¸ºç½šå‡½æ•°ï¼Œæˆ‘ä»¬é€šå¸¸å°†Î¦è®¾ä¸ºä¸€ä¸ªå¯¹ç§°çš„ã€éè´Ÿçš„å‡¸å‡½æ•°ï¼Œåˆ™ä¸Šè¿°é—®é¢˜æ˜¯ä¸€ä¸ªå‡¸ä¼˜åŒ–é—®é¢˜</p><p>â€‹å¸¸è§çš„ç½šå‡½æ•°ï¼š</p><ul><li><p>äºŒæ¬¡ç½šå‡½æ•°$\phi(u)=u^{2}$</p></li><li><p>å¸¦æ­»åŒºçš„ç½šå‡½æ•°$\phi(u)=\max{0,|u|-a}$</p></li><li><p>å¯¹æ•°ç½šå‡½æ•°<br>$$<br>\phi(u)=\begin{cases}-a^2\log(1-(u/a)^2)&amp;|u|&lt;a\ \infty&amp;\text{otherwise}\end{cases}<br>$$</p></li></ul><img src="https://s2.loli.net/2023/06/14/weIWRO76KdrNubG.png" style="zoom:67%;" /><ol start="4"><li><strong>æ­£åˆ™åŒ–é€¼è¿‘</strong></li></ol><p>â€‹<img src="https://s2.loli.net/2023/06/14/u7foyTsC2RGOhxt.png" alt=""></p><p>â€‹ç ”ç©¶çš„æ˜¯åŒç›®æ ‡ä¼˜åŒ–é—®é¢˜ï¼Œå³åŒæ—¶è®©|Ax-b|å’Œ|x|å°½å¯èƒ½åœ°å°ï¼Œè¿™åœ¨é²æ£’é€¼è¿‘ä¸­å¯è§£é‡Šä¸ºï¼šx è¾ƒå°æ—¶Ax=bå¯¹è¯¯å·®çš„é²æ£’æ€§æ›´å¥½</p><ol start="5"><li><p><strong>ä¿¡å·é‡æ„é—®é¢˜</strong></p><p>å‡è®¾ä¿¡å·è¢«åŠ æ€§å™ªå£° v æ±¡æŸ“ï¼Œå³<br>$$<br>x_{cor}=x+v<br>$$<br>â€‹æ‰€è°“<strong>ä¿¡å·é‡æ„</strong>ï¼Œå°±æ˜¯åœ¨ç»™å®šå—æ±¡æŸ“ä¿¡å· xcor çš„æƒ…å†µä¸‹ï¼Œæ„å»ºå¯¹åŸå§‹ä¿¡å· x çš„ä¼°è®¡å€¼ $\hat{x}$ï¼Œä¹Ÿå«<strong>å…‰æ»‘åŒ–</strong></p></li></ol><p>â€‹é‡æ„é—®é¢˜çš„ä¸€ä¸ªç®€å•å½¢å¼æ˜¯åŒå‡†åˆ™é—®é¢˜</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/wWBtCq4ouKRQpf8.png" alt=""></p><p>â€‹å…¶ä¸­ Î¦ æ˜¯å‡¸çš„ï¼Œç§°ä¸ºæ­£åˆ™åŒ–å‡½æ•°æˆ–å…‰æ»‘ç›®æ ‡ã€‚è¿™ä¸ªåŒå‡†åˆ™é—®é¢˜ï¼Œå°±æ˜¯è¦å¯»æ±‚ä¸€ä¸ªæ¥è¿‘è¢«æ±¡æŸ“ä¿¡å·å¹¶ä¸”å…‰æ»‘çš„ä¿¡å·</p><ul><li>â€‹<strong>äºŒæ¬¡å…‰æ»‘</strong></li></ul><img src="https://s2.loli.net/2023/06/14/zpAnhSduUiymxsj.png" style="zoom: 50%;" /><ul><li>â€‹<strong>æ€»å˜å·®é‡æ„</strong></li></ul><img src="https://s2.loli.net/2023/06/14/Csn6IaPi37WBqUd.png" style="zoom:67%;" /><ol start="6"><li><strong>é²æ£’é€¼è¿‘</strong></li></ol><p>â€‹é—®é¢˜å½¢å¼ä¸ºï¼Œåœ¨ A ä¸ç¡®å®šçš„æƒ…å†µä¸‹ï¼Œæœ€å¯èƒ½åœ°æœ€å°åŒ–$||Ax-b||$</p><p>â€‹ä¸¤ç§è§£å†³æ€è·¯ï¼š</p><ul><li>éšæœºï¼šå‡è®¾ A æ˜¯éšæœºçš„ï¼Œæœ€å°åŒ–$E||Ax-b||$</li><li>æœ€åæƒ…å†µï¼šæ±‚$min,sup||Ax-b||$</li></ul><h1>Lecture_10 Unconstrained minimization</h1><ol><li><strong>å®šä¹‰</strong></li></ol><p>â€‹å­—é¢æ„æ€ï¼Œæ²¡æœ‰çº¦æŸæ¡ä»¶çš„ä¼˜åŒ–é—®é¢˜ï¼Œæˆ‘ä»¬å‡è®¾ f æ˜¯å¯å¾®å‡¸å‡½æ•°ï¼Œé‚£ä¹ˆæ— çº¦æŸä¼˜åŒ–é—®é¢˜å…¶å®å°±æ˜¯å»æ±‚æ¢¯åº¦ä¸ºé›¶çš„ç‚¹</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/yhokBVYK4SmZ7tv.png" alt=""></p><ol start="2"><li><strong>ä¸‹é™æ–¹æ³•</strong></li></ol><p>â€‹å³é€‰æ‹©åˆé€‚çš„æœç´¢æ­¥é•¿ t</p><ul><li>â€‹<strong>ç²¾ç¡®ç›´çº¿æœç´¢</strong></li></ul><p>â€‹æ‰¾åˆ°è®©å‡½æ•°å€¼æœ€å°çš„é‚£ä¸ªæ­¥é•¿ tï¼Œå³<br>$$<br>t=argmin_{s \ge 0}, f(x+s\Delta x)<br>$$<br>â€‹å½“ç›®æ ‡å‡½æ•°å½¢å¼ç®€å•ï¼Œèƒ½æ±‚å¾—è§£æè§£æ—¶å¯è€ƒè™‘ä½¿ç”¨è¿™ç§æ–¹æ³•</p><ul><li>â€‹<strong>å›æº¯ç›´çº¿æœç´¢</strong></li></ul><p><img src="https://s2.loli.net/2023/06/14/9UpaeJWEyI3O5QF.png" alt=""></p><p>â€‹åŸºæœ¬æ€è·¯æ˜¯ï¼šå…ˆé‡‡ç”¨å•ä½æ­¥é•¿ï¼Œè‹¥ä¸æ»¡è¶³æ¡ä»¶ï¼Œåˆ™ä¸æ–­ç¼©å°ã€‚</p><p>â€‹æ»¡è¶³æ¡ä»¶æ—¶çš„å‡ ä½•æ„ä¹‰ï¼š$f(x+t\Delta x)$è½å…¥ä¸¤æ¡è™šçº¿ä¹‹é—´çš„èŒƒå›´</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/2cwMjJrspdaETqg.png" style="zoom:67%;" /></p><ol start="3"><li>å…¶ä½™å†…å®¹å‚è€ƒ<a href="https://qlhhahaha.github.io/2023/04/13/%E3%80%8A%E6%9C%80%E4%BC%98%E5%8C%96%E8%AE%A1%E7%AE%97%E6%96%B9%E6%B3%95%EF%BC%88%E6%96%87%E5%86%8D%E6%96%87%EF%BC%89%E7%AC%94%E8%AE%B0%E3%80%8B/#%E7%AC%AC%E5%9B%9B%E7%AB%A0%E3%80%81%E6%97%A0%E7%BA%A6%E6%9D%9F%E4%BC%98%E5%8C%96%E7%AE%97%E6%B3%95">ã€Šæœ€ä¼˜åŒ–è®¡ç®—æ–¹æ³•ï¼ˆæ–‡å†æ–‡ï¼‰ç¬”è®°ã€‹</a></li></ol><h1>Lecture_11 Equality constrained minimization</h1><ol><li><strong>å®šä¹‰</strong></li></ol><p>â€‹<img src="https://s2.loli.net/2023/06/14/jaecJsrBzb4qm2I.png" alt=""></p><p>â€‹x* ä¸ºæœ€ä¼˜ç‚¹çš„å……è¦æ¡ä»¶æ˜¯ï¼šå­˜åœ¨ v* æ»¡è¶³</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/noNjm1WsgJ9lSaF.png" alt=""></p><ol start="2"><li><p><strong>ç­‰å¼çº¦æŸäºŒæ¬¡è§„åˆ’</strong></p><p><img src="https://s2.loli.net/2023/06/14/GCusPihe2NI9qVo.png" alt=""></p></li></ol><p>â€‹é‚£ä¹ˆæ­¤æ—¶æœ€ä¼˜æ€§æ¡ä»¶ä¸ºï¼š<br>$$<br>Ax^<em>=b, Px^</em>+q+A^Tv^*=0<br>$$<br>â€‹å†™æˆçŸ©é˜µå½¢å¼ä¸ºï¼š</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/IyCaHxuVe9DgzlO.png" alt=""></p><p>â€‹ç§°ä¹‹ä¸ºç­‰å¼çº¦æŸä¼˜åŒ–é—®é¢˜çš„<strong>KKTæ¡ä»¶</strong></p><p>â€‹</p><ol start="3"><li><strong>ç­‰å¼çº¦æŸçš„Newtonæ–¹æ³•</strong></li></ol><p>â€‹<img src="https://s2.loli.net/2023/06/14/jaecJsrBzb4qm2I.png" alt=""></p><p>â€‹**æ€è·¯ï¼š**äºŒé˜¶taylorå±•å¼€è½¬æ¢ä¸º</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/JtYwfujRWzypMXd.png" alt=""></p><p>â€‹å³KKTæ¡ä»¶ä¸º</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/VjD9yaUTbcBxd2E.png" alt=""></p><p>â€‹æœ€åæ±‚è§£å‡ºæ¥çš„é‚£ä¸ª$\Delta x_{nt}$å°±æ˜¯newtonæ–¹å‘ï¼Œ$x+\Delta x_{nt}$æ˜¯å¯¹åŸé—®é¢˜çœŸæ­£çš„æœ€ä¼˜è§£ x* çš„ä¸€ä¸ªå¾ˆå¥½çš„ä¼°è®¡</p><p>â€‹</p><p>â€‹å¦å¤–ï¼Œæˆ‘ä»¬å®šä¹‰newtonå‡é‡ä¸ºï¼š</p><p><img src="https://s2.loli.net/2023/06/14/phw6qliF8BzTAuO.png" alt=""></p><p>â€‹æ•´ä¸ªç®—æ³•æµç¨‹ä¸ºï¼š</p><p>â€‹<img src="https://s2.loli.net/2023/06/14/odX7Gv6bLif8Vm9.png" alt=""></p>]]></content>
    
    
    <categories>
      
      <category>ç§‘ç ”åªä¸ºæŠŠä¸šæ¯•</category>
      
    </categories>
    
    
    <tags>
      
      <tag>åˆ†å¸ƒå¼</tag>
      
      <tag>å‡¸ä¼˜åŒ–</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ŠCS106Lç¬”è®°ã€‹</title>
    <link href="/2023/04/14/%E3%80%8ACS106L%E7%AC%94%E8%AE%B0%E3%80%8B/"/>
    <url>/2023/04/14/%E3%80%8ACS106L%E7%AC%94%E8%AE%B0%E3%80%8B/</url>
    
    <content type="html"><![CDATA[<div class="note note-success">            <p>è¯¾ç¨‹æ¥æºï¼šStanford-CS106L(22 fall)</p><p>è¯¾ç¨‹ä»‹ç»ï¼š<a href="https://github.com/qlhhahaha/HashMap_for_CS106L">HashMap_for_CS106L</a></p>          </div><h1>Lecture2ã€Types and Structs</h1><h2 id="ä¸€ã€Types">ä¸€ã€Types</h2><ul><li>**é™æ€è¯­è¨€ï¼š**æœ‰åå­—çš„ä¸œè¥¿ï¼ˆå˜é‡/å‡½æ•°ï¼‰è¦äººä¸ºç»™ç±»å‹</li><li>**åŠ¨æ€è¯­è¨€ï¼š**è¿è¡Œæ—¶è§£é‡Šå™¨æ ¹æ®current valueè‡ªåŠ¨ç»™ç±»å‹</li></ul><p><img src="https://s2.loli.net/2023/04/14/YX8tVdgN5bH6hiu.png" alt=""></p><p><img src="https://s2.loli.net/2023/04/14/kQbXxquftZjcAMz.png" alt=""></p><h1>Lecture3ã€Stream</h1><h2 id="ä¸€ã€cout">ä¸€ã€cout</h2><p>coutæ˜¯stdå†…åµŒçš„è¾“å‡ºæµï¼Œå®ƒçš„ç±»å‹æ˜¯std::ostreamï¼Œæ‰€ä»¥å…¶å®<strong>ä½ ä¹Ÿå®Œå…¨å¯ä»¥è‡ªå·±å®šä¹‰ä¸€ä¸ªstd::ostreamç±»å‹çš„è¾“å‡ºæµ</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">writeToStream</span><span class="hljs-params">(std::ostream&amp; anyOutputStream, <span class="hljs-type">int</span> favouriteNumber)</span> </span>&#123;<br>    anyOutputStream &lt;&lt; <span class="hljs-string">&quot;Writing to stream: &quot;</span><br>        &lt;&lt; favouriteNumber &lt;&lt; endl;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// Write an int to the user&#x27;s console.</span><br>    <span class="hljs-type">int</span> favouriteNumber = <span class="hljs-number">1729</span>;<br><br>    <span class="hljs-comment">// Write method to take any ostream</span><br>    <span class="hljs-function">std::ofstream <span class="hljs-title">fileOut</span><span class="hljs-params">(<span class="hljs-string">&quot;out.txt&quot;</span>)</span></span>;<br><br>    <span class="hljs-built_in">writeToStream</span>(cout, favouriteNumber);<br>    <span class="hljs-built_in">writeToStream</span>(fileOut, favouriteNumber + <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¼šåœ¨æ§åˆ¶å°ä¸Šè¾“å‡º1729ï¼Œåœ¨out.txtä¸­å†™å…¥1730</p><h2 id="äºŒã€cin">äºŒã€cin</h2><p>åŒç†ï¼Œå¯ä»¥è‡ªå·±åˆ›å»ºä¸€ä¸ªstd::istreamç±»å‹çš„è¾“å…¥æµ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//read numbers from a file</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">readNumbers</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// Create our istream and make it open the file</span><br>    <span class="hljs-function">std::istream <span class="hljs-title">input</span><span class="hljs-params">(<span class="hljs-string">&quot;res/numbers.txt&quot;</span>)</span></span>;<br>    <span class="hljs-type">int</span> value;<br>    <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) &#123;<br>        input &gt;&gt; value;<br>        <span class="hljs-keyword">if</span>(input.<span class="hljs-built_in">fail</span>())<br>            <span class="hljs-keyword">break</span>;<br>        cout &lt;&lt; <span class="hljs-string">&quot;Value read: &quot;</span> &lt;&lt; value &lt;&lt; endl;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><p><img src="https://s2.loli.net/2023/04/14/GxBvd9eRrohVJXI.png" alt=""></p><h1>Lecture4ã€Initialization and References</h1><h2 id="ä¸€ã€Initialization">ä¸€ã€Initialization</h2><ol><li>æ³¨æ„vectorä¸¤ç§åˆå§‹åŒ–çš„åŒºåˆ«</li></ol><p><img src="https://s2.loli.net/2023/04/14/kPzA2belKB5qnNr.png" alt="Untitled"></p><div class="note note-warning">            <p>ğŸ’¡ PS. å…¶ä¸­å¤§æ‹¬å·åˆå§‹åŒ–è¢«ç§°ä¸ºâ€œç»Ÿä¸€åˆå§‹åŒ–â€ï¼Œæ˜¯C11å¼•è¿›çš„ï¼Œå¯¹æ‰€æœ‰æ•°æ®ç±»å‹éƒ½é€‚ç”¨ï¼Œå¯ä»¥åœ¨declarationæ—¶ç«‹å³åˆå§‹åŒ–</p>          </div><ol start="2"><li><strong>ç»“æ„åŒ–ç»‘å®šï¼ˆstructured bindingï¼‰</strong></li></ol><p>â€‹ideaï¼šç»å…¸è¯­æ³•ä¸­ï¼Œä¸ºäº†æ¥æ”¶ä¸€ä¸ªstruct\pairï¼Œå¯èƒ½å¾—ç”¨ç‚¹å·å»ä¸€ä¸ªä¸ªè¯»å–ç»“æ„ä½“é‡Œçš„å€¼ï¼Œè¿™å¾ˆéº»çƒ¦ï¼›c17ä¸­å¼•å…¥ç»“æ„åŒ–ç»‘å®šï¼Œå¯ä»¥ç›´æ¥ç”¨<strong>auto+ä¸­æ‹¬å·</strong>å»æ¥æ”¶ï¼ˆè¯è¯´è¿™ä¸œè¥¿matlabé‡Œä¸æ˜¯æ—©æœ‰äº†å—ã€‚ã€‚ï¼‰</p><p><img src="https://s2.loli.net/2023/04/14/suEOq9jPceZ7LD8.png" alt=""></p><h2 id="äºŒã€References">äºŒã€References</h2><p>ä¸€ä¸ªç»å…¸çš„å¼•ç”¨errorï¼šæƒ³ç»™pairä¸­çš„æ¯ä¸ªå€¼åŠ ä¸€</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">shift</span><span class="hljs-params">(vector&lt;std::pair&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt;&gt;&amp; nums)</span> </span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> [num1, num2]: nums) <br>&#123;<span class="hljs-comment">//æ˜¾ç„¶é”™äº†ï¼Œå› ä¸ºnum1ã€2æ˜¯numsçš„å‰¯æœ¬ï¼Œå¼€è¾Ÿäº†æ–°ç©ºé—´</span><br>num1++;<br>num2++;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åº”è¯¥ä¿®æ”¹ä¸º for (auto&amp; [num1, num2]: nums)</p><h1>Lecture5ã€Container</h1><ol><li>ä¸è¦ææ··vectorçš„_sizeå’Œ_capacityå±æ€§</li></ol><p><img src="https://s2.loli.net/2023/04/14/Zv2KtfI5RH7MVgW.png" alt=""></p><h1>Lecture7ã€Classes</h1><ol><li>STLä¸­æ‰€æœ‰çš„containeréƒ½æ˜¯class</li><li><strong>æ¨¡æ¿ç±»ï¼ˆtemplate classï¼‰</strong></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//æ¨¡æ¿ç±»è¯­æ³•</span><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> First, <span class="hljs-keyword">typename</span> Second&gt; <span class="hljs-keyword">class</span> <span class="hljs-title class_">my_pair</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br><span class="hljs-function">First <span class="hljs-title">get_first</span><span class="hljs-params">()</span></span>;<br><span class="hljs-function">Second <span class="hljs-title">get_second</span><span class="hljs-params">()</span></span>;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">set_first</span><span class="hljs-params">(First f)</span></span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">set_second</span><span class="hljs-params">(Second f)</span></span>;<br><br><span class="hljs-keyword">private</span>:<br>First first;<br>Second second;<br>&#125;;<br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/*****************vector.h********************/</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;vector.cpp&quot;</span>           <span class="hljs-comment">//ps2</span></span><br><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">vector</span>&lt;T&gt;<br>&#123;<br><span class="hljs-function">T <span class="hljs-title">my_at</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span></span>;<br>&#125;<br><br><span class="hljs-comment">/*****************vector.cpp********************/</span><br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;       <span class="hljs-comment">//ps1</span><br><span class="hljs-type">void</span> vector&lt;T&gt;::<span class="hljs-built_in">my_at</span>(<span class="hljs-type">int</span> i)<br>&#123;<br><span class="hljs-comment">//oops</span><br>&#125;<br><br><span class="hljs-comment">/*****************main.cpp********************/</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;vector.h&quot;</span></span><br>vector&lt;<span class="hljs-type">int</span>&gt; a;<br>a.<span class="hljs-built_in">my_at</span>(<span class="hljs-number">5</span>);<br></code></pre></td></tr></table></figure><div class="note note-warning">            <aside> ğŸ’¡ PS.<ol><li>é¦–å…ˆï¼Œæ³¨æ„å¿…é¡»åœ¨æ¯ä¸ªæˆå‘˜å‡½æ•°é‚£å„¿å»å£°æ˜ä¸€éå®ƒæ˜¯templateï¼Œä¹Ÿå°±æ˜¯å»æ‰ps1é‚£ä¸€è¡Œä¼šæŠ¥é”™</li><li>ps2é‚£ä¸€è¡Œï¼Œæ³¨æ„ï¼Œvector.hå¤´æ–‡ä»¶é‡Œè¦include â€œvector.cppâ€ï¼Œå¦åˆ™æ‰¾ä¸åˆ°my_at()å‡½æ•°çš„å…·ä½“å®šä¹‰ ï¼ˆæƒ³äº†è€åŠå¤©ä¹Ÿæ²¡æƒ³æ¸…æ¥šä¸ºå•¥ã€‚ã€‚å—¯è®°ç€å§ï¼‰</li><li>ä¸€èˆ¬ä¸åœ¨å¤´æ–‡ä»¶é‡Œincludeæºæ–‡ä»¶ï¼Œå› ä¸ºå¯èƒ½é€ æˆé‡å¤å®šä¹‰ï¼›ä½†ä¹Ÿæœ‰ä¸€äº›åœºæ™¯æˆ–è®¸ä¼šç”¨ï¼Œæ¯”å¦‚vscodeé‡Œæ‡’å¾—å†™cmakeè„šæœ¬ï¼Œå°±å¯ä»¥ç”¨include&lt;.cpp&gt;è¿™ç§trickã€‚ã€‚</li></ol>          </div><p><img src="https://s2.loli.net/2023/04/14/oDHRjb3kGdw2ON8.jpg" alt=""></p><h1>Lecture9ã€Template Functions</h1><ol><li><p>**motivationï¼š**ä¸€ä¸ªåŠŸèƒ½é€šç”¨æ€§å¾ˆå¼ºçš„å‡½æ•°ï¼Œè¦å› ä¸ºæ¥æ”¶å‚æ•°æ•°æ®ç±»å‹ä¸åŒè€Œå¤åˆ¶ç²˜è´´å¤šä¸ªç‰ˆæœ¬å—ï¼Ÿå½“ç„¶ï¼Œfunction overloadingå¯ä»¥ç®€åŒ–è¿™ä¸ªé—®é¢˜ï¼Œä½†ä»ç„¶å¾—å¤åˆ¶ç²˜è´´ï¼Œèƒ½ä¸èƒ½æŠŠè¿™ä¸ªå‡½æ•°ç»™ä¸€èˆ¬åŒ–ï¼Œä»æ ¹æºä¸Šè§£å†³é—®é¢˜æï¼Ÿ</p><p><img src="https://s2.loli.net/2023/04/14/xJfgFth1wOmLb5I.png" alt=""></p></li><li><p><strong>æ¨¡æ¿å‡½æ•°ï¼ˆTemplate Functionsï¼‰</strong></p><p><img src="https://s2.loli.net/2023/04/14/9zcsDjKper6XuOI.png" alt=""></p><p>å…¶ä¸­typenameå¯ä»¥è®¾å®šé»˜è®¤å‚æ•°ï¼Œå³å†™æˆtemplate<typename Type=int></p><p>åœ¨å®ä¾‹åŒ–ä½¿ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥æ˜¾å¼å®šä¹‰Type</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">cout &lt;&lt; <span class="hljs-built_in">myMin</span>&lt;<span class="hljs-type">int</span>&gt;(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>) &lt;&lt; endl;<br></code></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œå®ƒè¿˜å¯ä»¥æ›´èªæ˜â€”â€”æˆ‘ä»¬éšå¼å£°æ˜å˜é‡ï¼Œè®©ç¼–è¯‘å™¨è‡ªå·±æ¨æ–­</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T, <span class="hljs-keyword">typename</span> U&gt;<br><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">smarterMyMin</span><span class="hljs-params">(T a, U b)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">return</span> a &lt; b ? a : b;<br>&#125;<br><br>cout &lt;&lt; <span class="hljs-built_in">smarterMyMin</span>(<span class="hljs-number">3.2</span>, <span class="hljs-number">4</span>) &lt;&lt; endl;<br></code></pre></td></tr></table></figure><div class="note note-warning">            <p>ğŸ’¡ PS. æ³¨æ„ï¼šæ¨¡æ¿ç±»å’Œæ¨¡æ¿å‡½æ•°éƒ½æ˜¯åœ¨ä½¿ç”¨ï¼ˆå³å®ä¾‹åŒ–ï¼‰ä¹‹åæ‰ä¼šç¼–è¯‘ï¼ä¸ç”¨å°±ä¸ç¼–è¯‘ã€‚ è€Œä¸åŒçš„å®ä¾‹åŒ–ç¼–è¯‘å‡ºçš„ç»“æœä¹Ÿä¸ä¸€æ ·ï¼Œæ‰€ä»¥å…¶å®æ˜¯ç¼–è¯‘å™¨å¸®ä½ å®Œæˆäº†â€œå¤åˆ¶ç²˜è´´å¤šä¸ªç‰ˆæœ¬â€è¿™ä¸€æ­¥ã€‚</p>          </div></li></ol><h1>Lecture10ã€Lambda Functions</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;algorithm&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cmath&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">abssort</span><span class="hljs-params">(<span class="hljs-type">float</span>* x, <span class="hljs-type">unsigned</span> n)</span> </span>&#123;<br>    std::<span class="hljs-built_in">sort</span>(x, x + n,<br>        <span class="hljs-comment">// Lambda expression begins</span><br>        [](<span class="hljs-type">float</span> a, <span class="hljs-type">float</span> b) &#123;<br>            <span class="hljs-built_in">return</span> (std::<span class="hljs-built_in">abs</span>(a) &lt; std::<span class="hljs-built_in">abs</span>(b));<br>        &#125; <span class="hljs-comment">// end of lambda expression</span><br>    );<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2023/04/14/N5Y3hbXFqJDOmaU.png" alt=""></p><p><strong>æ•è·åˆ—è¡¨çš„ä½œç”¨ï¼š</strong></p><ol><li>[ ]æ˜¯lambdaå¼•å‡ºç¬¦ï¼Œç¼–è¯‘å™¨æ ¹æ®è¯¥å¼•å‡ºç¬¦åˆ¤æ–­æ¥ä¸‹æ¥çš„ä»£ç æ˜¯å¦æ˜¯lambdaå‡½æ•°</li><li>æ•æ‰ä¸Šä¸‹æ–‡ä¸­çš„å˜é‡ä¾›lambdaä½¿ç”¨</li></ol><p><strong>æ•è·åˆ—è¡¨ä½¿ç”¨ï¼š</strong></p><ul><li>[ ]è¡¨ç¤ºä¸æ•è·ä»»ä½•å˜é‡</li><li>[var]ã€[&amp;var]åˆ†åˆ«è¡¨ç¤ºä»¥å€¼ä¼ é€’å’Œå¼•ç”¨ä¼ é€’çš„æ–¹å¼æ•æ‰å˜é‡var</li><li>[=]ã€[&amp;]åˆ†åˆ«è¡¨ç¤ºä»¥å€¼ä¼ é€’å’Œå¼•ç”¨ä¼ é€’æ–¹å¼æ•è·æ‰€æœ‰<strong>çˆ¶ä½œç”¨åŸŸ</strong>çš„å˜é‡</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">int</span> index = <span class="hljs-number">1</span>;<br><span class="hljs-type">int</span> num = <span class="hljs-number">100</span>;<br><span class="hljs-keyword">auto</span> function = ([]()<br>&#123;num = <span class="hljs-number">1000</span>;<br>index = <span class="hljs-number">2</span>;<br>std::cout &lt;&lt; <span class="hljs-string">&quot;index: &quot;</span>&lt;&lt; index &lt;&lt; <span class="hljs-string">&quot;, &quot;</span> <br>            &lt;&lt; <span class="hljs-string">&quot;num: &quot;</span>&lt;&lt; num &lt;&lt; std::endl; &#125;);<br><br><span class="hljs-built_in">function</span>();<br><span class="hljs-comment">//æŠ¥é”™ï¼Œå› ä¸ºæ²¡å»æ•è·numå’Œindexå°±åœ¨ä½¿ç”¨å®ƒä»¬</span><br><br><span class="hljs-type">int</span> index = <span class="hljs-number">1</span>;<br><span class="hljs-type">int</span> num = <span class="hljs-number">100</span>;<br><span class="hljs-keyword">auto</span> function = ([=]()<br>&#123;num = <span class="hljs-number">1000</span>;<br>index = <span class="hljs-number">2</span>;<br>std::cout &lt;&lt; <span class="hljs-string">&quot;index: &quot;</span>&lt;&lt; index &lt;&lt; <span class="hljs-string">&quot;, &quot;</span> <br>            &lt;&lt; <span class="hljs-string">&quot;num: &quot;</span>&lt;&lt; num &lt;&lt; std::endl; &#125;);<br><br><span class="hljs-built_in">function</span>();<br><span class="hljs-comment">//æŠ¥é”™ï¼Œå› ä¸ºlambdaçš„å€¼å¼•ç”¨é»˜è®¤ä¸èƒ½ä¿®æ”¹ï¼Œè¦ä¿®æ”¹çš„è¯å¾—åŠ mutableå…³é”®å­—</span><br><br><span class="hljs-type">int</span> index = <span class="hljs-number">1</span>;<br><span class="hljs-type">int</span> num = <span class="hljs-number">100</span>;<br><span class="hljs-keyword">auto</span> function = ([=]()<span class="hljs-keyword">mutable</span><br>&#123;num = <span class="hljs-number">1000</span>;<br>index = <span class="hljs-number">2</span>;<br>std::cout &lt;&lt; <span class="hljs-string">&quot;index: &quot;</span>&lt;&lt; index &lt;&lt; <span class="hljs-string">&quot;, &quot;</span> <br>            &lt;&lt; <span class="hljs-string">&quot;num: &quot;</span>&lt;&lt; num &lt;&lt; std::endl; &#125;);<br><br><span class="hljs-built_in">function</span>();<br><span class="hljs-comment">//æ­£ç¡®ï¼Œå› ä¸ºåŠ äº†mutableå…³é”®å­—ï¼Œå€¼ä¼ é€’å˜é‡å¯ä¿®æ”¹ï¼ˆä½†æ”¹çš„ä¹Ÿæ˜¯å‰¯æœ¬ï¼Œä¸å½±å“åŸå€¼ï¼‰</span><br><br><span class="hljs-type">int</span> index = <span class="hljs-number">1</span>;<br><span class="hljs-type">int</span> num = <span class="hljs-number">100</span>;<br><span class="hljs-keyword">auto</span> function = ([&amp;]()<br>&#123;num = <span class="hljs-number">1000</span>;<br>index = <span class="hljs-number">2</span>;<br>std::cout &lt;&lt; <span class="hljs-string">&quot;index: &quot;</span>&lt;&lt; index &lt;&lt; <span class="hljs-string">&quot;, &quot;</span> <br>            &lt;&lt; <span class="hljs-string">&quot;num: &quot;</span>&lt;&lt; num &lt;&lt; std::endl; &#125;);<br><br><span class="hljs-built_in">function</span>();<br><span class="hljs-comment">//æ­£ç¡®ï¼Œå¼•ç”¨ä¼ é€’çš„å€¼å¯ä»¥ä¿®æ”¹</span><br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šè¿°ä»£ç ä¸ºä¾‹ï¼Œæ€è€ƒLambdaçš„æ„ä¹‰ï¼ˆå’Œæ™®é€šå‡½æ•°ç›¸æ¯”ï¼‰ï¼š</p><ol><li><p>çœå»å®šä¹‰ä¸€ä¸ªå®Œæ•´å‡½æ•°ã€ç»™å‡½æ•°å‘½åçš„è¿‡ç¨‹ï¼Œå¯¹äºè¿™ç§<strong>ä¸éœ€è¦å¤ç”¨</strong>ï¼Œä¸”<strong>çŸ­å°</strong>çš„å‡½æ•°ï¼Œç›´æ¥ä¼ é€’å‡½æ•°ä½“å¯ä»¥å¢åŠ ä»£ç çš„å¯è¯»æ€§ã€‚æ‰€ä»¥lambdaå‡½æ•°åˆå«â€œåŒ¿åå‡½æ•°â€ã€‚</p><div class="note note-warning">            <p>ğŸ’¡ PS. ä¸è¦å°çœ‹â€œçœç•¥å‘½åâ€è¿™ä»¶äº‹ï¼Œè¡¨é¢ä¸Šçœ‹å®ƒåªæ˜¯å°‘äº†ä¸ªåå­—ï¼Œä½†å®è´¨æ˜¯æŠŠå®ƒçœ‹ä½œä¸€ä¸ªæ™®é€šçš„â€œæ“ä½œè¿‡ç¨‹â€è€Œéâ€œå¯¹è±¡â€ã€‚å°±åƒä½ ä¼šç»™ä¸€ä¸ªå˜é‡ã€ç±»ã€å‡½æ•°å‘½åï¼Œä½†ä¸ä¼šå•ç‹¬ç»™â€œæŠŠaä¹˜ä¸Šcçš„3æ¬¡æ–¹å†åŠ 123å†é™¤321â€è¿™ç§çº¯è¿‡ç¨‹å»å‘½ä¸ªåï¼ˆé™¤éè¿™ä¸ªæ“ä½œå¤ç”¨ç‡è¶³å¤Ÿé«˜ï¼‰ï¼Œå› ä¸ºå®ƒæŠ½è±¡ç¨‹åº¦å¤ªä½ï¼Œå³ç”¨å³æ‰”ã€‚ <strong>è€Œæ‰€æœ‰å€¼å¾—å»å‘½åçš„ä¸œè¥¿ï¼Œéƒ½åº”è¯¥æ˜¯ä¼šå¤ç”¨ä¸”æŠ½è±¡ç¨‹åº¦è¶³å¤Ÿçš„ã€‚æˆ‘è®¤ä¸ºè¿™æ˜¯ç¼–ç¨‹ä¸­çš„ä¸€ç§å“²å­¦æ€æƒ³ã€‚</strong> å¦‚ï¼šä¸€ä¸ªæ™®é€šæ“ä½œå¤ç”¨ç¨‹åº¦è¶³å¤Ÿé«˜æ—¶ï¼ˆæ¯”è¾ƒint aã€int bå¤§å°ï¼‰ï¼Œå°±æŠŠå®ƒæŠ½è±¡ä¸ºä¸€ä¸ªå‡½æ•°ï¼ˆmaxå‡½æ•°ï¼‰ï¼›è€Œè¿™ä¸ªå‡½æ•°å¤ç”¨ç‡å¤Ÿé«˜æ—¶ï¼Œå°±è¿›ä¸€æ­¥æŠ½è±¡ä¸ºtemplate function</p>          </div></li><li><p>å…è®¸å‡½æ•°ä½œä¸ºä¸€ä¸ªå¯¹è±¡è¿›è¡Œ<strong>ä¼ é€’</strong>ï¼šlambdaä¹Ÿå¯ä»¥å‘½åï¼Œç„¶åå°†å…¶è¿›è¡Œä¼ é€’ã€‚è¿™ç§æ–¹å¼å’Œä¼ ç»Ÿçš„å‡½æ•°æŒ‡é’ˆæ¯”èµ·æ¥æ›´åŠ ç®€æ˜ã€‚</p></li><li><p>å¼•å…¥<strong>é—­åŒ…</strong>ï¼šé—­åŒ…æ˜¯æŒ‡å°†å½“å‰ä½œç”¨åŸŸä¸­çš„å˜é‡é€šè¿‡å€¼æˆ–è€…å¼•ç”¨çš„æ–¹å¼å°è£…åˆ°lambdaè¡¨è¾¾å¼å½“ä¸­ï¼Œæˆä¸ºè¡¨è¾¾å¼çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒä½¿ä½ çš„lambdaè¡¨è¾¾å¼ä»ä¸€ä¸ªæ™®é€šçš„å‡½æ•°å˜æˆäº†ä¸€ä¸ªå¸¦éšè—å‚æ•°çš„å‡½æ•°ã€‚</p></li></ol><p>å¸¸è§åº”ç”¨åœºæ™¯ï¼š</p><ol><li><p><strong>ç”¨äºstlç®—æ³•åº“</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// for_eachåº”ç”¨å®ä¾‹</span><br><span class="hljs-type">int</span> a[<span class="hljs-number">4</span>] = &#123;<span class="hljs-number">11</span>, <span class="hljs-number">2</span>, <span class="hljs-number">33</span>, <span class="hljs-number">4</span>&#125;;<br><span class="hljs-built_in">sort</span>(a, a+<span class="hljs-number">4</span>, [=](<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y) -&gt; <span class="hljs-type">bool</span> &#123; <span class="hljs-keyword">return</span> x%<span class="hljs-number">10</span> &lt; y%<span class="hljs-number">10</span>; &#125; );<br>for_each(a, a+<span class="hljs-number">4</span>, [=](<span class="hljs-type">int</span> x) &#123; cout &lt;&lt; x &lt;&lt; <span class="hljs-string">&quot; &quot;</span>;&#125; );<br></code></pre></td></tr></table></figure><div class="note note-warning">            <p>ğŸ’¡ PS. foreach()è¿™ä¸ªä¸œè¥¿åœ¨#include<algorithm>é‡Œï¼Œæ˜¯ä¸ªtemplate functionï¼Œå…¶å‰ä¸¤ä¸ªå‚æ•°æ˜¯beginå’ŒendæŒ‡é’ˆ</p>          </div></li><li><p><em><strong>*ç”¨äºå¤šçº¿ç¨‹åœºæ™¯*</strong></em></p></li><li><p><strong>ä½œä¸ºå‡½æ•°çš„å…¥å‚</strong></p></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">using</span> FuncCallback = std::function&lt;<span class="hljs-built_in">void</span>(<span class="hljs-type">void</span>)&gt;;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DataCallback</span><span class="hljs-params">(FuncCallback callback)</span></span><br><span class="hljs-function"></span>&#123;<br>std::cout &lt;&lt; <span class="hljs-string">&quot;Start FuncCallback!&quot;</span> &lt;&lt; std::endl;<br><span class="hljs-built_in">callback</span>();<br>std::cout &lt;&lt; <span class="hljs-string">&quot;End FuncCallback!&quot;</span> &lt;&lt; std::endl;<br>&#125;<br><br><span class="hljs-keyword">auto</span> callback_handler = [&amp;]()&#123;<br>std::cout &lt;&lt; <span class="hljs-string">&quot;This is callback_handler&quot;</span>;<br>&#125;;<br><br><span class="hljs-built_in">DataCallback</span>(callback_handler);<br></code></pre></td></tr></table></figure><h1>Lecture12ã€Specical Member Functions(6ä¸ª)</h1><ol><li><p><strong>ä»‹ç»ï¼š</strong></p><p>C++ä¸­ç±»çš„ç‰¹æ®Šæˆå‘˜å‡½æ•°æœ‰6ä¸ªï¼Œå¯¹äºä¸€ä¸ªç±»</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setData</span><span class="hljs-params">(<span class="hljs-type">int</span> data)</span> </span>&#123; m_data = data; &#125;<br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">getData</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>&#123; <span class="hljs-keyword">return</span> m_data; &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">int</span> m_data;<br>&#125;;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬ç”Ÿæˆè¿™äº›ç‰¹æ®Šæˆå‘˜å‡½æ•°ï¼Œæ‰€ä»¥ç±»Açš„å®šä¹‰ç­‰ä»·äºå¦‚ä¸‹ï¼Œ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">A</span>() &#123;&#125;; <span class="hljs-comment">// é»˜è®¤æ„é€ å‡½æ•°</span><br>    <span class="hljs-built_in">A</span>(<span class="hljs-type">const</span> A&amp; other) &#123; m_data = other.m_data; &#125; <span class="hljs-comment">// æ‹·è´æ„é€ å‡½æ•°</span><br>    A&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> A&amp; other) &#123; m_data = other.m_data; <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>; &#125; <span class="hljs-comment">// æ‹·è´èµ‹å€¼æ„é€ å‡½æ•°</span><br>    ~<span class="hljs-built_in">A</span>() &#123;&#125; <span class="hljs-comment">// ææ„å‡½æ•°</span><br>    <span class="hljs-built_in">A</span>(A&amp;&amp; other) &#123; m_data = other.m_data; &#125; <span class="hljs-comment">// ç§»åŠ¨æ„é€ å‡½æ•°</span><br>    A&amp; <span class="hljs-keyword">operator</span>=(A&amp;&amp; other) &#123; m_data = other.m_data; <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>; &#125; <span class="hljs-comment">// ç§»åŠ¨èµ‹å€¼æ„é€ å‡½æ•°</span><br><br><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setData</span><span class="hljs-params">(<span class="hljs-type">int</span> data)</span> </span>&#123; m_data = data; &#125;<br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">getData</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>&#123; <span class="hljs-keyword">return</span> m_data; &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">int</span> m_data;<br>&#125;;<br></code></pre></td></tr></table></figure></li><li><p><strong>æ‹·è´æ„é€ å‡½æ•°ï¼ˆcopy constructorï¼‰</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream &gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Complex</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-type">double</span> real, imag;<br>    <span class="hljs-built_in">Complex</span>(<span class="hljs-type">double</span> r, <span class="hljs-type">double</span> i) &#123;<br>        real= r; imag = i;<br>    &#125;<br>&#125;;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-function">Complex <span class="hljs-title">cl</span><span class="hljs-params">(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)</span></span>;<br>    <span class="hljs-function">Complex <span class="hljs-title">c2</span> <span class="hljs-params">(cl)</span></span>;  <span class="hljs-comment">//ç”¨æ‹·è´æ„é€ å‡½æ•°åˆå§‹åŒ–c2</span><br>    cout&lt;&lt;c2.real&lt;&lt;<span class="hljs-string">&quot;,&quot;</span>&lt;&lt;c2.imag;  <span class="hljs-comment">//è¾“å‡º 1,2</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœç”¨æˆ·è‡ªå·±ç¼–å†™äº†å¤åˆ¶æ„é€ å‡½æ•°ï¼Œåˆ™é»˜è®¤å¤åˆ¶æ„é€ å‡½æ•°å°±ä¸å­˜åœ¨äº†</p></li><li><p><strong>æ‹·è´èµ‹å€¼æ„é€ å‡½æ•°ï¼ˆcopy assignment constructorï¼‰</strong></p><p>å¯¹â€œï¼â€è¿›è¡Œé‡è½½ï¼Œä½œç”¨æ˜¯è®©ä¸¤ä¸ªå·²ç»åˆå§‹åŒ–å®Œæ¯•çš„ç±»è¿›è¡Œæ‹·è´</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs CPP">myclass A,Bï¼›<br>A = Bï¼›<br></code></pre></td></tr></table></figure></li></ol><div class="note note-warning">            <p>â€‹ğŸ’¡ PS. ä¸Šè¿°ä¸¤ä¸ªæ„é€ å‡½æ•°çš„åº”ç”¨å…¶å®éƒ½éå¸¸éå¸¸å¹¿æ³› â€”â€” åˆ«å¿˜äº†ï¼Œstlçš„å®¹å™¨å…¨éƒ½æ˜¯ç±»ï¼ vector<int>nums1 = nums2ä¹Ÿç”¨äº†æ‹·è´èµ‹å€¼æ„é€ å‡½æ•°ï¼</p>          </div><ol start="4"><li><strong>æ·±æ‹·è´ä¸æµ…æ‹·è´</strong></li></ol><ul><li><p>å¤§éƒ¨åˆ†æ­£å¸¸æƒ…å†µä¸‹åªéœ€è¦æµ…æ‹·è´ï¼ˆå¦‚åŸºæœ¬æ•°æ®ç±»å‹ã€ç®€å•çš„ç±»ï¼‰ï¼Œint A = Bï¼Œå°±æ˜¯Bæ‰€åœ¨å†…å­˜ä¸­çš„æ•°æ®æŒ‰äºŒè¿›åˆ¶ä½ï¼ˆbitï¼‰å¤åˆ¶åˆ°Aæ‰€åœ¨çš„å†…å­˜</p></li><li><p>æ·±æ‹·è´ç”¨äºä»€ä¹ˆæƒ…å†µæï¼Ÿå‡è®¾æœ‰æŸä¸ªç±»æœ‰ä¸¤ä¸ªå®ä¾‹Aã€Bï¼Œç±»æŒæœ‰**åŠ¨æ€åˆ†é…çš„å†…å­˜/æŒ‡å‘å…¶ä»–æ•°æ®çš„æŒ‡é’ˆï¼Œ**é‚£æ­¤æ—¶å°±ä¸èƒ½ç®€å•åœ°A = Bï¼Œå¦åˆ™Aä¸­çš„æŒ‡é’ˆä¹Ÿä¼šæŒ‡å‘Bä¸­æŒ‡é’ˆå¯¹åº”çš„å†…å­˜ï¼Œè¿™æ ·ä¸€æ¥ï¼Œä¸€ä¿®æ”¹Aï¼ŒBä¹Ÿä¼šéšä¹‹è¢«ä¿®æ”¹ï¼Œæ²¡è¾¾åˆ°æ‹·è´çš„æ•ˆæœã€‚</p><p>æ­£ç¡®åšæ³•æ˜¯ï¼Œå»æ˜¾å¼åœ°å®šä¹‰ä¸€ä¸ªæ‹·è´æ„é€ å‡½æ•°ï¼Œå®ƒé™¤äº†ä¼šå°†åŸæœ‰å¯¹è±¡çš„æ‰€æœ‰æˆå‘˜å˜é‡æ‹·è´ç»™æ–°å¯¹è±¡ï¼Œè¿˜ä¼šä¸ºæ–°å¯¹è±¡å†åˆ†é…ä¸€å—å†…å­˜ï¼Œå¹¶å°†åŸæœ‰å¯¹è±¡æ‰€æŒæœ‰çš„å†…å­˜ä¹Ÿæ‹·è´è¿‡æ¥ã€‚è¿™æ ·åšçš„ç»“æœæ˜¯ï¼Œ<strong>åŸæœ‰å¯¹è±¡å’Œæ–°å¯¹è±¡æ‰€æŒæœ‰çš„åŠ¨æ€å†…å­˜æ˜¯ç›¸äº’ç‹¬ç«‹çš„</strong>ï¼Œæ›´æ”¹ä¸€ä¸ªå¯¹è±¡çš„æ•°æ®ä¸ä¼šå½±å“å¦å¤–ä¸€ä¸ªå¯¹è±¡ã€‚</p></li></ul><div class="note note-warning">            <p>â€‹ğŸ’¡ PS. å¦‚æœä¸€ä¸ªç±»æ‹¥æœ‰æŒ‡é’ˆç±»å‹çš„æˆå‘˜å˜é‡ï¼Œé‚£ä¹ˆç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹å°±éœ€è¦æ·±æ‹·è´ï¼Œå› ä¸ºåªæœ‰è¿™æ ·ï¼Œæ‰èƒ½å°†æŒ‡é’ˆæŒ‡å‘çš„å†…å®¹å†å¤åˆ¶å‡ºä¸€ä»½æ¥ï¼Œè®©åŸæœ‰å¯¹è±¡å’Œæ–°ç”Ÿå¯¹è±¡ç›¸äº’ç‹¬ç«‹ï¼Œå½¼æ­¤ä¹‹é—´ä¸å—å½±å“ã€‚å¦‚æœç±»çš„æˆå‘˜å˜é‡æ²¡æœ‰æŒ‡é’ˆï¼Œä¸€èˆ¬æµ…æ‹·è´è¶³çŸ£ã€‚</p>          </div><ul><li><strong>æ·±æ‹·è´çš„å¼€é”€å¾€å¾€æ¯”æµ…æ‹·è´å¤§</strong>ï¼ˆé™¤éæ²¡æœ‰æŒ‡å‘åŠ¨æ€åˆ†é…å†…å­˜çš„å±æ€§ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å€¾å‘äºå°½å¯èƒ½ä½¿ç”¨æµ…æ‹·è´</li></ul><ol start="5"><li><p><strong>å·¦å€¼ã€å³å€¼</strong></p><ul><li><p>å·¦å€¼ï¼ˆlvalueï¼‰ï¼šè¡¨è¾¾å¼ç»“æŸåä¾ç„¶å­˜åœ¨çš„æŒä¹…å¯¹è±¡</p></li><li><p>å³å€¼ï¼ˆrvalueï¼‰ï¼šè¡¨è¾¾å¼ç»“æŸåå°±ä¸å†å­˜åœ¨çš„ä¸´æ—¶å¯¹è±¡ã€‚å­—é¢é‡ï¼ˆå­—ç¬¦å­—é¢é‡é™¤å¤–ï¼‰ã€ä¸´æ—¶çš„è¡¨è¾¾å¼å€¼ã€ä¸´æ—¶çš„å‡½æ•°è¿”è¿˜å€¼è¿™äº›çŸ­æš‚å­˜åœ¨çš„å€¼éƒ½æ˜¯å³å€¼ã€‚</p></li></ul><p>æ›´ç›´è§‚çš„ç†è§£æ˜¯ï¼šæœ‰å˜é‡åçš„å¯¹è±¡éƒ½æ˜¯å·¦å€¼ï¼Œæ²¡æœ‰å˜é‡åçš„éƒ½æ˜¯å³å€¼ã€‚ï¼ˆå› ä¸ºæœ‰æ— å˜é‡åæ„å‘³ç€è¿™ä¸ªå¯¹è±¡æ˜¯å¦åœ¨ä¸‹ä¸€è¡Œä»£ç æ—¶ä¾ç„¶å­˜åœ¨ï¼‰</p></li></ol><p>â€‹<div class="note note-warning">            <p>â€‹ğŸ’¡ PS. å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå­—ç¬¦å­—é¢é‡æ˜¯å”¯ä¸€ä¸å¯ç®—å…¥å³å€¼çš„å­—é¢é‡ï¼Œå› ä¸ºå®ƒå®é™…å­˜å‚¨åœ¨é™æ€å†…å­˜åŒºï¼Œæ˜¯æŒä¹…å­˜åœ¨çš„</p><p>â€‹</p>          </div></p><ol start="6"><li><p><strong>å³å€¼å¼•ç”¨</strong></p><p>å³å€¼å¼•ç”¨ç±»å‹ &amp;&amp;ç”¨äºåŒ¹é…å³å€¼ï¼Œå·¦å€¼å¼•ç”¨&amp;ç”¨äºåŒ¹é…å·¦å€¼</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//å·¦å€¼å¼•ç”¨å½¢å‚=&gt;åŒ¹é…å·¦å€¼</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Vector::Copy</span><span class="hljs-params">(Vector&amp; v)</span></span>&#123;<br>    <span class="hljs-keyword">this</span>-&gt;num = v.num;<br>    <span class="hljs-keyword">this</span>-&gt;a = <span class="hljs-keyword">new</span> <span class="hljs-type">int</span>[num];<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;num;++i)&#123;a[i]=v.a[i]&#125;<br>&#125;<br><br><span class="hljs-comment">//å³å€¼å¼•ç”¨å½¢å‚=&gt;åŒ¹é…å³å€¼</span><br><span class="hljs-type">void</span> Vector::<span class="hljs-built_in">Copy</span>(Vector&amp;&amp; temp)&#123;<br>    <span class="hljs-keyword">this</span>-&gt;num = temp.num;<br>    <span class="hljs-keyword">this</span>-&gt;a = temp.a;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸€ä¸ªå¯¹åº”å…³ç³»ï¼š</p><p>å·¦å€¼ â€”â€” å·¦å€¼å¼•ç”¨ â€”â€” æ·±æ‹·è´</p><p>å³å€¼ â€”â€” å³å€¼å¼•ç”¨ â€”â€” æµ…æ‹·è´</p><p>è¿™å’Œæ·±æµ…æ‹·è´çš„å®šä¹‰æ˜¯ç›¸ç¬¦çš„ï¼Œå› ä¸ºå³å€¼ä¸´æ—¶å­˜åœ¨ï¼Œç”¨å®Œå°±ä¸¢ï¼Œæ‰€ä»¥å°±ä¸å­˜åœ¨æ‹·è´ä¹‹ååŠ¨æ€åˆ†é…å†…å­˜å†²çªçš„é—®é¢˜ï¼Œé‚£å°±åªéœ€è¦æµ…æ‹·è´ï¼›å·¦å€¼åä¹‹</p></li><li><p><strong>å¼ºè½¬å³å€¼std::move()</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">()</span></span>&#123;<br>    Vector result;<br>    <span class="hljs-comment">//...DoSomething with result</span><br><br>    <span class="hljs-keyword">if</span>(xxx)&#123;ans = result;&#125;  <br><span class="hljs-comment">//ç°åœ¨æˆ‘å¸Œæœ›æŠŠç»“æœæå–åˆ°å¤–éƒ¨çš„å˜é‡ansä¸Š</span><br><br><span class="hljs-comment">//...Do other things without result</span><br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>resultèµ‹å€¼ç»™ansåå°±ä¸å†è¢«ä½¿ç”¨ï¼Œå› æ­¤æˆ‘ä»¬æœŸæœ›å®ƒè°ƒç”¨çš„æ˜¯<strong>ç§»åŠ¨èµ‹å€¼æ„é€ å‡½æ•°</strong>ã€‚ ä½†æ˜¯resultæ˜¯ä¸€ä¸ªæœ‰å˜é‡åçš„å·¦å€¼ç±»å‹ï¼Œå› æ­¤ans = result è°ƒç”¨çš„æ˜¯æ‹·è´èµ‹å€¼æ„é€ å‡½æ•°è€Œéç§»åŠ¨èµ‹å€¼æ„é€ å‡½æ•°</p><p>è§£å†³åŠæ³•ï¼šç”¨c++11æä¾›çš„moveå¼ºè½¬å³å€¼</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">()</span></span>&#123;<br>    Vector result;<br>    <span class="hljs-comment">//...DoSomething with result</span><br>   <br><span class="hljs-keyword">if</span>(xxx)&#123;ans = std::<span class="hljs-built_in">move</span>(result);&#125;   <br><span class="hljs-comment">//è°ƒç”¨çš„æ˜¯ç§»åŠ¨èµ‹å€¼æ„é€ å‡½æ•°</span><br><br><span class="hljs-comment">//...Do other things without result</span><br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>å³å€¼å¼•ç”¨ç±»å‹å’Œå³å€¼çš„å…³ç³»</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test</span><span class="hljs-params">(<span class="hljs-type">int</span>&amp; o)</span> </span>&#123;std::cout &lt;&lt; <span class="hljs-string">&quot;ä¸ºå·¦å€¼ã€‚&quot;</span> &lt;&lt; std::endl;&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test</span><span class="hljs-params">(<span class="hljs-type">int</span>&amp;&amp; temp)</span> </span>&#123;std::cout &lt;&lt; <span class="hljs-string">&quot;ä¸ºå³å€¼ã€‚&quot;</span> &lt;&lt; std::endl;&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>  <span class="hljs-type">int</span> a;<br><span class="hljs-type">int</span>&amp;&amp; b = <span class="hljs-number">10</span>;<br>  <span class="hljs-comment">//è¯·åˆ†åˆ«å›ç­”ï¼šaã€std::move(a)ã€b åˆ†åˆ«æ˜¯å·¦å€¼è¿˜æ˜¯å³å€¼ï¼Ÿ</span><br><span class="hljs-built_in">test</span>(a);<br><span class="hljs-built_in">test</span>(std::<span class="hljs-built_in">move</span>(a));<br><span class="hljs-built_in">test</span>(b);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç­”ï¼šaæ˜¯å·¦å€¼ï¼Œstd::move(a)æ˜¯å³å€¼ï¼Œä½†bå´æ˜¯å·¦å€¼ã€‚</p><p>åœ¨è¿™é‡Œbè™½ç„¶æ˜¯ int&amp;&amp; ç±»å‹ï¼Œä½†å´å› ä¸ºæœ‰å˜é‡åï¼ˆå³å¯æŒä¹…å­˜åœ¨ï¼‰ï¼Œè¢«ç¼–è¯‘å™¨è®¤ä¸ºæ˜¯å·¦å€¼ã€‚</p><p><strong>ç»“è®ºï¼šå³å€¼å¼•ç”¨ç±»å‹åªæ˜¯ç”¨äºåŒ¹é…å³å€¼ï¼Œè€Œå¹¶éè¡¨ç¤ºä¸€ä¸ªå³å€¼ã€‚å› æ­¤ï¼Œå°½é‡ä¸è¦å£°æ˜å³å€¼å¼•ç”¨ç±»å‹çš„å˜é‡ï¼Œè€Œåªåœ¨å‡½æ•°å½¢å‚ä½¿ç”¨å®ƒä»¥åŒ¹é…å³å€¼ã€‚</strong></p></li><li><p><strong>è¡¥å……ï¼šæ„é€ å‡½æ•°ä¹‹åçš„å†’å·</strong></p><p>c++çš„è¯­æ³•ç‰¹æ€§ï¼Œå†’å·åé¢è·Ÿçš„æ˜¯èµ‹å€¼</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">A</span>(<span class="hljs-type">int</span> aa, <span class="hljs-type">int</span> bb):<span class="hljs-built_in">a</span>(aa), <span class="hljs-built_in">b</span>(bb) &#123;&#125;<br><br><span class="hljs-comment">//ç›¸å½“äº</span><br><span class="hljs-built_in">A</span>(<span class="hljs-type">int</span> aa, <span class="hljs-type">int</span> bb)<br>&#123;<br>a=aa;<br>b=bb;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h1>Lecture13ã€RAII and Smartpointer</h1><ol><li><p><strong>motivation</strong></p><p>æ‰‹åŠ¨ç”³è¯·åŠ¨æ€å†…å­˜+æ‰‹åŠ¨é‡Šæ”¾ä¼šæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp">Person* p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Person</span>(id_number);<br><br><span class="hljs-comment">//do something</span><br><br><span class="hljs-keyword">delete</span> p;<br></code></pre></td></tr></table></figure><p>è‹¥åœ¨ç”³è¯·å®Œå†…å­˜ä¹‹åï¼Œdo somethingçš„è¿‡ç¨‹ä¸­ç”¨æŠ›å‡ºäº†å¼‚å¸¸ï¼ˆthrow an exceptionï¼‰ï¼Œé‚£å°±æ— æ³•æ‰§è¡Œdelete pï¼Œä»è€Œé€ æˆå†…å­˜æ³„æ¼ï¼ˆleak memoryï¼‰ã€‚ æ­¤é—®é¢˜è¿˜ä¸æ­¢æ˜¯æŒ‡é’ˆï¼Œæ–‡ä»¶çš„openå’Œcloseã€çº¿ç¨‹çš„try_lockå’Œunlockã€å¥—æ¥å­—çš„socketå’Œcloseï¼Œéƒ½æ˜¯è¿™æ ·çš„â€œé…å¥—æ“ä½œâ€ï¼Œ</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨RAIIï¼ˆResource Acquisition is Initalizationï¼‰åŸåˆ™ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š</p><ul><li><strong>All resources used by a class should be acquired in the constructor</strong></li><li><strong>All resources used by a class should be released in the destructor</strong></li></ul><p>å³key ideaæ˜¯åˆ©ç”¨**â€œå¯¹è±¡çš„ææ„æ˜¯è‡ªåŠ¨å®Œæˆçš„â€** â€”â€” ç”±äºå¯¹è±¡åœ¨go out of its own scopeåï¼Œææ„å‡½æ•°æ€»æ˜¯ä¼šè¢«è‡ªåŠ¨è°ƒç”¨ï¼Œé‚£ä¹ˆåªè¦éµå¾ªä¸Šé¢ä¸¤ç‚¹åŸåˆ™ï¼Œå°±å¯ä»¥é¿å…å†…å­˜æ³„æ¼äº†</p></li><li><p><strong>å®ä¾‹</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br> <br> <br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">10000000</span>; i++)<br>&#123;<br><span class="hljs-type">int32_t</span> *ptr = <span class="hljs-keyword">new</span> <span class="hljs-type">int32_t</span>[<span class="hljs-number">3</span>];<br>ptr[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;<br>ptr[<span class="hljs-number">1</span>] = <span class="hljs-number">2</span>;<br>ptr[<span class="hljs-number">2</span>] = <span class="hljs-number">3</span>;<br><span class="hljs-comment">//delete ptr;     //å‡è®¾å¿˜è®°äº†é‡Šæ”¾å†…å­˜</span><br>&#125;<br><span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;pause&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯æƒ³è€ŒçŸ¥ä¼šå æ®æå¤§çš„å†…å­˜ç©ºé—´</p><p>æˆ‘ä»¬å°†å…¶æ”¹è¿›ä¸ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span><br> <br><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">auto_release_ptr</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br><span class="hljs-built_in">auto_release_ptr</span>(T *t) :<span class="hljs-type">_t</span>(t)&#123;&#125;;<br>~<span class="hljs-built_in">auto_release_ptr</span>()<br>&#123;<br><span class="hljs-keyword">delete</span> <span class="hljs-type">_t</span>;<br>&#125;;<br> <br><span class="hljs-function">T * <span class="hljs-title">getPtr</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-type">_t</span>;<br>&#125;<br> <br><span class="hljs-keyword">private</span>:<br>T *<span class="hljs-type">_t</span>;<br>&#125;;<br> <br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">10000000</span>; i++)<br>&#123;<br><span class="hljs-keyword">auto</span> arp = <span class="hljs-built_in">auto_release_ptr</span>&lt;<span class="hljs-type">int32_t</span>&gt;(<span class="hljs-keyword">new</span> <span class="hljs-type">int32_t</span>[<span class="hljs-number">3</span>]);<br><span class="hljs-type">int32_t</span> *ptr = arp.<span class="hljs-built_in">getPtr</span>();<br>ptr[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;<br>ptr[<span class="hljs-number">1</span>] = <span class="hljs-number">2</span>;<br>ptr[<span class="hljs-number">2</span>] = <span class="hljs-number">3</span>;<br>&#125;<br><span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;pause&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>**æ€è·¯ï¼š**å°†ç”³è¯·çš„intæŒ‡é’ˆæ‰˜ç®¡ç»™æ¨¡æ¿ç±»auto_release_ptrï¼Œå†å»å£°æ˜ä¸€ä¸ªæ™®é€šintæŒ‡é’ˆæŒ‡å‘ç”³è¯·çš„å†…å­˜ç©ºé—´ï¼ˆé€šè¿‡æ¥æ”¶ç±»æˆå‘˜å‡½æ•°çš„è¿”å›å€¼å®ç°ï¼‰ï¼Œä»è€Œè®©ptr ä¸ auto_release_ptr æ‹¥æœ‰äº†ç›¸åŒçš„ç”Ÿå‘½å‘¨æœŸï¼Œæ¯æ¬¡forå¾ªç¯è‡ªåŠ¨ææ„é‡Šæ”¾ï¼Œéå¸¸å¦™ã€‚</p></li><li><p><strong>æ™ºèƒ½æŒ‡é’ˆ</strong></p><p><strong>ï¼ˆ1ï¼‰std : : unique_ptr</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//æ™®é€šæŒ‡é’ˆ</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">raw_ptr_fun</span><span class="hljs-params">()</span></span>&#123;<br>Node* n = <span class="hljs-keyword">new</span> Node;<br><span class="hljs-comment">//do things with n </span><br><span class="hljs-keyword">delete</span> n;<br>&#125;<br><br><span class="hljs-comment">//æ™ºèƒ½æŒ‡é’ˆ</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">smart_ptr_fun</span><span class="hljs-params">()</span></span>&#123;<br><span class="hljs-function">std::unique_ptr&lt;Node&gt; <span class="hljs-title">n</span><span class="hljs-params">(<span class="hljs-keyword">new</span> node)</span></span>;<br><span class="hljs-comment">//do things with n </span><br><span class="hljs-comment">//automatically freed!</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç‰¹ç‚¹ï¼š</strong></p><ul><li>æ— æ³•è¿›è¡Œå·¦å€¼çš„èµ‹å€¼æˆ–èµ‹å€¼æ„é€ ï¼Œä½†å…è®¸ä¸´æ—¶å³å€¼èµ‹å€¼æ„é€ å’Œèµ‹å€¼ï¼ˆç”¨moveè¯­ä¹‰ï¼‰</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">unique_ptr&lt;string&gt; <span class="hljs-title">p1</span><span class="hljs-params">(<span class="hljs-keyword">new</span> string(<span class="hljs-string">&quot;I&#x27;m Li Ming!&quot;</span>))</span></span>;<br><span class="hljs-function">unique_ptr&lt;string&gt; <span class="hljs-title">p2</span><span class="hljs-params">(<span class="hljs-keyword">new</span> string(<span class="hljs-string">&quot;I&#x27;m age 22.&quot;</span>))</span></span>;<br><br>cout &lt;&lt; <span class="hljs-string">&quot;p1ï¼š&quot;</span> &lt;&lt; p1.<span class="hljs-built_in">get</span>() &lt;&lt; endl;<br>cout &lt;&lt; <span class="hljs-string">&quot;p2ï¼š&quot;</span> &lt;&lt; p2.<span class="hljs-built_in">get</span>() &lt;&lt; endl;<br><br><span class="hljs-comment">//p1 = p2;// errorï¼ç¦æ­¢å·¦å€¼èµ‹å€¼</span><br><span class="hljs-comment">//unique_ptr&lt;string&gt; p3(p2);// errorï¼ç¦æ­¢å·¦å€¼èµ‹å€¼æ„é€ </span><br><br><span class="hljs-function">unique_ptr&lt;string&gt; <span class="hljs-title">p3</span><span class="hljs-params">(std::move(p1))</span></span>;<br>p1 = std::<span class="hljs-built_in">move</span>(p2);<span class="hljs-comment">// ä½¿ç”¨moveæŠŠå·¦å€¼è½¬æˆå³å€¼å°±å¯ä»¥èµ‹å€¼äº†</span><br><br>cout &lt;&lt; <span class="hljs-string">&quot;p1 = p2 èµ‹å€¼åï¼š&quot;</span> &lt;&lt; endl;<br>cout &lt;&lt; <span class="hljs-string">&quot;p1ï¼š&quot;</span> &lt;&lt; p1.<span class="hljs-built_in">get</span>() &lt;&lt; endl;<br>cout &lt;&lt; <span class="hljs-string">&quot;p2ï¼š&quot;</span> &lt;&lt; p2.<span class="hljs-built_in">get</span>() &lt;&lt; endl;<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2023/04/14/SjMudQh6KBbCa21.png" alt=""></p><div class="note note-warning">            <p>ğŸ’¡ PS. åœ¨è¿™é‡Œä¹Ÿå¯ä»¥çœ‹åˆ°ï¼ŒæŠŠp2 moveæˆä¸´æ—¶å€¼ä¹‹åï¼Œä¸€èµ‹å€¼ç»™p1ï¼Œå®ƒå°±è¢«é‡Šæ”¾æ‰äº†ï¼Œå†…å­˜åœ°å€ä¸ºnullptr</p>          </div><ul><li>æ’å®ƒå¼èµ„æºäº«ç”¨ï¼šä¸¤ä¸ªæŒ‡é’ˆä¸èƒ½æŒ‡å‘åŒä¸€ä¸ªèµ„æº</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp">unique_ptr&lt;string&gt; p1;<br>string *str = <span class="hljs-keyword">new</span> <span class="hljs-built_in">string</span>(<span class="hljs-string">&quot;æ™ºèƒ½æŒ‡é’ˆçš„å†…å­˜ç®¡ç†é™·é˜±&quot;</span>);<br>p1.<span class="hljs-built_in">reset</span>(str);<span class="hljs-comment">// p1æ‰˜ç®¡stræŒ‡é’ˆ</span><br>&#123;<br>unique_ptr&lt;string&gt; p2;<br>p2.<span class="hljs-built_in">reset</span>(str);<span class="hljs-comment">// p2æ¥ç®¡stræŒ‡é’ˆæ—¶ï¼Œä¼šå…ˆå–æ¶ˆp1çš„æ‰˜ç®¡ï¼Œç„¶åå†å¯¹strçš„æ‰˜ç®¡</span><br>cout &lt;&lt; <span class="hljs-string">&quot;p2:&quot;</span> &lt;&lt;  *p2 &lt;&lt; endl;<br>&#125;<br><br><span class="hljs-comment">// æ­¤æ—¶p1å·²ç»æ²¡æœ‰æ‰˜ç®¡å†…å®¹æŒ‡é’ˆäº†ï¼Œä¸ºNULLï¼Œåœ¨ä½¿ç”¨å®ƒå°±ä¼šå†…å­˜æŠ¥é”™ï¼</span><br>cout &lt;&lt; <span class="hljs-string">&quot;p1:&quot;</span> &lt;&lt; *p1 &lt;&lt; endl;<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2023/04/14/R8OfldcxjaFIHEV.png" alt=""></p><p><strong>ï¼ˆ2ï¼‰std : : shared_ptr</strong></p><p><strong>idea:</strong> è®°å½•å¼•ç”¨ç‰¹å®šå†…å­˜å¯¹è±¡çš„æ™ºèƒ½æŒ‡é’ˆæ•°é‡ï¼Œå½“å¤åˆ¶æˆ–æ‹·è´æ—¶ï¼Œ<strong>å¼•ç”¨è®¡æ•°åŠ 1</strong>ï¼Œå½“æ™ºèƒ½æŒ‡é’ˆææ„æ—¶ï¼Œ<strong>å¼•ç”¨è®¡æ•°å‡1</strong>ï¼Œå¦‚æœè®¡æ•°ä¸ºé›¶ï¼Œä»£è¡¨å·²ç»æ²¡æœ‰æŒ‡é’ˆæŒ‡å‘è¿™å—å†…å­˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±é‡Šæ”¾å®ƒ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br><span class="hljs-keyword">public</span>:<br><span class="hljs-built_in">Person</span>() &#123;<br>cout &lt;&lt; <span class="hljs-string">&quot;æ„é€ å‡½æ•° \\t &quot;</span> &lt;&lt; endl;<br>&#125;<br><br>~<span class="hljs-built_in">Person</span>() &#123;<br>cout &lt;&lt; <span class="hljs-string">&quot;ææ„å‡½æ•° \\t &quot;</span> &lt;&lt; endl;<br>&#125;<br><br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>shared_ptr&lt;Person&gt; sp1;<br><br><span class="hljs-function">shared_ptr&lt;Person&gt; <span class="hljs-title">sp2</span><span class="hljs-params">(<span class="hljs-keyword">new</span> Person())</span></span>;<br><br><span class="hljs-comment">// è·å–æ™ºèƒ½æŒ‡é’ˆç®¡æ§çš„å…±äº«æŒ‡é’ˆçš„æ•°é‡use_count()ï¼šå¼•ç”¨è®¡æ•°</span><br>cout &lt;&lt; <span class="hljs-string">&quot;sp1use_count() = &quot;</span> &lt;&lt; sp1.<span class="hljs-built_in">use_count</span>() &lt;&lt; endl;<br>cout &lt;&lt; <span class="hljs-string">&quot;sp2use_count() = &quot;</span> &lt;&lt; sp2.<span class="hljs-built_in">use_count</span>() &lt;&lt; endl &lt;&lt; endl;<br><br><span class="hljs-comment">// å…±äº«,å³sp1å’Œsp2å…±åŒæ‰˜ç®¡åŒä¸€ä¸ªæŒ‡é’ˆ</span><br>sp1 = sp2;<br><br>cout &lt;&lt; <span class="hljs-string">&quot;sp1use_count() = &quot;</span> &lt;&lt; sp1.<span class="hljs-built_in">use_count</span>() &lt;&lt; endl;<br>cout &lt;&lt; <span class="hljs-string">&quot;sp2use_count() = &quot;</span> &lt;&lt; sp2.<span class="hljs-built_in">use_count</span>() &lt;&lt; endl &lt;&lt; endl;<br><br><span class="hljs-function">shared_ptr&lt;Person&gt; <span class="hljs-title">sp3</span><span class="hljs-params">(sp1)</span></span>;<br>cout &lt;&lt; <span class="hljs-string">&quot;sp1use_count() = &quot;</span> &lt;&lt; sp1.<span class="hljs-built_in">use_count</span>() &lt;&lt; endl;<br>cout &lt;&lt; <span class="hljs-string">&quot;sp2use_count() = &quot;</span> &lt;&lt; sp2.<span class="hljs-built_in">use_count</span>() &lt;&lt; endl;<br>cout &lt;&lt; <span class="hljs-string">&quot;sp2use_count() = &quot;</span> &lt;&lt; sp3.<span class="hljs-built_in">use_count</span>() &lt;&lt; endl;<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2023/04/14/cK9a5qX7MnjQHlv.png" alt=""></p><p><strong>ï¼ˆ3ï¼‰std : : weak_ptr</strong></p><p>â€‹TO-DO</p></li><li><p><strong>æ™ºèƒ½æŒ‡é’ˆåˆå§‹åŒ–æ–¹å¼</strong></p><p>å¸¸è§„åˆå§‹åŒ–æ–¹å¼æœ‰ä¸¤ç§ï¼šæ˜¾å¼è°ƒç”¨newã€ä½¿ç”¨make_unique()å‡½æ•°</p></li></ol><p><img src="https://s2.loli.net/2023/04/14/dIVEwpKhf47G5aH.png" alt=""></p><p><strong>Q:</strong> Which is betterï¼Ÿ</p><p><strong>A:</strong> std : : make_uniqueå’Œstd : : make_sharedæ›´å¥½ï¼Œå› ä¸º<strong>æ˜¾å¼è°ƒç”¨newä¼šåˆ†é…ä¸¤æ¬¡å†…å­˜</strong>ï¼ˆä¸€æ¬¡ç»™upï¼Œä¸€æ¬¡æ˜¯new Tï¼‰</p><hr><h1>Assignmentï¼šHashMap</h1><ol><li><p><strong>usingå…³é”®å­—</strong></p><p>å¯ç”¨äºè®¾ç½®åˆ«åï¼ŒåŠŸèƒ½ç±»ä¼¼äºtypedef</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">using</span> value_type = std::pair&lt;<span class="hljs-type">const</span> K, M&gt;;<br></code></pre></td></tr></table></figure></li><li><p><strong>explicitå…³é”®å­—</strong></p><p>ä¿®é¥°classçš„constructorï¼Œä»¤å…¶åªèƒ½æ˜¾å¼å£°æ˜ï¼Œä¸èƒ½éšå¼è½¬æ¢orèµ‹å€¼åˆå§‹åŒ–</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">HashMap</span><span class="hljs-params">(<span class="hljs-type">size_t</span> bucket_count, <span class="hljs-type">const</span> H&amp; hash = H())</span></span>;<br> <br><span class="hljs-function">HashMap&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt; <span class="hljs-title">map</span><span class="hljs-params">(<span class="hljs-number">1.0</span>)</span></span>;  <span class="hljs-comment">// double -&gt; int conversion not allowed.</span><br>HashMap&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt; map = <span class="hljs-number">1</span>;   <span class="hljs-comment">// copy-initialization, does not compile.</span><br></code></pre></td></tr></table></figure></li><li><p><strong>æˆå‘˜å‡½æ•°æœ«å°¾åŠ const â€”â€” å¸¸æˆå‘˜å‡½æ•°</strong></p><p>constæˆå‘˜å‡½æ•°å¯ä»¥ä½¿ç”¨ç±»ä¸­çš„æ‰€æœ‰æˆå‘˜å˜é‡ï¼Œä½†æ˜¯ä¸èƒ½ä¿®æ”¹å®ƒä»¬çš„å€¼ï¼Œè¿™ç§æªæ–½ä¸»è¦ç›®çš„è¿˜æ˜¯ä¿æŠ¤æ•°æ®ã€‚é€šå¸¸å°† getç±»å‹çš„å‡½æ•°ï¼ˆget_valueã€get_sizeã€‚ã€‚ï¼‰è®¾ç½®ä¸ºå¸¸æˆå‘˜å‡½æ•°ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">size_t</span> <span class="hljs-title">size</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span></span>;<br><span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title">empty</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span></span>;<br></code></pre></td></tr></table></figure><p>â€‹</p><div class="note note-warning">            <p>ğŸ’¡ PS.</p><ol><li>éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œå¿…é¡»åœ¨æˆå‘˜å‡½æ•°çš„å£°æ˜å’Œå®šä¹‰å¤„åŒæ—¶åŠ ä¸Š const å…³é”®å­—ã€‚<code>char *getname() const</code>å’Œ<code>char *getname()</code>æ˜¯ä¸¤ä¸ªä¸åŒçš„å‡½æ•°åŸå‹ï¼Œå¦‚æœåªåœ¨ä¸€ä¸ªåœ°æ–¹åŠ  const ä¼šå¯¼è‡´å£°æ˜å’Œå®šä¹‰å¤„çš„å‡½æ•°åŸå‹å†²çªã€‚</li><li>åŒºåˆ†ä¸€ä¸‹ const çš„ä½ç½®ï¼š<ul><li>å‡½æ•°å¼€å¤´çš„ const ç”¨æ¥ä¿®é¥°å‡½æ•°çš„è¿”å›å€¼ï¼Œè¡¨ç¤ºè¿”å›å€¼æ˜¯ const ç±»å‹ï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½è¢«ä¿®æ”¹ï¼Œä¾‹å¦‚<code>const char * getname()</code></li><li>å‡½æ•°å¤´éƒ¨çš„ç»“å°¾åŠ ä¸Š const è¡¨ç¤ºå¸¸æˆå‘˜å‡½æ•°ï¼Œè¿™ç§å‡½æ•°åªèƒ½è¯»å–æˆå‘˜å˜é‡çš„å€¼ï¼Œè€Œä¸èƒ½ä¿®æ”¹æˆå‘˜å˜é‡çš„å€¼ï¼Œä¾‹å¦‚<code>char * getname() const</code></li></ul></li></ol>          </div></li><li><p><strong>noexceptå…³é”®å­—</strong></p><p>ç¨‹åºå‘˜åœ¨è¯­ä¹‰å±‚é¢å£°æ˜â€œæˆ‘ä¿è¯è¿™ä¸ªå‡½æ•°ä¸ä¼šå¼‚å¸¸ï¼Œç¼–è¯‘å™¨ä½ ä¸ç”¨æ£€æŸ¥äº†â€ï¼Œä¹‹åç¼–è¯‘å™¨å°±ä¸ä¼šå¯¹è¯¥å‡½æ•°è¿›è¡Œå¼‚å¸¸æ£€æŸ¥ï¼Œä¹Ÿæ²¡åŠæ³•å®æ–½try-catchæ“ä½œ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func_not_throw</span><span class="hljs-params">()</span> <span class="hljs-keyword">noexcept</span> </span>&#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-number">1</span>;<br><span class="hljs-comment">// noexceptå‡½æ•°ä¸­æœ¬ä¸åº”æœ‰throwï¼Œæ²¡æ„ä¹‰ï¼Œä½†ç¼–è¯‘å™¨ä¸ä¼šæ£€æŸ¥æ˜¯å¦æœ‰throw</span><br><span class="hljs-comment">// æ‰€ä»¥ç¼–è¯‘é€šè¿‡ï¼Œä¸ä¼šæŠ¥é”™ï¼ˆå¯èƒ½ä¼šæœ‰è­¦å‘Šï¼‰</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">func_not_throw</span>(); <span class="hljs-comment">// ç›´æ¥ terminateï¼Œä¸ä¼šè¢« catch</span><br>    &#125; <span class="hljs-built_in">catch</span> (<span class="hljs-type">int</span>) &#123;<br>        cout &lt;&lt; <span class="hljs-string">&quot;catch int&quot;</span> &lt;&lt; endl;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>æ³¨æ„ï¼š</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br> <br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br> <br><span class="hljs-keyword">class</span> <span class="hljs-title class_">CTest</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">show</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span><br><span class="hljs-function"></span>&#123;<br>cout &lt;&lt; <span class="hljs-string">&quot;const&quot;</span> &lt;&lt; endl;<br>&#125;<br> <br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">show</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>cout &lt;&lt; <span class="hljs-string">&quot;normal&quot;</span> &lt;&lt; endl;<br>&#125;<br>&#125;;<br> <br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>CTest a;<br>a.<span class="hljs-built_in">show</span>();<br> <br><span class="hljs-type">const</span> CTest b;<br>b.<span class="hljs-built_in">show</span>();<br> <br><span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;pause&quot;</span>);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2023/04/14/48HvQ9oENy1ksPd.png" alt=""></p><p>è¿™ä¸¤ä¸ªshowå‡½æ•°å¯ä¸æ˜¯é‡è½½ï¼**é‡è½½å‡½æ•°çš„å½¢å‚å¿…é¡»ä¸åŒï¼ï¼**è¿™ä¿©å°±ä¸æ˜¯åŒä¸€ä¸ªå‡½æ•°åŸå‹ï¼ˆå› ä¸ºåŠ äº†constï¼Œæ˜¯å¸¸æˆå‘˜å‡½æ•°ï¼‰</p><p>é‚£ä¹ˆè°ƒç”¨çš„æ—¶å€™å¦‚ä½•åŒºåˆ†è¿™ä¿©æï¼Ÿ</p><p>å®ƒä»¬å„è‡ªè¢«è°ƒç”¨çš„æ—¶æœºä¸ºï¼š<strong>å¦‚æœå®šä¹‰çš„å¯¹è±¡æ˜¯å¸¸å¯¹è±¡ï¼Œåˆ™è°ƒç”¨çš„æ˜¯constæˆå‘˜å‡½æ•°ï¼Œå¦‚æœå®šä¹‰çš„å¯¹è±¡æ˜¯éå¸¸å¯¹è±¡ï¼Œåˆ™è°ƒç”¨é‡è½½çš„éconstæˆå‘˜å‡½æ•°ã€‚</strong></p><div class="note note-warning">            <p>ğŸ’¡ PS. ä¸è¿‡ä»å¦ä¸€ä¸ªè§’åº¦æ¥ç†è§£ï¼Œä¹Ÿå¯ä»¥æŠŠå®ƒä¿©çœ‹æˆé‡è½½ â€”â€” é¦–å…ˆç†è§£ä¸‹å‡½æ•°ç­¾åï¼šå®ƒåŒ…å«ç€ä¸€ä¸ªå‡½æ•°çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬**å‡½æ•°åã€å‚æ•°ç±»å‹ã€å‚æ•°ä¸ªæ•°ã€é¡ºåºä»¥åŠå®ƒæ‰€åœ¨çš„ç±»å’Œå‘½åç©ºé—´ï¼Œ**ä¸¤ä¸ªå‡½æ•°åªæœ‰åœ¨ç­¾åä¸åŒæ—¶æ‰èƒ½è¢«åŒºåˆ†ã€‚<br>é‚£ä¸Šé¢ä¸¤ä¸ªshow( )çš„ç­¾ååˆ°åº•å“ªé‡Œä¸åŒäº†æï¼Ÿ ç­”æ¡ˆæ˜¯å‚æ•°ç±»å‹ï¼Œæ¯ä¸ªæˆå‘˜å‡½æ•°çš„å‚æ•°ä¸­å…¶å®è‡ªå¸¦thisæŒ‡é’ˆï¼Œåªä¸è¿‡è—èµ·æ¥äº†ï¼Œè°è°ƒç”¨æˆå‘˜å‡½æ•°ï¼Œthis å°±æŒ‡å‘è°ã€‚<strong>è€Œæˆå‘˜å‡½æ•°å°¾å·´ä¸Šçš„constï¼Œå®è´¨ä¿®é¥°çš„æ˜¯thisæŒ‡é’ˆï¼</strong> å½“aè°ƒç”¨showæ–¹æ³•æ—¶ï¼Œå‡½æ•°ç­¾åä¸ºshow(a){}ï¼Œå³aä¼ ç»™thisæŒ‡é’ˆï¼Œä¸€çœ‹ï¼Œè¯¶ï¼aä¸ºéå¸¸å¯¹è±¡ï¼Œå¯¹åº”æ™®é€šthisæŒ‡é’ˆï¼Œå³éconstç‰ˆæœ¬çš„show()ï¼›båŒç†ã€‚</p>          </div></li><li><p><strong>typenameå…³é”®å­—ä½œç”¨</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> Map, <span class="hljs-type">bool</span> IsConst&gt;<br><span class="hljs-keyword">typename</span> HashMapIterator&lt;Map, IsConst&gt;::reference HashMapIterator&lt;Map, IsConst&gt;::<span class="hljs-keyword">operator</span>*() <span class="hljs-type">const</span> &#123;<br>    <span class="hljs-keyword">return</span> _node-&gt;value; <br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>ä½œä¸ºç±»å‹å£°æ˜ï¼Œæ•ˆæœå®Œå…¨ç­‰åŒäºclass â€”â€” ä»£ç ä¸­çš„typename Mapç­‰åŒäºclass Mapï¼Œå®ƒä¿©éƒ½æ˜¯å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œâ€œæˆ‘åé¢è·Ÿç€çš„è¿™ä¸ªæ˜¯ä¸ªç±»å‹åç§°ï¼Œè€Œä¸æ˜¯æˆå‘˜å˜é‡æˆ–æˆå‘˜å‡½æ•°â€ã€‚ï¼ˆè¿™å¥½åƒä¹Ÿèƒ½æ˜ è¯â€œæ¨¡æ¿å‡½æ•°åœ¨å®ä¾‹åŒ–åæ‰ä¼šè¢«ç¼–è¯‘â€ï¼‰</p></li><li><p>ä½œä¸º<strong>ä¿®é¥°å…³é”®å­—ï¼š</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">fun</span><span class="hljs-params">(<span class="hljs-type">const</span> T&amp; proto)</span></span>&#123;<br>    <span class="hljs-function">T::const_iterator <span class="hljs-title">it</span><span class="hljs-params">(proto.begin())</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>**motivationï¼š**è™½ç„¶äººç±»ç¼–ç¨‹è€…ä¸€çœ¼å°±çŸ¥é“const_iteratoræ˜¯ä¸ªç±»å‹åç§°ï¼Œä½†ç¼–è¯‘å™¨ä¸çŸ¥é“å‘€ï¼Œä¸‡ä¸€å®ƒæ˜¯ä¸ªå˜é‡å‘¢ï¼Ÿåœ¨æ¨¡æ¿å®ä¾‹åŒ–ä¹‹å‰ï¼Œå®Œå…¨æ²¡æœ‰åŠæ³•æ¥åŒºåˆ†å®ƒä»¬ï¼Œæ‰€ä»¥è¿™ä¸ªå†™æ³•æ˜¯ä¼šerrorçš„ï¼ æ€ä¹ˆåŠæï¼Ÿ è¿™æ—¶å€™å°±éœ€è¦ä½¿ç”¨typenameå…³é”®å­—æ¥ä¿®é¥°ï¼Œç¼–è¯‘å™¨æ‰ä¼šå°†è¯¥åç§°å½“æˆæ˜¯ç±»å‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">typename</span> T::const_iterator <span class="hljs-title">it</span><span class="hljs-params">(proto.begin())</span></span>;<br></code></pre></td></tr></table></figure><p>è¿™æ ·ç¼–è¯‘å™¨å°±å¯ä»¥ç¡®å®šT: :const_iteratoræ˜¯ä¸€ä¸ªç±»å‹ï¼Œè€Œä¸å†éœ€è¦ç­‰åˆ°å®ä¾‹åŒ–æ—¶æœŸæ‰èƒ½ç¡®å®šï¼Œå› æ­¤æ¶ˆé™¤äº†å‰é¢æåˆ°çš„æ­§ä¹‰ã€‚</p><div class="note note-warning">            <p>ğŸ’¡ PS. æ€»ç»“ï¼šåŒæ—¶ä½¿ç”¨æ¨¡æ¿ç±»Tå’ŒåŸŸè§£æç¬¦: : æ—¶ï¼Œå°±å¾—åŠ typename</p>          </div></li></ul></li><li><p>æ¨¡æ¿ç±»ä¸­çš„æˆå‘˜å‡½æ•°ï¼ˆå¾€å¾€ä¹Ÿæ˜¯æ¨¡æ¿å‡½æ•°ï¼‰çš„å…·ä½“å®ç°é€šå¸¸ä¹Ÿä¼šæ”¾åœ¨.hä¸­ï¼Œé™¤éå‡½æ•°å¤ªå¤šå¤ªé•¿</p></li><li><p>ä¸¤ä¸ªæŒ‡é’ˆç›¸å‡ = ä¸¤æŒ‡é’ˆçš„åœ°å€å·®å€¼/sizeof(æ•°æ®ç±»å‹)ï¼Œå³å¾—åˆ°çš„ç»“æœå°±æ˜¯ä¸¤æŒ‡é’ˆä¹‹é—´é—´éš”çš„å…ƒç´ ä¸ªæ•°</p><p>æ³¨æ„ï¼š ä¸éœ€è¦äººä¸ºæ‰‹åŠ¨å»é™¤sizeofå“ˆï¼å‡å·è‡ªåŠ¨ä¼šå®Œæˆè¿™ä¸ªæ“ä½œï¼ˆcå’Œcppä¸­éƒ½æ˜¯ï¼‰</p></li><li><p><strong>è¿ç®—ç¬¦é‡è½½</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iomanip&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-comment">//ç§’è¡¨ç±»</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">stopwatch</span>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">stopwatch</span>(): <span class="hljs-built_in">m_min</span>(<span class="hljs-number">0</span>), <span class="hljs-built_in">m_sec</span>(<span class="hljs-number">0</span>)&#123; &#125;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setzero</span><span class="hljs-params">()</span></span>&#123; m_min = <span class="hljs-number">0</span>; m_sec = <span class="hljs-number">0</span>; &#125;<br>    <span class="hljs-function">stopwatch <span class="hljs-title">run</span><span class="hljs-params">()</span></span>;  <span class="hljs-comment">// è¿è¡Œ</span><br>    stopwatch <span class="hljs-keyword">operator</span>++();  <span class="hljs-comment">//++iï¼Œå‰ç½®å½¢å¼</span><br>    stopwatch <span class="hljs-keyword">operator</span>++(<span class="hljs-type">int</span> n);  <span class="hljs-comment">//i++ï¼Œåç½®å½¢å¼</span><br>    <span class="hljs-keyword">friend</span> ostream &amp; <span class="hljs-keyword">operator</span>&lt;&lt;( ostream &amp;, <span class="hljs-type">const</span> stopwatch &amp;);<br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">int</span> m_min;  <span class="hljs-comment">//åˆ†é’Ÿ</span><br>    <span class="hljs-type">int</span> m_sec;  <span class="hljs-comment">//ç§’é’Ÿ</span><br>&#125;;<br><br><span class="hljs-function">stopwatch <span class="hljs-title">stopwatch::run</span><span class="hljs-params">()</span></span>&#123;<br>    ++m_sec;<br>    <span class="hljs-keyword">if</span>(m_sec == <span class="hljs-number">60</span>)&#123;<br>        m_min++;<br>        m_sec = <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;<br>&#125;<br><br>stopwatch stopwatch::<span class="hljs-keyword">operator</span>++()&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">run</span>();<br>&#125;<br><br>stopwatch stopwatch::<span class="hljs-keyword">operator</span>++(<span class="hljs-type">int</span> n)&#123;<br>    stopwatch s = *<span class="hljs-keyword">this</span>;<br>    <span class="hljs-built_in">run</span>();<br>    <span class="hljs-keyword">return</span> s;<br>&#125;<br><br>ostream &amp;<span class="hljs-keyword">operator</span>&lt;&lt;( ostream &amp; out, <span class="hljs-type">const</span> stopwatch &amp; s)&#123;<br>    out&lt;&lt;<span class="hljs-built_in">setfill</span>(<span class="hljs-string">&#x27;0&#x27;</span>)&lt;&lt;<span class="hljs-built_in">setw</span>(<span class="hljs-number">2</span>)&lt;&lt;s.m_min&lt;&lt;<span class="hljs-string">&quot;:&quot;</span>&lt;&lt;<span class="hljs-built_in">setw</span>(<span class="hljs-number">2</span>)&lt;&lt;s.m_sec;<br>    <span class="hljs-keyword">return</span> out;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    stopwatch s1, s2;<br><br>    s1 = s2++;<br>    cout &lt;&lt; <span class="hljs-string">&quot;s1: &quot;</span>&lt;&lt; s1 &lt;&lt;endl;<br>    cout &lt;&lt; <span class="hljs-string">&quot;s2: &quot;</span>&lt;&lt; s2 &lt;&lt;endl;<br>    s1.<span class="hljs-built_in">setzero</span>();<br>    s2.<span class="hljs-built_in">setzero</span>();<br><br>    s1 = ++s2;<br>    cout &lt;&lt; <span class="hljs-string">&quot;s1: &quot;</span>&lt;&lt; s1 &lt;&lt;endl;<br>    cout &lt;&lt; <span class="hljs-string">&quot;s2: &quot;</span>&lt;&lt; s2 &lt;&lt;endl;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>C++è¿ç®—ç¬¦é‡è½½ï¼Œæœ¬è´¨ä¸Šç­‰äºå®šä¹‰ä¸€ä¸ªæˆå‘˜å‡½æ•°(å®é™…ä¸Šä¹Ÿå¯èƒ½æ˜¯å…¨å±€å‡½æ•°)ã€‚ä¾‹å¦‚a+bï¼Œæœ¬è´¨ä¸Šç­‰åŒäºè°ƒç”¨å‡½æ•°**ã€Œa.operator+(b)ã€**ï¼Œè¯¥å‡½æ•°çš„åå­—å«ã€Œoperator+ã€ ++çš„é‡è½½åˆ†ä¸ºå‰ç½®å’Œåç½®æƒ…å†µï¼Œa = ++b;(å‰ç½®)ï¼Œ a = b++;(åç½®)ã€‚å› ä¸ºç¬¦å·ä¸€æ ·ï¼Œæ‰€ä»¥ç»™åç½®ç‰ˆæœ¬åŠ ä¸€ä¸ªintå½¢å‚ä½œä¸ºåŒºåˆ†ï¼Œè¿™ä¸ªå½¢å‚æ˜¯0ï¼Œä½†æ˜¯åœ¨å‡½æ•°ä½“ä¸­æ˜¯ç”¨ä¸åˆ°çš„ï¼Œåªæ˜¯ä¸ºäº†åŒºåˆ†å‰ç½®åç½®ã€‚ è‡³äºä¸ºå•¥åŠ äº†ä¸ªå½¢å‚å°±èƒ½åŒºåˆ†å‰åç¼€ï¼Œæ²¡æƒ³æ‡‚ï¼Œä¹Ÿæ²¡æŸ¥åˆ°èµ„æ–™</p></li><li><p><strong>thisæŒ‡é’ˆ</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> K, <span class="hljs-keyword">typename</span> M, <span class="hljs-keyword">typename</span> H&gt;<br>HashMap&lt;K, M, H&gt;::~<span class="hljs-built_in">HashMap</span>() &#123;<br>    <span class="hljs-built_in">clear</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œè°ƒç”¨clear()ç”¨ä¸ç”¨åŠ thisæŒ‡é’ˆï¼Ÿ ç­”æ¡ˆæ˜¯å¯åŠ å¯ä¸åŠ ï¼Œç¼–è¯‘å™¨éƒ½ä¼šéšå¼è°ƒç”¨</p><p>Q: ä»€ä¹ˆæ—¶å€™thisæŒ‡é’ˆæ˜¯å¿…ä¸å¯å°‘çš„æï¼Ÿ</p><p>A: å½“ä½ åœ¨å¯¹è±¡æ–¹æ³•é‡Œéœ€è¦<strong>æ˜ç¡®</strong>ä½¿ç”¨è‡ªå·±çš„æ—¶å€™ï¼Œæ¯”å¦‚åŒºåˆ†åŒåçš„å½¢å‚å’Œæˆå‘˜å˜é‡</p></li><li><p>å½“ä¸€ä¸ªå‡½æ•°çš„è¿”å›å€¼ä¸ºå¼•ç”¨ç±»å‹æ—¶ï¼Œ<strong>ä¸è¦return æŸä¸ªåœ¨stackä¸Šçš„å˜é‡çš„å¼•ç”¨ï¼</strong>ï¼ˆå¦åˆ™è¯¥å‡½æ•°ä¸€é€€å‡ºï¼Œstackå°±é‡Šæ”¾ï¼Œå¼•ç”¨å°±æ‰äº†ï¼‰</p></li><li><p><strong>éå†ç±»çš„å®ä¾‹åŒ–å¯¹è±¡ï¼ˆè‡ªå®šä¹‰ç±»çš„è¿­ä»£å™¨ï¼‰</strong></p></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">bool</span> <span class="hljs-keyword">operator</span>==(<span class="hljs-type">const</span> HashMap&lt;K, M, H&gt;&amp; lhs, <span class="hljs-type">const</span> HashMap&lt;K, M, H&gt;&amp; rhs) &#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> [key, mapped] : lhs)&#123;<br>        ã€‚ã€‚ã€‚<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Q: lhsæ˜¯è‡ªå®šä¹‰çš„HashMapç±»ï¼Œå…¶æˆå‘˜å˜é‡ä¸åªæ˜¯è£…æœ‰&lt;key, mapped&gt;çš„é“¾è¡¨ï¼Œè¿˜æœ‰å„ç§int sizeã€int load_factorç­‰å±æ€§å•Šï¼Œä¸ºå•¥å¯ä»¥ç›´æ¥ç”¨ : è¿›è¡Œrange based for loopæï¼Ÿæˆ–è€…è¯´ï¼Œä¸ºå•¥åªä¼šå¾ªç¯åˆ°æƒ³è¦çš„é“¾è¡¨ï¼Œè€Œä¸ä¼šè®¿é—®å…¶å®ƒæˆå‘˜å˜é‡æï¼Ÿ</p><p>A: ä¹‹æ‰€ä»¥ä¼šæœ‰ä¸Šè¿°è¯¯åŒºï¼Œ<strong>æ˜¯å› ä¸ºæŠŠrange basedå¾ªç¯å½“æˆäº†ç¼–è¯‘å™¨å†…ç½®è¿ç®—ç¬¦ï¼Œäº‹å®ä¸Šæ˜¯è‡ªå·±è¦ä¸ºè¯¥ç±»å®šä¹‰ä¸€ä¸ªiteratorç±»ï¼</strong></p><p>range basedçš„ : ç¬¦å·åªæ˜¯ä¸€ç§ç®€ç•¥å†™æ³•ï¼Œå®ƒçš„æºç å®ç°å¤§æ¦‚ä¸ºï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">for</span> ( range_declaration : range_expression) loop_statement<br>&#123;  <br>    <span class="hljs-keyword">auto</span> &amp;&amp; __range = range_expression ;   <br>    <span class="hljs-keyword">auto</span> __begin = <span class="hljs-built_in">begin_expr</span>(__range);   <br>    <span class="hljs-keyword">auto</span> __end = <span class="hljs-built_in">end_expr</span>(__range);   <br>    <span class="hljs-keyword">for</span> (;__begin != __end; ++__begin) &#123;  <br>        range_declaration = *__begin;   <br>        loop_statement   <br>    &#125;   <br>&#125;<br></code></pre></td></tr></table></figure><p>ç”±æ­¤å¯è§ï¼Œè‡ªå®šä¹‰çš„iteratorç±»è‡³å°‘è¦æœ‰5ä¸ªåŠŸèƒ½ï¼š</p><ul><li>begin( )</li><li>end( )</li><li>é‡è½½++ã€*ã€! =ä¸‰ä¸ªè¿ç®—ç¬¦</li></ul><p>å…¶ä¸­begin( )ã€end( )è¿”å›ç±»å‹å°±æ˜¯iterator</p><p>ç°åœ¨å°±å¯ä»¥ç†è§£ä¸ºå•¥å¯ç”¨range basedå¾ªç¯è·å–è‡ªå®šä¹‰ç±»ä¸­æƒ³è¦çš„æ•°æ®äº† â€”â€” iteratoråŠŸèƒ½å…¨æ˜¯ç”¨æˆ·è‡ªå·±å®šä¹‰çš„ï¼Œæƒ³è·å–å•¥å°±è·å–å•¥æ</p><ol start="13"><li><strong>Q: å³å€¼å¼•ç”¨çš„ç±»å¯¹è±¡çš„å±æ€§ä¹Ÿæ˜¯å³å€¼å—ï¼Ÿ</strong></li></ol><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//ç§»åŠ¨æ„é€ å‡½æ•°</span><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> K, <span class="hljs-keyword">typename</span> M, <span class="hljs-keyword">typename</span> H&gt;<br>HashMap&lt;K, M, H&gt;::<span class="hljs-built_in">HashMap</span>(HashMap&amp;&amp; rhs):<br>    _size&#123;rhs._size&#125;,<br>    _hash_function&#123;rhs._hash_function&#125;,<br>    _buckets_array&#123;rhs.<span class="hljs-built_in">bucket_count</span>(), <span class="hljs-literal">nullptr</span>&#125; &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">bucket_count</span>(); i++)&#123;<br>        _buckets_array[i] = rhs._buckets_array[i];<br>        rhs._buckets_array[i] = <span class="hljs-literal">nullptr</span>;<br>    &#125;<br>    rhs._size = <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>A: å°†ç±»å¯¹è±¡ç”¨move()å¼ºè½¬ä¸ºå³å€¼ï¼Œå¹¶ä¸å½±å“ç±»ä¸­æˆå‘˜å˜é‡çš„å·¦å³å€¼å±æ€§ï¼Œè¯¥æ˜¯å•¥è¿˜æ˜¯å•¥</p><ol start="14"><li><p><strong>å¯¹ä¸Šé¢è¿™ä¸ªé—®é¢˜çš„è¿›ä¸€æ­¥æ·±å±‚ç†è§£ï¼š</strong></p><p>Q: è¢«move()è¿‡çš„å˜é‡ä¼šè¢«ç¼–è¯‘å™¨è‡ªåŠ¨ç»™é”€æ¯å—ï¼Ÿå¦‚æœä¼šï¼Œé‚£ä¸ºå•¥è¿˜è¦æ‰‹åŠ¨è®©rhs._buckets_array[i] æŒ‡å‘nullptrï¼Ÿå¦‚æœä¸ä¼šï¼Œé‚£å¼ºè½¬å³å€¼æœ‰å•¥æ„ä¹‰å•Šï¼Ÿ</p><p>A: å˜é‡ä¼šè¢«æ€ä¹ˆå¤„ç†ï¼Œä¸å®ƒæ˜¯å¦è¢«move()è¿‡æ²¡åŠæ¯›é’±å…³ç³»ï¼Œ<strong>move()å¹¶ä¸æ”¹å˜å˜é‡æœ¬èº«ï¼Œåªæ˜¯é¢å¤–æä¾›äº†ä¸€ä¸ªreturnçš„å³å€¼</strong>ï¼Œè¿™ä¸€ç‚¹çœ‹æºç å³å¯æ˜ç™½</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// FUNCTION TEMPLATE move</span><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">_Ty</span>&gt;<br><span class="hljs-function"><span class="hljs-type">remove_reference_t</span>&lt;_Ty&gt;&amp;&amp; <span class="hljs-title">move</span><span class="hljs-params">(_Ty&amp;&amp; _Arg)</span> <span class="hljs-keyword">noexcept</span> </span>&#123; <br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-type">remove_reference_t</span>&lt;_Ty&gt;&amp;&amp;&gt;(_Arg);<br>&#125;<br><span class="hljs-comment">//åªæ˜¯æŠŠè¿”å›å€¼ç”¨static_castå¼ºåˆ¶è½¬æ¢æˆå³å€¼ï¼Œä½†ä¼ å…¥çš„åŸå˜é‡è¯¥æ˜¯å•¥è¿˜æ˜¯å•¥</span><br></code></pre></td></tr></table></figure><p>é‚£move()çš„æ„ä¹‰æ˜¯å•¥æ â€”â€” <strong>å¤šæä¾›ä¸€ç§æ•°æ®ç±»å‹ï¼Œç”¨äºé‡è½½å‡½æ•°çš„å½¢å‚åŒ¹é…</strong>ã€‚ è¯´ç™½äº†ï¼Œå°±æ˜¯<strong>æ‰‹åŠ¨å¸®åŠ©ç¼–è¯‘å™¨é€‰æ‹©é‡è½½å‡½æ•°ï¼ŒåŒæ—¶å‘ç¼–è¯‘å™¨å‘èª“å†ä¹Ÿä¸ç¢°è¿™ä¸ªå¯¹è±¡</strong>ï¼ é‚£è¿™ä¸ªä½œç”¨çš„motivationåˆæ˜¯å•¥æ â€”â€” è‹¥æ²¡æœ‰å³å€¼å¼•ç”¨ï¼Œé‚£æ‹·è´å‡½æ•°å°±è¦åˆ†æˆdeep_copy()å’Œshallow_copy()ä¸¤ä¸ªç‰ˆæœ¬æ¥å†™ï¼Œä¸”æ¯æ¬¡éƒ½è¦æ‰‹åŠ¨æ˜¾å¼è°ƒç”¨ â€”â€” è¿™æ—¢éº»çƒ¦ï¼Œåˆå®¹æ˜“å‡ºé”™ï¼›ä½†åˆ©ç”¨é‡è½½å†™æˆcopy(const T&amp; val)å’Œcopy(T&amp;&amp; val)åï¼Œå°±å¯ä»¥è®©ç¼–è¯‘å™¨è‡ªåŠ¨è°ƒç”¨ã€‚è€Œè‹¥ç”¨æˆ·è‡ªå·±å‘ç°ï¼Œè¯¶ï¼è¿™ä¸ªæŒ‡é’ˆaè™½ç„¶æ˜¯å·¦å€¼ï¼Œä½†æˆ‘ä¹‹åä¸ç”¨äº†ï¼Œå¯ä»¥ç›´æ¥æµ…æ‹·è´ï¼Œokï¼Œé‚£ç”¨move()å¼ºè½¬ä¸€æ¬¡å³å¯ï¼Œå³æ‰€è°“çš„â€œæ‰‹åŠ¨å¸®ç¼–è¯‘å™¨é€‰æ‹©é‡è½½å‡½æ•°â€ã€‚ å›åˆ°ä¸€å¼€å§‹çš„é—®é¢˜ï¼Œç»move()çš„å˜é‡ä¼šè¢«é”€æ¯å’©ï¼Ÿ é‚£å¾—çœ‹ç§»åŠ¨æ„é€ å‡½æ•°/ç§»åŠ¨èµ‹å€¼æ„é€ å‡½æ•°æ˜¯å’‹å®ç°çš„ï¼šåœ¨ä¸Šé¢HashMapçš„é‚£ä¸ªç§»åŠ¨æ„é€ å‡½æ•°ä¸­ï¼Œæ‰‹åŠ¨é‡Šæ”¾äº†æŒ‡é’ˆå¹¶è®©sizeæ¸…é›¶ï¼ˆè¿™ä¹Ÿæ˜¯ç¬¦åˆå®é™…å†™ä»£ç çš„æ€è·¯çš„ï¼Œæ—¢ç„¶è®¤å®šäº†â€œè¿™ä¸ªå¯¹è±¡ä¸ä¼šå†ç¢°â€ï¼Œé‚£å°±åº”è¯¥é‡Šæ”¾å®ƒï¼Œç•™ç€æ—¢å ç©ºé—´ã€åˆæœ‰ä¿®æ”¹å†…å­˜çš„é£é™©ï¼‰ï¼›åä¹‹ï¼Œå¦‚æœç§»åŠ¨æ„é€ å‡½æ•°ä¸­æ²¡é‡Šæ”¾å³å€¼ï¼Œé‚£å®ƒå°±åŸå°ä¸åŠ¨åœ°åœ¨é‚£å„¿ â€”â€” è¯´åˆ°åº•ï¼Œè¿˜æ˜¯<strong>ä¸å˜é‡æ˜¯å·¦å€¼/å³å€¼æœ¬èº«æ²¡åŠæ¯›é’±å…³ç³»ï¼Œè€Œæ˜¯å–å†³äºSMFä¸­æ€ä¹ˆå»å¤„ç†è¿™ä¸ªå˜é‡</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test_fun</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">int</span>&amp; val)</span></span>&#123;<br>    cout &lt;&lt; <span class="hljs-string">&quot;value: &quot;</span> &lt;&lt; val&lt;&lt; <span class="hljs-string">&quot;, type: å·¦å€¼&quot;</span> &lt;&lt; endl;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test_fun</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">int</span>&amp;&amp; val)</span></span>&#123;<br>    cout &lt;&lt; <span class="hljs-string">&quot;value: &quot;</span> &lt;&lt; val&lt;&lt; <span class="hljs-string">&quot;, type: å³å€¼&quot;</span> &lt;&lt; endl;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span> a = <span class="hljs-number">1</span>;<br>    <span class="hljs-type">int</span> b = <span class="hljs-built_in">move</span>(a);<br>    <span class="hljs-built_in">test_fun</span>(a); <span class="hljs-comment">//aæ²¡æœ‰è¢«é”€æ¯</span><br>    <span class="hljs-built_in">test_fun</span>(b);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2023/04/14/H3Y1s7jSPFquXCK.png" alt=""></p></li></ol>]]></content>
    
    
    <categories>
      
      <category>æ ¸å¿ƒç§‘æŠ€çœ‹ç¾å¸</category>
      
    </categories>
    
    
    <tags>
      
      <tag>c++</tag>
      
      <tag>æ–¯å¦ç¦</tag>
      
      <tag>hashmap</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ŠCS61Cç¬”è®°ã€‹</title>
    <link href="/2023/04/14/%E3%80%8ACS61C%E7%AC%94%E8%AE%B0%E3%80%8B/"/>
    <url>/2023/04/14/%E3%80%8ACS61C%E7%AC%94%E8%AE%B0%E3%80%8B/</url>
    
    <content type="html"><![CDATA[<div class="note note-success">            <p>è¯¾ç¨‹æ¥æºï¼šUCB-CS61C(20 summer)</p><p>è¯¾ç¨‹ä»‹ç»ï¼š<a href="https://github.com/qlhhahaha/CS61C-SU20">https://github.com/qlhhahaha/CS61C-SU20</a></p>          </div><h1>ã€ŠCS61Cç¬”è®°ã€‹@qlhhahaha</h1><hr><h3 id="Q-C-å®Œå…¨å…¼å®¹Cï¼Œä¸ºä»€ä¹ˆCè¿˜æœ‰å•ç‹¬å­˜åœ¨çš„å¿…è¦ï¼Ÿ">Q: C++å®Œå…¨å…¼å®¹Cï¼Œä¸ºä»€ä¹ˆCè¿˜æœ‰å•ç‹¬å­˜åœ¨çš„å¿…è¦ï¼Ÿ</h3><h3 id="A">A:</h3><h3 id="ä¸€ã€å¤§é“è‡³ç®€ï¼Œå¤šå¹¶éå¥½ï¼šç”¨æ›´å°‘çš„èµ„æºåšåŒæ ·çš„äº‹ï¼ˆå•ç‰‡æœºã€åº•å±‚èŠ¯ç‰‡èµ„æºæœ‰é™ï¼‰">ä¸€ã€å¤§é“è‡³ç®€ï¼Œå¤šå¹¶éå¥½ï¼šç”¨æ›´å°‘çš„èµ„æºåšåŒæ ·çš„äº‹ï¼ˆå•ç‰‡æœºã€åº•å±‚èŠ¯ç‰‡èµ„æºæœ‰é™ï¼‰</h3><h3 id="äºŒã€è·¨å¹³å°å…¼å®¹æ€§ï¼šä»…æœ‰Cèƒ½åšåˆ°å®Œç¾è·¨å¹³å°ï¼ˆè¿™ä¹Ÿæ˜¯å› ä¸ºå®ƒç®€å•ï¼ŒC-ç‰ˆæœ¬å¤ªå¤šã€æ ‡å‡†åè®®éƒ½ä¸ç»Ÿä¸€ï¼Œè€ä¸€ç‚¹çš„æœºå™¨å¯èƒ½æ ¹æœ¬å°±ä¸æ”¯æŒC17ç”šè‡³C11ç­‰ç°ä»£è¯­æ³•ï¼‰">äºŒã€è·¨å¹³å°å…¼å®¹æ€§ï¼šä»…æœ‰Cèƒ½åšåˆ°å®Œç¾è·¨å¹³å°ï¼ˆè¿™ä¹Ÿæ˜¯å› ä¸ºå®ƒç®€å•ï¼ŒC++ç‰ˆæœ¬å¤ªå¤šã€æ ‡å‡†åè®®éƒ½ä¸ç»Ÿä¸€ï¼Œè€ä¸€ç‚¹çš„æœºå™¨å¯èƒ½æ ¹æœ¬å°±ä¸æ”¯æŒC17ç”šè‡³C11ç­‰ç°ä»£è¯­æ³•ï¼‰</h3><h3 id="ä¸‰ã€C-å¤ªéš¾ï¼ŒäººåŠ›æˆæœ¬é«˜ï¼Œå­¦ä¹ é™¡å³­ã€ç»´æŠ¤å›°éš¾">ä¸‰ã€C++å¤ªéš¾ï¼ŒäººåŠ›æˆæœ¬é«˜ï¼Œå­¦ä¹ é™¡å³­ã€ç»´æŠ¤å›°éš¾</h3><h3 id="ï¼ˆæ–°å¢ï¼šå››ã€ä¸¤ç§è¯­è¨€åœ¨å®é™…åº”ç”¨ä¸­çš„ä½¿ç”¨æ€è·¯å…¶å®å·®å¼‚éå¸¸å¤§ï¼ŒCç¼–ç¨‹è€…å†™C-åªèƒ½å†™å‡ºC-with-classï¼Œå±äºæœ‰äº†å¤§ç‚®è¿˜ç”¨æ£’æ£’æˆ³ï¼›C-è€…å†™Cä¼šå‘ç°æŠ€èƒ½å…¨è¢«å°å°ï¼Œä¸çŸ¥å¦‚ä½•ç”¨å¹³Aæ‰“bossâ€”â€”æ€»ä¹‹ä¸€å¥è¯ï¼Œè®©å‰‘å®—å’Œæ°”å®—å„è‡ªå»åšè‡ªå·±çš„äº‹å§ï¼‰">ï¼ˆæ–°å¢ï¼šå››ã€ä¸¤ç§è¯­è¨€åœ¨å®é™…åº”ç”¨ä¸­çš„ä½¿ç”¨æ€è·¯å…¶å®å·®å¼‚éå¸¸å¤§ï¼ŒCç¼–ç¨‹è€…å†™C++åªèƒ½å†™å‡ºC with classï¼Œå±äºæœ‰äº†å¤§ç‚®è¿˜ç”¨æ£’æ£’æˆ³ï¼›C++è€…å†™Cä¼šå‘ç°æŠ€èƒ½å…¨è¢«å°å°ï¼Œä¸çŸ¥å¦‚ä½•ç”¨å¹³Aæ‰“bossâ€”â€”æ€»ä¹‹ä¸€å¥è¯ï¼Œè®©å‰‘å®—å’Œæ°”å®—å„è‡ªå»åšè‡ªå·±çš„äº‹å§ï¼‰</h3><h1>Lecture4ã€C Memory Management</h1><ol><li>sizeof( )å¯ä»¥æŸ¥çœ‹æ•°ç»„çš„å¤§å°ï¼Œä½†ä¸èƒ½æŸ¥çœ‹æŒ‡é’ˆæ‰€æŒ‡åŒºåŸŸçš„å¤§å°ï¼ˆä½†è¿™ä»ç„¶ä¸åº”æˆä¸ºä¸€ç§æ™®éç”¨æ³•ï¼Œæ›´å¥½çš„åšæ³•æ˜¯ä½¿ç”¨ä¸¤ä¸ªå‚æ•°ï¼šæ•°ç»„æŒ‡é’ˆå’Œæ•°ç»„é•¿åº¦ï¼‰</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> a[<span class="hljs-number">61</span>] ;<br><span class="hljs-type">int</span>* ptr = a;<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;the size of a is: %d, ptr is %d&quot;</span>, <span class="hljs-keyword">sizeof</span>(a), <span class="hljs-keyword">sizeof</span>(ptr))<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2023/04/14/KyR5fEG2k4iWZjo.png" alt=""></p><ol start="2"><li>ä¸€ç§å¸¸è§çš„å†…å­˜æ³„æ¼bug â€”â€” æ”¹å˜æŒ‡é’ˆå´æœªç•™å‰¯æœ¬</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">plk = (<span class="hljs-type">int</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">2</span>*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>...<br>plk++;<br></code></pre></td></tr></table></figure><h1>Lecture6ã€Assembly Language, RISC-V Intro</h1><ol><li><strong>ä¸»æµæ¶æ„</strong></li></ol><p><img src="https://s2.loli.net/2023/04/14/t67yLVeOrbdn9z2.png" alt=""></p><ul><li>**x86ï¼š**å±äºCISC(complex instruction set computer)ï¼Œintelå’ŒAMDéƒ½ä½¿ç”¨x86æ¶æ„ï¼ŒMacBookå’Œpc(Core i3, i5, i7, M)çš†ä½¿ç”¨x86æŒ‡ä»¤é›†</li><li>**ARMï¼š**å±äºRISC(reduced instruction set computer)ï¼Œç”¨äºæ™ºèƒ½æ‰‹æœºã€æ ‘è“æ´¾ã€åµŒå…¥å¼ç³»ç»Ÿ</li><li>**risc-Vï¼š**å±äºRISCï¼Œæ–°å…´æ¶æ„ï¼Œæœ€å¤§ä¼˜ç‚¹æ˜¯å¼€æºï¼Œå¸¸ç”¨äºäº‘è®¡ç®—ã€ç‰©è”ç½‘ç­‰</li></ul><ol start="2"><li><strong>memory hierarchy</strong></li></ol><p><img src="https://s2.loli.net/2023/04/14/VH4ydbQIkExq7zZ.png" alt=""></p><ol start="3"><li><p><strong>riscvç®€ä»‹</strong></p><p>å…±32ä¸ªå¯„å­˜å™¨ï¼Œæœ‰äº›ç”¨äºå­˜ç¼–ç¨‹ä¸­çš„å˜é‡ï¼Œæœ‰äº›ç”¨äºå­˜ä¸´æ—¶å˜é‡</p><p><img src="https://s2.loli.net/2023/04/14/4O7d1hY6rEVZkRH.png" alt=""></p><p><strong>åŸºæœ¬è¯­æ³•ï¼š</strong></p><p><img src="https://s2.loli.net/2023/04/14/TtZaqi3FPbB8Swk.png" alt=""></p><p><strong>æ•°æ®ä¼ è¾“æŒ‡ä»¤ï¼š</strong></p><ul><li>Load Wordï¼ˆlwï¼‰ï¼šè¯»å†…å­˜ï¼Œå³memory åˆ°register</li><li>Store Wordï¼ˆswï¼‰ï¼šåä¹‹</li></ul><p><img src="https://s2.loli.net/2023/04/14/F6iyTX91EgADKzV.png" alt=""></p><p><strong>å†…å­˜è¯»å†™æŒ‡ä»¤ï¼š</strong></p><ul><li>lbï¼šlb rd,imm(rs) â€”â€” ä»å†…å­˜ imm+rs å¤„è¯»å–8bitæ•°æ®(ç¬¦å·æ‹“å±•)åˆ° rd ä¸­</li><li>sbï¼šsb rs2,imm(rs1) â€”â€” å°†rs2ä¸­çš„8bitæ•°æ®å†™å…¥å†…å­˜imm+rs1å¤„</li></ul><p><img src="https://s2.loli.net/2023/04/14/WaCwBDVMZFRTnUS.png" alt=""></p></li></ol><div class="note note-warning">            <p>ğŸ’¡ PS.</p><ol><li>riscvé‡‡ç”¨çš„æ˜¯å°å­—èŠ‚åºï¼Œå³å¯¹äºs0ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚å­˜80ï¼Œç¬¬äºŒä¸ªå­˜01è¿™æ ·å­</li><li>offsetçš„å•ä½æ˜¯å­—èŠ‚</li><li>å› ä¸ºlbåªè¯»å†™8ä¸ªbitï¼Œè€Œriscvæ˜¯32ä½æ¶æ„ï¼Œæ‰€ä»¥è¦è¿›è¡Œç¬¦å·æ‹“å±•ã€‚å¦‚ç»™s2ä¸­è¯»å…¥0x80ï¼Œå³1000 0000ï¼Œæ‹“å±•ås2çš„å‰24ä½å°±éƒ½å˜æˆäº†F</li><li>ä¹Ÿæœ‰å…¶å®ƒçš„è¯»å†™æŒ‡ä»¤ï¼Œå¦‚lwå’Œswæ˜¯è¯»å†™32bitæ•°æ®</li></ol>          </div><p>â€‹<strong>æ§åˆ¶æŒ‡ä»¤ï¼š</strong></p><p><img src="https://s2.loli.net/2023/04/14/iqQIOF7pmfMrJR9.png" alt=""></p><ul><li>beqï¼šç›¸ç­‰åˆ™è·³</li><li>bneï¼šnot equal</li><li>bltï¼šbranch less than</li><li>bgeï¼šbranch greater than</li><li>jalï¼ˆjump and linkï¼‰ï¼šjal rd,labelæŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€å­˜å…¥rd,è·³è½¬åˆ°label</li></ul><p>â€‹<strong>æ¯”è¾ƒæŒ‡ä»¤ï¼š</strong></p><p><img src="https://s2.loli.net/2023/04/14/LP9hcsIFHp67Cm5.png" alt=""></p><h1>Lecture7ã€RISC-V Functions</h1><ol><li><p><strong>ä½æ•°æ‹“å±•</strong></p><p>æ‹“å±•ç¬¦å·ä½å³å¯ï¼Œå³æ­£æ•°è¡¥å……0ï¼Œè´Ÿæ•°è¡¥å……1</p><p><img src="https://s2.loli.net/2023/04/14/PRQYrc2WsikVbDe.png" alt=""></p></li><li><p><strong>å‡½æ•°</strong></p><p><img src="https://s2.loli.net/2023/04/14/ieJP4dKS5mn3faZ.png" alt=""></p><p>å…¶ä¸­jalçš„å‚æ•°raæ˜¯x1å¯„å­˜å™¨ï¼Œå­˜æ”¾å‡½æ•°è¿”å›åœ°å€ï¼ˆreturn addressï¼‰</p><p>è€Œä¼ªæŒ‡ä»¤jç­‰æ•ˆäºjal x0 labelï¼Œç”±äºx0æ’ä¸º0ä¸”æ— æ³•æ›´æ”¹ï¼Œæ‰€ä»¥ç›¸å½“äºåªè·³è½¬è€Œä¸è®°å½•è¿”å›åœ°å€ï¼›</p><p>jrç­‰æ•ˆäºjalr x0,0(rs)ï¼Œ(rs+imm)ä½ç½®çš„å†…å­˜åˆ°x0ï¼ˆå®é™…æ— æ•ˆï¼‰ï¼Œå¹¶è·³è½¬åˆ°rså¯„å­˜å™¨ä¿å­˜çš„åœ°å€</p><div class="note note-warning">            <p>ğŸ’¡ PS. jalå’Œjéƒ½æ˜¯ç”¨labelè·³è½¬ï¼›jræ˜¯ç”¨å¯„å­˜å™¨è·³è½¬</p>          </div></li></ol><h1>Lecture8ã€RISC-V Instruction Formats</h1><ol><li><p><strong>æ±‡ç¼–ä»£ç è½¬æ¢ä¸ºäºŒè¿›åˆ¶ä»£ç ï¼š</strong></p><p>æ€è·¯ï¼šå°†ä¸€æ¡æ±‡ç¼–è¯­å¥åˆ†ä¸ºå„ä¸ªfieldï¼Œæ¯ä¸ªfieldå æ®ä¸€å®šçš„ä½é•¿ï¼Œè¡¨ç¤ºç‰¹å®šå«ä¹‰ï¼ˆä¸€æ¡æ±‡ç¼–è¯­å¥å æ®32bitï¼‰</p><p>å¦‚R-Formatè¯­å¥ï¼šè¾“å…¥3ä¸ªå¯„å­˜å™¨ï¼ˆaddã€mulç­‰ï¼‰</p><p><img src="https://s2.loli.net/2023/04/14/p3OV82MSdCsLbn6.png" alt=""></p><p>å¯„å­˜å™¨çš„fieldéƒ½æ˜¯5bitï¼Œæ­£å¥½å¯ä»¥è¡¨ç¤º32ä¸ªå¯„å­˜å™¨</p></li></ol><h1>Lecture10ã€digital logic</h1><ol><li><strong>å¸ƒå°”ä»£æ•°è¿ç®—</strong></li></ol><p><img src="https://s2.loli.net/2023/04/14/bgfhmUysV6zwXRJ.png" alt=""></p><ol start="2"><li><strong>æ•°ç”µç³»ç»Ÿæœ‰ä¸¤ç§åŸºæœ¬ç±»å‹ï¼š</strong></li></ol><ul><li><p>**combinational logicï¼ˆCLï¼‰ï¼š**è¾“å‡ºä»…ä»…æ˜¯è¾“å…¥çš„å‡½æ•°ï¼Œä¸å†å²çŠ¶æ€æ— å…³ï¼ˆå¦‚cpuä¸­çš„åŠ æ³•è¿ç®—å™¨ï¼‰</p></li><li><p>**sequential logicï¼ˆSLï¼‰ï¼š**ä¸å†å²çŠ¶æ€æœ‰å…³ï¼ˆå¦‚memory and registersï¼‰</p></li></ul><h1>Lecture12ã€RISC-V Datapath, Single-Cycle Control Intro</h1><ol><li><p><strong>cpuæ‰§è¡Œæ±‡ç¼–è¯­å¥çš„ç¡¬ä»¶å®ç°</strong></p><p>**ç‰ˆæœ¬1.0ï¼š**å®ç°R-typeè¯­å¥ï¼ˆä»¥add t0 t2 t3ä¸ºä¾‹ï¼‰</p><p><img src="https://s2.loli.net/2023/04/14/xiFk6514aodpylg.png" alt=""></p><p>(1) è·å–æ±‡ç¼–æŒ‡ä»¤ï¼šåœ¨PCå¯„å­˜å™¨ä¸­è·å–å½“å‰æŒ‡ä»¤çš„åœ°å€ï¼Œå°†æŒ‡ä»¤å†…å®¹ä¼ ç»™IMEMï¼ˆinstruction memoryï¼‰ï¼ŒåŒæ—¶åŠ 4byteè¿”å›ç»™PCï¼ˆå³ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼‰</p><p>(2) å°†æŒ‡ä»¤åˆ†æ®µæˆå„ä¸ªfield</p><p>(3) å°†å¯„å­˜å™¨åœ°å€ä¼ ç»™å¯„å­˜å™¨å †ï¼ˆregister fileï¼‰ï¼Œè·å–å¯„å­˜å™¨ä¸­çš„å€¼</p><p>(4) å°†è·å–çš„å€¼ä¼ ç»™è¿ç®—å™¨ALUï¼Œå¹¶ç”±æ§åˆ¶ä½ALUSel(ect)å†³å®šé‡‡ç”¨å“ªç§è¿ç®—ï¼ˆaddã€subã€xorã€‚ã€‚ï¼‰</p><p>(5) ALUè¾“å‡ºè¿ç®—ç»“æœå¹¶å°†å€¼returnç»™register files</p><p>**ç‰ˆæœ¬2.0ï¼š**å®ç°loadsç±»å‹è¯­å¥ï¼ˆlbã€sbï¼‰</p><p><img src="https://s2.loli.net/2023/04/14/7XGujUOA5wZpdix.png" alt=""></p><p>è¯´æ˜ï¼š</p><p>ï¼ˆ1ï¼‰å¤šäº†ä¸€ä¸ªimmediate generatorï¼Œç”¨äºç”Ÿæˆç«‹å³æ•°ï¼Œå†åœ¨01é€‰æ‹©å™¨å¤„è¿›è¡Œé€‰æ‹©ï¼Œå³addå’Œaddiçš„åŒºåˆ«</p><p>ï¼ˆ2ï¼‰å¤šäº†ä¸€ä¸ªdata memoryï¼Œç”¨äºæ‰§è¡Œloadsç±»å‹çš„æŒ‡ä»¤ï¼ˆåœ¨å†…å­˜ä¸­è¯»å†™æ•°æ®ï¼‰ï¼Œå…¶ä¸­MemRWï¼ˆmemory read and writeï¼‰ç”¨äºé€‰æ‹©è¯»/å†™ï¼šä¸º0æ—¶è¯»æ•°æ®ï¼Œå°†Addrå¤„çš„æ•°æ®è¾“å‡ºï¼›ä¸º1æ—¶å†™æ•°æ®ï¼Œå°†è¾“å…¥çš„æ•°æ®å­˜åˆ°Addrå¤„çš„å†…å­˜ä¸­</p><p><img src="https://s2.loli.net/2023/04/14/jSRNUOicTJhrd4B.png" alt=""></p><p>**ç‰ˆæœ¬3.0ï¼š**å®ç°åˆ†æ”¯æ§åˆ¶è¯­å¥ï¼ˆbeqã€bltï¼‰</p><p><img src="https://s2.loli.net/2023/04/14/asl3DvzpPGjbSAc.png" alt=""></p><p>è¯´æ˜ï¼šå¤šäº†åˆ†æ”¯æ§åˆ¶æ¨¡å—ï¼Œå°†DataAå’ŒDataBè¿›è¡Œæ¯”è¾ƒï¼Œæ ¹æ®ç»“æœå°†ä¸‹é¢BrUnå‡ ä¸ªæ§åˆ¶ä½è®¾ä¸º0/1ï¼Œå†ç”¨ASelæ§åˆ¶01é€‰æ‹©å™¨ï¼Œä½¿ALUçš„è¾“å‡ºä¸ºè¦è·³è½¬çš„åœ°å€ï¼Œreturnç»™PC</p></li></ol><p>â€‹**æœ€ç»ˆç‰ˆæœ¬ï¼š**å®ç°è·³è½¬è¯­å¥</p><p><img src="https://s2.loli.net/2023/04/14/1rKli23jMkvx87Z.png" alt=""></p><h1>Lecture13ã€RISC-V Single-Cycle Control and Pipelining</h1><ol><li><p><strong>æ§åˆ¶å™¨è®¾è®¡</strong></p><p>ä»¥PCSelä¸ºä¾‹ï¼Œé»˜è®¤è¾“å‡º0ï¼Œä»…å½“opcodeä¸ºbranchè¯­å¥ï¼ˆ63ï¼‰æˆ–jumpè¯­å¥ï¼ˆ67æˆ–6fï¼‰æ—¶æ‰ä¼šè¾“å‡º1ï¼Œåˆ™åœ¨muxä¸­é€‰æ‹©ALUè¾“å‡º</p><p><img src="https://s2.loli.net/2023/04/14/IURA27kP5EHxicZ.png" alt=""></p></li><li><p><strong>æ§åˆ¶å™¨ç»“æ„</strong></p><p>è§‚å¯Ÿä¸Šé¢çš„CPUç»“æ„å¯çŸ¥ï¼Œæ§åˆ¶å™¨ä¸€å…±æœ‰ä¸‰ä¸ªè¾“å…¥ï¼Œå…¶ä½™çš„çš†æ˜¯è¾“å‡º</p><p>å®é™…ä¸­ç”±ROMå®ç°æ§åˆ¶å™¨</p><p><img src="https://s2.loli.net/2023/04/14/m7x2VWFOSo1rshY.png" alt=""></p></li><li><p><strong>pipeline</strong></p><p>**motivationï¼š**å•æ¡æŒ‡ä»¤è¿è¡Œæ—¶ï¼Œå¤§éƒ¨åˆ†ç‰ˆå—éƒ½å¤„äºç©ºé—²çŠ¶æ€ï¼Œ</p><p><img src="https://s2.loli.net/2023/04/14/wWYksDqCdZnixHG.png" alt=""></p><p><strong>cpuæ€§èƒ½è¡¨ç°ï¼š</strong></p><p><img src="https://s2.loli.net/2023/04/14/spvkcf2x5ITZz9Y.png" alt=""></p><p>ï¼ˆ1ï¼‰æ¯ä¸ªç¨‹åºçš„æŒ‡ä»¤æ•°å–å†³äºï¼š</p><ul><li>ç¨‹åºç®—æ³•çš„æ—¶é—´å¤æ‚åº¦</li><li>ç¼–ç¨‹è¯­è¨€</li><li>ç¼–è¯‘å™¨</li><li>ISA</li></ul><p>ï¼ˆ2ï¼‰æ¯æ¡æŒ‡ä»¤è¦æ‰§è¡Œå¤šå°‘ä¸ªcpuå¾ªç¯</p><ul><li>æŒ‡ä»¤å¤æ‚ç¨‹åº¦</li></ul><p>ï¼ˆ3ï¼‰æ¯ä¸ªcpuå¾ªç¯æ‰€è€—è´¹çš„æ—¶é—´</p><ul><li>cpuè®¾è®¡</li><li>ç”µå­å‚æ•°ï¼ˆæ™¶ä½“ç®¡å°ºå¯¸ã€ç”µå‹å¤§å°ï¼‰</li></ul><p><strong>æµæ°´çº¿æŠ€æœ¯ï¼š</strong></p><p><img src="https://s2.loli.net/2023/04/14/6DrgXQPSoFdTafs.png" alt=""></p> <div class="note note-warning">            <p>ğŸ’¡ PS. æµæ°´çº¿ä¸­ï¼Œå•ä¸ªæ¿å—çš„è€—æ—¶ç”±çŸ­æ¿å†³å®š</p>          </div></li></ol><p><img src="https://s2.loli.net/2023/04/14/kOFKpimAJRhWtNu.png" alt=""></p><p>â€‹<strong>riscvçš„5æ®µæµæ°´çº¿</strong><br><img src="https://s2.loli.net/2023/04/14/hRSsPQYO7Jpzu12.png" alt="Untitled"></p><h1>Lecture14ã€RISC-V 5-Stage Pipeline</h1><ol><li><p>æµæ°´çº¿è®¾è®¡ä¹Ÿä¼šå¸¦æ¥ä¸€äº›é—®é¢˜ï¼š</p><p>**ç»“æ„æ€§é—®é¢˜ï¼š**æŠ¢å èµ„æºï¼Œå¦‚ä¸¤æ¡æŒ‡ä»¤åŒæ—¶éœ€è¦ç”¨åˆ°RegFile</p><p>è§£å†³æ€è·¯ï¼š</p><ul><li>è®©è¯»/å†™ç«¯å£ç›¸äº’ç‹¬ç«‹</li><li>åœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸçš„å‰åŠéƒ¨åˆ†å†™æ•°æ®ï¼ŒååŠéƒ¨åˆ†è¯»æ•°æ®ï¼ˆè¿™åœ¨ç†è®ºä¸Šæ˜¯å¯è¡Œçš„ï¼Œå› ä¸ºRegFileçš„access timeè¿œä½äºæ—¶é’Ÿå‘¨æœŸçš„ä¸€åŠï¼‰</li></ul><p><img src="https://s2.loli.net/2023/04/14/wNPK5C8cMFSGinW.png" alt=""></p><p>**æ•°æ®æ›´æ–°é—®é¢˜ï¼š**ä¸€ä¸ªå…¸å‹æ¡ˆä¾‹ï¼Œå¤šæ¡è¯­å¥éƒ½è¦å¯¹t0è¿›è¡Œä¿®æ”¹ï¼Œä½†ç¬¬ä¸€æ¬¡è¿˜æ²¡ç”Ÿæ•ˆï¼Œåé¢å‡ æ¬¡å°±å¼€å§‹ç”¨äº†</p><p><img src="https://s2.loli.net/2023/04/14/qfBl9nzE2GigCsW.png" alt=""></p><p>è§£å†³æ€è·¯ï¼š</p><ul><li>è´®å­˜ï¼šåŠ å…¥ä¸€äº›ç©ºæŒ‡ä»¤è¿›è¡Œæ‹–å»¶ï¼Œç¡®ä¿ä¸Šä¸€æ¡æŒ‡ä»¤çš„ç»“æœå†™å…¥åï¼Œä¸‹ä¸€æ¡æŒ‡ä»¤æ‰å¼€å§‹è¯»å–</li></ul><p><img src="https://s2.loli.net/2023/04/14/H6gGC5djiPaKeyW.png" alt=""></p><ul><li>è½¬å‘ï¼šç»“æœç®—å‡ºåç«‹é©¬ä¼ è¾“ç»™ä¹‹åçš„ALUï¼Œè€Œä¸æ˜¯ä»RegFileä¸­è¯»å–</li></ul><p><img src="https://s2.loli.net/2023/04/14/8ATpVMf9w7khNyb.png" alt=""></p><p><strong>åˆ†æ”¯æ§åˆ¶é—®é¢˜ï¼š</strong>â€ç­‰å¾…branchè¯­å¥äº§ç”Ÿç»“æœâ€œè¿™ä¸€è¡Œä¸ºä¼šå¸¦æ¥å·¨å¤§çš„å»¶è¿Ÿï¼Œå¦‚æ‰€è°“çš„æµæ°´çº¿æ‰“å—ï¼ˆpipeline hiccupï¼‰äº§ç”Ÿæ°”æ³¡ï¼ˆbubbleï¼‰ï¼Œä¸ºæ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨**åˆ†æ”¯é¢„æµ‹ï¼ˆbranch predictionï¼‰**æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>å…ˆæ¥çœ‹ä¸€æ®µä»£ç ï¼Œåœ¨ä¸€ä¸ªå¤§å°ä¸º32768çš„æ•°ç»„ä¸­éšæœºã€å‡åŒ€åœ°æ”¾å…¥0~255çš„æ•°å­—ï¼Œå†å»ç»Ÿè®¡æ•°ç»„ä¸­ï¼128çš„æ•°çš„æ€»å’Œ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;algorithm&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ctime&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// éšæœºäº§ç”Ÿæ•´æ•°ï¼Œç”¨åˆ†åŒºå‡½æ•°å¡«å……ï¼Œä»¥é¿å…å‡ºç°åˆ†æ¡¶ä¸å‡</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> arraySize = <span class="hljs-number">32768</span>;<br>    <span class="hljs-type">int</span> data[arraySize];<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">unsigned</span> c = <span class="hljs-number">0</span>; c &lt; arraySize; ++c)<br>        data[c] = std::<span class="hljs-built_in">rand</span>() % <span class="hljs-number">256</span>;<br><br>    <span class="hljs-comment">// !!! æ’åºåä¸‹é¢çš„Loopè¿è¡Œå°†æ›´å¿«</span><br>    std::<span class="hljs-built_in">sort</span>(data, data + arraySize);<br><br>    <span class="hljs-comment">// æµ‹è¯•éƒ¨åˆ†</span><br>    <span class="hljs-type">clock_t</span> start = <span class="hljs-built_in">clock</span>();<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> sum = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">unsigned</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; ++i)<br>    &#123;<br>        <span class="hljs-comment">// ä¸»è¦è®¡ç®—éƒ¨åˆ†ï¼Œé€‰ä¸€åŠå…ƒç´ å‚ä¸è®¡ç®—</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">unsigned</span> c = <span class="hljs-number">0</span>; c &lt; arraySize; ++c)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (data[c] &gt;= <span class="hljs-number">128</span>)<br>                sum += data[c];<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-type">double</span> elapsedTime = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">double</span>&gt;(<span class="hljs-built_in">clock</span>() - start) / CLOCKS_PER_SEC;<br><br>    std::cout &lt;&lt; elapsedTime &lt;&lt; std::endl;<br>    std::cout &lt;&lt; <span class="hljs-string">&quot;sum = &quot;</span> &lt;&lt; sum &lt;&lt; std::endl;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹äºæœ‰åºæ•°ç»„ï¼š</p><p><img src="https://s2.loli.net/2023/04/14/YbFymqfUp5kreCM.png" alt=""></p><p>è€Œå¯¹äºæ— åºæ•°ç»„ï¼š</p><p><img src="https://s2.loli.net/2023/04/14/NfwLXZRz7yISuW5.png" alt=""></p><p>ä¸Šè¿°è€—æ—¶å·®å¼‚ç”±åˆ†æ”¯é¢„æµ‹å¯¼è‡´ï¼Œè€Œå®é™…ä¸­çš„åˆ†æ”¯é¢„æµ‹å¸¸ç”±å†å²æ•°æ®å†³å®šã€‚å¯¹äºæœ‰åºæ•°æ®ï¼Œå‰ä¸€åŠçš†ï¼œ128ï¼Œå¤„ç†å™¨å¾ˆå®¹æ˜“æ‰¾å‡ºå…¶ä¸­çš„patternï¼›æ— åºæ•°ç»„åˆ™ç›¸å½“äºçè’™ï¼Œåªæœ‰50%çš„å‘½ä¸­ç‡</p><p><img src="https://s2.loli.net/2023/04/14/kSy1c4aegBpC8NE.png" alt=""></p><div class="note note-warning">            <p>ğŸ’¡ PS. è¿™ä¸ªä¾‹å­ç»™æˆ‘ä»¬å¯ç¤º: åœ¨å¤§è§„æ¨¡å¾ªç¯é€»è¾‘ä¸­è¦å°½é‡é¿å…æ•°æ®å¼ºä¾èµ–çš„åˆ†æ”¯(data-dependent branching).</p>          </div><p>åˆ†æ”¯é¢„æµ‹çš„ç­–ç•¥å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼šé™æ€é¢„æµ‹å’ŒåŠ¨æ€é¢„æµ‹</p><p>**é™æ€é¢„æµ‹ï¼š**å›ºå®šçš„é¢„æµ‹ç­–ç•¥ï¼Œå¦‚â€â‰¥æŒ‡ä»¤ä¸€å¾‹è·³ï¼Œï¼œä¸€å¾‹ä¸è·³â€œã€â€ä¸ä¸Šæ¬¡takenä¿æŒä¸€è‡´â€œï¼Œè¿™ç±»ç­–ç•¥ç®€å•æ˜“å®ç°ä¸”èƒ½è€—å°ï¼Œä¹Ÿå¯ä»¥ä¿æŒä¸é”™çš„æ­£ç¡®ç‡ï¼ˆ70%ä»¥ä¸Šï¼‰ï¼Œå¯¹æ€§èƒ½è¦æ±‚ä¸æ˜¯ç‰¹åˆ«é«˜ä½†åˆè¦ä½åŠŸè€—ä½æˆæœ¬çš„ç³»ç»Ÿå¯ä»¥ä½¿ç”¨</p><p>**åŠ¨æ€é¢„æµ‹ï¼š**å¦‚2-bit çŠ¶æ€æœºï¼š åˆå§‹å€¼ä¸º00ï¼Œæ¯å½“ä¸€ä¸ªbranch takenå°±+1ï¼Œbranchæ²¡æœ‰takenåˆ™-1ã€‚æ ¹æ®ç¬¬ä¸€ä½çš„å€¼æ¥è¿›è¡Œé¢„æµ‹ï¼Œä¾‹å¦‚11é¢„æµ‹takenï¼Œ01é¢„æµ‹ not takenã€‚ ç”¨ä¸€ä¸ª2bitçŠ¶æ€æœºçš„æ ¸å¿ƒæ€è·¯å°±æ˜¯ï¼š<strong>è¿™æ¬¡é¢„æµ‹é”™äº†ä¸è¦ç´§ï¼Œå†ç»™ä½ ä¸€æ¬¡æœºä¼šï¼Œè¿˜æ˜¯é¢„æµ‹é”™äº†çš„è¯é‚£å†æ”¹å˜é¢„æµ‹ç»“æœ</strong>ã€‚æ€»ä¹‹å°±æ˜¯æä¾›äº†ä¸€å®šçš„å®¹é”™ç‡ï¼Œå¯æƒ³è€ŒçŸ¥è¿™æ ·çš„é¢„æµ‹å‡†ç¡®ç‡è‡ªç„¶ä¹Ÿæ˜¯æé«˜äº†çš„ã€‚</p></li></ol><h1>Lecture15-17ã€ Cache</h1><ol><li><strong>å…¸å‹å†…å­˜åˆ†çº§</strong></li></ol><p><img src="https://s2.loli.net/2023/04/14/jL2HfckoJCMQ5NX.png" alt=""></p><p>â€‹cacheç”¨static RAMï¼šæ›´å¿«ï¼ˆ1nsï¼‰ï¼Œä½†åŠŸè€—æ›´é«˜ä¹Ÿæ›´è´µï¼Œé€šç”µæ—¶å†…å®¹ä¸€ç›´åœ¨</p><p>â€‹ä¸»å­˜ç”¨dynamic RAMï¼šæ›´ä¾¿å®œä¹Ÿæ›´æ…¢ï¼ˆ70nsï¼‰ï¼Œå®šæ—¶æ›´æ–°å†…å®¹</p><ol start="2"><li><p>**ä¸¤ä¸ªåŸºæœ¬åŸç†ï¼š**æ—¶é—´å±€éƒ¨æ€§ï¼ˆå¦‚æœä¸€ä¸ªåœ°å€è¢«è®¿é—®äº†ä¸€æ¬¡ï¼Œé‚£ä¹ˆå®ƒæ¥ä¸‹æ¥è¿˜å¯èƒ½è¢«è®¿é—®å¾ˆå¤šæ¬¡ï¼‰ä¸ç©ºé—´å±€éƒ¨æ€§ï¼ˆå¦‚æœä¸€ä¸ªåœ°å€è¢«è®¿é—®äº†ä¸€æ¬¡ï¼Œé‚£ä¹ˆå®ƒå‘¨å›´çš„å†…å­˜ä¹Ÿå¯èƒ½è¢«è®¿é—®ï¼Œå¦‚æ•°ç»„ï¼‰</p></li><li><p><strong>ä»¥ç›´æ¥æ˜ å°„ï¼ˆdirect mappingï¼‰ä¸ºä¾‹ï¼Œå®Œæ•´å™è¿°cacheå·¥ä½œè¿‡ç¨‹</strong></p><p>å‡è®¾cacheå¤§å°64bytesï¼Œåˆ†ä¸º8ä¸ªcache lineï¼ˆæˆ–ç§°cache blockï¼‰ï¼Œåˆ™æ¯ä¸ªlineå¤§å°ä¸º8bytes</p> <div class="note note-warning">            <p>ğŸ’¡ PS. cache lineæ˜¯cacheå’Œä¸»å­˜ä¹‹é—´ä¼ è¾“æ•°æ®çš„æœ€å°å•ä½ï¼Œline å¤§å°ä¸€èˆ¬è®¾ä¸ºwordçš„æ•´æ•°å€ï¼ˆ4byteã€8byteè¿™æ ·å­ï¼‰ï¼Œå¾ˆå°‘ä¼šåšæˆ1byteï¼Œä¸ºä»€ä¹ˆæï¼Ÿè§ä¸‹æ–‡åˆ†æ</p>          </div><p><img src="https://s2.loli.net/2023/04/14/DyBX4L6cQtol7s5.png" alt=""></p><p>å‡è®¾åœ°å€ä½å®½ä¸º48bitï¼Œcpuç°åœ¨è¦åœ¨åœ°å€ä¸º0x0654ç©ºé—´ä¸­è¯»æ•°æ®ï¼Œé‚£ä¹ˆå¦‚å›¾ï¼Œé¦–å…ˆé€šè¿‡é»„è‰²éƒ¨åˆ†çš„010ï¼ˆç§°ä¹‹ä¸º<strong>index</strong>ï¼‰<strong>æ‰¾åˆ°å¯¹åº”ä½ç½®çš„cache line</strong>ï¼ˆè¿™ä¸ªè¿‡ç¨‹å¯ä»¥ç§°ä¹‹ä¸ºä¸€æ¬¡hashï¼‰ï¼Œä½†å…‰æ‰¾åˆ°lineè¿˜ä¸å¤Ÿï¼Œå› ä¸ºå¦‚æœä¸¤ä¸ªä¸åŒåœ°å€çš„bit3-bit5ä¸€æ ·çš„è¯ï¼Œç»è¿‡hashåéƒ½ä¼šæ‰¾åˆ°åŒä¸€ä¸ªcache lineã€‚ ä¸‹ä¸€æ­¥æ˜¯æ¯”è¾ƒç»¿è‰²çš„tagâ€”â€”<strong>æ¯ä¸€ä¸ªcache lineéƒ½å¯¹åº”å”¯ä¸€ä¸€ä¸ªtag</strong>ï¼Œtagä¸­ä¿å­˜çš„æ˜¯æ•´ä¸ª48bitåœ°å€é™¤å»indexå’Œoffsetåçš„å‰©ä½™éƒ¨åˆ†ã€‚è‹¥åœ°å€çš„tagå’Œlineå¯¹åº”çš„tagç›¸ç­‰ï¼Œåˆ™è¯´æ˜cacheç¡®å®æŠŠå†…å­˜ä¸­å‰45ä½åœ°å€ä¸º00â€¦.011001010xxxçš„é‚£8byteç©ºé—´å…¨æè¿›æ¥äº†ï¼Œå³cache hitã€‚okï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥åªéœ€è¦é€šè¿‡<strong>è“è‰²çš„offsetå°±å¯åœ¨lineä¸­æ‰¾åˆ°å…·ä½“çš„é‚£ä¸ªbyte</strong>ï¼›è‹¥tagä¸ç›¸ç­‰ï¼Œåˆ™cache missã€‚è¿™ä¹Ÿè§£ç­”äº†æˆ‘ä»¬ä¹‹å‰çš„ä¸€ä¸ªç–‘é—®â€œä¸ºå•¥cache lineä¸åšæˆä¸€ä¸ªbyteâ€ï¼Œå› ä¸ºåŸæœ¬8byteå¯¹åº”ä¸€ä¸ªtagï¼Œç°åœ¨éœ€è¦8ä¸ªtagï¼Œå ç”¨å¤ªå¤šç©ºé—´ï¼ˆtagä¹Ÿæ˜¯cacheçš„ä¸€éƒ¨åˆ†ï¼Œä½†æˆ‘ä»¬è°ˆåˆ°cache sizeçš„æ—¶å€™å¹¶ä¸è€ƒè™‘tagå ç”¨çš„å†…å­˜éƒ¨åˆ†ï¼‰ã€‚ å›¾ä¸­è¿˜å¯ä»¥çœ‹åˆ°tagæ—çš„valid bitï¼Œå®ƒç”¨æ¥è¡¨ç¤ºcache lineä¸­çš„æ•°æ®æ˜¯å¦æœ‰æ•ˆï¼Œå¦‚ç³»ç»Ÿåˆšå¯åŠ¨æ—¶ï¼Œcacheä¸­çš„æ•°æ®åº”è¯¥éƒ½æ˜¯æ— æ•ˆçš„ï¼Œå› ä¸ºè¿˜æ²¡æœ‰ç¼“å­˜ä»»ä½•æ•°æ®ã€‚æ‰€ä»¥å®é™…ä¸­æ¯”è¾ƒtagå‰è¿˜ä¼šæ£€æŸ¥valid bitæ˜¯å¦æœ‰æ•ˆï¼Œæ— æ•ˆåˆ™ç›´æ¥åˆ¤å®šcache missã€‚</p> <div class="note note-warning">            <p>ğŸ’¡ PS. ä½“ä¼šä¸€ä¸‹ä¸Šè¿°æŸ¥æ‰¾cacheçš„è¿‡ç¨‹ï¼Œä¼šå‘ç°è™½ç„¶çœ‹èµ·æ¥æœ‰ç‚¹å¤æ‚ï¼Œä½†æœ¬è´¨ä¸Šå°±æ˜¯ä¸ªé€šè¿‡åœ°å€æ‰¾å¯¹åº”æ•°æ®çš„è¿‡ç¨‹â€”â€”å…ˆåˆ¤æ–­cacheä¸­æ˜¯å¦æœ‰è¿™å‰45ä½åœ°å€ï¼Œæœ‰çš„è¯ç›´æ¥å¾€åæ‰¾æˆ‘è¦çš„é‚£ä¸ªæ•°æ®ï¼Œæ²¡æœ‰çš„è¯cache miss</p>          </div><p>ç›´æ¥æ˜ å°„ä¼˜ç‚¹ï¼šç¡¬ä»¶è®¾è®¡ç®€å•ã€æˆæœ¬ä½ ç¼ºç‚¹ï¼šç¨‹åºä¾æ¬¡è®¿é—®0x00ã€0x40ã€0x80ï¼ˆè¿™3ä¸ªåœ°å€çš„indexä¸€æ ·çš„ï¼‰æ—¶ï¼Œé¦–å…ˆè®¿é—®ç¬¬0ä¸ªlineï¼Œå†è®¿é—®0x40åœ°å€æ—¶ä¾ç„¶ä¼šæ£€ç´¢åˆ°ç¬¬0ä¸ªï¼Œç„¶åå‘ç°æ•°æ®ç¼ºå¤±ï¼Œäºæ˜¯ä»ä¸»å­˜ä¸­åŠ è½½0x0åœ°å€æ•°æ®åˆ°ç¬¬ä¸€ä¸ªlineï¼Œ0x80äº¦æ˜¯å¦‚æ­¤ï¼Œæ‰€ä»¥æ­¤æ—¶cacheçš„å­˜åœ¨å¹¶æ²¡æœ‰å¯¹æ€§èƒ½æœ‰å•¥æå‡ï¼Œè¿™ç§è¿ç»­åŠ è½½æ›¿æ¢cacheçš„ç°è±¡å«åš<strong>cacheé¢ ç°¸ï¼ˆcache thrashingï¼‰</strong>ï¼Œé’ˆå¯¹è¿™ä¸ªé—®é¢˜æˆ‘ä»¬å¼•å…¥å¤šè·¯ç»„ç›¸è¿ç¼“å­˜</p></li><li><p><strong>ä¸¤è·¯ç›¸è¿ç¼“å­˜ï¼ˆtwo-way set associative cacheï¼‰</strong></p><p>ä¾ç„¶å‡è®¾64 Bytes cache sizeï¼Œcache line sizeæ˜¯8 Bytesã€‚ä¸¤è·¯ç»„ç›¸è¿ç¼“å­˜å°±æ˜¯å°†cacheå¹³å‡åˆ†æˆ2ä»½ï¼Œæ¯ä»½32 Bytesã€‚</p><p><img src="https://s2.loli.net/2023/04/14/g4pRkofIhutGd7x.png" alt=""></p><p>cacheè¢«åˆ†æˆ2è·¯ï¼Œæ¯è·¯åŒ…å«4è¡Œcache lineã€‚æˆ‘ä»¬å°†æ‰€æœ‰indexä¸€æ ·çš„cache lineç»„åˆåœ¨ä¸€èµ·ç§°ä¹‹ä¸ºä¸€ä¸ªsetã€‚ä¾‹å¦‚ï¼Œä¸Šå›¾ä¸­ä¸€ä¸ªç»„æœ‰ä¸¤ä¸ªcache lineï¼Œæ€»å…±4ä¸ªç»„ã€‚æˆ‘ä»¬ä¾ç„¶å‡è®¾ä»åœ°å€0x0654åœ°å€è¯»å–ä¸€ä¸ªå­—èŠ‚æ•°æ®ã€‚ç”±äºcache line sizeæ˜¯8 Bytesï¼Œå› æ­¤offsetéœ€è¦3 bitsï¼Œè¿™å’Œä¹‹å‰ç›´æ¥æ˜ å°„ç¼“å­˜ä¸€æ ·ï¼›ä¸ä¸€æ ·çš„åœ°æ–¹æ˜¯indexï¼Œåœ¨ä¸¤è·¯ç»„ç›¸è¿ç¼“å­˜ä¸­ï¼Œindexåªéœ€è¦2 bitsï¼Œå› ä¸ºä¸€è·¯åªæœ‰4è¡Œcache lineã€‚ä¸Šé¢çš„ä¾‹å­æ ¹æ®indexæ‰¾åˆ°ç¬¬2è¡Œcache lineï¼ˆä»0å¼€å§‹è®¡ç®—ï¼‰ï¼Œç¬¬2è¡Œå¯¹åº”2ä¸ªcache lineï¼Œåˆ†åˆ«å¯¹åº”way 0å’Œway 1ã€‚å› æ­¤indexä¹Ÿå¯ä»¥ç§°ä½œset indexï¼ˆç»„ç´¢å¼•ï¼‰ã€‚å…ˆæ ¹æ®indexæ‰¾åˆ°setï¼Œç„¶åå°†ç»„å†…çš„æ‰€æœ‰cache lineå¯¹åº”çš„tagå–å‡ºæ¥å’Œåœ°å€ä¸­çš„tagéƒ¨åˆ†å¯¹æ¯”ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªç›¸ç­‰å°±æ„å‘³ç€å‘½ä¸­ã€‚ å› æ­¤ï¼Œä¸¤è·¯ç»„ç›¸è¿ç¼“å­˜è¾ƒç›´æ¥æ˜ å°„ç¼“å­˜æœ€å¤§çš„å·®å¼‚å°±æ˜¯ï¼šç¬¬ä¸€ä¸ªåœ°å€å¯¹åº”çš„æ•°æ®å¯ä»¥å¯¹åº”2ä¸ªcache lineï¼Œè€Œç›´æ¥æ˜ å°„ç¼“å­˜ä¸€ä¸ªåœ°å€åªå¯¹åº”ä¸€ä¸ªcache line</p></li><li><p><strong>å…¨ç›¸è¿ç¼“å­˜(Full associative cache)</strong></p><p>è¿›ä¸€æ­¥æŠŠæ‰€æœ‰çš„cache lineæ”¾åœ¨ä¸€ä¸ªç»„é‡Œï¼Œç§°ä¹‹ä¸ºå…¨ç›¸è¿ç¼“å­˜</p><p><img src="https://s2.loli.net/2023/04/14/Eefgy3G5dYlxDtH.png" alt=""></p><p>ç”±äºæ‰€æœ‰çš„cache lineéƒ½åœ¨ä¸€ä¸ªç»„å†…ï¼Œå› æ­¤åœ°å€ä¸­ä¸éœ€è¦set indexéƒ¨åˆ†ã€‚å› ä¸ºï¼Œåªæœ‰ä¸€ä¸ªç»„è®©ä½ é€‰æ‹©ï¼Œä¹Ÿå°±æ˜¯æ²¡å¾—é€‰ã€‚æˆ‘ä»¬æ ¹æ®åœ°å€ä¸­çš„tagéƒ¨åˆ†å’Œæ‰€æœ‰çš„cache lineå¯¹åº”çš„tagè¿›è¡Œæ¯”è¾ƒï¼ˆç¡¬ä»¶ä¸Šå¯èƒ½å¹¶è¡Œæ¯”è¾ƒä¹Ÿå¯èƒ½ä¸²è¡Œæ¯”è¾ƒï¼‰ã€‚å“ªä¸ªtagæ¯”è¾ƒç›¸ç­‰ï¼Œå°±æ„å‘³ç€å‘½ä¸­æŸä¸ªcache lineã€‚å› æ­¤ï¼Œåœ¨å…¨ç›¸è¿ç¼“å­˜ä¸­ï¼Œä»»æ„åœ°å€çš„æ•°æ®å¯ä»¥ç¼“å­˜åœ¨ä»»æ„çš„cache lineä¸­ã€‚æ‰€ä»¥ï¼Œè¿™å¯ä»¥æœ€å¤§ç¨‹åº¦çš„é™ä½cacheé¢ ç°¸çš„é¢‘ç‡ï¼Œä½†æ˜¯ç¡¬ä»¶æˆæœ¬ä¸Šä¹Ÿæ˜¯æ›´é«˜ã€‚</p></li><li><p><strong>ç¼“å­˜å‘½ä¸­</strong></p><p>cache hitï¼šcacheä¸­æœ‰blockçš„æœ‰æ•ˆå‰¯æœ¬ï¼Œæ‰€ä»¥èƒ½è¿”å›æœŸæœ›æ•°æ®</p><p>cache missï¼šcacheä¸­æ²¡æœ‰æƒ³è¦çš„blockï¼Œæ‰€ä»¥åªèƒ½ä»memoryä¸­å–å‡º</p><p>block replacementï¼šè‹¥cacheæ»¡äº†ï¼Œå°±è¦æ’¤é”€å…¶ä¸­ä¸€ä¸ªblockï¼Œç”¨æœŸå¾…è¯»å–çš„æ•°æ®æ›¿æ¢ã€‚ä½†æ˜¯æ›¿æ¢å“ªä¸ªblockæï¼Ÿ</p><p>å¸¸ç”¨çš„cacheç®—æ³•ï¼š</p><ul><li><p>éšæœºæ›¿æ¢</p></li><li><p>Least Recently Usedï¼ˆLRUï¼‰ï¼šæœ€è¿‘ä¸€æ¬¡è®¿é—®æ—¶é—´æœ€ä¹…è¿œçš„é‚£ä¸ªblock</p></li></ul></li><li><p><strong>å¤šçº§cacheä¹‹é—´çš„é…åˆå·¥ä½œ:</strong></p><p><img src="https://s2.loli.net/2023/04/14/X14bpdWwz5aSgCn.png" alt=""></p><p>å½“CPUè¯•å›¾ä»æŸåœ°å€loadæ•°æ®æ—¶ï¼Œé¦–å…ˆä»L1 cacheä¸­æŸ¥è¯¢æ˜¯å¦å‘½ä¸­ï¼Œå¦‚æœå‘½ä¸­åˆ™æŠŠæ•°æ®è¿”å›ç»™CPUã€‚å¦‚æœL1 cacheç¼ºå¤±ï¼Œåˆ™ç»§ç»­ä»L2 cacheä¸­æŸ¥æ‰¾ã€‚å½“L2 cacheå‘½ä¸­æ—¶ï¼Œæ•°æ®ä¼šè¿”å›ç»™L1 cacheåŠCPUã€‚å¦‚æœL2 cacheä¹Ÿç¼ºå¤±ï¼Œå¾ˆä¸å¹¸ï¼Œæˆ‘ä»¬éœ€è¦ä»ä¸»å­˜ä¸­loadæ•°æ®ï¼Œå°†æ•°æ®è¿”å›ç»™L2 cacheã€L1 cacheåŠCPUã€‚è¿™ç§å¤šçº§cacheçš„å·¥ä½œæ–¹å¼ç§°ä¹‹ä¸ºinclusive cacheã€‚æŸä¸€åœ°å€çš„æ•°æ®å¯èƒ½å­˜åœ¨å¤šçº§ç¼“å­˜ä¸­ã€‚ä¸inclusive cacheå¯¹åº”çš„æ˜¯exclusive cacheï¼Œè¿™ç§cacheä¿è¯æŸä¸€åœ°å€çš„æ•°æ®ç¼“å­˜åªä¼šå­˜åœ¨äºå¤šçº§cacheå…¶ä¸­ä¸€çº§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»»æ„åœ°å€çš„æ•°æ®ä¸å¯èƒ½åŒæ—¶åœ¨L1å’ŒL2 cacheä¸­ç¼“å­˜</p></li><li><p><strong>å†™æ“ä½œï¼š</strong></p><p>å†™æ“ä½œä¼šé€ æˆcacheå’Œä¸»å­˜ä¸­çš„æ•°æ®ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆå¦‚ä½•ä¿è¯æ•°æ®æ“ä½œæ­£ç¡®æï¼Ÿ</p><ul><li><p>é€šå†™ï¼ˆwrite throughï¼‰ï¼šæŠŠæ•°æ®å†™å…¥cacheçš„åŒæ—¶ä¹Ÿå†™å…¥ä¸»å­˜ï¼Œå¥½å¤„æ˜¯ä¿æŒä¸€è‡´æ€§ï¼Œåå¤„æ˜¯æå…¶å½±å“å†™é€Ÿåº¦</p><p><img src="https://s2.loli.net/2023/04/14/EJbRZ36jGACeOsL.png" alt=""></p></li><li><p>å›å†™ï¼ˆwrite backï¼‰ï¼šå…ˆæŠŠæ•°æ®å†™å›cacheï¼Œå½“cacheä¸­çš„æ•°æ®è¢«æ›¿æ¢æ—¶å†å†™å›ä¸»å­˜ã€‚å…·ä½“é€šè¿‡dirty bitå®ç°ï¼Œæ•°æ®ä¿®æ”¹åˆ™ç½®ä½ã€‚</p></li></ul><p><img src="https://s2.loli.net/2023/04/14/DHV7LmUpOwS63Ic.png" alt=""></p></li><li><p><strong>AMATï¼ˆAverage Memory Access Timeï¼‰</strong></p><p>åŒæ—¶è€ƒè™‘å‘½ä¸­å’Œä¸¢å¤±æ—¶çš„è·å–memoryä¸­æ•°æ®çš„å¹³å‡æ—¶é—´</p></li></ol><p><img src="https://s2.loli.net/2023/04/14/qd5wpKOuEiGHbyA.png" alt=""></p><p><img src="https://s2.loli.net/2023/04/14/5eh9B36T7NISdHL.png" alt=""></p><p>â€‹AMAT=1+0.02*50=2 clock cycles=400ps</p><p>â€‹â€”â€”190ps clockï¼š2 cycles=2*190=380</p><p>â€‹â€”â€”MP of 40 clock cyclesï¼š1+0.02*40=360</p><p>â€‹<strong>â€”â€”MR of 0.015*50=350 ï¼ˆâˆšï¼‰</strong></p><h1>Lecture18-19ã€Operating Systems &amp; Virtual Memory</h1><ol><li><p>OSçš„æœ€å…¸å‹ç‰¹å¾ä¹‹ä¸€å°±æ˜¯<strong>å¤šä»»åŠ¡</strong>ï¼Œä¾èµ–äºä¸åŒå¤„ç†å™¨çš„è¿›ç¨‹åˆ‡æ¢ï¼Œä½†è¿™ä¸ªè¿‡ç¨‹å¯èƒ½å¯¼è‡´å†…å­˜èµ„æºåœ°å€ç­‰å‘ç”Ÿå˜åŒ–</p><p><img src="https://s2.loli.net/2023/04/14/cwJQEKZl3WgzmU4.png" alt=""></p><p><img src="https://s2.loli.net/2023/04/14/yGSTfc3ELUFu4nQ.png" alt=""></p><p>é€ æˆè¿™ç§ç°è±¡çš„åŸå› æ˜¯åº”ç”¨æœªå®Œå…¨éš”ç¦»ï¼Œä¸€ä¸ªåº”ç”¨å¯ä»¥è¦†å†™å¦ä¸€ä¸ªåº”ç”¨çš„å†…å­˜ï¼ŒåŒæ—¶è€ƒè™‘åˆ°ä¸€äº›å…¶ä»–é—®é¢˜ï¼ˆå¦‚å¯èƒ½ä¼šå¤„ç†æ¯”æˆ‘ä»¬çœŸæ­£éœ€æ±‚è¦å¤šä¸å°‘çš„å†…å­˜ï¼Œåƒç¨€ç–çŸ©é˜µï¼‰ï¼Œæˆ‘ä»¬å¼•å…¥è™šæ‹Ÿå†…å­˜</p></li><li><p><strong>virtual memory</strong></p><ul><li>è™šæ‹Ÿå†…å­˜VMï¼šç»™æ¯ä¸ªè¿›ç¨‹éš”ç¦»çš„ç©ºé—´ï¼Œè¿›ç¨‹è®¤ä¸ºå…¶å†…å­˜è¶³å¤Ÿå¤§ï¼Œå¹¶ä¸”å®Œå…¨å±äºè‡ªå·±ï¼ˆä»…è‡ªå·±æœ‰è®¿é—®æƒï¼‰</li><li>ç‰©ç†å†…å­˜PMï¼šç”µè„‘ä¸­çœŸå®çš„é™åˆ¶æ€§çš„RAM</li></ul><p><strong>key ideaï¼š<strong>ç”±äºç¨‹åºå¤§å°çš„è†¨èƒ€ï¼Œä¸”ç³»ç»ŸåŒæ—¶è¿è¡Œå¤šä¸ªç¨‹åºï¼Œç»å¸¸ä¼šå‡ºç°éœ€è¦ç©ºé—´&gt;å®é™…å†…å­˜çš„é—®é¢˜ï¼Œè€Œè™šæ‹Ÿå†…å­˜å¯æœ‰æ•ˆè§£å†³è¯¥é—®é¢˜ï¼šæ¯ä¸ªè¿›ç¨‹éƒ½æŒæœ‰å„è‡ªçš„è™šæ‹Ÿå†…å­˜ï¼Œ<strong>åˆ†ä¸ºå¾ˆå¤šä¸ªé¡µ</strong>ï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰é¡µéƒ½å¿…é¡»åœ¨å†…å­˜ä¸­æ—¶æ‰èƒ½è¿è¡Œç¨‹åºã€‚ç”¨åˆ°å“ªä¸€é¡µï¼Œå°±ä½œæ˜ å°„å»ç‰©ç†åœ°å€å¯»æ‰¾æ•°æ®ï¼›è‹¥æ˜ å°„è¿™ä¸ªç‰©ç†åœ°å€ä¸åœ¨å†…å­˜ä¸­æ€ä¹ˆåŠæï¼Ÿé‚£å®ƒåœ¨å“ªé‡Œæï¼Ÿç­”æ¡ˆæ˜¯ï¼š<strong>å¤–å­˜ï¼Œå³disk</strong>ã€‚æ¥ä¸‹æ¥ç”±ç³»ç»Ÿè‡ªåŠ¨å®Œæˆå°†å¤–å­˜è°ƒå…¥å†…å­˜çš„çš„å·¥ä½œï¼›è€Œå½“å†…å­˜ç©ºé—´ä¸å¤Ÿæ—¶ï¼Œç³»ç»ŸæŒ‰ä¸€å®šç®—æ³•</strong>é‡Šæ”¾æŸéƒ¨åˆ†å†…å­˜ç©ºé—´</strong>ã€‚ é€šè¿‡ä¸Šè¿°æ“ä½œï¼Œå°±èƒ½è®©ç¨‹åºåœ¨è¿è¡Œä¸­æ„Ÿè§‰åˆ°æ‹¥æœ‰ä¸€ä¸ªä¸å—å†…å­˜å®¹é‡çº¦æŸçš„ã€è™šæ‹Ÿçš„ã€èƒ½å¤Ÿæ»¡è¶³è‡ªå·±éœ€æ±‚çš„å­˜å‚¨å™¨ã€‚</p><p>ä¸»è¦éœ€è¦è¾¾æˆçš„å‡ ä¸ªç›®æ ‡ï¼š</p><ul><li><p>è¿›ç¨‹éš”ç¦»</p></li><li><p>æœ‰é™åˆ°æ— é™ç©ºé—´çš„è¿‡æ¸¡</p></li><li><p>VMã€PMåœ°å€çš„è½¬æ¢</p></li></ul></li><li><p><strong>è§£å†³æ€è·¯ï¼šåˆ†æ®µå†…å­˜ï¼ˆsegmented memoryï¼‰</strong></p><p>æ¯ä¸ªæ®µç”¨åŸºåœ°å€ï¼ˆbaseï¼‰å’Œåç§»åœ°å€ï¼ˆboundï¼‰è¡¨ç¤ºï¼Œæ¯ä¸ªç¨‹åºç‹¬äº«ä¸€ä¸ªsegmentï¼Œåœ¨å„è‡ªçš„å†…å­˜è§†è§’ä¸­ï¼Œéƒ½è®¤ä¸ºè‡ªå·±è¿™ä¸ªæ®µçš„æ®µé¦–åœ°å€æ˜¯0x0000</p><p>åœ¨è£¸çš„äº”æ®µæµæ°´çº¿ä¸­ï¼ŒPCè¾“å‡ºçš„æ˜¯çœŸå®çš„ç‰©ç†åœ°å€ï¼›ä½†åœ¨base and boundæœºåˆ¶ä¸­ï¼š</p><p><img src="https://s2.loli.net/2023/04/14/sEHDjNy6hVXOwtf.png" alt=""></p><p>ä½†åˆ†æ®µå†…å­˜ä»æœ‰ä¸€äº›é—®é¢˜ï¼šå¦‚æœæˆ‘ä»¬éœ€è¦çš„åœ°å€æ¯”æ®µç©ºé—´å¤§æï¼ŸRAMéƒ½åˆ†æˆäº†æ®µå¯¼è‡´è¿ç»­ç©ºé—´ä¸å¤Ÿæï¼Ÿ</p></li><li><p><strong>åˆ†é¡µå†…å­˜ï¼ˆpaged memoryï¼‰</strong></p><p>**key ideaï¼š**æŠŠç‰©ç†å†…å­˜å‡åˆ†ä¸ºå¤šä¸ªpageï¼Œæ¯ä¸ªè¿›ç¨‹å¯ä»¥ç‹¬äº«å¤šä¸ªpageã€‚pageåœ¨RAMä¸­ä¸å¿…çœŸçš„è¿ç»­ï¼Œä½†åœ¨å„ä¸ªè¿›ç¨‹çš„è§†è§’çœ‹æ¥ï¼Œå®ƒä»¬å¯¹è‡ªå·±æ¥è¯´å°±æ˜¯è¿ç»­çš„</p><p>é‚£VMã€PMåœ°å€å¦‚ä½•è½¬æ¢å‘¢â€”â€”page tableï¼Œæ¯ä¸ªè¿›ç¨‹ç»´æŠ¤ä¸€å¼ ï¼Œç”¨äºè®°å½•è‡ªå·±å ç”¨çš„pageå’Œå…¶çœŸå®ç‰©ç†åœ°å€</p><p><img src="https://s2.loli.net/2023/04/14/uHglNXbaPYtRD8G.png" alt=""></p><p>æ³¨æ„ï¼šè™šæ‹Ÿå†…å­˜åœ¨RAMæ²¡æœ‰å¯¹åº”æ˜¯ä¸€ä»¶å¾ˆæ­£å¸¸çš„äº‹å“ˆï¼ˆå›¾ä¸­é»„è‰²çš„é‚£äº›é¡µï¼‰ï¼ŒCç›˜é‡Œé‚£ä¸ªå·¨å¤§çš„PageFile.Syså°±æ˜¯æ”¾åœ¨å¤–å­˜é‡Œçš„è™šæ‹Ÿå†…å­˜</p></li><li><p><strong>åœ°å€è½¬æ¢</strong></p><p><img src="https://s2.loli.net/2023/04/14/X95WOrG2kMZ7HAp.png" alt=""></p><p><img src="https://s2.loli.net/2023/04/14/IUG75RzLhYKfJ6F.png" alt=""></p><p><strong>è½¬æ¢ç®—æ³•ï¼š</strong></p><p>1ï¼‰é€šè¿‡virtual page numberåœ¨è¡¨ä¸­æ‰¾åˆ°å¯¹åº”ä½ç½®</p><p>2ï¼‰æ£€æŸ¥validå’Œaccess rightsä½æ˜¯å¦æœ‰æ•ˆ</p><p>3ï¼‰é€šè¿‡physical page numberå’Œoffsetç®—å‡ºç‰©ç†åœ°å€</p></li><li><p><strong>é¡µé¢è¡¨</strong></p><p>è‹¥æ˜¯ç®€å•çš„çº¿æ€§ç»“æ„è¡¨ï¼Œéœ€è¦è¡¨0å’Œè¡¨næ—¶å¾—éå†æ•´ä¸ªè¡¨ï¼Œå¾ˆè€—æ—¶é—´ï¼ˆä¸€ä¸ªæ“ä½œç³»ç»Ÿä¸­page tableé‡Œçš„entryå¯å¤šè¾¾æ•°ç™¾ä¸‡æ¡ï¼‰ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº›æ”¹è¿›ç»“æ„</p><ul><li><p><strong>åˆ†çº§åˆ†é¡µ</strong></p><p><img src="https://s2.loli.net/2023/04/14/pfaS9cNI3jtsAvB.png" alt=""></p></li></ul></li><li><p><strong>é¡µè¡¨ç¼“å†²TLBï¼ˆTranslation Lookaside Bufferï¼‰</strong></p><p>åœ¨åˆ†çº§åˆ†é¡µä¸­ï¼Œè·å–ä¸€ä¸ªæ•°æ®å¯èƒ½éœ€è¦å¤šæ¬¡è®¿é—®physical addressï¼Œé€ æˆé€Ÿåº¦ç¼“æ…¢ï¼Œè€Œæ—¢ç„¶pageä¸­ä¹Ÿå­˜åœ¨å±€éƒ¨æ€§ï¼Œé‚£æˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨å’Œcacheçš„ç±»ä¼¼çš„ç¼“å­˜ç»“æ„</p><p><img src="https://s2.loli.net/2023/04/14/J7bRiFxkNu6yQHD.png" alt=""></p><ul><li>TLBä¸­å­˜çš„ä¸æ˜¯å†…å­˜æ•°æ®ï¼Œè€Œæ˜¯VPNâ†’PPNçš„æ˜ å°„</li><li>TLBé€šå¸¸å¾ˆå°ï¼Œä¸€èˆ¬å­˜32-128æ¡entry</li><li>é€Ÿåº¦æ¯”cacheå¿«å¾ˆå¤š</li></ul><p>**TLBå’Œcacheçš„ç»„åˆå·¥ä½œåŸç†ï¼š**å…ˆåœ¨TLBä¸­æŸ¥è™šæ‹Ÿåœ°å€ï¼Œå‘½ä¸­åˆ™ç›´æ¥åœ¨cacheä¸­è¯»ç‰©ç†åœ°å€ï¼›å¦åˆ™åœ¨page tableä¸­æ‰¾æ˜ å°„å…³ç³»</p><p><img src="https://s2.loli.net/2023/04/14/kE78VqNFfGBLZlj.png" alt=""></p></li></ol><h1>Lecture20ã€IO</h1><ol><li><p>**disks are I/Oï¼š**å› ä¸ºcpuæ— æ³•ä»ç£ç›˜ï¼ˆåŒ…æ‹¬ssdå’Œæœºæ¢°ï¼‰ä¸­ç›´æ¥è¯»å†™æ•°æ®ï¼Œpageä»diskç§»å‘RAMåæ‰ä¼šå˜æˆmemoryï¼›ç”µè„‘æ²¡diskä¹Ÿèƒ½è·‘</p></li><li><p><strong>IOæ“ä½œæ–¹å¼ï¼š</strong></p><p>å¤„ç†å™¨é¢‘ç‡ä¸€èˆ¬è¿œå¤§äºIOè®¾å¤‡ï¼Œæ‰€ä»¥éœ€è¦ä¸€å®šæ–¹å¼è¿›è¡Œæ“ä½œ</p><ul><li><p><strong>è½®è¯¢ï¼ˆpollingï¼‰</strong></p><p>å¤„ç†å™¨åœ¨å¾ªç¯ä¸­ä¸æ–­ç­‰å¾…control registerä¿¡å·ï¼Œè‹¥ready bitç½®ä¸€ï¼Œåˆ™å¤„ç†å™¨å‘data registerä¸­è¯»å†™æ•°æ®ï¼Œcè¯­è¨€ä¸­çš„while(getchar()==â€˜xâ€™)å…¶å®å°±æ˜¯ä¸€ç§æœ€ç®€å•çš„è½®è¯¢æ€æƒ³ è½®è¯¢å¯¹äºä¸€äº›ç®€å•è®¾å¤‡æ²¡é—®é¢˜ï¼Œå¦‚é¼ æ ‡ï¼Œä¸€ç§’åªåš30æ¬¡pollingï¼Œcpuè€—æ—¶æ¯”ä¾‹å¾ˆä½ï¼›ä½†ç£ç›˜æ¯ç§’è¯»å†™æ•°MBçš„æ•°æ®ï¼Œç®—ä¸‹æ¥cpué«˜è¾¾40%çš„æ—¶é—´éƒ½è€—åœ¨è½®è¯¢ä¸Šï¼Œæ˜¾ç„¶ä¸å¯æ¥å—</p></li><li><p><strong>ä¸­æ–­ï¼ˆinterruptï¼‰</strong></p><p><img src="https://s2.loli.net/2023/04/14/D5sxBgJl7cUIuOw.png" alt=""></p><p>ç»è®¡ç®—ï¼Œä¸­æ–­å¯æŠŠcpuåœ¨ç£ç›˜è¯»å†™ä¸Šçš„è€—æ—¶é™åˆ°2%ï¼Œä½†è¿˜å¯ä»¥ä¼˜åŒ–</p></li><li><p>**DMAï¼š**memoryå’ŒIOè®¾å¤‡ç›´æ¥ä¼ æ•°æ®ï¼Œä¸ç»è¿‡cpu</p><p>ä¸€ä¸ªæ¯”å–»ï¼špollingåƒé¥¿äº†å»é¤é¦†ï¼Œè¿‡ä¸€ä¼šå„¿é—®ä¸‹â€œèœå¥½æ²¡â€ï¼›interruptåƒåœ¨çº¿ä¸‹å•ï¼Œä½ ç»§ç»­å¹²æ´»ï¼Œåšå¥½äº†å†å«ä½ ï¼Œå»äº†ç›´æ¥æ‹¿ç›´æ¥èµ°ï¼›dmaåˆ™åƒä¸‹ä¸€å•å¤–å–ï¼Œæ‹¿å–éƒ½å–æ¶ˆï¼Œåªç®¡ç­‰ä¸œè¥¿æ¥</p><p><img src="https://s2.loli.net/2023/04/14/gMWR4TAvKzIw9Jk.png" alt=""></p><p>ç»è®¡ç®—ï¼Œdmaå¯æŠŠcpuåœ¨ç£ç›˜è¯»å†™ä¸Šçš„è€—æ—¶é™åˆ°0.2%</p></li></ul></li></ol><h1>Lecture21ã€Data-level Parallelism</h1><ol><li><p>**motivationï¼š**æ™¶ä½“ç®¡çš„å‘å±•å—é™ï¼Œæ— æ³•é€šè¿‡æé«˜æ—¶é’Ÿé¢‘ç‡è¿›ä¸€æ­¥æå‡cpuæ€§èƒ½ï¼Œè€Œå¹¶è¡Œæ­£æ˜¯è§£å†³è¿™ä¸€é—®é¢˜çš„å¥½æ–¹æ³•</p></li><li><p><strong>å¹¶è¡ŒåŒ–åˆ†ç±»</strong></p><p><img src="https://s2.loli.net/2023/04/14/zlKvwu2JBD8m4aL.png" alt=""></p></li><li><p><strong>SIMD(Single Instruction Multiple Data)æ¶æ„</strong></p><p>è®¸å¤šåŸºæœ¬æ•°æ®ç±»å‹ä¸º8bitï¼Œè€Œç°åœ¨å¤„ç†å™¨æ˜¯32/64bitï¼Œè‹¥ä¸€æ¬¡åªç”¨64ä½ä¸­çš„ä½å…«ä½å¤„ç†æ•°æ®æ˜¾ç„¶å¾ˆæµªè´¹ï¼Œä½†è‹¥å°†64ä½å¯„å­˜å™¨æ‹†æˆ8ä¸ª8ä½å¯„å­˜å™¨å°±èƒ½åŒæ—¶å®Œæˆ8ä¸ªæ“ä½œï¼Œè®¡ç®—æ•ˆç‡æå‡8å€ï¼Œè¿™å°±æ˜¯SIMDçš„åˆè¡·ï¼Œå…·ä½“è¡¨ç°ä¸ºå‘é‡è¿ç®—</p><p><img src="https://s2.loli.net/2023/04/14/DeBKghxMAmLtojf.png" alt=""></p><p>intelçš„ä¸€äº›æ‹“å±•æŒ‡ä»¤é›†SSEï¼ˆStreaming SIMD Extensionsï¼‰ã€AVXï¼ˆAdvanced Vector Extensionsï¼‰ç”¨äºè¿›è¡ŒSIMDè¿ç®—</p><p>å…·ä½“å®ç°ä¸Šï¼Œå¸¸ç”¨å†…ç½®å‡½æ•°ï¼ˆintrinsicsï¼‰æ–¹å¼ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºè®©ä¸¤æ•°ç»„ç›¸åŠ </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">add_no_SSE</span><span class="hljs-params">(<span class="hljs-type">int</span> size, <span class="hljs-type">int</span> *first_array, <span class="hljs-type">int</span> *second_array)</span> </span>&#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; size; ++i) &#123;<br>first_array[i] += second_array[i];<br>&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">add_SSE</span><span class="hljs-params">(<span class="hljs-type">int</span> size, <span class="hljs-type">int</span> *first_array, <span class="hljs-type">int</span> *second_array)</span> </span>&#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i + <span class="hljs-number">4</span> &lt;= size; i+=<span class="hljs-number">4</span>) &#123; <span class="hljs-comment">// only works if (size%4) == 0</span><br><span class="hljs-comment">// load 128-bit chunks of each array</span><br>__m128i first_values = _mm_loadu_si128((__m128i*) &amp;first_array[i]);<br>__m128i second_values = _mm_loadu_si128((__m128i*) &amp;second_array[i]);<br><span class="hljs-comment">// add each pair of 32-bit integers in the 128-bit chunks</span><br>first_values = _mm_add_epi32(first_values, second_values);<br><span class="hljs-comment">// store 128-bit chunk to first array</span><br>_mm_storeu_si128((__m128i*) &amp;first_array[i], first_values);<br>&#125;<br>...<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>å¾ªç¯å±•å¼€</strong></p><p><img src="https://s2.loli.net/2023/04/14/wW4sJ17DUOF3xtM.png" alt=""></p><p>ä¸ºä»€ä¹ˆè¿™ç§å¾ªç¯å±•å¼€å¯ä»¥åŠ é€Ÿè¿ç®—å‘¢ï¼Ÿ</p><p>æœªå±•å¼€æ—¶çš„æ±‡ç¼–ä»£ç ï¼šæ¯ä¸ªå…ƒç´ æ“ä½œå®Œåéƒ½è¦è·³ä¸€æ¬¡loop</p><p><img src="https://s2.loli.net/2023/04/14/Z68HIYsCQLaOqRk.png" alt=""></p><p>å±•å¼€åï¼šæ±‡ç¼–ä»£ç é‡æ’ï¼Œå¯åˆ©ç”¨SIMDæœºåˆ¶</p></li></ol><p><img src="https://s2.loli.net/2023/04/14/se4LKvalYpqyCRH.png" alt=""></p><h1>Lecture22ã€Thread-level Parallelism</h1><ol><li><p><strong>å¤šå¤„ç†å™¨è¿è¡Œå¤šè¿›ç¨‹(å¹¶è¡Œ)</strong></p><p><img src="https://s2.loli.net/2023/04/14/5xt7rjyhSsvkwz1.png" alt=""></p><p>æ¯ä¸ªè¿›ç¨‹åœ¨å„è‡ªçš„å¤„ç†å™¨ä¸Šè¿è¡Œï¼Œä½†äº«ç”¨åŒæ ·çš„ç³»ç»Ÿå†…å­˜</p></li><li><p><strong>å•å¤„ç†å™¨è¿è¡Œå¤šä¸ªçº¿ç¨‹ï¼ˆå¹¶å‘ï¼‰</strong></p><p>å„ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„PCã€å¯„å­˜å™¨ã€æ ˆç©ºé—´ï¼Œäº«ç”¨ç›¸åŒçš„é™æ€ç©ºé—´ã€‚ä¸€ä¸ªå…¸å‹çš„ä¾‹å­æ˜¯æµè§ˆå™¨ä¸­å¼€å¤šä¸ªé¡µé¢ï¼Œæ¯ä¸ªé¡µé¢çš„æµè§ˆå™¨æºç å’Œå…¨å±€è®¾ç½®æ˜¯ä¸€æ ·çš„ï¼Œä½†æœ‰ç€å„è‡ªä¸åŒçš„stackå’Œå¯„å­˜å™¨ï¼ˆä½†äº‹å®ä¸Šç°åœ¨çš„æµè§ˆå™¨å‡ºäºå®‰å…¨å’Œæ€§èƒ½åŸå› ï¼Œç»™æ¯ä¸ªé¡µé¢ç”¨çš„æ˜¯ç‹¬ç«‹çš„å¤„ç†å™¨ï¼‰</p><p><img src="https://s2.loli.net/2023/04/14/vyPLMpWEcDRr6kB.png" alt=""></p><p>å¤šçº¿ç¨‹æœ‰å•¥å¥½å¤„å‘¢ï¼šå¤„ç†å™¨çš„èµ„æºå®è´µï¼Œå¤šçº¿ç¨‹å¯ä»¥å°½å¯èƒ½**é¿å…å…¶ç©ºé—²ï¼Œ**å¦‚cache missåæœ‰ä¸ªå¾ˆé•¿çš„memory latencyï¼Œåˆ™ç›´æ¥åˆ‡æ¢åˆ°å…¶å®ƒçº¿ç¨‹ï¼ˆæ‰€ä»¥åˆ‡æ¢ä¸Šä¸‹æ–‡çš„å¼€é”€å¾—å°äºcache miss latencyï¼‰</p></li><li><p><strong>å¹¶å‘ä¸­çš„ä¸€äº›é—®é¢˜</strong></p><ul><li><p><strong>åŠ é€Ÿæ€§èƒ½</strong></p><p>é˜¿å§†è¾¾å°”å®šå¾‹ï¼š</p><p><img src="https://s2.loli.net/2023/04/14/tj3WE45JF9sIxfg.png" alt=""></p><p>å¯çŸ¥å¯¹äºä¸€ä¸ª5%çš„æ—¶é—´ä½¿ç”¨å¹¶è¡Œï¼Œå³ä½¿ç”¨5ä¸ªå¤„ç†å™¨ï¼Œå…¶åŠ é€Ÿæ€§èƒ½ä¹Ÿä¸è¿‡æ˜¯ï¼š</p><p><img src="https://s2.loli.net/2023/04/14/cHliG971Uqwv6Sn.png" alt=""></p><p>åªæœ‰å¹¶è¡Œè¿ç®—å æ¯”è¶³å¤Ÿé«˜æ—¶ï¼Œå¤„ç†å™¨æ•°é‡çš„å¢åŠ æ‰ä¼šå¸¦æ¥æ˜æ˜¾æ€§èƒ½æå‡</p><p><img src="https://s2.loli.net/2023/04/14/hgDJ5ktYdTmsX8K.png" alt=""></p><p>ä½†è¿™æ ·çš„åŠ é€Ÿä¹Ÿæœ‰ç“¶é¢ˆï¼Œç”±é˜¿å§†è¾¾å°”å®šå¾‹å¯çŸ¥ï¼ŒSè¶³å¤Ÿå¤§æ—¶ï¼Œspeedupæ¥è¿‘äºå¸¸æ•°</p><p>**è§£å†³æ€è·¯ï¼š**åŸå§‹è¿ç®—ä¸­å°½å¯èƒ½å°‘ç”¨æ ‡é‡è¿ç®—ï¼Œä¹Ÿå°±æ˜¯å°½é‡æå‡å¹¶è¡ŒåŒ–å æ¯”</p></li><li><p><strong>æ•°æ®ç«äº‰</strong></p><p>çº¿ç¨‹è°ƒåº¦æ˜¯<strong>ä¸ç¡®å®šçš„</strong>ï¼Œå› æ­¤å½“å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªå˜é‡æ“ä½œæ—¶ï¼Œå…¶æœ€ç»ˆçš„å€¼ä¹Ÿæ˜¯ä¸ç¡®å®šçš„</p><p>**è§£å†³æ€è·¯ï¼š**ä¸è¦å¾€ç›¸åŒçš„å†…å­˜å†™æ•°æ®ï¼›è®©è¯»å†™åŒæ­¥ï¼Œä»è€Œè·å¾—ç¡®å®šè¡Œä¸º</p></li></ul></li><li><p><strong>é”åŒæ­¥</strong></p><p>ç”¨lockæ¥å¯¹é‡è¦åŒºåŸŸï¼ˆæ¯”å¦‚æœ‰å…±åŒæ“ä½œçš„å˜é‡çš„å†…å­˜åŒºåŸŸï¼‰ä½œè®¿é—®é™åˆ¶ï¼Œä»¥ä¾¿ä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è®¿é—®</p><p><img src="https://s2.loli.net/2023/04/14/lkWcYZOyRASI84p.png" alt=""></p></li><li><p><strong>cache coherence</strong></p><p><img src="https://s2.loli.net/2023/04/14/wDslLqVnNKrOdg3.png" alt=""></p><p>å‡è®¾ä¸¤ä¸ªcoreåŒæ—¶è¿è¡Œä¸¤ä¸ªçº¿ç¨‹ï¼Œéƒ½å¯¹å˜é‡iè¿›è¡Œæ“ä½œï¼Œè¿™æ—¶Aæ‰§è¡Œäº†i++ï¼Œcacheé‡‡ç”¨å†™å›ç­–ç•¥ï¼Œå³å…ˆæ”¾åˆ°è‡ªå·±çš„cacheé‡Œå¹¶æŠŠdirty bitç½®ä¸€ï¼Œå¹¶æœªåŒæ­¥åˆ°memoryã€‚è¿™æ—¶Bä»å†…å­˜è¯»içš„å€¼ï¼Œåˆ™è¯»åˆ°çš„å°†ä¼šæ˜¯é”™è¯¯å€¼ï¼Œå³æ‰€è°“çš„ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜</p><p>è§£å†³æ–¹æ³•ï¼š</p><ul><li><p><strong>å†™ä¼ æ’­ï¼ˆwrite propagationï¼‰</strong></p><p>key ideaï¼šå½“æŸä¸ªcoreæ›´æ–°äº†cacheä¸­çš„æ•°æ®æ—¶ï¼Œè¦æŠŠè¯¥äº‹ä»¶å¹¿æ’­é€šçŸ¥åˆ°å…¶å®ƒcore ï¼Œæœ€å¸¸è§çš„å®ç°æ–¹æ³•æ˜¯<strong>æ€»çº¿å—…æ¢ï¼ˆbus snoopingï¼‰</strong></p><p>å¦‚core Aæ”¹å˜äº†içš„å€¼åï¼Œä¼šé€šè¿‡æ€»çº¿æŠŠè¿™ä¸ªäº‹ä»¶å¹¿æ’­ç»™å…¶å®ƒæ‰€æœ‰coreï¼›å…¶å®ƒcoreéšæ—¶ä¿æŒç›‘å¬æ€»çº¿ä¸Šçš„å¹¿æ’­äº‹ä»¶ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦æœ‰ç›¸åŒçš„æ•°æ®åœ¨è‡ªå·±çš„cacheé‡Œï¼Œè‹¥æœ‰åˆ™æ›´æ–°</p><p>ä½†è¿™ä¸ªæ–¹æ³•å¹¶ä¸å®Œç¾ï¼šä¸€æ¥æ¯ä¿®æ”¹ä¸€ä¸ªæ•°æ®éƒ½è¦å¹¿æ’­ä¸€æ¬¡ï¼Œä¼šåŠ é‡æ€»çº¿è´Ÿè½½ï¼›äºŒæ¥æ€»çº¿å—…æ¢åªèƒ½ä¿è¯æŸä¸ª CPU æ ¸å¿ƒçš„ Cache æ›´æ–°æ•°æ®è¿™ä¸ªäº‹ä»¶èƒ½è¢«å…¶ä»– CPU æ ¸å¿ƒçŸ¥é“ï¼Œä½†æ˜¯å¹¶ä¸èƒ½ä¿è¯äº‹åŠ¡ä¸²è¡ŒåŒ–ï¼ˆå³ä¸çŸ¥é“è°å…ˆæ”¹è°åæ”¹ï¼‰</p></li><li><p><strong>MESI åè®®</strong></p><p>MESI åè®®å…¶å®æ˜¯ 4 ä¸ªçŠ¶æ€å•è¯çš„å¼€å¤´å­—æ¯ç¼©å†™ï¼Œåˆ†åˆ«æ˜¯ï¼šModifiedï¼ˆå·²ä¿®æ”¹ï¼‰ã€Exclusiveï¼ˆç‹¬å ï¼‰ã€Sharedï¼ˆå…±äº«ï¼‰ã€Invalidatedï¼ˆå·²å¤±æ•ˆï¼‰ï¼Œè¿™å››ä¸ªçŠ¶æ€æ¥æ ‡è®° Cache Line å››ä¸ªä¸åŒçš„çŠ¶æ€</p><p>æ•´ä¸ª MESI çŠ¶æ€çš„å˜æ›´ï¼Œåˆ™æ˜¯æ ¹æ®æ¥è‡ªæœ¬åœ° CPU æ ¸å¿ƒçš„è¯·æ±‚ï¼Œæˆ–è€…æ¥è‡ªå…¶ä»– CPU æ ¸å¿ƒé€šè¿‡æ€»çº¿ä¼ è¾“è¿‡æ¥çš„è¯·æ±‚ï¼Œä»è€Œæ„æˆä¸€ä¸ªæµåŠ¨çš„çŠ¶æ€æœºã€‚å¦å¤–ï¼Œå¯¹äºåœ¨ã€Œå·²ä¿®æ”¹ã€æˆ–è€…ã€Œç‹¬å ã€çŠ¶æ€çš„ Cache Lineï¼Œä¿®æ”¹æ›´æ–°å…¶æ•°æ®ä¸éœ€è¦å‘é€å¹¿æ’­ç»™å…¶ä»– CPU æ ¸å¿ƒ</p><p><img src="https://s2.loli.net/2023/04/14/mTnkYR1GqaQlJEA.png" alt=""></p></li></ul></li></ol><h1>Lecture24ã€Warehouse Scale Computers, MapReduce</h1><ol><li><p><strong>å…¸å‹ç»“æ„</strong></p><p><img src="https://s2.loli.net/2023/04/14/RLmXyJhxjcdo2OT.png" alt=""></p><p>ä¸€ä¸ªWSCä¸­åŒ…å«å¤šä¸ªarrayï¼ˆaka clusterï¼‰ï¼Œä¸€ä¸ªarrayä¸­æœ‰å¤šä¸ªrackï¼ˆæœºæ¶ï¼‰ï¼Œä¸€ä¸ªrackä¸­åˆåŒ…å«å¤šä¸ªæœåŠ¡å™¨</p></li><li><p><strong>é˜è¿°wscæ¶æ„å·¥ä½œè¿‡ç¨‹ï¼ˆä»¥googleæœç´¢hustä¸ºä¾‹ï¼‰</strong></p><ol><li>å‘é€è¯·æ±‚ç»™æœ€è¿‘çš„Google warehouse scale computer</li><li>å‰ç«¯å¹³è¡¡è´Ÿè½½ï¼Œåœ¨ä¼—å¤šclusterä¸­æ‰¾å‡ºæœ€åˆé€‚çš„é‚£ä¸ª</li><li>åœ¨clusterå†…éƒ¨æ‰¾å‡ºä¸€ä¸ªgoogle web serversæ¥å¤„ç†è¯·æ±‚ï¼Œç”Ÿæˆç½‘é¡µ</li><li>google web serverså’Œå†…éƒ¨æœåŠ¡å™¨äº¤æµï¼Œæ‰¾åˆ°åŒ…å«â€œhustâ€çš„é‚£ä¸ªæ–‡ä»¶</li><li>è¿”å›ç›¸å…³çš„æ–‡ä»¶åˆ—è¡¨ä»¥åŠå¯¹åº”çš„å…³è”åˆ†æ•°</li></ol><p>æ­¤å¤–ï¼Œéšä¹‹å‘ç”Ÿçš„è¿˜å¯èƒ½æœ‰ï¼š</p><ul><li>æ¨èç³»ç»Ÿç”Ÿæˆç›¸å…³å¹¿å‘Š</li><li>æ ¹æ®å…³è”åˆ†æ•°å¯¹æœç´¢ç»“æœè¿›è¡Œæ’åºï¼Œåœ¨ç½‘é¡µä¸­æ˜¾ç¤º</li><li>å¯¹ç´¢å¼•å’Œæ–‡ä»¶ç”Ÿæˆå‰¯æœ¬ï¼Œç”¨äºæé«˜request-level parallelism</li></ul></li></ol><h1>Lecture_Bonus</h1><ol><li><p><strong>è¿›ç¨‹ä¸çº¿ç¨‹</strong></p><p>CPUæ‰§è¡Œä¸€ä¸ªå‡½æ•°çš„æœ¬è´¨æ˜¯é‚£ä¹ˆ<strong>æŠŠè¯¥å‡½æ•°å¯¹åº”çš„ç¬¬ä¸€æ¡æœºå™¨æŒ‡ä»¤çš„åœ°å€å†™å…¥PCå¯„å­˜å™¨</strong>ï¼Œè€Œæœºå™¨æŒ‡ä»¤è¦åŠ è½½åˆ°å†…å­˜ä¸­æ‰§è¡Œï¼Œéœ€è¦è®°å½•ä¸‹å†…å­˜çš„èµ·å§‹åœ°å€å’Œé•¿åº¦ï¼ŒåŒæ—¶è¦æ‰¾åˆ°å‡½æ•°çš„å…¥å£åœ°å€å¹¶å†™åˆ°PCå¯„å­˜å™¨ä¸­â€”â€”è¿™æ­£æ˜¯æ„å»º<strong>è¿›ç¨‹</strong>çš„æ€è·¯</p> <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">process</span>&#123;<br>   <span class="hljs-type">void</span>* start_addr;<br>   <span class="hljs-type">int</span> len;<br>   <br>   <span class="hljs-type">void</span>* start_point;<br>&#125;;<br></code></pre></td></tr></table></figure></li></ol><p>â€‹å¸¸è§„ç¨‹åºä¸­ï¼Œmain()æ˜¯ç¬¬ä¸€ä¸ªæ‰§è¡Œçš„ï¼›ä½†æ˜¯æˆ‘ä»¬èƒ½å…ˆæ‰§è¡Œå…¶å®ƒå‡½æ•°å—ï¼Ÿèƒ½ï¼å› ä¸ºmain()å’Œå…¶å®ƒå‡½æ•°å¹¶æ— æœ¬è´¨åŒºåˆ«ï¼Œæ—¢ç„¶å¯ä»¥æŠŠPCå¯„å­˜å™¨æŒ‡å‘main()ï¼Œå°±ä¹Ÿå¯ä»¥æŠŠPCæŒ‡å‘ä»»ä½•ä¸€ä¸ªå‡½æ•°ï¼›è€Œå½“æˆ‘ä»¬æŒ‡å‘émain()å‡½æ•°çš„æ—¶å€™ï¼Œ**çº¿ç¨‹ï¼ˆthreadï¼‰**å°±è¯ç”Ÿäº†</p><p><img src="https://s2.loli.net/2023/04/14/resuH62xw1tSl5D.png" alt=""></p><p>â€‹é‚£ä¹ˆè¿›ä¸€æ­¥è§£æ”¾æ€æƒ³â€”â€”ä¸€ä¸ªè¿›ç¨‹å†…æœ‰å¤šä¸ªå…¥å£å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´åŒä¸€ä¸ªè¿›ç¨‹ä¸­çš„æœºå™¨æŒ‡ä»¤å¯ä»¥è¢«å¤šä¸ªCPUåŒæ—¶æ‰§è¡Œï¼Œå³å¤šçº¿ç¨‹å¹¶å‘</p><div class="note note-warning">            <p>ğŸ’¡ PS.</p><ol><li>å¹¶ä¸æ˜¯ä¸€å®šå¾—æœ‰å¤šæ ¸æ‰èƒ½å¤šçº¿ç¨‹ï¼Œå•æ ¸åŒæ ·å¯ä»¥ï¼Œå› ä¸º<strong>çº¿ç¨‹æ˜¯OSå±‚é¢çš„å®ç°ï¼Œä¸æœ‰å¤šå°‘ä¸ªæ ¸å¿ƒæ— å…³</strong>ï¼ŒCPUåœ¨æ‰§è¡Œæœºå™¨æŒ‡ä»¤æ—¶ä¹Ÿæ„è¯†ä¸åˆ°æ‰§è¡Œçš„æœºå™¨æŒ‡ä»¤å±äºå“ªä¸ªçº¿ç¨‹</li><li>ä¸Šè¿°ç†è®ºä¹Ÿè¯´æ˜äº†ä¸ºå•¥OSè¦ç»™æ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ªæ ˆï¼Œå› ä¸ºæ¯ä¸ªçº¿ç¨‹çš„æ‰§è¡Œæµéƒ½éœ€è¦ä¿å­˜è‡ªå·±æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°çš„æ•°æ®ï¼ˆå‚æ•°ã€å±€éƒ¨å˜é‡ã€è¿”å›åœ°å€ç­‰ï¼‰</li></ol>          </div><ol start="2"><li><p><strong>çº¿ç¨‹æ± </strong></p><p>**motivationï¼š<strong>å¯¹äºçŸ­ä»»åŠ¡ï¼ˆä¸€æ¬¡ç½‘ç»œè¯·æ±‚ã€æ•°æ®åº“æŸ¥è¯¢ï¼‰ï¼Œè‹¥æ¥ä¸€ä¸ªè¯·æ±‚å°±åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ï¼Œç”¨å®Œå†æ‘§æ¯ï¼Œåˆ™å³è€—æ—¶é—´åˆè´¹å†…å­˜ï¼›å¦‚æœä½ æ˜¯å…¬å¸è€æ¿ï¼Œå’Œâ€œæ¥ä¸€ä¸ªä»»åŠ¡æ‹›ä¸€ä¸ªäººâ€ç›¸æ¯”ï¼Œæ›´å¥½çš„åŠæ³•å½“ç„¶æ˜¯æ‹›ä¸€æ‰¹äººå…»ç€ï¼Œæœ‰äº‹åšäº‹ï¼Œæ²¡äº‹èººå°¸ï¼Œè¿™å°±æ˜¯</strong>çº¿ç¨‹æ± ï¼ˆthread poolï¼‰**çš„ç”±æ¥</p><p>**åŸºæœ¬ç»“æ„ï¼š**é˜Ÿåˆ—ç»“æ„ï¼Œç”Ÿäº§è€…æäº¤ä»»åŠ¡ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹ä»»åŠ¡</p><p><img src="https://s2.loli.net/2023/04/14/Ucm5pV8CeJkTzWo.png" alt=""></p><p>æäº¤ç»™çº¿ç¨‹æ± çš„ä»»åŠ¡åŒ…å«ä¸¤éƒ¨åˆ†ï¼šéœ€è¦è¢«å¤„ç†çš„æ•°æ®å’Œå¤„ç†æ•°æ®çš„å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">task</span> &#123;<br>   <span class="hljs-type">void</span>* data;     <span class="hljs-comment">// ä»»åŠ¡æ‰€æºå¸¦çš„æ•°æ®</span><br>   handler handle; <span class="hljs-comment">// å¤„ç†æ•°æ®çš„æ–¹æ³•</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç”Ÿäº§è€…å‘é˜Ÿåˆ—ä¸­å†™å…¥æ•°æ®åï¼Œçº¿ç¨‹æ± ä¸­çš„æŸä¸ªçº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œè¯¥çº¿ç¨‹ä»é˜Ÿåˆ—ä¸­å–å‡ºä¸Šè¿°ç»“æ„ä½“ï¼Œæ‰§è¡Œï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) &#123;<br> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">task</span> = <span class="hljs-built_in">GetFromQueue</span>(); <span class="hljs-comment">// ä»é˜Ÿåˆ—ä¸­å–å‡ºæ•°æ®</span><br> task-&gt;<span class="hljs-built_in">handle</span>(task-&gt;data);     <span class="hljs-comment">// å¤„ç†æ•°æ®</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>æ ¸æ•°ä¸çº¿ç¨‹æ•°çš„å…³ç³»</strong></p><p>ç»“è®ºï¼šæ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œä¸€ä¸ªæ ¸å¯æ‰§è¡Œå¤šä¸ªçº¿ç¨‹</p><p>Qï¼šé‚£ä¹ˆçº¿ç¨‹æ•°ä¸ºå¤šå°‘æ—¶æ€§èƒ½æœ€ä½³æï¼Ÿ</p><p>Aï¼šå¦‚æœçº¿ç¨‹ä¸æ¶‰åŠä»»ä½•I/Oã€æ²¡æœ‰ä»»ä½•åŒæ­¥äº’æ–¥çš„çº¯è®¡ç®—ç±»å‹ï¼Œé‚£ä¹ˆæ¯ä¸ªæ ¸å¿ƒä¸€ä¸ªçº¿ç¨‹é€šå¸¸æ˜¯æœ€ä½³é€‰æ‹©ï¼›ä½†é€šå¸¸æ¥è¯´ï¼Œçº¿ç¨‹éƒ½éœ€è¦ä¸€å®šçš„I/Oï¼Œå¯èƒ½éœ€è¦ä¸€å®šçš„åŒæ­¥äº’æ–¥ï¼Œé‚£ä¹ˆæ­¤æ—¶<strong>é€‚å½“å¢åŠ çº¿ç¨‹</strong>å¯èƒ½ä¼šæé«˜æ€§èƒ½ï¼Œä½†çº¿ç¨‹æ•°é‡è¾¾åˆ°ä¸€ä¸ª<strong>ä¸´ç•Œå€¼åæ€§èƒ½ä¼šå¼€å§‹ä¸‹é™</strong>ï¼Œè¿™æ—¶çº¿ç¨‹é—´åˆ‡æ¢çš„å¼€é”€å°†æ˜¾è‘—å¢åŠ ã€‚</p></li><li><p><strong>ä¸€æ®µå…¸å‹riscvä»£ç </strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs nasm">#æ‰“å°ç¬¬nä¸ªæ–æ³¢é‚£å¥‘æ•°<br><br>.data<br>.word 2, 4, 6, 8<br>n: .word 9<br><br>.text<br>main:   <br>    add t0, x0, x0<br>    addi t1, x0, 1<br>    la t3, n <br>    lw t3, 0(t3)<br>fib:    <br>    beq t3, x0, finish<br>    add t2, t1, t0<br>    mv t0, t1<br>    mv t1, t2<br>    addi t3, t3, -1  <br>    j fib<br>finish: <br>    addi a0, x0, 1<br>    addi a1, t0, 0<br>    ecall # print integer ecall<br>    addi a0, x0, 10<br>    ecall # terminate ecall<br></code></pre></td></tr></table></figure><p>.dataå’Œ.textæ˜¯ä¼ªæ“ä½œæŒ‡ä»¤ï¼Œè¡¨ç¤ºå°†æ¥ä¸‹æ¥çš„ä»£ç åˆ†é…åˆ°dataåŒºå’ŒtextåŒºï¼Œ.wordè¡¨ç¤ºæŒ‰å­—ï¼ˆ32bitï¼‰åˆ†é…æ•°æ®ï¼Œå³dataåŒºçš„ç¬¬ä¸€ä¸ªwordæ”¾å…¥0x02ï¼ˆå¤šä½™çš„bitè¡¥é›¶ï¼‰ï¼Œç¬¬äºŒä¸ªwordæ”¾0x04è¿™æ ·å­ laè¡¨ç¤ºæŠŠnçš„åœ°å€ç»™åˆ°t3ï¼Œlwåˆ™æ˜¯æŠŠnçš„åœ°å€ä¸­å­˜çš„å€¼æ”¾å…¥t3ä¸­ï¼Œå³t3ä¸­çš„å€¼å˜ä¸º9ï¼Œlaå’Œlwé€šå¸¸é…å¥—ä½¿ç”¨ fibæ ‡ç­¾ä¸­çš„å†…å®¹å°±æ˜¯ä¸æ–­åˆ¤æ–­æ¯”è¾ƒç´¯åŠ å¾—æ–æ³¢é‚£å¥‘æ•°äº† æœ€åçš„ecallæ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œç”±å‚æ•°å†³å®šå…·ä½“è°ƒç”¨å†…å®¹ï¼Œa0å’Œa1éƒ½æ˜¯å‚æ•° (argument) å¯„å­˜å™¨ï¼Œç”¨äºåœ¨å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­ä¿å­˜ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªå‚æ•°ï¼Œä»¥åŠåœ¨å‡½æ•°è¿”å›æ—¶ä¼ é€’è¿”å›å€¼ã€‚ecall 1å°±æ˜¯printï¼Œecall 10å°±æ˜¯exit</p></li><li><p><strong>æµæ°´çº¿å¯„å­˜å™¨</strong></p><p><img src="https://s2.loli.net/2023/04/14/Iq4Qw7DaX9HbEoP.png" alt=""></p><p>æµæ°´çº¿çš„åŸºæœ¬åŸç†å¦‚æ­¤ï¼Œä¸Šé¢çš„ç¬”è®°ä¹Ÿæ¢è®¨è¿‡ï¼Œé‚£å…·ä½“åº”è¯¥æ€ä¹ˆå®ç°æï¼Ÿæˆ–è€…è¯´ï¼Œæ™®é€šçš„ä¸²è”ç»„åˆé€»è¾‘ç”µè·¯æ€ä¹ˆå°±ä¸èƒ½å®ç°pipelineæï¼Ÿ</p><p>å®ç°æ–¹æ³•ï¼šåŠ <strong>æµæ°´çº¿å¯„å­˜å™¨</strong>ã€‚å¦‚æˆ‘ä»¬èƒ½æŠŠæŒ‡ä»¤å­˜å‚¨å™¨è¾“å‡ºçš„æŒ‡ä»¤ç¼–ç äº‹å…ˆä¿å­˜ä¸‹æ¥ï¼Œé‚£å°±å¯ä»¥æå‰æ›´æ–°PCå¯„å­˜å™¨çš„å€¼ï¼Œå¹¶ç”¨è¿™æ–°çš„å€¼å»æŒ‡ä»¤å­˜å‚¨å™¨å½“ä¸­å–å‡ºä¸€ä¸ªæ–°çš„æŒ‡ä»¤ï¼Œè€Œåœ¨å–æ–°æŒ‡ä»¤çš„åŒæ—¶ï¼Œåˆšæ‰å–å‡ºçš„é‚£æ¡æŒ‡ä»¤çš„ç¼–ç å°±ä¼šè¢«åˆ†è§£æˆä¸åŒä½åŸŸï¼Œè€Œå¯„å­˜å™¨å †ä¹Ÿä¼šæ ¹æ®è¾“å…¥é€å‡ºå¯¹åº”å¯„å­˜å™¨çš„å†…å®¹ã€‚ç”±æ­¤å°±å®ç°äº†å„ä¸ªé˜¶æ®µåˆ†åˆ«è¿è¡Œï¼Œäº’ä¸å¹²æ‰°ã€‚</p><p>æ‰“ä¸ªæ¯”æ–¹ï¼Œå°å¿—å¹´è½»åŠ›å£®ï¼Œæ¬å¿«é€’æ—¶çŒ›å¾—ä¸€pï¼Œåé¢æ¥æ‰‹çš„è€å¸ˆå‚…è¯´å“å‘€æˆ‘è¦æ‘¸é±¼ï¼Œå¹´è½»äºº<strong>ä½ åªç®¡æ¬ä½ çš„åˆ«ç®¡æˆ‘ä»¬</strong>ï¼ˆæµæ°´çº¿æ€æƒ³ï¼‰ï¼Œä½ é€Ÿåº¦å¿«ï¼Œå¤šæ¬å‡ºæ¥çš„é‚£äº›<strong>æ”¾æ—è¾¹å°è½¦ä¸Šå°±å¥½ï¼Œå¾…ä¼šæˆ‘ç›´æ¥ä»å°è½¦ä¸Šå–å°±è¡Œ</strong>ï¼ˆå°è½¦å°±æ˜¯æµæ°´çº¿å¯„å­˜å™¨ï¼‰</p><p><img src="https://s2.loli.net/2023/04/14/fQLhHwrpKyxuIki.png" alt="Untitled"></p><p>æ€§èƒ½åˆ†æï¼Œä¸ä¹‹å‰çš„æµæ°´çº¿ç›¸æ¯”ï¼Œå¤šäº†æµæ°´çº¿å¯„å­˜å™¨çš„å»¶è¿Ÿï¼Œå‘¨æœŸ200åˆ°250ps</p><p><img src="https://s2.loli.net/2023/04/14/QAwatYbL73v1Exj.png" alt=""></p><p>è€Œè‡³äºä¸ºä»€ä¹ˆä¸åŠ å¯„å­˜å™¨å°±ä¸èƒ½å®ç°æµæ°´çº¿ï¼Œæˆ‘æƒ³åº”è§£é‡Šä¸ºå„éƒ¨åˆ†æ—¶å»¶ä¸åŒ¹é…é€ æˆçš„<strong>çº¿è·¯ä¿¡å·å†²çª</strong>ï¼Œå³å¦‚æœåé¢éƒ¨åˆ†è¿˜æ²¡æ‰§è¡Œå®Œï¼ŒIFå°±åœ¨ä¸€ç›´å­å“§å­å“§å–æŒ‡ï¼Œé‚£ä¹ˆå–å‡ºæ¥çš„instruction wordæƒ³å¿…ä¸ä¼šè¢«IDæ¥å—ï¼Œä¹Ÿå°±æˆäº†æ— æ•ˆè¾“å…¥</p></li><li><p>cache<strong>å‘½ä¸­æ—¶</strong>ï¼Œç­–ç•¥ä¸ºå›å†™ï¼ˆwrite backï¼‰å’Œç›´å†™ï¼ˆwrite throughï¼‰ï¼› <strong>æœªå‘½ä¸­æ—¶</strong>ï¼Œç­–ç•¥ä¸ºå†™åˆ†é…ï¼ˆwrite-allocateï¼‰å’Œæ— å†™åˆ†é…ï¼ˆno write-allocateï¼‰ï¼Œå†™åˆ†é…è¡¨ç¤ºå‘ç”Ÿwrite missæ—¶ï¼ŒæŠŠæ²¡å‘½ä¸­çš„é‚£ä¸ªå—æ”¾åˆ°cacheä¸­ï¼Œè€Œæ— å†™åˆ†é…åˆ™æ„å‘³ç€åªæ”¹memory é€šå¸¸ï¼Œwrite backå’Œwrite-allocateæ­é…ä½¿ç”¨ï¼Œè¿™æ ·çš„memoryæ°¸è¿œä¸ä¼šè¢«ç›´æ¥ä¿®æ”¹ï¼›write throughå’Œno write-allocateæ­é…</p></li><li><p><strong>ç”¨æŒ‡é’ˆéç©ºåˆ¤æ–­æ•°ç»„è¾¹ç•Œï¼Ÿ</strong></p> <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>* argv[])</span> </span>&#123;<br>    <span class="hljs-type">int</span> array[<span class="hljs-number">4</span>] = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">3</span> , <span class="hljs-number">5</span>, <span class="hljs-number">7</span>&#125;;<br>    <span class="hljs-type">int</span>* ptr = array;<br><br>    <span class="hljs-keyword">while</span>(ptr != <span class="hljs-literal">NULL</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\\n&quot;</span>, *ptr);<br>        ptr += <span class="hljs-number">1</span>;<br>    &#125; <br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2023/04/14/oJjaIEqM2rtQDcX.png" alt=""></p><p>è¾“å‡ºç»“æœç›¸å½“ç‚¸è£‚ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆæï¼Ÿ</p><p>å› ä¸º<strong>ç”¨æŒ‡é’ˆéç©ºåˆ¤æ–­æ•°ç»„è¾¹ç•Œæœ¬å°±æ˜¯é”™çš„ï¼æ•°ç»„å¤§å°ä¸º4ä¸ä»£è¡¨ç¬¬äº”ä¸ªå†…å­˜ç©ºé—´å°±æ²¡æœ‰å…¶å®ƒä¸œè¥¿äº†å•Šï¼</strong>ï¼ˆä¸‹é¢è¿™æ®µä»£ç ä¹Ÿå¯ä»¥è¯´æ˜è¿™ä¸€ç‚¹ï¼Œä¸¤ä¸ªæ•°ç»„åˆ†åˆ«ç”³è¯·ï¼Œä½†å†…å­˜ä½ç½®æ˜¯è¿ç»­çš„ï¼‰</p> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>* argv[])</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-built_in">array</span>[<span class="hljs-number">4</span>] = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">3</span> , <span class="hljs-number">5</span>, <span class="hljs-number">7</span>&#125;;<br>    <span class="hljs-type">int</span> array2[<span class="hljs-number">4</span>] = &#123;<span class="hljs-number">9</span>, <span class="hljs-number">10</span> , <span class="hljs-number">11</span>, <span class="hljs-number">12</span>&#125;;<br>    <span class="hljs-type">int</span>* ptr = <span class="hljs-built_in">array</span>;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\\n&quot;</span>, *ptr);<br>        ptr += <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2023/04/14/8xdBXH6YoyEjtD7.png" alt=""></p><p>ä¹Ÿå°±è§£é‡Šäº†ä¸ºä»€ä¹ˆCè¯­è¨€ä¸­åå¤å¼ºè°ƒï¼Œä¼ æ•°ç»„æŒ‡é’ˆæ—¶ï¼Œä¹Ÿå¿…é¡»æ˜¾å¼åœ°å°†æ•°ç»„é•¿åº¦ä¼ è¿›å»ï¼›å…‰é€šè¿‡ä¸€ä¸ªæ•°ç»„æŒ‡é’ˆæ˜¯æ²¡åŠæ³•è·å–æ•°ç»„é•¿åº¦çš„ï¼ï¼ˆcharæ•°ç»„ç”¨strlen()é™¤å¤–ï¼‰ è€Œè‡³äºä¸ºå•¥åœ¨è¿‡å»çš„ä»£ç ä¸­å¥½åƒç”¨è¿‡â€œæŒ‡é’ˆéç©ºâ€æ¥åˆ¤æ–­è¾¹ç•Œå‘¢ã€‚ã€‚æ˜¯å› ä¸ºä½¿ç”¨åœºæ™¯æ˜¯é“¾è¡¨ï¼Œé“¾è¡¨åˆå§‹åŒ–å°±æŠŠnextæŒ‡é’ˆè®¾ä¸ºnullpträº†ï¼›è€Œåƒvectorçš„è¾¹ç•Œåˆ¤æ–­ï¼Œé‚£ä¹Ÿæ˜¯ç”¨çš„vector.end()ï¼Œæ˜¯ä¸ªè¿­ä»£å™¨ï¼Œè€Œä¸æ˜¯æ™®é€šçš„ä¸€ä¸ªnullptrã€‚ã€‚</p></li></ol>]]></content>
    
    
    <categories>
      
      <category>æ ¸å¿ƒç§‘æŠ€çœ‹ç¾å¸</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ä½“ç³»ç»“æ„</tag>
      
      <tag>riscv</tag>
      
      <tag>æ“ä½œç³»ç»Ÿ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¸€ä¸ªå…¸å‹çš„cacheå·¥ä½œåŸç†æ¼”ç¤ºå®éªŒ</title>
    <link href="/2023/04/14/%E4%B8%80%E4%B8%AA%E5%85%B8%E5%9E%8B%E7%9A%84cache%E6%BC%94%E7%A4%BA%E5%AE%9E%E9%AA%8C/"/>
    <url>/2023/04/14/%E4%B8%80%E4%B8%AA%E5%85%B8%E5%9E%8B%E7%9A%84cache%E6%BC%94%E7%A4%BA%E5%AE%9E%E9%AA%8C/</url>
    
    <content type="html"><![CDATA[<div class="note note-success">            <p>å‰è¨€ï¼šæœ¬æ–‡ç« å°†åœ¨å¯è§†åŒ–ç¯å¢ƒä¸‹å¯¹cacheå·¥ä½œåŸç†è¿›è¡Œæ¼”ç¤ºå®éªŒï¼Œé€šè¿‡ä¸‹é¢ä¸‰ä¸ªå®éªŒï¼Œè¯»è€…åº”èƒ½ï¼š</p><ol><li>ç†è§£cacheä¸‰ç§è®¿é—®æ¨¡å¼ï¼ˆç›´è¿ã€ä¸¤è·¯ç›¸è¿ã€å…¨è¿ï¼‰çš„å·¥ä½œåŸç†ï¼›</li><li>å­¦ä¼šè®¡ç®—å‘½ä¸­ç‡ï¼ˆhit rateï¼‰ï¼Œå¹¶ç†è§£å„ä¸ªå‚æ•°ï¼ˆå¾ªç¯æ¬¡æ•°ã€æ­¥é•¿ã€cache sizeç­‰ï¼‰å¦‚ä½•å½±å“hit rateï¼›</li><li>ç†è§£ä¸åŒçš„cacheç­–ç•¥ï¼ˆå›å†™ã€ç›´å†™ã€LRUï¼‰å¯¹hit rateçš„å½±å“ï¼›</li><li>çŸ¥é“å¦‚ä½•ä¼˜åŒ–ä»£ç ï¼Œä»¥å®ç°æ›´é«˜çš„hit rate</li></ol><p>å®éªŒæ¥æºï¼š<a href="https://inst.eecs.berkeley.edu/~cs61c/su20/labs/lab07/">CS61Cï¼ˆ20-SUMMERï¼‰- lab 7</a></p><p>å¯è§†åŒ–å¹³å°ï¼š<a href="https://venus.cs61c.org/">venus</a></p>          </div><div class="note note-warning">            <p>PS. å®Œæ•´çš„é¢˜ç›®å’Œæè¿°è¯·å‚è€ƒ<a href="https://inst.eecs.berkeley.edu/~cs61c/su20/labs/lab07/">CS61Cï¼ˆ20-SUMMERï¼‰- lab 7</a>ï¼ä¸‹è¿°æ‰€æœ‰åˆ†æä»…ç›¸å½“äºæ˜¯å®éªŒç­”æ¡ˆï¼Œå¯¹é¢˜ç›®æœ¬èº«ä¸å†èµ˜è¿°ğŸ˜ª</p>          </div><p><strong>æ±‡ç¼–å¯¹åº”çš„Cä»£ç ï¼š</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">int</span> array[];  <span class="hljs-comment">//Assume sizeof(int) == 4</span><br><span class="hljs-keyword">for</span> (k = <span class="hljs-number">0</span>; k &lt; repcount; k++) &#123;<span class="hljs-comment">// repeat repcount times</span><br>  <span class="hljs-keyword">for</span> (index = <span class="hljs-number">0</span>; index &lt; arraysize; index += stepsize) &#123;<br>    <span class="hljs-keyword">if</span>(option==<span class="hljs-number">0</span>)<br>      array[index] = <span class="hljs-number">0</span>;<span class="hljs-comment">// Option 0: One cache access - write</span><br>    <span class="hljs-keyword">else</span><br>      array[index] = array[index] + <span class="hljs-number">1</span>;<br><span class="hljs-comment">// Option 1: Two cache accesses - read AND write</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å®éªŒä¸€ï¼šç›´æ¥æ˜ å°„</strong></p><p>å‚æ•°è®¾ç½®ä¸ºï¼š</p><ul><li>Array Size (a0): 128 (bytes)ï¼Œå³32ä¸ªint</li><li>Step Size (a1): 8</li><li>Rep Count (a2): 1</li><li>Option (a3): 0</li><li>cache lineè®¾ä¸º8byteï¼Œå…±4ä¸ªline</li><li>ç­–ç•¥ä¸ºdirect map + LRU</li></ul><p>æ‰‹åŠ¨åˆ†æï¼Œä¸€æ¬¡forå¾ªç¯ä¸­ï¼Œè¦è®¿é—®array[0ã€8ã€16ã€24]è¿™4ä¸ªå…ƒç´ ï¼Œè®¿é—®array[0]æ—¶ï¼Œcache missï¼ˆæ­¤æ—¶cacheä¸­è¿˜æ²¡ä¸œè¥¿ï¼‰ï¼Œäºæ˜¯ä»memoryä¸­æŠŠarray[0ã€1]éƒ½æ”¾è¿›æ¥ï¼›ä½†ä¸‹ä¸€æ¬¡è®¿é—®array[8]æ—¶ä»ç„¶ä¼šmissï¼Œè¿™ä¹ˆä¸€è·¯ä¸‹æ¥cache accessä¸º4ï¼Œhit rateä¸º0</p><p><img src="https://s2.loli.net/2023/04/14/WzSZARV1gETyI5C.png" alt=""></p><p>ç»éªŒè¯ç¡®å®å¦‚æ­¤ï¼Œæ³¨æ„ä¸ºå•¥åªåœ¨cache0ä¸Šæ“ä½œæï¼Ÿ</p><p><img src="https://s2.loli.net/2023/04/14/lY2BUCygoJn4qvG.jpg" alt=""></p><p>çœ‹å›¾å°±æ¸…æ¥šäº†ï¼šindex 2bitï¼Œoffset 3bitã€‚è®¿é—®çš„æ˜¯array[0ã€8ã€16ã€24]è¿™å‡ ä¸ªå…ƒç´ ï¼Œåœ°å€ä¸º0ã€32ã€64ã€96ï¼Œå…¶äºŒè¿›åˆ¶çš„indexä¸€æ ·çš„ï¼Œéƒ½æ˜¯å¯¹åº”line0</p><p>é‚£ä¹ˆåŒç†ï¼Œæˆ‘ä»¬æŠŠstepsizeæ”¹æˆ4ã€2ï¼Œhit rateå§‹ç»ˆéƒ½æ˜¯0;</p><p>æ”¹æˆ1åˆ™hit rate=50%</p><p><img src="https://s2.loli.net/2023/04/14/LqTQDVnlOGaXjrc.png" alt="Untitled"></p><p><strong>å®éªŒäºŒï¼š4è·¯æ˜ å°„</strong></p><p>å‚æ•°è®¾ç½®ä¸ºï¼š</p><ul><li>Array Size (a0): 256(bytes)ï¼Œå³64ä¸ªint</li><li>Step Size (a1): 2</li><li>Rep Count (a2): 1</li><li>Option (a3): 1</li><li>cache lineè®¾ä¸º16byteï¼Œå…±16ä¸ªline</li><li>ç­–ç•¥ä¸º4 way set associative + LRU</li></ul><p><img src="https://s2.loli.net/2023/04/14/Daexf5wv9JUN3jp.jpg" alt=""></p><p>æ‰‹åŠ¨åˆ†æhit rate = 0.75ï¼Œç»éªŒè¯ç¡®å®å¦‚æ­¤</p><p><img src="https://s2.loli.net/2023/04/14/s9TJvIlmoUVYHQX.png" alt=""></p><p>è¿›ä¸€æ­¥æ€è€ƒï¼šé‚£æŠŠrepcountè®¾ä¸º2ï¼Œhit rateè¿˜æ˜¯0.75å—ï¼Ÿ</p><p>æ˜¾ç„¶ä¸æ˜¯ï¼Œå› ä¸ºç¬¬ä¸€éforæŠŠæ‰€æœ‰cache lineéƒ½å¡«æ»¡äº†ï¼ˆæ•´ä¸ªarray[]æ­£å¥½å…¨è£…è¿›å»äº†ï¼ï¼‰ï¼Œæ‰€ä»¥åç»­æ¯æ¬¡cache accesséƒ½ä¼šå‘½ä¸­ï¼›hit rate = ï¼ˆ48+64ï¼‰/ï¼ˆ2*64ï¼‰ = 0.875</p><p><img src="https://s2.loli.net/2023/04/14/5vKhocQJH1t3V7u.png" alt=""></p><p>repcountè®¾ä¸º100æ—¶ï¼Œhit rateå°±å¾ˆæ¥è¿‘äº100%äº†ï¼ˆè¿™å…¶å®ä¹Ÿæ˜¯æ˜ è¯äº†cacheçš„åŸºæœ¬åŸç†ï¼Œæ—¶ç©ºå±€éƒ¨æ€§ï¼Œå³æ•°æ®é‡å¤åº¦è¶Šé«˜ï¼Œcacheè¶Šç®¡ç”¨ï¼‰</p><p><img src="https://s2.loli.net/2023/04/14/S9wBezDrEpVi1vf.png" alt=""></p><p><strong>å®éªŒä¸‰ï¼šä¸¤çº§cache</strong></p><p>å‚æ•°è®¾ç½®ä¸ºï¼š</p><ul><li>Array Size (a0): 128(bytes)ï¼Œå³32ä¸ªint</li><li>Step Size (a1): 1</li><li>Rep Count (a2): 1</li><li>Option (a3): 0</li></ul><p>L1 cacheï¼š</p><ul><li>cache lineè®¾ä¸º8byteï¼Œå…±8ä¸ªline</li><li>ç­–ç•¥ä¸ºdirect map + LRU</li></ul><p>L2 cacheï¼š</p><ul><li>cache lineè®¾ä¸º8byteï¼Œå…±16ä¸ªline</li><li>ç­–ç•¥ä¸ºdirect map + LRU</li></ul><p><img src="https://s2.loli.net/2023/04/14/5DNjmzHWGcyhRis.png" alt=""></p><p><img src="https://s2.loli.net/2023/04/14/zygfL8HXFeiOMuk.png" alt=""></p><p><strong>è§£é‡Šï¼š</strong></p><p>L1 hit rate 50%ä¸è§£é‡Šï¼ŒåŒå®éªŒä¸€ï¼›</p><p>L2ä¸ºå•¥æ˜¯0%æï¼Ÿ å…¶å®æƒ³æƒ³é‚£ä¸ªè¿‡ç¨‹å°±æ¸…æ¥šäº†ï¼šæ‰¾array[0]çš„æ—¶å€™ï¼ŒL1ã€L2éƒ½missï¼Œç„¶åä»memoryä¸­æŠŠarray[0ã€1]æ‹¿å‡ºæ¥ï¼Œæ¥ä¸‹æ¥è®¿é—®array[1]çš„æ—¶å€™åœ¨L1é‡Œå°±ç›´æ¥æ‰¾åˆ°äº†ï¼Œæ ¹æœ¬ä¸ä¼šå»è®¿é—®L2ï¼Œæ‰€ä»¥L2ä¸€å…±ä¹Ÿå°±ä¼šè®¿é—®16æ¬¡ï¼Œæ¬¡æ¬¡miss</p><p>**Qï¼š**æ”¹å˜å“ªä¸ªå‚æ•°ä¼šè®©L1å‘½ä¸­ç‡ä¸å˜ä¸”L2å‘½ä¸­ç‡å¢åŠ ï¼Ÿ</p><p>**Aï¼š**rep countã€‚å› ä¸ºå¢åŠ foré‡å¤æ¬¡æ•°æ—¶ï¼ŒL1ä¸­å§‹ç»ˆåªè£…äº†ä¸€åŠçš„arrayï¼Œæ°¸è¿œéƒ½æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ missã€ç¬¬äºŒä¸ªhitï¼›è€ŒL2 cache sizeä¸º128bytesï¼Œåˆšå¥½èƒ½æŠŠæ•´ä¸ªæ•°ç»„è£…ä¸‹ï¼Œæ‰€ä»¥rep countè¶Šå¤§ï¼ŒL2çš„hit rateè¶Šæ¥è¿‘äº100%<br>$$</p><p>$$</p>]]></content>
    
    
    <categories>
      
      <category>è‡ªå·±äº‹æƒ…é è‡ªå·±</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ä½“ç³»ç»“æ„</tag>
      
      <tag>cache</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æœ€ä¼˜åŒ–è®¡ç®—æ–¹æ³•ï¼ˆæ–‡å†æ–‡ï¼‰ç¬”è®°</title>
    <link href="/2023/04/13/%E3%80%8A%E6%9C%80%E4%BC%98%E5%8C%96%E8%AE%A1%E7%AE%97%E6%96%B9%E6%B3%95%EF%BC%88%E6%96%87%E5%86%8D%E6%96%87%EF%BC%89%E7%AC%94%E8%AE%B0%E3%80%8B/"/>
    <url>/2023/04/13/%E3%80%8A%E6%9C%80%E4%BC%98%E5%8C%96%E8%AE%A1%E7%AE%97%E6%96%B9%E6%B3%95%EF%BC%88%E6%96%87%E5%86%8D%E6%96%87%EF%BC%89%E7%AC%94%E8%AE%B0%E3%80%8B/</url>
    
    <content type="html"><![CDATA[<h1>ã€Šæœ€ä¼˜åŒ–è®¡ç®—æ–¹æ³•ï¼ˆæ–‡å†æ–‡ï¼‰ç¬”è®°ã€‹</h1><h1>ç¬¬ä¸€ç« ã€æœ€ä¼˜åŒ–ç®€ä»‹</h1><h3 id="ä¸€ã€æ¦‚è¿°">ä¸€ã€æ¦‚è¿°</h3><ol><li><p><strong>æœ€ä¼˜åŒ–é—®é¢˜ä¸€èˆ¬å½¢å¼ï¼š</strong></p><p><img src="https://s2.loli.net/2023/04/14/wazjU2bHxYqCuVs.png" alt=""></p><p>å…¶ä¸­$x=(x_1,x_2,â€¦,x_n)^T\in R^n$æ˜¯<strong>å†³ç­–å˜é‡</strong></p><p>$f:R^n\rightarrow R$æ˜¯<strong>ç›®æ ‡å‡½æ•°</strong></p><p>$\chi\in R^n$æ˜¯çº¦æŸé›†åˆï¼Œå³<strong>å¯è¡ŒåŸŸ</strong></p><p>s.t.æ˜¯subject toï¼Œä¸“æŒ‡<strong>çº¦æŸæ¡ä»¶</strong></p><p>ä½†f(x)çš„min/maxä¸æ€»æ˜¯å­˜åœ¨çš„ï¼Œæ­¤æ—¶æˆ‘ä»¬å…³å¿ƒå…¶ä¸Šä¸‹ç¡®ç•Œï¼Œå³å°†ä¸Šå¼æ”¹ä¸ºinf(sup) f(x)</p></li><li><p><strong>æœ€ä¼˜åŒ–é—®é¢˜åˆ†ç±»</strong></p><ul><li>ç›®æ ‡å‡½æ•°å’Œçº¦æŸå‡½æ•°çš†ä¸ºçº¿æ€§æ—¶ï¼Œç§°ä¸ºçº¿æ€§è§„åˆ’</li><li>è‡³å°‘æœ‰ä¸€ä¸ªéçº¿æ€§æ—¶ç§°ä¸ºéçº¿æ€§è§„åˆ’</li><li>ç›®æ ‡å‡½æ•°ä¸ºäºŒæ¬¡å‡½æ•°æ—¶ç§°ä¸ºäºŒæ¬¡è§„åˆ’</li><li>è¿˜æœ‰æ•´æ•°è§„åˆ’ã€éå…‰æ»‘è§„åˆ’ã€æ— å¯¼æ•°è§„åˆ’ç­‰ã€‚ã€‚</li></ul></li><li><p><strong>å‡¸ä¼˜åŒ–</strong></p><p>å®šä¹‰ï¼šæœ€å°åŒ–é—®é¢˜ä¸­ï¼Œç›®æ ‡å‡½æ•°å’Œå¯è¡ŒåŸŸåˆ†åˆ«æ˜¯å‡¸å‡½æ•°å’Œå‡¸é›†ï¼›ç›¸åï¼Œåªè¦æœ‰ä¸€ä¸ªä¸ä¸ºå‡¸ï¼Œåˆ™ä¸ºéå‡¸ä¼˜åŒ–é—®é¢˜ã€‚å› ä¸ºå‡¸ä¼˜åŒ–é—®é¢˜çš„ä»»ä½•å±€éƒ¨æœ€ä¼˜è§£éƒ½æ˜¯å…¨å±€æœ€ä¼˜è§£ï¼Œæ‰€ä»¥å…¶ç›¸åº”çš„ç®—æ³•è®¾è®¡ä»¥åŠç†è®ºåˆ†æç›¸å¯¹éå‡¸ä¼˜åŒ–é—®é¢˜ç®€å•å¾ˆå¤šã€‚</p><div class="note note-warning">            <p>ğŸ’¡ PS. æ‰€ä»¥ç”¨å‡¸æ¨¡å‹å¯¹éå‡¸é—®é¢˜è¿›è¡Œè½¬æ¢/é€¼è¿‘æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ‰‹æ®µ</p>          </div></li></ol><h1>ç¬¬äºŒç« ã€åŸºç¡€çŸ¥è¯†</h1><h3 id="ä¸€ã€æ¦‚è¿°-2">ä¸€ã€æ¦‚è¿°</h3><ol><li><p><strong>çŸ©é˜µèŒƒæ•°</strong></p><p>å½“p=1æ—¶ï¼ŒçŸ©é˜µ$A\in R^{mÃ—n}$çš„$l_1$èŒƒæ•°å®šä¹‰ä¸ºï¼š<br>$$<br>\lVert A \rVert_1=\sum_{i=1}^m\sum_{j=1}^n\vert a_{ij} \vert<br>$$<br>p=2æ—¶ï¼š<br>$$<br>\lVert A \rVert_2=\sqrt{Tr(AA^T)}=\sqrt{\sum_{i,j}a_{ij}^2}<br>$$<br>Tr(X)è¡¨ç¤ºæ–¹é˜µçš„è¿¹ï¼Œå³æ–¹é˜µçš„ä¸»å¯¹è§’çº¿çš„å…ƒç´ ä¹‹å’Œ</p><div class="note note-warning">            <p>ğŸ’¡ PS. ä¸€ä¸ªç»“è®ºï¼š çŸ©é˜µçš„2èŒƒæ•°æ˜¯è¯¥çŸ©é˜µçš„æœ€å¤§å¥‡å¼‚å€¼ï¼ˆwhyï¼Ÿï¼‰</p>          </div></li><li><p><strong>æµ·ç‘ŸçŸ©é˜µ</strong></p><p><img src="https://s2.loli.net/2023/04/14/BECN3juMKan6xLo.png" alt=""></p></li><li><p><strong>çŸ©é˜µå˜é‡å‡½æ•°çš„å¯¼æ•°</strong></p><p><img src="https://s2.loli.net/2023/04/14/hzEMxDuX9WcHiyt.png" alt=""></p><p><img src="https://s2.loli.net/2023/04/14/219YjdlZ5aShr3x.png" alt=""></p></li><li><p><strong>å‡¸é›†</strong></p><p>å¦‚æœè¿æ¥é›†åˆCä¸­ä»»æ„ä¸¤ç‚¹çš„çº¿æ®µéƒ½åœ¨Cå†…ï¼Œåˆ™ç§°Cä¸ºå‡¸é›†</p><p><img src="https://s2.loli.net/2023/04/14/bRu7fcMCqldoD6W.png" alt=""></p></li><li><p><strong>å‡¸åŒ…</strong></p><p>å¯¹äºå½¢å¦‚</p><p><img src="https://s2.loli.net/2023/04/14/HZlsb1pIMCx6Gwc.png" alt=""></p><p>çš„ç‚¹ç§°ä¸ºx1ã€x2ã€‚ã€‚ã€‚xkæ„æˆçš„<strong>å‡¸ç»„åˆ</strong>ï¼Œé›†åˆSä¸­ç‚¹æ‰€æœ‰å¯èƒ½çš„å‡¸ç»„åˆæ„æˆçš„é›†åˆç§°ä½œSçš„<strong>å‡¸åŒ…</strong>ï¼Œè®°ä½œ<strong>convS</strong>ï¼å®é™…ä¸Šï¼Œ<strong>convS</strong>æ˜¯åŒ…å«Sçš„æœ€å°çš„å‡¸é›†ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåˆ†åˆ«ä¸ºç¦»æ•£ç‚¹é›†çš„å‡¸åŒ…å’Œæ‰‡å½¢çš„å‡¸åŒ…ã€‚</p><p><img src="https://s2.loli.net/2023/04/14/luNXMaWSRO12Ko4.png" alt=""></p></li><li><p><strong>ä¸€äº›é‡è¦çš„å‡¸é›†</strong></p><ul><li>è¶…å¹³é¢å’ŒåŠç©ºé—´</li></ul><p><img src="https://s2.loli.net/2023/04/14/xw7VaQyXfHuZlbA.png" alt=""></p><ul><li>çƒã€æ¤­çƒã€æ¤</li></ul><p>å¸¸è§„çš„çƒã€æ¤­çƒã€æ¤çš„å®šä¹‰ç”¨çš„æ˜¯æ¬§å‡ é‡Œå¾—èŒƒæ•°ï¼Œä½†å¯ç”¨å…¶å®ƒèŒƒæ•°è¿›è¡Œæ¦‚å¿µæ¨å¹¿</p><p>å¤šé¢ä½“</p><ul><li>ï¼ˆåŠï¼‰æ­£å®šæ¤</li></ul><p><img src="https://s2.loli.net/2023/04/14/DEHSgQ6AaeNpC5w.png" alt=""></p></li><li><p><strong>å¼ºå‡¸å‡½æ•°</strong></p><p><img src="https://s2.loli.net/2023/04/14/Aoa2UdNbKrw7chf.png" alt="Untitled"></p><p>å¼ºå‡¸å‡½æ•°å‡å»ä¸€ä¸ªæ­£å®šäºŒæ¬¡å‡½æ•°ä»ç„¶æ˜¯å‡¸çš„ã€‚å’Œæ™®é€šå‡¸å‡½æ•°ç›¸æ¯”ï¼Œå¼ºå‡¸å‡½æ•°æœ‰æ›´å¥½çš„æ€§è´¨ã€‚</p><div class="note note-warning">            <p>ğŸ’¡ PS. ç»“è®ºï¼šè®¾ <em>f</em> ä¸ºå¼ºå‡¸å‡½æ•°ä¸”å­˜åœ¨æœ€å°å€¼ï¼Œåˆ™ <em>f</em> çš„æœ€å°å€¼ç‚¹å”¯ä¸€</p>          </div></li></ol><h1>ç¬¬ä¸‰ç« ã€å…¸å‹ä¼˜åŒ–é—®é¢˜</h1><h3 id="ä¸€ã€çº¿æ€§è§„åˆ’">ä¸€ã€çº¿æ€§è§„åˆ’</h3><ol><li><p>ä¸€èˆ¬å½¢å¼</p><p><img src="https://s2.loli.net/2023/04/14/RwBQujfqc4stJIK.png" alt=""></p><p>å¸¸è§çš„ä¸¤ç§å½¢å¼ï¼šæ ‡å‡†å‹ï¼ˆç­‰å¼çº¦æŸ+å†³ç­–å˜é‡éè´Ÿï¼‰</p><p><img src="https://s2.loli.net/2023/04/14/WXe3PD5Oc1faYjN.png" alt=""></p><p>ä¸ç­‰å¼å½¢ï¼ˆæ²¡æœ‰ç­‰å¼çº¦æŸï¼‰</p><p><img src="https://s2.loli.net/2023/04/14/f1jFugUqNXJ3PYc.png" alt=""></p></li></ol><h1>ç¬¬å››ç« ã€æ— çº¦æŸä¼˜åŒ–ç®—æ³•</h1><h3 id="ä¸€ã€çº¿æœç´¢æ–¹æ³•">ä¸€ã€çº¿æœç´¢æ–¹æ³•</h3><p>ç»™å®šå½“å‰è¿­ä»£ç‚¹xkï¼Œé¦–å…ˆé€šè¿‡æŸç§ç®—æ³•é€‰å–å‘é‡dkï¼Œä¹‹åç¡®å®šæ­£æ•°Î±kï¼Œåˆ™ä¸‹ä¸€æ­¥çš„è¿­ä»£ç‚¹å¯å†™ä½œ<br>$$<br>x^{k+1}=x^k+\alpha_kd^k<br>$$<br>å…¶ä¸­dkæ˜¯æœç´¢æ–¹å‘ï¼ŒÎ±kæ˜¯æ­¥é•¿ï¼Œçº¿æœç´¢ç®—æ³•çš„å…³é”®å°±æ˜¯é€‰å–å¥½çš„dkå’ŒÎ±kï¼Œä¸ºäº†é€‰å‡ºåˆé€‚çš„æ­¥é•¿Î±kï¼Œæˆ‘ä»¬è¦å¼•å…¥ä¸€å®šçš„è¦æ±‚ï¼Œç§°ä¹‹ä¸º<strong>çº¿æœç´¢å‡†åˆ™</strong>ï¼Œå¸¸è§çš„æœ‰Armijoå‡†åˆ™ã€Goldsteinå‡†åˆ™ã€Wolfeå‡†åˆ™ç­‰</p><p>å…¶ä¸­ï¼Œç”¨äºæ»¡è¶³Armijoå‡†åˆ™çš„å¸¸ç”¨æ–¹æ³•æ˜¯<strong>å›é€€æ³•</strong>ï¼Œå…¶åŸºæœ¬æ€æƒ³ä¸ºç”±å¤§åˆ°å°ä¸æ–­è¯•éªŒÎ±ï¼Œç›´è‡³è¾“å‡ºä¸€ä¸ªæ»¡è¶³Armijoå‡†åˆ™ä¸”å°½å¯èƒ½å¤§çš„æ­¥é•¿</p><p><img src="https://s2.loli.net/2023/04/14/87Lrs5XoR4M9ObN.png" alt=""></p><h3 id="äºŒã€æ¢¯åº¦ç±»ç®—æ³•">äºŒã€æ¢¯åº¦ç±»ç®—æ³•</h3><ol><li><p><strong>æ¢¯åº¦ä¸‹é™æ³•</strong></p><p>$$ x^{k+1}=x^k-\alpha_k\nabla f(x^k) $$</p></li><li><p><strong>BBç®—æ³•ï¼ˆBarzilai-Borweinï¼‰</strong></p><p>$$ x^{k+1}=x^k-\alpha_{BB1}^K\nabla f(x^k) $$</p><p>$$ x^{k+1}=x^k-\alpha_{BB2}^K\nabla f(x^k) $$</p><p>å…¶ä¸­</p><p><img src="https://s2.loli.net/2023/04/14/PmaeTIGiWnXb1YH.png" alt=""></p><p><img src="https://s2.loli.net/2023/04/14/6chSM21efDy8BY7.png" alt=""></p><p>ç”±ä¸Šå¼å¯è§ï¼ŒBBç®—æ³•ä»…éœ€è¦çŸ¥é“å‡½æ•°ç›¸é‚»ä¸¤æ­¥çš„æ¢¯åº¦ä¿¡æ¯å’Œè¿­ä»£ç‚¹ä¿¡æ¯ï¼Œæ‰€ä»¥BBç®—æ³•çš„åº”ç”¨èŒƒå›´å¾ˆå¹¿æ³›</p><p><img src="https://s2.loli.net/2023/04/14/q1dE8OU5Pr9zgGJ.png" alt=""></p></li></ol><h3 id="ä¸‰ã€æ¬¡æ¢¯åº¦ç®—æ³•">ä¸‰ã€æ¬¡æ¢¯åº¦ç®—æ³•</h3><ol><li><p><strong>motivation</strong>ï¼šä½¿ç”¨GDAçš„å‰æä¸ºç›®æ ‡å‡½æ•° f(x) æ˜¯ä¸€é˜¶å¯å¾®çš„ï¼Œä½†å®é™…åº”ç”¨ä¸­ç»å¸¸ä¼šé‡åˆ°<strong>ä¸å¯å¾®</strong>çš„å‡½æ•°ï¼Œå¯¹äºè¿™ç±»å‡½æ•°æˆ‘ä»¬æ— æ³•åœ¨æ¯ä¸ªç‚¹å¤„æ±‚å‡ºæ¢¯åº¦ï¼Œä½†å¾€å¾€å®ƒä»¬çš„æœ€ä¼˜å€¼éƒ½æ˜¯åœ¨ä¸å¯å¾®ç‚¹å¤„å–åˆ°çš„ã€‚ä¸ºäº†èƒ½å¤„ç†è¿™ç§æƒ…å½¢ï¼Œæˆ‘ä»¬å¼•å…¥æ¬¡æ¢¯åº¦ç®—æ³•</p></li><li><p><strong>æ¬¡æ¢¯åº¦ç®—æ³•çš„ç»“æ„</strong></p><p><img src="https://s2.loli.net/2023/04/14/MlaJcfgUHEtXpbo.png" alt=""></p><p>å³å¯¹äºå‡¸å‡½æ•°æ¥è¯´ï¼Œå…¶åˆ‡çº¿æ€»æ˜¯åœ¨å‡½æ•°çš„ä¸‹æ–¹ã€‚</p><p>ç±»æ¯”ä¸Šå¼å¯å®šä¹‰ï¼Œç»™å®šå‡½æ•°fï¼Œå¯¹äºä»»æ„yï¼Œå¦‚æœæ»¡è¶³ï¼š</p><p>$$ f(y)\ge f(x)+g^T(y-x) $$</p><p>åˆ™ç§° g æ˜¯å‡½æ•° f åœ¨ç‚¹ x å¤„çš„æ¬¡æ¢¯åº¦ï¼Œå¯è§æ¬¡æ¢¯åº¦ä¸ä¸€å®šå”¯ä¸€ï¼Œä¹Ÿå¯èƒ½ä¸å­˜åœ¨ã€‚</p><p>å°† f åœ¨ x å¤„æ‰€æœ‰æ¬¡æ¢¯åº¦æ„æˆçš„é›†åˆç§°ä¸º f åœ¨ x å¤„çš„æ¬¡å¾®åˆ†ï¼Œè®°ä½œ$\partial f(x)$</p><div class="note note-warning">            <p>ğŸ’¡ PS. æ³¨æ„ï¼šæ¬¡å¾®åˆ†æ˜¯ä¸€ä¸ªé›†åˆï¼Œè€Œå‡¸å‡½æ•°çš„æ¬¡å¾®åˆ†æ€»æ˜¯éç©ºï¼Œå³å¿…æœ‰æ¬¡æ¢¯åº¦</p>          </div><p>å‡è®¾å‡¸å‡½æ•° f åœ¨ä¸å¯å¾®ç‚¹x0å¤„çš„å·¦å³å¯¼æ•°åˆ†åˆ«ä¸ºaã€bï¼Œé‚£ä¹ˆé—­åŒºé—´[aï¼Œb]ä¸­çš„ä»»ä½•ä¸€ä¸ªå–å€¼éƒ½æ˜¯æ¬¡æ¢¯åº¦ï¼Œå¦‚$f(x)=\vert x \vert$ï¼Œåˆ™<br>$$<br>g=\begin{cases}sgn(x)&amp;x\neq0\\ any\in[-1,1]&amp;x=0\end{cases}<br>$$</p></li><li><p><strong>æ”¶æ•›æ€§</strong></p><p>ä¸€ä¸ªå¸¸ç”¨çš„å–æ³•æ˜¯$\alpha_k=\frac{1}{k}$ï¼Œè¿™æ ·å¯ä¿è¯ç®—æ³•çš„æ”¶æ•›æ€§</p></li></ol><h3 id="å››ã€ç‰›é¡¿ç±»ç®—æ³•">å››ã€ç‰›é¡¿ç±»ç®—æ³•</h3><ol><li><p><strong>motivation</strong>ï¼š</p><p>æ¢¯åº¦æ³•ä»…ä»…ä¾èµ–å‡½æ•°å€¼å’Œæ¢¯åº¦çš„ä¿¡æ¯ï¼ˆå³ä¸€é˜¶ä¿¡æ¯ï¼‰ï¼Œå¦‚æœå‡½æ•° <em>f</em>(<em>x</em>) å……åˆ†å…‰æ»‘ï¼Œåˆ™å¯ä»¥åˆ©ç”¨äºŒé˜¶å¯¼æ•°ä¿¡æ¯æ„é€ ä¸‹é™æ–¹å‘ <em>dk</em>ã€‚ç‰›é¡¿ç±»ç®—æ³•å°±æ˜¯åˆ©ç”¨äºŒé˜¶å¯¼æ•°ä¿¡æ¯æ¥æ„é€ è¿­ä»£æ ¼å¼çš„ç®—æ³•ã€‚ç”±äºåˆ©ç”¨çš„ä¿¡æ¯å˜å¤šï¼Œç‰›é¡¿æ³•çš„å®é™…è¡¨ç°å¯ä»¥è¿œå¥½äºæ¢¯åº¦æ³•ï¼Œä½†æ˜¯å®ƒå¯¹å‡½æ•° <em>f</em>(<em>x</em>) çš„è¦æ±‚ä¹Ÿç›¸åº”å˜é«˜</p></li><li><p><strong>ç»å…¸ç‰›é¡¿æ³•</strong><br>$$<br>x^{k+1}=x^k-\nabla^2f(x^k)^{-1}\nabla f(x^k)<br>$$<br>ç»å…¸ç‰›é¡¿æ³•çš„ç‰¹ç‚¹ï¼š</p><ul><li>æ­¥é•¿æ’ä¸º1</li><li>æ”¶æ•›é€Ÿåº¦å¾ˆå¿«ï¼Œä½†åªæœ‰å±€éƒ¨æ”¶æ•›æ€§ï¼Œå³åˆå§‹ç‚¹x0å¿…é¡»ç¦»çœŸå®è§£è¾ƒè¿‘ï¼Œè¾ƒè¿œæ—¶å®¹æ˜“å¤±æ•ˆ</li></ul><p>å› æ­¤åœ¨åœ¨å®é™…åº”ç”¨ä¸­ï¼Œäººä»¬é€šå¸¸ä¼šä½¿ç”¨æ¢¯åº¦ç±»ç®—æ³•å…ˆæ±‚å¾—è¾ƒä½ç²¾åº¦çš„è§£ï¼Œè€Œåè°ƒç”¨ç‰›é¡¿æ³•æ¥è·å¾—é«˜ç²¾åº¦çš„è§£</p></li><li><p><strong>ä¿®æ­£ç‰›é¡¿æ³•</strong></p><p><img src="https://s2.loli.net/2023/04/14/kO4vuQbPhI3tcs6.png" alt=""></p><p>åŸºæœ¬æ€æƒ³æ˜¯å¯¹ç‰›é¡¿æ–¹ç¨‹ä¸­çš„æµ·ç‘ŸçŸ©é˜µ$\nabla^2f(x^k)$è¿›è¡Œä¿®æ­£</p></li></ol><h3 id="äº”ã€æ‹Ÿç‰›é¡¿ç±»ç®—æ³•">äº”ã€æ‹Ÿç‰›é¡¿ç±»ç®—æ³•</h3><ol><li><p>**motivationï¼š**æ‹Ÿç‰›é¡¿æ–¹æ³•ä¸è®¡ç®—æµ·ç‘ŸçŸ©é˜µ$\nabla^2f(x^k)$ ï¼Œè€Œæ˜¯æ„é€ å…¶è¿‘ä¼¼çŸ©é˜µ$B^k$æˆ–å…¶é€†çš„è¿‘ä¼¼çŸ©é˜µ $H^k$ï¼Œæˆ‘ä»¬å¸Œæœ› $B^k$ **æˆ–$H^k$ä»ç„¶ä¿ç•™æµ·ç‘ŸçŸ©é˜µçš„éƒ¨åˆ†æ€§è´¨ï¼Œä¾‹å¦‚ä½¿dkä»ç„¶ä¸ºä¸‹é™æ–¹å‘</p></li><li><p><strong>ç®—æ³•æ¡†æ¶</strong></p><p><img src="https://s2.loli.net/2023/04/14/P34FKpX1rmdulV5.png" alt=""></p></li><li><p><strong>æ‹Ÿç‰›é¡¿çŸ©é˜µæ›´æ–°æ–¹å¼</strong></p></li></ol><ul><li><p>ç§©ä¸€æ›´æ–°ï¼ˆSR1ï¼‰</p><p>$$ B^{k+1}=B^k+\dfrac{(y^k-B^ks^k)(y^k-B^k s^k)^{\text{T}}}{(y^k-B^kj)^{\text{T}}s^k} $$</p><p>$$ H^{k+1}=H^k+\dfrac{(s^k-H^k y^k)(s^k-H^ky^k)^{\mathrm{T}}}{(s^k-H^ky^{k})^{\mathrm{T}}y^k} $$</p></li><li><p>BFGSå…¬å¼</p><p>$$ B^{k+1}=B^k+\dfrac{y^k(y^k)^{T}}{(s^k)^{T}y^k}-\dfrac{B^k s^k(B^k s^k)^}{(s^k)^{T}B^k s^k} $$</p><p>BFGS å…¬å¼æ˜¯ç›®å‰æœ€æœ‰æ•ˆçš„æ‹Ÿç‰›é¡¿æ›´æ–°æ ¼å¼ä¹‹ä¸€ï¼Œå®ƒæœ‰æ¯”è¾ƒå¥½çš„ç†è®ºæ€§è´¨ï¼Œå®ç°èµ·æ¥ä¹Ÿå¹¶ä¸å¤æ‚</p></li></ul><ol><li><p><strong>æœ‰é™å†…å­˜BFGSæ–¹æ³•</strong></p><p>æ‹Ÿç‰›é¡¿æ³•è™½ç„¶å…‹æœäº†è®¡ç®—æµ·ç‘ŸçŸ©é˜µçš„å›°éš¾ï¼Œä½†æ˜¯å®ƒä»ç„¶æ— æ³•åº”ç”¨åœ¨å¤§è§„æ¨¡ä¼˜åŒ–é—®é¢˜ä¸Šã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ‹Ÿç‰›é¡¿çŸ©é˜µ$B^k$ æˆ–$H^k$ æ˜¯ç¨ å¯†çŸ©é˜µï¼Œè€Œå­˜å‚¨ç¨ å¯†çŸ©é˜µè¦æ¶ˆè€— <em>O</em>(nÂ²) çš„å†…å­˜ï¼Œè¿™å¯¹äºå¤§è§„æ¨¡é—®é¢˜æ˜¾ç„¶æ˜¯ä¸å¯èƒ½å®ç°çš„ï¼Œæ•…å¼•å…¥æœ‰é™å†…å­˜BFGSæ–¹æ³•ï¼ˆL-BFGSï¼‰</p><p><img src="https://s2.loli.net/2023/04/14/PwRMakbExuog97v.png" alt=""></p><p><img src="https://s2.loli.net/2023/04/14/hB2pODdcqLivJRy.png" alt=""></p></li></ol><h3 id="å…­ã€ä¿¡èµ–åŸŸç®—æ³•">å…­ã€ä¿¡èµ–åŸŸç®—æ³•</h3><ol><li><p>**motivationï¼š**åœ¨ä¿¡èµ–åŸŸç±»ç®—æ³•ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨ä¸€ä¸ªæœ‰ç•ŒåŒºåŸŸå†…æ±‚è§£è¿™ä¸ªè¿‘ä¼¼æ¨¡å‹ï¼Œè€Œåè¿­ä»£åˆ°ä¸‹ä¸€ä¸ªç‚¹ï¼å› æ­¤ä¿¡èµ–åŸŸç®—æ³•å®é™…ä¸Šæ˜¯åŒæ—¶é€‰æ‹©äº†æ–¹å‘å’Œæ­¥é•¿</p></li><li><p><strong>å½¢å¼ï¼š</strong></p><p>æˆ‘ä»¬åœ¨å¦‚ä¸‹çƒå†…è€ƒè™‘ f(x) çš„è¿‘ä¼¼<br>$$<br>\Omega_k={x^k+d\mid|d|\leqslant\Delta_k}<br>$$<br><img src="https://s2.loli.net/2023/04/14/uDc6BfUdOZrG5v2.png" alt=""></p><p>å…¶ä¸­ï¼Œmk(d)æ˜¯åœ¨ç‚¹x=xkå¤„å¯¹f(x)çš„è¿‘ä¼¼</p><p>$$ m_k(d)=f(x^k)+\nabla f(x^k)^{\mathrm T}d+\dfrac12d^{\mathrm T}B^kd $$</p><p>é€‰å–ä¿¡èµ–åŸŸåŠå¾„éå¸¸å…³é”®ï¼Œå®ƒå†³å®šäº†ç®—æ³•çš„æ”¶æ•›æ€§ã€‚è€ƒè™‘åˆ°ä¿¡èµ–åŸŸåŠå¾„æ˜¯â€œå¯¹æ¨¡å‹ <em>mk</em>(<em>d</em>) ç›¸</p><p>ä¿¡çš„ç¨‹åº¦â€ï¼Œå¦‚æœ <em>mk</em>(<em>d</em>) å¯¹å‡½æ•° <em>f</em>(<em>x</em>) è¿‘ä¼¼è¾ƒå¥½ï¼Œå°±åº”è¯¥æ‰©å¤§ä¿¡èµ–åŸŸåŠå¾„ï¼›åä¹‹å‡å°ã€‚æˆ‘ä»¬å¼•å…¥å¦‚ä¸‹å®šä¹‰æ¥è¡¡é‡ <em>mk</em>(<em>d</em>) è¿‘ä¼¼ç¨‹åº¦çš„å¥½å</p><p>$$ \rho_k=\dfrac{f(x^k)-f(x^k+d^k)}{m_k(0)-m_k(d^k)} $$</p><p>å¦‚æœ<em>Ïk</em> æ¥è¿‘äº1ï¼Œè¯´æ˜ç”¨ <em>mk</em>(<em>d</em>) æ¥è¿‘ä¼¼ <em>f</em>(<em>x</em>) æ˜¯æ¯”è¾ƒæˆåŠŸçš„ï¼Œæˆ‘ä»¬åº”è¯¥æ‰©å¤§ <em>âˆ†k</em>ï¼›å¦‚æœ <em>Ïk</em> éå¸¸å°ç”šè‡³ä¸ºè´Ÿï¼Œå°±è¯´æ˜æˆ‘ä»¬è¿‡åˆ†åœ°ç›¸ä¿¡äº†äºŒé˜¶æ¨¡å‹ <em>mk</em>(<em>d</em>)ï¼Œæ­¤æ—¶åº”è¯¥ç¼©å° <em>âˆ†k</em></p><p><img src="https://s2.loli.net/2023/04/14/pRejfTP5g3yAiLV.png" alt="Untitled"></p></li></ol><h1>ç¬¬äº”ç« ã€çº¦æŸä¼˜åŒ–ç®—æ³•</h1><h3 id="ä¸€ã€ç½šå‡½æ•°æ³•">ä¸€ã€ç½šå‡½æ•°æ³•</h3><ol><li><p><strong>motivationï¼š</strong></p><p>å¯è¡ŒåŸŸçš„çº¦æŸå¯¼è‡´å¾ˆå¤šæ— çº¦æŸç®—æ³•ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼ˆå¦‚æ¢¯åº¦ä¸‹é™æ²¿è´Ÿæ¢¯åº¦ä¸‹é™çš„ç‚¹æœªå¿…æ˜¯å¯è¡Œç‚¹ï¼‰ï¼Œè€Œç½šå‡½æ•°çš„æ€æƒ³æ˜¯å°†çº¦æŸæ¡ä»¶ä½œä¸ºæƒ©ç½šé¡¹åŠ åˆ°ç›®æ ‡å‡½æ•°ä¸­ï¼Œä»è€Œè½¬æ¢ä¸ºæ— çº¦æŸä¼˜åŒ–é—®é¢˜ã€‚</p><p>è€Œè¿™æ ·åšçš„åŸç†æ˜¯ä»€ä¹ˆæ â€”â€” å¯¹äº<strong>å¯è¡ŒåŸŸå¤–çš„ç‚¹ï¼Œæƒ©ç½šé¡¹ä¸ºæ­£</strong>ï¼Œå³å¯¹è¯¥ç‚¹è¿›è¡Œæƒ©ç½šï¼›å¯¹äº<strong>å¯è¡ŒåŸŸå†…çš„ç‚¹ï¼Œæƒ©ç½šé¡¹ä¸º 0</strong>ï¼Œå³ä¸åšä»»ä½•æƒ©ç½šã€‚å› æ­¤ï¼Œæƒ©ç½šé¡¹ä¼šä¿ƒä½¿æ— çº¦æŸä¼˜åŒ–é—®é¢˜çš„è§£è½åœ¨å¯è¡ŒåŸŸå†…ï¼ˆå¥½èªæ˜çš„åšæ³•ï¼‰ã€‚</p></li><li><p><strong>ç­‰å¼çº¦æŸæ¡ä»¶ç½šå‡½æ•°</strong></p><p><img src="https://s2.loli.net/2023/04/14/pDF1ZyodE9vP5jI.png" alt=""></p></li><li><p><strong>ä¸ç­‰å¼çº¦æŸ</strong></p><p><img src="https://s2.loli.net/2023/04/14/xX73rBP5fuwVtlS.png" alt=""></p><p>æˆ‘ä»¬è®¾è®¡åŠ å…¥ç½šå‡½æ•°çš„ç›®æ ‡å‡½æ•°ä¸ºï¼š</p><p><img src="https://s2.loli.net/2023/04/14/WXZBYGvCbUFSNo2.png" alt=""></p><p><img src="https://s2.loli.net/2023/04/14/KEHV2ipQcxqT7N9.png" alt=""></p><p>è¿™æ ·çš„ç½šå‡½æ•°åªä¼šæƒ©ç½šci(x)ï¼0çš„éƒ¨åˆ†ï¼Œä¸”ç”±äºå‡½æ•° <em>h</em>(<em>t</em>) = (max*{t*, 0*}*)Â²å…³äº <em>t</em> æ˜¯å¯å¯¼çš„ï¼Œå› æ­¤ <em>PI</em>(<em>x</em>,<em>Ïƒ</em>) çš„æ¢¯åº¦ä¹Ÿå­˜åœ¨ï¼Œåˆ™å¯ä»¥ä½¿ç”¨æ¢¯åº¦ç±»ç®—æ³•æ¥æ±‚è§£å­é—®é¢˜</p></li><li><p><strong>å†…ç‚¹ç½šå‡½æ•°</strong></p><p>åŸºæœ¬æ€æƒ³ï¼šæ™®é€šçš„å¤–ç‚¹ç½šå‡½æ•°å…è®¸å–å¯è¡ŒåŸŸä¹‹å¤–çš„ç‚¹ï¼Œåªæ˜¯è¦è¿›è¡Œæƒ©ç½šï¼›è€Œå†…ç‚¹æ³•ç›´æ¥ä¸å…è®¸å–å¯è¡ŒåŸŸä¹‹å¤–çš„ç‚¹ï¼Œå³ä»å¯è¡ŒåŸŸå†…éƒ¨é€¼è¿‘æœ€ä¼˜è§£</p><p><img src="https://s2.loli.net/2023/04/14/2LPyCemrqFWRujQ.png" alt=""></p><p>ä¸Šå¼æ—¢åšåˆ°äº†é™åˆ¶å¯è¡ŒåŸŸï¼Œåˆåšåˆ°äº†â€œxè¶‹è¿‘äºè¾¹ç•Œæ—¶è¿›è¡Œæƒ©ç½šâ€ï¼ˆInæ— ç©·å¤§ï¼‰</p></li></ol><h3 id="äºŒã€å¢å¹¿æ‹‰æ ¼æœ—æ—¥å‡½æ•°æ³•">äºŒã€å¢å¹¿æ‹‰æ ¼æœ—æ—¥å‡½æ•°æ³•</h3><ol><li><strong>ç»“æ„</strong></li></ol><p><img src="https://s2.loli.net/2023/04/14/67anqbXZ3CoHMRx.png" alt=""></p><ol><li><p><strong>ä¸€èˆ¬çº¦æŸä¼˜åŒ–é—®é¢˜çš„å¢å¹¿æ‹‰æ ¼æœ—æ—¥å‡½æ•°æ³•</strong></p><p><img src="https://s2.loli.net/2023/04/14/2DK1ludNp9EkQit.png" alt=""></p><p>æ€è·¯ï¼šå¼•å…¥æ¾å¼›å˜é‡å°†ä¸ç­‰å¼çº¦æŸè½¬åŒ–ä¸ºç­‰å¼çº¦æŸå’Œç®€å•çš„éè´Ÿçº¦æŸï¼Œå†æ„é€ å¢å¹¿æ‹‰æ ¼æœ—æ—¥å‡½æ•°</p><p><img src="https://s2.loli.net/2023/04/14/9CePmiN4RJXKWHg.png" alt=""></p><p>å¯¹ä¸Šè¿°é—®é¢˜æˆ‘ä»¬å¯ä»¥æ„é€ å‡ºä¸€ä¸ªç»å…¸çš„æ‹‰æ ¼æœ—æ—¥å‡½æ•°</p><p><img src="https://s2.loli.net/2023/04/14/A2b8cl9PHEz4NJf.png" alt=""></p></li></ol><h1>ç¬¬å…­ç« ã€å¤åˆä¼˜åŒ–ç®—æ³•</h1><h3 id="ä¸€ã€èƒŒæ™¯">ä¸€ã€èƒŒæ™¯</h3><p>å¤åˆä¼˜åŒ–é—®é¢˜å®šä¹‰ä¸ºï¼š</p><p><img src="https://s2.loli.net/2023/04/14/7fLqF8cXxjO3ZVS.png" alt=""></p><p>å…¶ä¸­ <em>f</em>(<em>x</em>) ä¸ºå¯å¾®å‡½æ•°ï¼ˆå¯èƒ½éå‡¸ï¼‰ï¼Œ<em>h</em>(<em>x</em>) å¯èƒ½ä¸ºä¸å¯å¾®å‡½æ•°</p><h3 id="äºŒã€è¿‘ä¼¼ç‚¹æ¢¯åº¦æ³•">äºŒã€è¿‘ä¼¼ç‚¹æ¢¯åº¦æ³•</h3><ol><li><p><strong>é‚»è¿‘ç®—å­</strong></p><p>å¯¹äºä¸€ä¸ªå‡¸å‡½æ•° <em>h</em>ï¼Œå®šä¹‰å®ƒçš„é‚»è¿‘ç®—å­ä¸º</p><p><img src="https://s2.loli.net/2023/04/14/MXkIeUJt6zPBFlC.png" alt=""></p><p>å¯è§ï¼Œé‚»è¿‘ç®—å­çš„ç›®çš„æ˜¯æ±‚è§£ä¸€ä¸ªè· <em>x</em> ä¸ç®—å¤ªè¿œçš„ç‚¹ï¼Œå¹¶ä½¿å‡½æ•°å€¼ <em>h</em>(<em>x</em>) ä¹Ÿç›¸å¯¹è¾ƒå°</p></li><li><p><strong>å…¬å¼</strong></p><p>å¯¹äºä¸€ä¸ªå¤åˆä¼˜åŒ–é—®é¢˜</p><p><img src="https://s2.loli.net/2023/04/14/P4NxGtKcvzmS8XF.png" alt=""></p><p>è¿‘ä¼¼ç‚¹æ¢¯åº¦æ³•çš„æ€æƒ³éå¸¸ç®€å•ï¼šæ³¨æ„åˆ° <em>Ïˆ</em>(<em>x</em>) æœ‰ä¸¤éƒ¨åˆ†ï¼Œå¯¹äºå…‰æ»‘éƒ¨åˆ†<em>f</em> åšæ¢¯åº¦ä¸‹é™ï¼Œå¯¹äºéå…‰æ»‘éƒ¨åˆ† <em>h</em> ä½¿ç”¨é‚»è¿‘ç®—å­ï¼Œåˆ™è¿‘ä¼¼ç‚¹æ¢¯åº¦æ³•çš„è¿­ä»£å…¬å¼ä¸ºï¼š</p><p><img src="https://s2.loli.net/2023/04/14/aOG3ESCUkqFM5Np.png" alt=""></p><p>å…¶ä¸­ <em>tk &gt;</em> 0 ä¸ºæ¯æ¬¡è¿­ä»£çš„æ­¥é•¿ï¼Œå®ƒå¯ä»¥æ˜¯ä¸€ä¸ªå¸¸æ•°æˆ–è€…ç”±çº¿æœç´¢å¾—å‡ºã€‚</p><p><img src="https://s2.loli.net/2023/04/14/jTPA6um7OtqriVL.png" alt=""></p></li></ol><h3 id="ä¸‰ã€NesterovåŠ é€Ÿç®—æ³•">ä¸‰ã€NesterovåŠ é€Ÿç®—æ³•</h3><ol><li><p><strong>FISTAç®—æ³•</strong>ï¼ˆå¯å¯¹è¿‘ä¼¼ç‚¹æ¢¯åº¦ç®—æ³•è¿›è¡ŒåŠ é€Ÿï¼‰</p><p>FISTA ç®—æ³•ç”±ä¸¤æ­¥ç»„æˆï¼šç¬¬ä¸€æ­¥æ²¿ç€å‰ä¸¤æ­¥çš„è®¡ç®—æ–¹å‘è®¡ç®—ä¸€ä¸ªæ–°ç‚¹ï¼Œç¬¬äºŒæ­¥åœ¨è¯¥æ–°ç‚¹å¤„åšä¸€æ­¥è¿‘ä¼¼ç‚¹æ¢¯åº¦è¿­ä»£ï¼Œå³</p><p><img src="https://s2.loli.net/2023/04/14/Oyvg5k97UMNCELB.png" alt=""></p><p><img src="https://s2.loli.net/2023/04/14/LFejMiZGSY1V2Nn.png" alt=""></p></li></ol><h3 id="å››ã€åˆ†å—åæ ‡ä¸‹é™æ³•ï¼ˆblock-coordinate-descentï¼ŒBCDï¼‰">å››ã€åˆ†å—åæ ‡ä¸‹é™æ³•ï¼ˆblock coordinate descentï¼ŒBCDï¼‰</h3><ol><li><p><strong>motivationï¼š</strong> å®é™…é—®é¢˜ä¸­çš„ç›®æ ‡å‡½æ•°è™½å¯èƒ½æœ‰æˆç™¾ä¸Šåƒä¸ªè‡ªå˜é‡ï¼Œæ±‚è§£ååˆ†å›°éš¾ï¼Œä½†å½“å›ºå®šå…¶ä¸­è‹¥å¹²å˜é‡æ—¶ï¼Œå‡½æ•°çš„ç»“æ„ä¼šå¾—åˆ°æå¤§çš„ç®€åŒ–ï¼Œæ˜¯åŸé—®é¢˜è¢«æ‹†åˆ†ä¸ºæ•°ä¸ªåªæœ‰å°‘æ•°è‡ªå˜é‡çš„å­é—®é¢˜ï¼Œè¿™ä¹Ÿæ­£æ˜¯BCDæ–¹æ³•çš„åŸºæœ¬æ€æƒ³</p></li><li><p><strong>å½¢å¼ï¼š</strong></p><p><img src="https://s2.loli.net/2023/04/14/Z8oWvxUuVjlCy9H.png" alt=""></p><p>å°†è‡ªå˜é‡ <em>x</em> æ‹†åˆ†æˆ <em>s</em> ä¸ªå˜é‡å— <em>x</em>1, <em>x</em>2,<em>Â·Â·Â·</em> , <em>xs</em>ï¼Œå‡½æ•° <em>f</em> æ˜¯å…³äº <em>x</em> çš„å¯å¾®å‡½æ•°ï¼Œæ¯ä¸ª <em>ri</em>(<em>xi</em>) å…³äº <em>xi</em> æ˜¯é€‚å½“çš„é—­å‡¸å‡½æ•°ã€‚ å•ç‹¬è€ƒè™‘æ¯ä¸€å—è‡ªå˜é‡æ—¶ï¼Œf æœ‰ç®€å•ç»“æ„ï¼Œri åªä¸ç¬¬ i ä¸ªè‡ªå˜é‡å—æœ‰å…³</p></li><li><p><strong>ä¸¾ä¾‹</strong></p><p>è€ƒè™‘äºŒå…ƒäºŒæ¬¡å‡½æ•°çš„ä¼˜åŒ–é—®é¢˜</p><p><img src="https://s2.loli.net/2023/04/14/Z8oWvxUuVjlCy9H.png" alt=""></p><p>ç°åœ¨å¯¹å˜é‡ <em>x</em>,<em>y</em> ä½¿ç”¨åˆ†å—åæ ‡ä¸‹é™æ³•æ±‚è§£ã€‚å½“å›ºå®š <em>y</em> æ—¶ï¼Œå¯çŸ¥å½“ <em>x</em> = 2 + <em>y</em>æ—¶å‡½æ•°å–æå°å€¼ï¼›å½“å›ºå®š <em>x</em> æ—¶ï¼Œå¯çŸ¥å½“ <em>y</em> = 1 +*x/*10æ—¶å‡½æ•°å–æå°å€¼ã€‚æ•…é‡‡ç”¨çš„åˆ†å—åæ ‡ä¸‹é™æ³•ä¸ºï¼š</p><p><img src="https://s2.loli.net/2023/04/14/O5J1ovfhcqgCaZt.png" alt=""></p><p>ç»éªŒè¯ï¼Œåˆå§‹ç‚¹ä¸º(0.5, 0.2)æ—¶ï¼Œç»è¿‡ä¸ƒæ¬¡è¿­ä»£å°±ä¸æœ€ä¼˜è§£ç›¸å½“æ¥è¿‘</p><p><img src="https://s2.loli.net/2023/04/14/JDINTVim7MEvOKZ.png" alt=""></p></li></ol><h3 id="äº”ã€å¯¹å¶ç®—æ³•">äº”ã€å¯¹å¶ç®—æ³•</h3><ol><li>å¯¹å¶æ€æƒ³å¸¸ç”¨æ€è·¯æœ‰ä¸¤ç§ï¼šæŠŠå‰é¢çš„ç®—æ³•åº”ç”¨åˆ°å¯¹å¶é—®é¢˜ä¸Šï¼Œå¦‚å¯¹å¶è¿‘ä¼¼ç‚¹æ¢¯åº¦æ³•ï¼›å¦ä¸€ç§æ˜¯åŒæ—¶æŠŠåŸå§‹é—®é¢˜å’Œå¯¹å¶é—®é¢˜ç»“åˆèµ·æ¥è€ƒè™‘ï¼Œå¦‚åŸå§‹-å¯¹å¶æ··åˆæ¢¯åº¦ç±»ç®—æ³• å¯¹å¶ç®—æ³•ä¸»è¦è€ƒè™‘å¦‚ä¸‹å½¢å¼çš„é—®é¢˜ï¼š</li></ol><p><img src="https://s2.loli.net/2023/04/14/CVquzigKfx4jYQJ.png" alt=""></p><ol start="2"><li><strong>å¯¹å¶è¿‘ä¼¼ç‚¹æ¢¯åº¦æ³•</strong></li></ol><p>â€‹å¦‚æœæˆ‘ä»¬å†™å‡ºä¸Šè¿°çº¦æŸä¼˜åŒ–é—®é¢˜çš„æ‹‰æ ¼æœ—æ—¥å‡½æ•°å’Œå¢å¹¿æ‹‰æ ¼æœ—æ—¥å‡½æ•°</p><p><img src="https://s2.loli.net/2023/04/14/pfmt3ELqnaowGNk.png" alt=""></p><p>â€‹åˆ™è¿­ä»£æ ¼å¼å¯ä»¥å†™ä¸º</p><p><img src="https://s2.loli.net/2023/04/14/81PytDkENRAsQVY.png" alt=""></p><p>â€‹ä¸Šè¿°è¿­ä»£æ ¼å¼åˆç§°ä¸º**äº¤æ›¿æå°åŒ–æ–¹æ³•ï¼Œ**ç¬¬ä¸€æ­¥è¿­ä»£ä¸ºåœ¨æ‹‰æ ¼æœ—æ—¥å‡½æ•°ä¸­å…³äº <em>x</em> æ±‚æå°ï¼Œç¬¬äºŒæ­¥è¿­ä»£ä¸ºåœ¨å¢å¹¿æ‹‰æ ¼æœ—æ—¥å‡½æ•°ä¸­å…³äº <em>y</em> æ±‚æå°ï¼Œç¬¬ä¸‰æ­¥è¿­ä»£ä¸ºæ›´æ–°æ‹‰æ ¼æœ—æ—¥ä¹˜å­ã€‚</p><ol start="3"><li><strong>åŸå§‹-å¯¹å¶æ··åˆæ¢¯åº¦ç®—æ³•ï¼ˆprimaldual hybrid gradient, PDHGï¼‰</strong></li></ol><p>â€‹PDGHåœ¨æ¯æ¬¡è¿­ä»£æ—¶åŒæ—¶è€ƒè™‘åŸå§‹å˜é‡å’Œå¯¹å¶å˜é‡çš„æ›´æ–°ï¼Œè¿™ä½¿å¾—å®ƒåœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥æœ‰æ•ˆé¿å…å•ç‹¬é’ˆå¯¹åŸå§‹é—®é¢˜æˆ–å¯¹å¶é—®é¢˜æ±‚è§£ç®—æ³•ä¸­å¯èƒ½å‡ºç°çš„é—®é¢˜ ä»ç„¶è€ƒè™‘å¦‚ä¸‹å½¢å¼ï¼š</p><p><img src="https://s2.loli.net/2023/04/14/5ERFWfJcpC9xrlb.png" alt=""></p><p>â€‹å…¶ä¸­ <em>f</em> , <em>h</em> æ˜¯é€‚å½“çš„é—­å‡¸å‡½æ•°ï¼ç”±äº <em>h</em> æœ‰è‡ªå…±è½­æ€§ï¼Œæˆ‘ä»¬å°†ä¸Šè¿°é—®é¢˜å˜å½¢ä¸ºï¼š</p><p><img src="https://s2.loli.net/2023/04/14/qclZvI8Y1K5EsGF.png" alt=""></p><p>â€‹æ­¤æ—¶é—®é¢˜å˜å½¢ä¸ºä¸€ä¸ªæå°-æå¤§é—®é¢˜ï¼Œå³ä¸€ä¸ªå…¸å‹çš„<strong>éç‚¹é—®é¢˜</strong>ã€‚PDHG ç®—æ³•äº¤æ›¿æ›´æ–°åŸå§‹å˜é‡ä»¥åŠå¯¹å¶å˜é‡ï¼Œå…¶è¿­ä»£æ ¼å¼å¦‚ä¸‹ï¼š</p><p><img src="https://s2.loli.net/2023/04/14/89ROHGwP5YDfgoc.png" alt=""></p><h3 id="å…­ã€äº¤æ›¿æ–¹å‘ä¹˜å­æ³•ï¼ˆalternating-direction-method-of-multipliers-ADMMï¼‰">å…­ã€äº¤æ›¿æ–¹å‘ä¹˜å­æ³•ï¼ˆalternating direction method of multipliers, ADMMï¼‰</h3><ol><li><p><strong>å®šä¹‰ï¼š</strong></p><p>æœ¬èŠ‚è€ƒè™‘å¦‚ä¸‹å‡¸é—®é¢˜ï¼š</p><p><img src="https://s2.loli.net/2023/04/14/OjyM8sLdxBIUTho.png" alt=""></p><p>æ³¨æ„ï¼šå¾ˆå¤šå¸¸è§çš„é—®é¢˜éƒ½å¯è½¬åŒ–ä¸ºä¸Šè¿°å½¢å¼</p><p>å¦‚æŠŠ</p><p><img src="https://s2.loli.net/2023/04/14/ePVhFaBwXq4dG5g.png" alt=""></p><p>è½¬åŒ–ä¸ºï¼š</p><p><img src="https://s2.loli.net/2023/04/14/5NPCMdZmROeQ23B.png" alt=""></p><p>å†æ¯”å¦‚å¯¹äº<strong>ä¸€è‡´æ€§é—®é¢˜</strong>ï¼š</p><p><img src="https://s2.loli.net/2023/04/14/4ZTa6v2eUuIQSPx.png" alt=""></p><p>ä»¤ <em>x</em> = <em>z</em>ï¼Œå¹¶å°† <em>x</em> å¤åˆ¶ <em>N</em> ä»½ï¼Œåˆ†åˆ«ä¸º <em>xi</em>ï¼Œé‚£ä¹ˆé—®é¢˜è½¬åŒ–ä¸ºï¼š</p><p><img src="https://s2.loli.net/2023/04/14/KVco15f4PrFmuUx.png" alt=""></p><p>å¦‚æœä»¤$x=(x_1^\mathrm T,x_2^\mathrm T,\cdots,x_N^\mathrm T)^\mathrm T$ä»¥åŠ$f_1(x)=\sum\limits_{i=1}^N\phi_i(x_i),\quad f_2(z)=0$ åˆ™æ­¤é—®é¢˜å¯ä»¥åŒ–ä¸ºï¼š</p><p><img src="https://s2.loli.net/2023/04/14/lUen9HYD73EhXdW.png" alt=""></p><p>å…¶ä¸­çŸ©é˜µ <em>A</em>1, <em>A</em>2 å®šä¹‰ä¸ºï¼š</p><p><img src="https://s2.loli.net/2023/04/14/hFfUAVeaGOc731n.png" alt=""></p></li><li><p><strong>è¿­ä»£æ ¼å¼</strong></p><p>é¦–å…ˆå†™å‡ºé—®é¢˜çš„å¢å¹¿æ‹‰æ ¼æœ—æ—¥å‡½æ•°</p><p><img src="https://s2.loli.net/2023/04/14/ckdolxbypJTeZ42.png" alt=""></p><p>åˆ™è¿­ä»£æ ¼å¼ä¸ºï¼š</p></li></ol><p><img src="https://s2.loli.net/2023/04/14/62H5jK1lVUkQrzO.png" alt=""></p>]]></content>
    
    
    <categories>
      
      <category>ç§‘ç ”åªä¸ºæŠŠä¸šæ¯•</category>
      
    </categories>
    
    
    <tags>
      
      <tag>åˆ†å¸ƒå¼</tag>
      
      <tag>å‡¸ä¼˜åŒ–</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å€Ÿtop Ké¢˜ç›®æ€è€ƒæ€»ç»“å †ï¼ˆheapï¼‰ä¸ä¼˜å…ˆé˜Ÿåˆ—ï¼ˆpriority_quequeï¼‰ç”¨æ³•</title>
    <link href="/2023/04/13/%E5%80%9FtopK%E9%A2%98%E7%9B%AE%E6%80%9D%E8%80%83%E6%80%BB%E7%BB%93%E5%A0%86%E4%B8%8E%E4%BC%98%E5%85%88%E9%98%9F%E5%88%97%E7%94%A8%E6%B3%95/"/>
    <url>/2023/04/13/%E5%80%9FtopK%E9%A2%98%E7%9B%AE%E6%80%9D%E8%80%83%E6%80%BB%E7%BB%93%E5%A0%86%E4%B8%8E%E4%BC%98%E5%85%88%E9%98%9F%E5%88%97%E7%94%A8%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h1>ä¸€ã€å‰è¨€</h1><p>ä»Šå¤©åšäº†ä¼ è¯´ä¸­çš„top K ï¼Œå³â€œ<strong>ç”¨å¤§é¡¶å †/å°é¡¶å †å¯¹æ•°æ®è¿›è¡Œæ’åº</strong>â€çš„ç»å…¸é¢˜ç›®</p><p><img src="https://s2.loli.net/2023/04/13/ayuA9B7DGbOni2p.png" alt=""><br>æœ¬é¢˜æ€è·¯ï¼š</p><ol><li>ç”¨mapè®°å½•æ¯ä¸ªå…ƒç´ å‡ºç°çš„é¢‘ç‡</li><li>ç”¨heapå¯¹mapè¿›è¡Œæ’åºå¹¶èŠ‚é€‰å‡ºå‰Kä¸ªå…ƒç´ </li></ol><p>è‹¥ç¬¬ä¸€æ¬¡è§æ­¤ç±»é¢˜ï¼Œéš¾ç‚¹å½“ä¸ºheapçš„åŸç†å’Œå¯¹åº”stlå®¹å™¨ï¼ˆpriority_queueï¼‰çš„ç”¨æ³•ã€‚æŸ¥é˜…äº†ä¸€äº›èµ„æ–™ï¼Œå‘ç°ä¸ç®¡æ˜¯leetcodeé¢˜è§£æŠ‘æˆ–åšå®¢æ–‡ç« éƒ½å†™å¾—ç•¥è¯­ç„‰ä¸è¯¦ï¼Œå¯¹æ–°æ‰‹ä¸ç”šå‹å¥½ï¼Œæ•…ç¬”è€…è¯•å›¾ç”¨è‡ªå·±çš„è¯å¯¹å…¶åŸç†è¿›è¡Œç²—ç³™è§£é‡Šã€‚</p><hr><h1>äºŒã€å †ï¼ˆheapï¼‰çš„åŸç†å’Œç”¨æ³•ï¼ˆä¸‹è¿°æ‰€æœ‰ä¾‹å­é»˜è®¤ç”¨å°é¡¶å †ï¼‰</h1><h3 id="1-å®šä¹‰">1.å®šä¹‰</h3><p>ï¼ˆ1ï¼‰ å †æ˜¯ä¸€ç§å…·æœ‰ç‰¹æ®Šæ’åºå…³ç³»çš„å®Œå…¨äºŒå‰æ ‘ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå †é¦–å…ˆå¾—å…·æœ‰å®Œå…¨äºŒå‰æ ‘çš„æ‰€æœ‰ç‰¹æ€§<br>ï¼ˆ2ï¼‰ ç‰¹æ®Šæ’åºå…³ç³»æŒ‡â€”â€”ä»¥å°é¡¶å †ä¸ºä¾‹â€”â€”<strong>æ¯ä¸ªèŠ‚ç‚¹çš„valueéƒ½å°äºå…¶ä¸¤ä¸ªå­èŠ‚ç‚¹</strong> ï¼›å¤§é¡¶å †åä¹‹</p><p>ä¸‹å›¾å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„å°é¡¶å †</p><p><img src="https://s2.loli.net/2023/04/13/LYr9ecyzTOpSwCM.png" alt=""></p><h3 id="3-å †çš„å»ºç«‹ï¼ˆpushï¼‰">3.å †çš„å»ºç«‹ï¼ˆpushï¼‰</h3><p>å¯¹äºä¸€ä¸ªå·²ç»å»ºå¥½çš„å †ï¼Œpushæ–°å…ƒç´ çš„æ–¹æ³•æ˜¯ï¼š</p><ol><li><strong>æ’å…¥</strong>ï¼šå°†è¯¥å…ƒç´ æ’å…¥åˆ°heapçš„å°¾éƒ¨</li><li><strong>æ¯”è¾ƒ</strong>ï¼šç„¶åä¸æ–­â€œä¸Šæµ®â€ï¼Œç›´è‡³æ»¡è¶³å †çš„æ¡ä»¶ã€‚æ‰€è°“â€œä¸Šæµ®â€ï¼Œå°±æ˜¯å°†è¯¥å…ƒç´ ä¸å…¶çˆ¶èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒï¼Œæ¯”çˆ¶èŠ‚ç‚¹å°åˆ™ä¸Šæµ®ä¸€å±‚ï¼Œå¦åˆ™ä¸åŠ¨ï¼Œä¸€ç›´æ“ä½œç›´è‡³ä¸Šæµ®ä¸åŠ¨ã€‚</li></ol><p>è€Œè‹¥æ˜¯è¦ä»é›¶å¼€å§‹å»ºç«‹ä¸€ä¸ªå †æï¼Ÿå¾ˆç®€å•ï¼Œä»ç¬¬ä¸€ä¸ªå…ƒç´ å¼€å§‹ï¼Œå¯¹æ¯ä¸ªå…ƒç´ éƒ½æ‰§è¡Œä¸€æ¬¡pushæ“ä½œå°±è¡Œäº†ã€‚<br>ä¸‹å›¾å±•ç¤ºäº†ä»é›¶å¼€å§‹å»ºç«‹ä¸€ä¸ªheapè¿‡ç¨‹</p><p><img src="https://s2.loli.net/2023/04/13/gkV1vRcHpiLSujf.jpg" alt=""></p><h3 id="2-å †çš„åˆ é™¤ï¼ˆpopï¼‰">2.å †çš„åˆ é™¤ï¼ˆpopï¼‰</h3><p>ä¸‰æ­¥èµ°ï¼š</p><ol><li><strong>å¼¹å‡º</strong>ï¼šå°†å †é¡¶å…ƒç´ ï¼ˆå³æœ€å°çš„é‚£ä¸ªå…ƒç´ ï¼‰ç›´æ¥pop</li><li><strong>æä¸Š</strong>ï¼šå°†heapçš„æœ€åä¸€ä¸ªå…ƒç´ æåˆ°å †é¡¶</li><li><strong>ä¸‹æ²‰</strong>ï¼šå°†æä¸Šçš„è¿™ä¸ªå †é¡¶å…ƒç´ ä¸æ–­ä¸å…¶å­èŠ‚ç‚¹æ¯”è¾ƒï¼Œå¤§äºå­èŠ‚ç‚¹å°±ä¸‹æ²‰ä¸€å±‚ï¼Œç›´è‡³å…¨æ»¡è¶³å®šä¹‰</li></ol><p>å¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="https://s2.loli.net/2023/04/13/RXMb5QG1VdutzF6.jpg" alt=""></p><hr><h1>ä¸‰ã€ä¼˜å…ˆé˜Ÿåˆ—ï¼ˆpriority_queueï¼‰çš„ä½¿ç”¨</h1><h3 id="1-å®šä¹‰-2">1.å®šä¹‰</h3><p>æˆ‘ä»¬å¯ä»¥ç”¨c++ stlä¸­çš„priority_queueå®¹å™¨æ¥å®ç°heapçš„æ“ä½œï¼Œå…¶å®šä¹‰å¦‚ä¸‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span>&lt;<br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">T</span>,<br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Container</span> = std::vector&lt;T&gt;,<br>    <span class="hljs-keyword">class</span> Compare = std::less&lt;<span class="hljs-keyword">typename</span> Container::value_type&gt;<br>&gt; <span class="hljs-keyword">class</span> priority_queue;<br></code></pre></td></tr></table></figure><p>Tæ˜¯æŒ‡å †ä¸­å…ƒç´ çš„<strong>æ•°æ®ç±»å‹</strong>ï¼›<br>containeræŒ‡ç”¨äºå­˜å‚¨è¿™äº›å…ƒç´ çš„<strong>åº•å±‚å®¹å™¨ç±»å‹</strong>ï¼ˆ<strong>é»˜è®¤ç”¨vector</strong>ï¼Œä¸€èˆ¬ä¹Ÿä¸ç”¨æ”¹ï¼‰ï¼›<br>compareæ˜¯å…ƒç´ ä¹‹é—´çš„<strong>æ¯”è¾ƒæ–¹å¼</strong>ï¼Œç”¨äºå†³å®šå»ºç«‹çš„æ˜¯å¤§é¡¶å †orå°é¡¶å †ï¼Œé»˜è®¤ç”¨lesså‡½æ•°å»ºç«‹å¤§é¡¶å †ï¼ˆå½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥è‡ªå®šä¹‰compareæ–¹æ³•æ¥å»ºç«‹ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„å †ã€‚ã€‚ï¼‰</p><h3 id="2-å¸¸ç”¨æ–¹æ³•">2.å¸¸ç”¨æ–¹æ³•</h3><p>å’Œæ™®é€šé˜Ÿåˆ—ä¸€æ ·ï¼Œå¸¸ç”¨çš„å°±pop()ã€push()ã€top()ã€empty()</p><h3 id="3-ä»£ç ç¤ºä¾‹">3.ä»£ç ç¤ºä¾‹</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;functional&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;queue&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br> <br><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt; <span class="hljs-type">void</span> <span class="hljs-title">print_queue</span><span class="hljs-params">(T&amp; q)</span> </span>&#123;<br>    <span class="hljs-keyword">while</span>(!q.<span class="hljs-built_in">empty</span>()) &#123;<br>        std::cout &lt;&lt; q.<span class="hljs-built_in">top</span>() &lt;&lt; <span class="hljs-string">&quot; &quot;</span>;<br>        q.<span class="hljs-built_in">pop</span>();<br>    &#125;<br>    std::cout &lt;&lt; <span class="hljs-string">&#x27;\n&#x27;</span>;<br>&#125;<br> <br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    std::priority_queue&lt;<span class="hljs-type">int</span>&gt; q;<br> <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> n : &#123;<span class="hljs-number">4</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">5</span>,<span class="hljs-number">3</span>&#125;)<br>        q.<span class="hljs-built_in">push</span>(n);<br> <br>    <span class="hljs-built_in">print_queue</span>(q);<br> <br>    std::priority_queue&lt;<span class="hljs-type">int</span>, std::vector&lt;<span class="hljs-type">int</span>&gt;, std::greater&lt;<span class="hljs-type">int</span>&gt; &gt; q2;<br> <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> n : &#123;<span class="hljs-number">4</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">5</span>,<span class="hljs-number">3</span>&#125;)<br>        q2.<span class="hljs-built_in">push</span>(n);<br> <br>    <span class="hljs-built_in">print_queue</span>(q2);<br> <br>    <span class="hljs-comment">// ç”¨ lambda æ¯”è¾ƒå…ƒç´ ã€‚</span><br>    <span class="hljs-keyword">auto</span> cmp = [](<span class="hljs-type">int</span> left, <span class="hljs-type">int</span> right) &#123; <span class="hljs-built_in">return</span> (left ^ <span class="hljs-number">1</span>) &lt; (right ^ <span class="hljs-number">1</span>); &#125;;<br>    std::priority_queue&lt;<span class="hljs-type">int</span>, std::vector&lt;<span class="hljs-type">int</span>&gt;, <span class="hljs-keyword">decltype</span>(cmp)&gt; <span class="hljs-built_in">q3</span>(cmp);<br> <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> n : &#123;<span class="hljs-number">4</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">5</span>,<span class="hljs-number">3</span>&#125;)<br>        q3.<span class="hljs-built_in">push</span>(n);<br> <br>    <span class="hljs-built_in">print_queue</span>(q3);<br> <br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š<br><img src="https://s2.loli.net/2023/04/13/n4RIGtX7NACKceQ.png" alt=""><br>ä¸Šè¿°ä»£ç åŠè¿è¡Œç»“æœï¼Œä¸å‰é¢æˆ‘æ‰‹ç”»çš„é‚£ä¸¤å¼ å›¾éƒ½æ˜¯å»åˆçš„</p><hr><h1>å››ã€é¢˜è§£</h1><p>å›åˆ°å¼€å¤´é‚£é“topKåŠ›æ‰£é¢˜ï¼Œç­”æ¡ˆå¦‚ä¸‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-comment">// å°é¡¶å †</span><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">mycomparison</span> <br>    &#123;<br>        <span class="hljs-keyword">public</span>:<br>            <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">operator</span><span class="hljs-params">()</span><span class="hljs-params">(<span class="hljs-type">const</span> pair&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt;&amp; lhs, <span class="hljs-type">const</span> pair&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt;&amp; rhs)</span> </span><br><span class="hljs-function">            </span>&#123;<br>                <span class="hljs-keyword">return</span> lhs.second &gt; rhs.second;<br>            &#125;<br>    &#125;;<br><br>    <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">topKFrequent</span><span class="hljs-params">(vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums, <span class="hljs-type">int</span> k)</span> </span>&#123;<br><br>        unordered_map&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt; map; <br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> iter : nums) &#123;<br>            map[iter]++;<br>        &#125;<br><br>        <span class="hljs-comment">// å¯¹é¢‘ç‡æ’åº</span><br>        <span class="hljs-comment">// å®šä¹‰ä¸€ä¸ªå°é¡¶å †ï¼Œå¤§å°ä¸ºk</span><br>        priority_queue&lt;pair&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt;, vector&lt;pair&lt;<span class="hljs-type">int</span>, <span class="hljs-type">int</span>&gt;&gt;, mycomparison&gt; pri_que;<br><br>        <span class="hljs-comment">// ç”¨å›ºå®šå¤§å°ä¸ºkçš„å°é¡¶å †ï¼Œæ‰«é¢æ‰€æœ‰é¢‘ç‡çš„æ•°å€¼</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> it = map.<span class="hljs-built_in">begin</span>(); it != map.<span class="hljs-built_in">end</span>(); it++) <br>        &#123;<br>            pri_que.<span class="hljs-built_in">push</span>(*it);<br>            <span class="hljs-keyword">if</span> (pri_que.<span class="hljs-built_in">size</span>() &gt; k) &#123; <span class="hljs-comment">// å¦‚æœå †çš„å¤§å°å¤§äºäº†Kï¼Œåˆ™é˜Ÿåˆ—å¼¹å‡ºï¼Œä¿è¯å †çš„å¤§å°ä¸€ç›´ä¸ºk</span><br>                pri_que.<span class="hljs-built_in">pop</span>();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// æ‰¾å‡ºå‰Kä¸ªé«˜é¢‘å…ƒç´ ï¼Œå› ä¸ºå°é¡¶å †å…ˆå¼¹å‡ºçš„æ˜¯æœ€å°çš„ï¼Œæ‰€ä»¥å€’åºæ¥è¾“å‡ºåˆ°æ•°ç»„</span><br>        <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">result</span><span class="hljs-params">(k)</span></span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = k - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) &#123;<br>            result[i] = pri_que.<span class="hljs-built_in">top</span>().first;<br>            pri_que.<span class="hljs-built_in">pop</span>();<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>åšä¸€äº›è§£é‡Šè¯´æ˜ï¼š</p><ol><li><p>é¦–å…ˆæ³¨æ„ï¼Œæˆ‘ä»¬è¦<strong>æ‰¾å‡ºå‰Kå¤§çš„å…ƒç´ ï¼Œé‚£è¦ç”¨çš„æ˜¯å°é¡¶å †</strong>ï¼Œå› ä¸ºå°é¡¶å †æ‰èƒ½æŠŠå°å…ƒç´ æ’å‡ºå»ï¼Œå‰©ä¸‹çš„å°±æ˜¯å‰Kå¤§å…ƒç´ å˜›</p></li><li><p>mapä¸­çš„å•ä¸ªå…ƒç´ çš„æ•°æ®ç±»å‹æ˜¯pair&lt;Type, Type&gt;</p></li><li><p>å…³äºcompareæ–¹æ³•çš„ç†è§£ï¼šé»˜è®¤çš„<strong>lessæ–¹æ³•å»ºç«‹çš„æ˜¯å¤§é¡¶å †</strong>ï¼Œè¦<strong>å»ºç«‹å°é¡¶å †åˆ™æ”¹ç”¨greater&lt;T&gt;</strong></p><p>ç„¶åæ‰€è°“çš„lessæ–¹æ³•ï¼Œæ˜¯å°†ç¬¬ä¸€ä¸ªå®å‚ï¼ˆç§°ä¹‹ä¸ºå·¦å®å‚ï¼‰ä¸ç¬¬äºŒä¸ªå®å‚ï¼ˆç§°ä¹‹ä¸ºå³å®å‚ï¼‰è¿›è¡Œæ¯”è¾ƒï¼Œreturn left&lt;rightâ€”â€”é‚£ä¹ˆå·¦å®å‚æ›´å°æ—¶åˆ™ä¸ºtrueï¼Œä¸ºtrueåˆ™äº¤æ¢ï¼›greateræ–¹æ³•åä¹‹ï¼Œreturn left&gt;rightï¼›</p><p>åœ¨ä¸Šè¿°ä»£ç çš„è‡ªå®šä¹‰æ–¹æ³•mycomparisonä¸­ä¹Ÿå¯ä»¥è¯´æ˜è¿™ä¸€ç‚¹ï¼Œå®ƒä½¿ç”¨çš„æ˜¯return left&gt;right,å³greateræ–¹æ³•ï¼Œå³å»ºç«‹å°é¡¶å †</p></li></ol><blockquote><p>æ€»ç»“ï¼š<br>å»ºç«‹å¤§é¡¶å † = lessæ–¹æ³• = return left &lt; right<br>å»ºç«‹å°é¡¶å † = greateræ–¹æ³• = return left &gt; right</p></blockquote><div class="note note-warning">            <p>TO-DOï¼š<br>ä¸Šè¿°ç¬¬ä¸‰æ¡çº¯å±è‡ªå·±ç†è§£ï¼Œè¿™ä¹ˆæ­»è®°ç”¨æ¥åšé¢˜åº”ç”¨æ²¡å•¥é—®é¢˜ï¼Œä½†è¿˜æ˜¯å¾—æŒ‘ä¸ªè‰¯è¾°å‰æ—¥å»ç¿»ç¿»æºç æ‰è¡ŒæğŸ˜£</p>          </div>]]></content>
    
    
    <categories>
      
      <category>è‡ªå·±äº‹æƒ…é è‡ªå·±</category>
      
    </categories>
    
    
    <tags>
      
      <tag>c++</tag>
      
      <tag>ç®—æ³•</tag>
      
      <tag>leetcode</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å€Ÿä¸€é“leetcodeæ€è€ƒæ€»ç»“map/setçš„åº”ç”¨åŠåŒºåˆ«</title>
    <link href="/2023/04/13/%E5%80%9F%E4%B8%80%E9%81%93leetcode%E6%80%9D%E8%80%83%E6%80%BB%E7%BB%93mapset%E7%9A%84%E5%BA%94%E7%94%A8%E5%8F%8A%E5%8C%BA%E5%88%AB/"/>
    <url>/2023/04/13/%E5%80%9F%E4%B8%80%E9%81%93leetcode%E6%80%9D%E8%80%83%E6%80%BB%E7%BB%93mapset%E7%9A%84%E5%BA%94%E7%94%A8%E5%8F%8A%E5%8C%BA%E5%88%AB/</url>
    
    <content type="html"><![CDATA[<h1>å‰è¨€</h1><p>åŸé¢˜æ˜¯leetcode349ï¼Œè¦æ±‚ä¸¤ä¸ªæ•°ç»„çš„äº¤é›†</p><p><img src="https://s2.loli.net/2023/04/13/WmNqiBn9R6Lh7f4.png" alt=" "><br>è¿™é¢˜æœ¬èº«ä¸éš¾ï¼Œä¸»è¦æ˜¯è¦è€ƒè™‘åˆ°ï¼š</p><ol><li>åŸé¢˜åªéœ€æ±‚â€œé¢‘ç‡â€ï¼Œæ— éœ€è€ƒè™‘â€œé¡ºåºâ€ï¼Œåˆ™åº”ä½¿ç”¨å“ˆå¸Œè¡¨ç»“æ„ï¼Œè€Œä¸æ˜¯é¡ºåºç»“æ„+ä¸¤ä¸ªforæš´åŠ›éå†</li><li>ç”¨äºä½œé”®å€¼keyçš„æ˜¯æ•°å­—è€Œéå­—æ¯ï¼Œæ‰€ä»¥åº”è¯¥ç”¨æ­£å„¿å…«ç»çš„set/mapï¼Œè€Œä¸æ˜¯ç”¨vectoræä¼ªhashï¼ˆå¦åˆ™å½“æ•°å­—é”®å€¼å¾ˆå¤§ä¸”ç¨€ç–æ—¶ï¼Œvectorä¼šæµªè´¹å¤§é‡ç©ºé—´ï¼‰</li><li>ä¸éœ€è¦è®¾ç½®æ˜ç¡®çš„keyï¼Œæ‰€ä»¥ç”¨setï¼Œè€Œä¸æ˜¯map</li><li>ä¸è€ƒè™‘é¡ºåºï¼Œæ‰€ä»¥ç”¨unordered_set</li></ol><p>ä¸Šè¿°æ€è·¯ç†æ¸…ä¹‹åï¼Œä»£ç è‡ªç„¶å°±å‡ºæ¥äº†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">intersection</span><span class="hljs-params">(vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums1, vector&lt;<span class="hljs-type">int</span>&gt;&amp; nums2)</span> </span><br><span class="hljs-function">    </span>&#123;<br>        unordered_set&lt;<span class="hljs-type">int</span>&gt; result_set; <span class="hljs-comment">// å­˜æ”¾ç»“æœï¼Œä¹‹æ‰€ä»¥ç”¨setæ˜¯ä¸ºäº†ç»™ç»“æœé›†å»é‡</span><br>        <span class="hljs-function">unordered_set&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">nums_set</span><span class="hljs-params">(nums1.begin(), nums1.end())</span></span>;<br>        <br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> iter : nums2) <br>        &#123;<br>            <span class="hljs-comment">// å‘ç°nums2çš„å…ƒç´  åœ¨nums_seté‡Œåˆå‡ºç°è¿‡</span><br>            <span class="hljs-keyword">if</span> (nums_set.<span class="hljs-built_in">find</span>(iter) != nums_set.<span class="hljs-built_in">end</span>()) <br>            &#123;<br>                result_set.<span class="hljs-built_in">insert</span>(iter); <br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;(result_set.<span class="hljs-built_in">begin</span>(), result_set.<span class="hljs-built_in">end</span>());<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>ç”±æ­¤é¢˜æˆ‘ä»¬å¯ä»¥ä¸€çª¥set/mapçš„å…·ä½“ä½¿ç”¨åœºæ™¯ï¼Œä¸‹é¢å¯¹å…¶å·®åˆ«å’Œåº”ç”¨è¿›è¡Œç®€å•æ€»ç»“</p><hr><h1>ä¸€ã€å®šä¹‰å’Œç±»å‹</h1><p>STLä¸­çš„éƒ¨åˆ†å®¹å™¨ï¼ˆvectorã€listã€dequeç­‰ï¼‰åº•å±‚ä¸ºçº¿æ€§åºåˆ—çš„æ•°æ®ç»“æ„ï¼Œæ•…å°†è¿™äº›å®¹å™¨ç»Ÿç§°ä¸º<strong>åºåˆ—å¼å®¹å™¨</strong>ï¼Œé‡Œé¢å­˜å‚¨çš„æ˜¯å…ƒç´ æœ¬èº«ï¼›å¯¹åº”çš„ï¼Œæœ‰å¦å¤–ä¸€ç§ç”¨&lt;keyï¼Œvalue&gt;é”®å€¼å¯¹æ–¹å¼å‚¨å­˜æ•°æ®çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬ç§°å…¶ä¸º<strong>å…³è”å¼å®¹å™¨</strong>ï¼Œå…¸å‹çš„æœ‰setç±»å’Œmapç±»å®¹å™¨ã€‚</p><p>è¿™ç§å…³è”å¼å®¹å™¨çš„motivitionåº”è¯¥æ˜¯ç”¨æŸç§ç‰¹æ®Šçš„åº•å±‚æ•°æ®ç»“æ„æ¥ä»£æ›¿çº¿æ€§åºåˆ—ï¼Œä»¥é¿å…çº¿æ€§ç»“æ„å®¹æ˜“å¯¼è‡´çš„ç©ºé—´æµªè´¹é—®é¢˜ï¼ŒåŒæ—¶æé«˜curdæ•ˆç‡ â€“ â€“ çº¿æ€§åºåˆ—ä¸ºO(n)ï¼Œé‚£å†æé«˜å°±æ˜¯O(log n)å’ŒO(1)ï¼Œå¯¹åº”çš„æ˜¯å•¥æï¼Ÿ</p><p><em><strong>æ ‘å’Œhash tableå˜›ï¼è¿™ä¹Ÿæ­£æ˜¯set\mapçš„åº•å±‚å®ç°æ–¹å¼</strong></em></p><p>å…·ä½“å¦‚ä¸‹ï¼š</p><table><thead><tr><th>é›†åˆ</th><th>åº•å±‚å®ç°</th><th>æ˜¯å¦æœ‰åº</th><th>æ•°å€¼å¯é‡å¤</th><th>æ•°å€¼å¯æ›´æ”¹</th><th>curdæ•ˆç‡</th></tr></thead><tbody><tr><td>std::set</td><td>çº¢é»‘æ ‘</td><td>æœ‰åº</td><td>å¦</td><td>å¦</td><td>O(log n)</td></tr><tr><td>std::multiset</td><td>çº¢é»‘æ ‘</td><td>æœ‰åº</td><td>æ˜¯</td><td>å¦</td><td>O(logn)</td></tr><tr><td>std::unordered_set</td><td>å“ˆå¸Œè¡¨</td><td>æ— åº</td><td>å¦</td><td>å¦</td><td>O(1)</td></tr></tbody></table><table><thead><tr><th>é›†åˆ</th><th>åº•å±‚å®ç°</th><th>æ˜¯å¦æœ‰åº</th><th>æ•°å€¼å¯é‡å¤</th><th>æ•°å€¼å¯æ›´æ”¹</th><th>curdæ•ˆç‡</th></tr></thead><tbody><tr><td>std::map</td><td>çº¢é»‘æ ‘</td><td>æœ‰åº</td><td>keyä¸å¯é‡å¤</td><td>å¦</td><td>O(log n)</td></tr><tr><td>std::multimap</td><td>çº¢é»‘æ ‘</td><td>æœ‰åº</td><td>keyå¯é‡å¤</td><td>å¦</td><td>O(logn)</td></tr><tr><td>std::unordered_set</td><td>å“ˆå¸Œè¡¨</td><td>æ— åº</td><td>keyä¸å¯é‡å¤</td><td>å¦</td><td>O(1)</td></tr></tbody></table><p>å…¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œset\multiset\map\multimapçš„å®ç°éƒ½ä¸ºçº¢é»‘æ ‘ï¼Œçº¢é»‘æ ‘æ˜¯ä¸€ç§å¹³è¡¡äºŒå‰æœç´¢æ ‘ï¼Œæ‰€ä»¥keyæœ‰åºä¸”ä¸èƒ½ä¿®æ”¹ï¼Œä¿®æ”¹keyä¼šå¯¼è‡´æ•´æ£µæ ‘çš„é”™ä¹±ï¼›<br>è€Œæˆ‘ä»¬è¦ç”¨é›†åˆæ¥è§£å†³hashé—®é¢˜æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨unorderedï¼Œå› ä¸ºå…¶åº•å±‚ä½¿ç”¨hash tableï¼Œcurdæ•ˆç‡æœ€é«˜ï¼ˆåªéœ€æ‰§è¡Œä¸€æ¬¡hash functionï¼Œå¤æ‚åº¦ä¸ºO(1)ï¼‰</p><hr><h1>äºŒã€setç±»è¯´æ˜</h1><ol><li>ä¸map/multimapä¸åŒï¼Œmapä¸­å­˜å‚¨çš„æ˜¯çœŸæ­£çš„é”®å€¼å¯¹&lt;key, value&gt;ï¼Œsetä¸­åªæ”¾valueï¼Œä½†åœ¨åº•å±‚å®é™…å­˜æ”¾çš„æ˜¯ç”±&lt;value, value&gt;æ„æˆçš„é”®å€¼å¯¹ï¼ˆå³ä¸€ä¸ªå…ƒç´ çš„valueåŒæ—¶ä¹Ÿä¼šæ ‡è¯†å®ƒï¼Œvalueå°±æ˜¯keyï¼‰ã€‚æ•…setä¸­æ’å…¥å…ƒç´ æ—¶ï¼Œ<strong>åªéœ€è¦æ’å…¥valueå³å¯ï¼Œä¸éœ€è¦æ„é€ é”®å€¼å¯¹</strong></li><li>setä¸­çš„å…ƒç´ ä¸å¯ä»¥é‡å¤ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨setè¿›è¡Œ<strong>å»é‡</strong></li><li>setä¸­çš„å…ƒç´ æœ‰åºï¼ˆé»˜è®¤å‡åºï¼‰ï¼Œæ•…å¯ç”¨iteration<strong>éå†setå¾—æœ‰åºåºåˆ—</strong></li><li>setä¸­çš„å…ƒç´ <strong>ä¸å…è®¸ä¿®æ”¹</strong>ï¼ˆå…ƒç´ æ€»æ˜¯constï¼‰</li><li>setä¸­çš„count()æ–¹æ³•åªèƒ½è¿”å›0æˆ–1ï¼Œæ‰€ä»¥å…¶å®å°±æ˜¯ä¸ªfind()ã€‚ã€‚è€Œfind()è¿”å›çš„æ˜¯æŸ¥æ‰¾å…ƒç´ çš„ä½ç½®æŒ‡é’ˆï¼Œæ²¡æœ‰åˆ™è¿”å›set.end()</li><li>multisetä¸setçš„åŒºåˆ«æ˜¯<strong>å‰è€…ä¸­çš„å…ƒç´ å¯é‡å¤</strong>ï¼Œå…¶å®ƒéƒ½ä¸€æ ·</li><li>unordered_setä¸setçš„åŒºåˆ«æ˜¯<strong>å‰è€…ä¸­çš„å…ƒç´ ä¸ä¼šæ’åº</strong></li></ol><p>ä»£ç ç¤ºä¾‹ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;set&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unordered_set&gt;</span></span><br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">TestSet</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">// ç”¨æ•°ç»„arrayä¸­çš„å…ƒç´ æ„é€ set</span><br><span class="hljs-type">int</span> array[] = &#123; <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>, <span class="hljs-number">0</span> &#125;;<br>set&lt;<span class="hljs-type">int</span>&gt; s;<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> e : array)<br>s.<span class="hljs-built_in">insert</span>(e);<br><br>cout &lt;&lt; <span class="hljs-string">&quot;setä¸­çš„å…ƒç´ ä¸ªæ•°ä¸º: &quot;</span> &lt;&lt; s.<span class="hljs-built_in">size</span>() &lt;&lt; endl;<br><br><span class="hljs-comment">// æ­£å‘æ‰“å°setä¸­çš„å…ƒç´ ï¼Œä»æ‰“å°ç»“æœä¸­å¯ä»¥çœ‹å‡ºï¼šsetå¯å»é‡</span><br>    cout &lt;&lt; <span class="hljs-string">&quot;æ­£å‘æ‰“å°setä¸­çš„å…ƒç´ : &quot;</span> ;<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; e : s)<br>cout&lt;&lt; e &lt;&lt; <span class="hljs-string">&quot; &quot;</span>;<br>cout &lt;&lt; endl;<br><br><span class="hljs-comment">// ä½¿ç”¨è¿­ä»£å™¨é€†å‘æ‰“å°setä¸­çš„å…ƒç´ </span><br>    cout &lt;&lt; <span class="hljs-string">&quot;é€†å‘æ‰“å°setä¸­çš„å…ƒç´ : &quot;</span> ;<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> it = s.<span class="hljs-built_in">rbegin</span>(); it != s.<span class="hljs-built_in">rend</span>(); ++it)<br>cout &lt;&lt; *it &lt;&lt; <span class="hljs-string">&quot; &quot;</span>;<br>cout &lt;&lt; endl;<br><br><span class="hljs-comment">// setä¸­å€¼ä¸º3çš„å…ƒç´ å‡ºç°äº†å‡ æ¬¡</span><br>cout &lt;&lt; <span class="hljs-string">&quot;setä¸­å€¼ä¸ºxçš„å…ƒç´ å‡ºç°äº†å‡ æ¬¡ï¼š&quot;</span> &lt;&lt; s.<span class="hljs-built_in">count</span>(<span class="hljs-number">0</span>) &lt;&lt; endl;<br><br>    <span class="hljs-function">multiset&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">muls</span><span class="hljs-params">(array, array + <span class="hljs-keyword">sizeof</span>(array) / <span class="hljs-keyword">sizeof</span>(array[<span class="hljs-number">0</span>]))</span></span>;<br>    cout &lt;&lt;  <span class="hljs-string">&quot;æ­£å‘æ‰“å°multisetä¸­çš„å…ƒç´ : &quot;</span> ;<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; e : muls)<br>cout &lt;&lt;e &lt;&lt; <span class="hljs-string">&quot; &quot;</span>;<br>cout &lt;&lt; endl;<br><br>    <span class="hljs-function">unordered_set&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">unorders</span><span class="hljs-params">(array, array + <span class="hljs-keyword">sizeof</span>(array) / <span class="hljs-keyword">sizeof</span>(array[<span class="hljs-number">0</span>]))</span></span>;<br>    cout &lt;&lt;  <span class="hljs-string">&quot;æ‰“å°unordered_setä¸­çš„å…ƒç´ : &quot;</span> ;<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; e : unorders)<br>cout &lt;&lt;e &lt;&lt; <span class="hljs-string">&quot; &quot;</span>;<br>cout &lt;&lt; endl;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">TestSet</span>();<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š<br><img src="https://s2.loli.net/2023/04/13/w8kQyJztoIBaq1E.png" alt=""></p><hr><h1>ä¸‰ã€mapç±»è¯´æ˜</h1><ol><li>éœ€è¦<strong>æ„é€ é”®å€¼å¯¹</strong></li><li>mapæ”¯æŒä¸‹æ ‡è®¿é—®ç¬¦ï¼Œå³åœ¨[]ä¸­æ”¾å…¥keyï¼Œå°±å¯ä»¥æ‰¾åˆ°ä¸keyå¯¹åº”çš„valueï¼›<a href="http://xn--ujqw61c2rb.at">ä¹Ÿæ”¯æŒ.at</a>()æ–¹æ³•ï¼Œä½†äºŒè€…æœ‰æ‰€ä¸åŒï¼ˆè§ä¸‹é¢ä»£ç ï¼‰</li><li>multimapå’Œmapçš„å”¯ä¸€ä¸åŒå°±æ˜¯ï¼šmapä¸­çš„<strong>keyæ˜¯å”¯ä¸€</strong>çš„ï¼Œè€Œmultimapä¸­keyæ˜¯<strong>å¯ä»¥é‡å¤çš„</strong></li><li>unordered_mapå’Œmap : : unordered_mapå­˜å‚¨å…ƒç´ æ—¶æ˜¯<strong>æ²¡æœ‰é¡ºåºçš„</strong>ï¼Œåªæ˜¯æ ¹æ®keyçš„å“ˆå¸Œå€¼ï¼Œå°†å…ƒç´ å­˜åœ¨æŒ‡å®šä½ç½®ï¼Œæ‰€ä»¥æ ¹æ®keyæŸ¥æ‰¾å•ä¸ªvalueæ—¶éå¸¸é«˜æ•ˆ</li></ol><p>ä»£ç ç¤ºä¾‹ï¼ˆæ¥æº: <a href="https://blog.csdn.net/qq_61635026/article/details/126070134?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522166593410616782412589556%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=166593410616782412589556&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-6-126070134-null-null.142%5Ev56%5Econtrol_1,201%5Ev3%5Econtrol_2&amp;utm_term=stl%20set%E5%92%8Cmap%E7%9A%84%E5%8C%BA%E5%88%AB&amp;spm=1018.2226.3001.4187">C++ STLä¸­ setå’Œmapä»‹ç»ä»¥åŠä½¿ç”¨æ–¹æ³•</a>ï¼‰</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;set&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;map&gt;</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br> <br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">TestMap</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>map&lt;string, string&gt; m;<br><span class="hljs-comment">// å‘mapä¸­æ’å…¥å…ƒç´ çš„æ–¹å¼ï¼š</span><br><span class="hljs-comment">// å°†é”®å€¼å¯¹&lt;&quot;peach&quot;,&quot;æ¡ƒå­&quot;&gt;æ’å…¥mapä¸­ï¼Œç”¨pairç›´æ¥æ¥æ„é€ é”®å€¼å¯¹</span><br>m.<span class="hljs-built_in">insert</span>(<span class="hljs-built_in">pair</span>&lt;string, string&gt;(<span class="hljs-string">&quot;peach&quot;</span>, <span class="hljs-string">&quot;æ¡ƒå­&quot;</span>));<br><span class="hljs-comment">// å°†é”®å€¼å¯¹&lt;&quot;peach&quot;,&quot;æ¡ƒå­&quot;&gt;æ’å…¥mapä¸­ï¼Œç”¨make_pairå‡½æ•°æ¥æ„é€ é”®å€¼å¯¹</span><br>m.<span class="hljs-built_in">insert</span>(<span class="hljs-built_in">make_pair</span>(<span class="hljs-string">&quot;banan&quot;</span>, <span class="hljs-string">&quot;é¦™è•‰&quot;</span>));<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">operator[]çš„åŸç†æ˜¯ï¼š</span><br><span class="hljs-comment"> ç”¨&lt;key, T()&gt;æ„é€ ä¸€ä¸ªé”®å€¼å¯¹ï¼Œç„¶åè°ƒç”¨insert()å‡½æ•°å°†è¯¥é”®å€¼å¯¹æ’å…¥åˆ°mapä¸­</span><br><span class="hljs-comment"> å¦‚æœkeyå·²ç»å­˜åœ¨ï¼Œæ’å…¥å¤±è´¥ï¼Œinsertå‡½æ•°è¿”å›è¯¥keyæ‰€åœ¨ä½ç½®çš„è¿­ä»£å™¨</span><br><span class="hljs-comment"> å¦‚æœkeyä¸å­˜åœ¨ï¼Œæ’å…¥æˆåŠŸï¼Œinsertå‡½æ•°è¿”å›æ–°æ’å…¥å…ƒç´ æ‰€åœ¨ä½ç½®çš„è¿­ä»£å™¨</span><br><span class="hljs-comment"> operator[]å‡½æ•°æœ€åå°†insertè¿”å›å€¼é”®å€¼å¯¹ä¸­çš„valueè¿”å›</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">// å°†&lt;&quot;apple&quot;, &quot;&quot;&gt;æ’å…¥mapä¸­ï¼Œæ’å…¥æˆåŠŸï¼Œè¿”å›valueçš„å¼•ç”¨ï¼Œå°†â€œè‹¹æœâ€èµ‹å€¼ç»™è¯¥å¼•ç”¨ç»“æœ</span><br>m[<span class="hljs-string">&quot;apple&quot;</span>] = <span class="hljs-string">&quot;è‹¹æœ&quot;</span>;<br><br><span class="hljs-comment">// keyä¸å­˜åœ¨æ—¶æŠ›å¼‚å¸¸</span><br><span class="hljs-comment">//m.at(&quot;waterme&quot;) = &quot;æ°´èœœæ¡ƒ&quot;;</span><br><br>cout &lt;&lt; m.<span class="hljs-built_in">size</span>() &lt;&lt; endl;<br><span class="hljs-comment">// ç”¨è¿­ä»£å™¨å»éå†mapä¸­çš„å…ƒç´ ï¼Œå¯ä»¥å¾—åˆ°ä¸€ä¸ªæŒ‰ç…§keyæ’åºçš„åºåˆ—</span><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; e : m)<br>cout &lt;&lt; e.first &lt;&lt; <span class="hljs-string">&quot;---&gt;&quot;</span> &lt;&lt; e.second &lt;&lt; endl;<br>cout &lt;&lt; endl;<br><span class="hljs-comment">// mapä¸­çš„é”®å€¼å¯¹keyä¸€å®šæ˜¯å”¯ä¸€çš„ï¼Œå¦‚æœkeyå­˜åœ¨å°†æ’å…¥å¤±è´¥</span><br><span class="hljs-keyword">auto</span> ret = m.<span class="hljs-built_in">insert</span>(<span class="hljs-built_in">make_pair</span>(<span class="hljs-string">&quot;peach&quot;</span>, <span class="hljs-string">&quot;anotheræ¡ƒå­&quot;</span>));<br><span class="hljs-keyword">if</span> (ret.second)<br>cout &lt;&lt; <span class="hljs-string">&quot;&lt;peach, anotheræ¡ƒå­&gt;ä¸åœ¨mapä¸­, å·²ç»æ’å…¥&quot;</span> &lt;&lt; endl;<br><span class="hljs-keyword">else</span><br>cout &lt;&lt; <span class="hljs-string">&quot;é”®å€¼ä¸ºpeachçš„å…ƒç´ å·²ç»å­˜åœ¨ï¼š&quot;</span> &lt;&lt; ret.first-&gt;first &lt;&lt; <span class="hljs-string">&quot;---&gt;&quot;</span><br>&lt;&lt; ret.first-&gt;second &lt;&lt; <span class="hljs-string">&quot; æ’å…¥å¤±è´¥&quot;</span> &lt;&lt; endl;<br><span class="hljs-comment">// åˆ é™¤keyä¸º&quot;apple&quot;çš„å…ƒç´ </span><br>m.<span class="hljs-built_in">erase</span>(<span class="hljs-string">&quot;apple&quot;</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-number">1</span> == m.<span class="hljs-built_in">count</span>(<span class="hljs-string">&quot;apple&quot;</span>))<br>cout &lt;&lt; <span class="hljs-string">&quot;appleè¿˜åœ¨&quot;</span> &lt;&lt; endl;<br><span class="hljs-keyword">else</span><br>cout &lt;&lt; <span class="hljs-string">&quot;appleè¢«åƒäº†&quot;</span> &lt;&lt; endl;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">TestMap</span>();<br><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="https://s2.loli.net/2023/04/13/A3rM12B8DJKzVS7.png" alt=""><br>å¦‚æœç”¨at()æŸ¥å€¼ï¼Œåˆ™keyä¸åœ¨æ—¶æŠ›å‡ºå¼‚å¸¸</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">m.<span class="hljs-built_in">at</span>(<span class="hljs-string">&quot;waterme&quot;</span>) = <span class="hljs-string">&quot;æ°´èœœæ¡ƒ&quot;</span>;<br></code></pre></td></tr></table></figure><p><img src="https://s2.loli.net/2023/04/13/bMPIHgarpTBKlu1.png" alt=""></p><hr><h1>æ€»ç»“</h1><p><strong>1. ç”¨setç±»è¿˜æ˜¯mapç±»ï¼Ÿ</strong><br>å¦‚æœéœ€è¦å»ºç«‹æ˜ç¡®çš„<strong>é”®å€¼å¯¹åº”å…³ç³»</strong>ï¼ˆå¦‚ç¤ºä¾‹ä¸­çš„æ°´æœï¼‰ï¼Œé‚£åªèƒ½ç”¨mapï¼›å¦‚æœåªéœ€çŸ¥é“â€œ<strong>å­˜åœ¨ä¸å¦</strong>â€ï¼Œé‚£ç”¨setå°±å¤Ÿäº†ï¼ˆå¦‚leetcodeä¾‹é¢˜ï¼Œå…¶å®æ²¡æœ‰ä½“ç°ä¸€ä¸ªæ˜ç¡®çš„keyï¼Œcodingæ—¶å…³å¿ƒçš„ä¹Ÿæ˜¯valueè€Œä¸æ˜¯keyï¼‰</p><p><strong>2. ç”¨setç±»è¿˜æ˜¯arrayä¼ªhashï¼Ÿ</strong><br>å¦‚æœkeyåˆ†å¸ƒåœ¨ä¸€ä¸ª<strong>ä¸å¤§çš„è¿ç»­åŒºé—´</strong>å†…ï¼ˆ å¦‚26ä¸ªå­—æ¯ï¼‰ï¼Œåˆ™å¯ä»¥ç›´æ¥ç”¨arrayï¼Œè¿™æ ·æ›´å¿«ï¼Œå› ä¸ºsetä¸ä»…å ç”¨ç©ºé—´æ¯”æ•°ç»„å¤§ï¼Œè€Œä¸”é€Ÿåº¦è¦æ¯”æ•°ç»„æ…¢ï¼ŒsetæŠŠæ•°å€¼æ˜ å°„åˆ°keyä¸Šéƒ½è¦åšhashè®¡ç®—çš„ï¼›<br>ä½†å¦‚æœkeyéšæœºåˆ™ç”¨setï¼Œå¦‚keyä¸º<strong>åˆ†å¸ƒç¨€ç–</strong>çš„å¤§æ•°å­—æ—¶ï¼Œç”¨æ•°ç»„å°±éå¸¸æµªè´¹ç©ºé—´ï¼Œåªèƒ½ç”¨setã€‚</p><p><strong>3. ç”¨setè¿˜æ˜¯unordered_setï¼Ÿï¼ˆmapåŒç†ï¼‰</strong><br>æœ‰åºsetï¼ˆçº¢é»‘æ ‘ï¼‰ï¼Œæ— åºunordered_setï¼ˆhash tableï¼‰</p><p><strong>PS.</strong> pyä¸­çš„inå…³é”®å­—åœ¨ä¸åŒç»“æ„ä¸­ï¼ˆtuple, list, dict, setï¼‰æŸ¥æ‰¾å…ƒç´ æ—¶æ•ˆç‡æ˜¯ç›¸å·®å¾ˆå¤§çš„ï¼Œå› ä¸ºdict, setåº•å±‚æ˜¯ä¸€ä¸ªhash tableï¼›è€Œtuple, liståªæ˜¯ä¸€ä¸ªå•çº¯ç±»äºæ•°ç»„çš„çº¿æ€§ç»“æ„ã€‚ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>è‡ªå·±äº‹æƒ…é è‡ªå·±</category>
      
    </categories>
    
    
    <tags>
      
      <tag>c++</tag>
      
      <tag>ç®—æ³•</tag>
      
      <tag>å“ˆå¸Œç®—æ³•</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è®°ä½è¿ç®—ç¬¦(ï¼ï¼)ä½¿ç”¨ä¸å½“å¼•èµ·çš„ä¸€æ¬¡bug</title>
    <link href="/2023/04/13/%E8%AE%B0%E4%BD%8D%E8%BF%90%E7%AE%97%E7%AC%A6(%EF%BC%9E%EF%BC%9E)%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%BD%93%E5%BC%95%E8%B5%B7%E7%9A%84%E4%B8%80%E6%AC%A1bug/"/>
    <url>/2023/04/13/%E8%AE%B0%E4%BD%8D%E8%BF%90%E7%AE%97%E7%AC%A6(%EF%BC%9E%EF%BC%9E)%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%BD%93%E5%BC%95%E8%B5%B7%E7%9A%84%E4%B8%80%E6%AC%A1bug/</url>
    
    <content type="html"><![CDATA[<h1>é—®é¢˜æè¿°</h1><p>ä»Šå¤©åˆ·leetcodeæ—¶é‡åˆ°ä¸ªæ­»æ´»ä¹Ÿæƒ³ä¸é€šçš„bug</p><p>åŸé¢˜å¾ˆç®€å•ï¼Œçº¿æ€§æ•°ç»„æ’å€¼é—®é¢˜ï¼Œæš´åŠ›éå†å’ŒäºŒåˆ†æ³•éƒ½å¯ä»¥åš</p><p><img src="https://s2.loli.net/2023/04/13/ifSOReA2dapUFsh.png" alt=""><br>ä¸å‡æ€ç´¢ç”¨åŒºé—´å·¦é—­å³å¼€çš„äºŒåˆ†æ³•ï¼Œä¸‰ä¸‹äº”é™¤äºŒå°±æ•´äº†å‡ºæ¥ï¼Œèƒ¸æœ‰æˆç«¹ğŸ˜‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Solution</span> &#123;</span><br>public:<br>    <span class="hljs-type">int</span> <span class="hljs-title function_">searchInsert</span><span class="hljs-params">(<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">int</span>&gt;&amp; nums, <span class="hljs-type">int</span> target)</span> &#123;<br>        <span class="hljs-type">int</span> left = <span class="hljs-number">0</span>, right = nums.size();<br>        <span class="hljs-keyword">while</span>(left &lt; right)<br>        &#123;<br>            <span class="hljs-type">int</span> middle = left + (right - left) &gt;&gt; <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">if</span> (nums[middle] &gt; target )<br>                right = middle;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nums[middle] &lt; target )<br>                left = middle + <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> middle;<br>        &#125;<br>        <span class="hljs-keyword">return</span> right;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>è°çŸ¥æäº¤æ—¶ä¸€ç›´åœ¨ç¤ºä¾‹3ï¼ˆå³è¾“å…¥æ•°ç»„ä¸º[1 3 5 6]ï¼ŒæŸ¥è¯¢å€¼target = 7ï¼‰å¡bugï¼Œæç¤ºè¶…æ—¶ã€‚ã€‚</p><hr><h1>åŸå› åˆ†æï¼š</h1><p>åŸä»¥ä¸ºæ˜¯åŒºé—´è¾¹ç•Œæ¡ä»¶è®¾ç½®ä¸å½“ï¼Œåå¤æ£€æŸ¥ï¼Œæ‰‹åŠ¨æ¼”ç®—ï¼Œè„‘è¢‹æƒ³ç ´äº†ä¹Ÿè§‰å¾—æ²¡é—®é¢˜ã€‚ã€‚</p><p>æ— å¥ˆdebugï¼Œå‘ç°æ‰§è¡Œè¿™ä¸€å¥åï¼Œmiddleä¸€å€¼å˜åŒ–å¾ˆå¥‡æ€ªã€‚ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> middle = left + (right - left) &gt;&gt; <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><p>çªç„¶è™èº¯ä¸€éœ‡ï¼Œæ„è¯†åˆ°å¯èƒ½æ˜¯è¿ç®—ç¬¦ä¼˜å…ˆçº§ä¸€é—®é¢˜ï¼Œé€Ÿgoogleä¹‹ï¼Œæœç„¶ï¼</p><p><img src="https://s2.loli.net/2023/04/13/ildhp5643oy9vXw.png" alt=""></p><p><em><strong>åŸæ¥åŠ å‡ç¬¦çš„ä¼˜å…ˆçº§æ˜¯è¦é«˜äºä½è¿ç®—ç¬¦çš„ï¼</strong></em><br>ä¸€éªŒè¯å‘ç°ä¹Ÿçš„ç¡®å¦‚æ­¤<br><img src="https://s2.loli.net/2023/04/13/r8KHytNjmulQXIv.png" alt=""></p><p><img src="https://s2.loli.net/2023/04/13/pCmWrFxzQE8AY1T.png" alt=""></p><hr><h1>è§£å†³æ–¹æ¡ˆï¼š</h1><p>åŠ ä¸ªæ‹¬å·å³å¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> middle = left +( (right - left) &gt;&gt; <span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><p>é—®é¢˜è§£å†³ï¼Œé¡ºåˆ©é€šå…³ï¼</p><p><img src="https://s2.loli.net/2023/04/13/vtzFBo3YmZqg4XV.png" alt=""></p><hr><h1>æ€»ç»“åæ€ï¼š</h1><ol><li>å–„äºä½¿ç”¨æ‹¬å·ï¼Œå°¤å…¶æ˜¯ä¸»è§‚ä¸Šå¸Œæœ›æŸä¸ªå¼å­éƒ¨åˆ†å…ˆè¿ç®—æ—¶ã€‚</li><li>è€è€å®å®ç”¨ä¹˜é™¤å¾—äº†ï¼Œåˆ«æ•´äº›ä»€ä¹ˆèŠ±é‡Œèƒ¡å“¨trickã€‚ã€‚ä»£ç çœä¸‹å‡ æ¯«ç§’ï¼Œdebugå¤šèŠ±å‡ ååˆ†é’Ÿã€‚ã€‚</li></ol>]]></content>
    
    
    <categories>
      
      <category>è‡ªå·±äº‹æƒ…é è‡ªå·±</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ç®—æ³•</tag>
      
      <tag>leetcode</tag>
      
      <tag>bug</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
